--[[
@Title:			Map Life Facts V3.2
@Author:			Mike Tate
@LastUpdated:	21 May 2012
@Version:			3.2
@Description:	Creates web pages that use Google Maps to display on a map the Locations from each persons Facts.
@V3.2:				Revised new Address…Place sub-options that retain entries, and new Set Preferences Database Management tab.
@V3.1:				Statistics speed-up for many Locations, fixed Delete key bug in Subs/Lat/Long fields, and four new Address…Place sub-options.
@V3.0:				Force all dialogue backgrounds to white, and make editing Substitute, Latitude & Longitude more responsive.
@V2.9:				Optionally detects previous manually adjusted Locations, allows Geocode Plot/Map All/Some to escape at Quota Warning.
@V2.8:				New Manual statistics class of Location, revised Geocode Plot All button, new Geocode Plot Some button, revised Next... buttons. 
@V2.7:				Translate any delimited Country/State/Chapman/County Code into full name before submitting to Geocoder.
@V2.7:				Use read("*all") and table.concat instead of string concatenation, save Plugin sticky settings more often.
@V2.6:				Fixed 'Not enough memory' for big _nameindex.html, set quota warning on all Plot/Map buttons, FlgFile/FolderExists now use "lfs".
@V2.5:				Corrects missing webpage links when no 'See also' section, adds warning about exceeding 2,500 plots per 24 hours.
@V2.4:				Checks map files belong to chosen Individual, adds Region Biasing option, uses bell blob for newline
@V2.3:				Improved Map options & GUI avoids Blue, default Zoom only set on Preferences tab, multi-plot sample Maps on Create Maps tab.
@V2.2:				Redesigned GUI, colour coded tree lists & statistics, zoom set from Google Map, better map Markers, bug fixes & code revisions.
@V2.1:				Loads fast, resizeable main GUI, trees replace dropdown lists, better tooltips, bigger Google Map pane, bug fixes & code revisions.
@V2.0:				New GUI with tabs, progress bars, and embedded HTML Google Map, plus Google Geocoder API, bug fixes & code revisions.
@V1.1:				Improved version with fhSleep(), Interface Font option, and Knowledge Base Help.
@V1.0:				Initial version using HTML Application (HTA) for Google Maps Geocoder.
]]

	require "iuplua"								-- To access GUI window builder
	require "lfs"									-- To access LUA filing system
	require "iupluaole"								-- To access OLE subsystem
	require "luacom"								-- To access COM subsystem

-- Global Data Constants Definition --
function PresetGlobalConstants()

	-- GUI Global Constants

	StrPlugin			= "Map Life Facts"			-- Plugin title & version
	StrIssue			= " V3.2"
	StrRed				= "255 0 0"					-- Color attributes (must exclude leading zeros)
	StrAmber			= "250 160 0"
	StrGreen			= "0 120 0"
	StrBlue			= "0 0 255"
	StrPurple			= "200 0 200"
	StrGray			= "120 120 120"
	StrBlack			= "0 0 0"
	StrWhite			= "255 255 255"
	StrGap 			= "2"							-- Gap & Margin attributes
	StrMinMargin		= "2x2"
	StrBigMargin		= "8x8"
	IntTabGeoLoc		=	0							-- Main tab (& Preferences tab) position values
	IntTabCreate		=	1
	IntTabPrefer		=	2
	StrClickHere		= "Click here to choose an Entry"
	StrRegBiasTitle	= "Region Bias Code"
	StrGeoCodeTitle	= "Smart Geocoding"
	StrFromTagTitle	= "Locations From"
	StrStorageTitle	= "Database In"
	StrMarkersTitle	= "Marker Style"
	StrPrivacyTitle	= "Privacy Filter"
	StrFontSetTitle	= "Set Interface Font"
	StrMapZoomTitle	= "Map Zoom"
	IntGetZoom		=	1
	IntFromPLAC		=	1							-- Locations From values for IntFromTag
	IntFromADDR		=	2
	IntFromBOTH		=	3							-- Locations From values for BOTH variants:
	IntFromP			=	3							-- …Place only
	IntFromA			=	4							-- Address… only
	IntFromAP			=	5							-- Address…Place
	IntFromA_P_		=	6							-- Address…[Place]
	IntFrom_A_P		=	7							-- [Address]…Place
	IntFrom_A__P_	=	8							-- [Address]…[Place]
	IntFromINDI		=	4							-- Special From value for Tree GUI table
	TblFromName		= { "Place Fields only", "Address Fields only", "…Place only", "Address… only", "Address…Place", "Address…[Place]", "[Address]…Place", "[Address]…[Place]" }
	TblFromTag		= { "PLAC", "ADDR", "BOTH" }
	StrFromTag		= TblFromTag[IntFromPLAC]
	TblFromType		= { PLAC="Facts Place", ADDR="Facts Address", BOTH="Facts Address…Place" }
	TblStoreTAG		= { "", "REPO", "SOUR", "SOUR" }
	IntStoreFILE		=	1							-- Geocode Database values for IntStorage
	IntStoreREPO		=	2
	IntStoreSOUR		=	3
	IntStoreBOTH		=	4
	IntMarkNothing	=	1							-- Marker Style values for IntMarkers
	IntMarkSynchro	=	2
	IntMarkCascade	=	3
	IntLivingFlag	=	1							-- Privacy Flag values for IntPrivacy
	IntPrivateFlag	=	2
	IntBothFlags		=	3
	IntSwitchedOff	=	4
	IntFontPlain		=	1							-- Font Face & Style values for IntFontSet
	IntFontBold		=	2
	IntArialPlain	=	3
	IntArialBold		=	4
	IntTahomaPlain	=	5
	IntTahomaBold	=	6
	StrFontFace		= string.gsub(iup.GetGlobal("DEFAULTFONT"),",.*","")

	-- Plot & Map Status Translation Tables

	IntQuotaLimit	=	2500						-- Geocoder maximum plots per day quota limit
	IntCheckDone		=	1000000					-- Auto-check of Manual plots done value
	StrPlotNoData	= "No Data"					-- Plot status text strings related to TblPlotStates
	StrPlotLatLong	= "%-?%d+%.?%d-"			-- Lat/Longitude numerical pattern ( optional "-"  1+ digits  optional "."  0+ digits )
	StrPlotManual	= "%-?%d+%.?%d-Manual"		-- Lat/Longitude numerical pattern as above but entered manually 
	StrPlotNoPlot	= "No Plot"
	StrPlotInvalid	= "Invalid Request"
	StrPlotDenied	= "Request Denied"
	StrPlotQuotaX	= "Quota Exceeded"
	IntPlotNoData	=	1							-- Plot status table index values related to TblPlotStates & TblStatusColor
	IntPlotLatLong	=	2
	IntPlotManual	=	3
	IntPlotNoPlot	=	4
	IntPlotInvalid	=	5
	IntPlotDenied	=	6
	IntPlotQuota		=	7
	IntPlotSumTotal	=	8
	StrMapNoMap		= "No Map"					-- Map status text strings related to TblMapStates
	StrMapFilename	= "map%d+%.html"			-- Map Folder filename pattern ( "map"  1+ digits  ".html" )
	StrMapOmitted	= "Omitted"
	StrMapFiltered	= "Filtered"
	IntMapNoMap		=	1							-- Map status table index values related to TblMapStates & TblStatusColor
	IntMapFilename	=	2	
	IntMapOmitted	=	4
	IntMapFiltered	=	5
	IntMapSumTotal	=	8
	IntHighlight		=	8
	TblPlotStates	= { "^$"		, "^"..StrPlotLatLong.."$"	, "^"..StrPlotManual.."$"	, "^"..StrPlotNoPlot.."$"	, "^"..StrPlotInvalid.."$"	, "^"..StrPlotDenied.."$"	, "^"..StrPlotQuotaX.."$"	, }
	TblMapStates		= { "^$"		, "^"..StrMapFilename.."$"	, "^$"							,"^"..StrMapOmitted.."$"	, "^"..StrMapFiltered.."$"	, }
	TblStatusColor	= { StrGray	, StrGreen						, StrPurple					, StrAmber					, StrRed							, StrRed						, StrRed						, StrBlack }

	-- Filename Global Constants

	StrComputerName = os.getenv("COMPUTERNAME")

	StrStickyFile = fhGetPluginDataFileName()
	-- Allow plugins with variant filenames to use same plugin data files
	StrStickyFile = string.gsub(StrStickyFile,"\\"..StrPlugin..".+%.[D,d][A,a][T,t]$","\\"..StrPlugin..".dat")
	if StrStickyFile == "" then
		-- Use standalone GEDCOM path & filename..".fh_data\Plugin Data\" as the folder + the Plugin Filename..".dat"
		StrStickyFile = fhGetContextInfo("CI_GEDCOM_FILE")
		StrStickyFile = string.gsub(StrStickyFile, "%.[G,g][E,e][D,d]", ".fh_data")
		lfs.mkdir(StrStickyFile)
		StrStickyFile = StrStickyFile.."\\Plugin Data"
		lfs.mkdir(StrStickyFile)
		StrStickyFile = StrStickyFile.."\\"..StrPlugin..".dat"
	end

	-- Plugin data folder path name
	StrPluginPath = string.gsub(StrStickyFile,"\\"..StrPlugin.."%.[D,d][A,a][T,t]$","")

	-- Plugin data file root name
	local strPluginRoot = StrPluginPath.."\\"..StrPlugin

	StrFileNameHTM = strPluginRoot..".htm"		-- Google Maps HTML file
	StrFileNameACT = strPluginRoot..".act"		-- Google Maps Action file
	StrFileNameLOC = strPluginRoot..".loc"		-- Locations Geocode database file

	-- Public data folder path name
	StrPublicPath = fhGetContextInfo("CI_PROJECT_PUBLIC_FOLDER")
	if StrPublicPath == "" then StrPublicPath = StrPluginPath end

	-- FH Web Page HTML code strings
	StrDivContent = "<div class=\"fhcontent fhpage%u%l%l\">\n"	-- <div class="fhcontent fhpageFam">\n or <div class="fhcontent fhpageInd">\n
	StrDivSeeAlso = "<div class=\"FhSeeAlso\">\n"					-- <div class="FhSeeAlso">\n
	StrTxtSeeAlso = "<p>See also</p>\n<ul>\n"							-- <p>See also</p>\n<ul>\n
	StrEndSeeAlso = "</ul>\n</div>\n"									-- </ul>\n</div>\n
	StrH1Heading  = "<h1 class=\"FhHdg1\">"							-- <h1 class="FhHdg1">
	StrMapHeaders = " "														-- Map file script between "</title>" and "</head>"  to replace {fhheaders}
	StrMapMenubar = " "														-- Map file script between "<body>" and "<div class" to replace {fhmenubar}

end -- function PresetGlobalConstants

-- Global Script Definitions --

StrMasterHTM = [=[
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html>
  <head>
    <title>{plugin}</title>
    <meta name='viewport' content='initial-scale=1.0,user-scalable=no'>
    <meta http-equiv='content-type' content='text/html; charset=utf-8'>
    <link type='text/css' rel='stylesheet' href='http://code.google.com/apis/maps/documentation/javascript/examples/default.css'>
    <link type='text/css' rel='stylesheet' href='mapfacts.css'>
    <script type='text/javascript' src='http://maps.googleapis.com/maps/api/js?sensor=false'> </script>
    <script type='text/javascript' src='mapfacts.js'> </script>
    <script type='text/javascript' language='JavaScript'>
    window.onload = function Initialise()							// Initialisation function
    {
      MapMark = new Array();											// google.maps.Marker overlays
      LatLong = new Array();											// google.maps.LatLng positions
      InfoWin = new Array();											// google.maps.InfoWindow popups
      Caption = new Array();											// Marker caption title tooltips
      if ( CheckOnline('canvas') == "Fail" ) { return; };		// Check if PC is online
      SynOld = '';														// Synchronisation old char
      SynNew = '';														// Synchronisation new char
      Action = '';														// Action command code e.g. 'MARK', 'NULL', 'PLOT', 'DROP', 'ZOOM'
      Value1 = '';														// Latitude or Drop animation or Zoom level
      Value2 = '';														// Longitude or Drop delay
      Value3 = '';														// Location Address/Place
      Value4 = '';														// Recorded Facts text
      BanZoom = 1;														// Banned map Zoom level to exclude from reports
      SetZoom = 1;														// Current map Zoom level
      SetZoomLevel({setzoom});										// Integer between 0 and 22
      MarkZoom = SetZoom;												// Default zoom level for single 'MARK' Markers
      Animation = null;												// Marker animation mode
      SetAnimation('{animate}');									// 'null'=No Animation, or 'DROP'=Synchro/Cascade
      SetPause = 0;														// Pause for 0ms before dropping Markers
      SetDelay = 0;														// Marker delay of 0ms=Immediate, ~300ms=No Animation/Synchro, or ~2000ms=Cascade
      SetWait = 250;													// Wait between checks for new action file
      Home = new google.maps.LatLng(5.65,0.0);					// Tema, Accra, Ghana is nearest urban area to (0.0,0.0) N.B. Greenwich = (51.5,0.0)
      Map = new google.maps.Map(document.getElementById('canvas'),{ zoom:1, center:Home, overviewMapControl:false, scaleControl:true, mapTypeId:google.maps.MapTypeId.ROADMAP });
      Geocoder = new google.maps.Geocoder();						// Note overviewMapControl:true fails when Zoom slider moved up rapidly sometimes!
      google.maps.event.addListener(Map, 'zoom_changed', function() { GetZoomLevel(); } );
      google.maps.event.addListener(Map, 'click', function(event) { RepresentMap(); } );
      xmlDoc = new ActiveXObject('Microsoft.XMLDOM');			// or ActiveXObject('msxml2.DOMDocument.6.0'); 
      xmlDoc.async=false;												// See http://msdn.microsoft.com/en-us/library/windows/desktop/ms766487%28v=VS.85%29.aspx
      LoadFile('{plugin}.act');
    }
    function LoadFile(filename)
    {
      var status = xmlDoc.load(filename);							// Load the input action file
      if ( status )
      {
        if ( xmlDoc.parseError.errorCode == 0 )
        {
          var line = xmlDoc.xml.split('\n');						// Split action file into lines & remove carriage returns
          SynNew = line[1].replace('\r','');						// Synchronisation char
          Action = line[2].replace('\r','');						// Action command code
          Value1 = line[3].replace('\r','');						// Latitude or Drop delay or Zoom level
          Value2 = line[4].replace('\r','');						// Longitude or Drop animation style
          Value3 = line[5].replace('\r','');						// Location Address/Place
          Value4 = line[6].replace('\r','');						// Recorded Facts text
          if ( SynOld != SynNew )
          {
            SynOld = SynNew;
            DoAction();												// After synchronisation changes, perform the action
          }
          else
          {
            setTimeout(function(){LoadFile(filename)},SetWait); // Wait for new action file to appear
          }
        }
        else
        {
          var myErr = xmlDoc.parseError;							// Input action file has errors
          ShowStatus('You have error ' + myErr.reason);
        }
      }
      else
      {
        setTimeout(function(){LoadFile(filename)},SetWait);	// Wait for new action file to appear
      } 
    }
    function DoAction()												// Perform each action command
    {
      switch (Action)
      {
      case 'MARK':														// MARK the Geocoded location
        RemoveMarkers()
        if ( isNaN(parseFloat(Value1)) || isNaN(parseFloat(Value2)) )
        {
          BanZoom = 1;
          Map.setZoom(1);												// Lat/Long missing so Zoom out and pan to Home
          Map.panTo(Home);
        }
        else
        {																	// Mark supplied Latitude & Longitude with popup InfoWindow and tooltip Caption
          LatLong[0] = new google.maps.LatLng(Value1,Value2);
          InfoWin[0] = 'Recorded Fact(s) at'
          Caption[0] = Value3;
          SetDelay = 0;
          MakeMarkers();
          DropMarker(0);
          Map.setZoom(SetZoom);										// Zoom in and pan to Marker
          Map.panTo(LatLong[0]);
          BanZoom = 0;
        }
        break;

      case 'NULL':														// NULLify all existing Markers
        RemoveMarkers()
        SetWait = 50;													// Reduce wait between checks for new action file
        break;

      case 'PLOT':														// PLOT details for multiple Markers
        var iEntry = LatLong.length;
        LatLong[iEntry] = new google.maps.LatLng(Value1,Value2);
        Caption[iEntry] = Value3;
        InfoWin[iEntry] = Value4;
        break;

      case 'DROP':														// DROP multple Markers in chosen style
        SetAnimation(Value1);										// Set Marker Animation mode Value1 is 'null' for No Animation, or 'DROP' for Synchro/Cascade
        SetDelay = parseInt(Value2);								// Value2 is ~300 for No Animation/Synchro, or ~2000 for Cascade
        if ( isNaN(SetDelay) ) { SetDelay = 300; }
        BanZoom = 99;
        MakeMarkers();
        PresentMap();
        GetZoomLevel();
        BanZoom = GetZoom;
        SetWait = 250;													// Increase wait between checks for new action file
        break;

      case 'ZOOM':														// ZOOM to chosen map Zoom level
        SetZoomLevel(Value1);
        Map.setZoom(SetZoom);
        MarkZoom = SetZoom;											// Remember 'MARK' RepresentMap() Zoom level
        BanZoom = 0;
        break;
      }
      ShowStatus(' ' + SetZoom);									// Send synchronisation char + map zoom level via HTML page
      LoadFile('{plugin}.act');
    }
    function RepresentMap()											// Represent original zoomed out Map & Marker(s) after Map click
    {
      if ( LatLong.length == 0 )
      {
        BanZoom = 1;													// Lat/Long missing so Zoom out and pan to Home
        Map.setZoom(1);
        Map.panTo(Home);
      }
      else
      if ( SetDelay == 0 )
      { 
        DropMarker(0);													// Display single Marker created by MARK
        Map.setZoom(MarkZoom);
        Map.panTo(LatLong[0]);
        BanZoom = 0;
      }
      else
      {
        BanZoom = 99;													// Display multiple Markers created by DROP
        PresentMap();
        GetZoomLevel()
        BanZoom = GetZoom;
      }
    }
    function RemoveMarkers()											// Remove all Marker and LatLong entries from map
    {
      for ( var iEntry = 0; iEntry < LatLong.length; iEntry++ )
      {
        MapMark[iEntry].setMap(null);
      }
      MapMark.length = 0;
      LatLong.length = 0;
    }
    function GetZoomLevel()											// Get & send map Zoom level change
    {
      GetZoom = Map.getZoom();
      if ( GetZoom>0 && BanZoom<30 && GetZoom!=BanZoom )		// Inhibit values after MARK missing Lat/Lng and DROP sample Markers
      {
        SetZoom = GetZoom;				
        ShowStatus(' ' + SetZoom);									// Send synchronisation char + map zoom level via HTML page
        BanZoom = 0;
      }
    }
    function ShowStatus(message)									// Display synch char + status message hidden below GUI IUP frame
    {
      document.getElementById('status').innerHTML = '<p>' + SynNew + message + '<\/p>';
    }
    </script>
  </head>
  <body scroll=no>
    <div id='canvas' style='width:100%;height:100%;'>
    </div>
    <div id='status' style='width:100%;height:0%;'>
      <p>~</p>
    </div>
  </body>
</html>
]=]

StrMasterCSS = [=[
body	{font-family:Arial,Helvetica,sans-serif;}
li	{font-size:small; padding-bottom:0.25em;}
h1	{font-family:Arial,Helvetica,sans-serif; background-color:rgb(255,255,204); padding-top:0.1em; padding-right:1em; padding-bottom:0.1em; padding-left:1em;}
a	{text-decoration:none;}
#facts	{width:48%; float:left; padding-right:2%;}
#map	{width:50%; height:80%;}
]=]

StrMasterJS = [=[
// Map Life Events shared JavaScript
function MakeArrays()											// Declare map Marker data arrays
{
  MapMark = new Array();										// google.maps.Marker overlays
  LatLong = new Array();										// google.maps.LatLng positions
  InfoWin = new Array();										// google.maps.InfoWindow popups
  Caption = new Array();										// Marker caption title tooltips
  CheckOnline('map');											// Check if PC is online
}
function InitialMap()											// Initialise Google map, Zoom level, and Marker Animation & Delay, then display Map
{
  Map = new google.maps.Map(document.getElementById('map'),{ zoom:7, center:new google.maps.LatLng(0.0,0.0), overviewMapControl:true, scaleControl:true, mapTypeId:google.maps.MapTypeId.ROADMAP });
  google.maps.event.addListener(Map, 'click', function(event) { PresentMap() } );
  SetZoom = 7;													// Current map Zoom level
  SetZoomLevel({setzoom});									// Integer between 0 and 22
  Animation = null;												// Marker animation mode
  SetAnimation('{animate}');									// 'null'=No Animation, or 'DROP'=Synchro/Cascade
  SetPause = 900;												// Pause for 900ms before dropping initial Markers
  SetDelay = parseInt({timeout});							// Marker delay of ~300ms=No Animation/Synchro, or ~2000ms=Cascade
  if ( isNaN(SetDelay) ) { SetDelay = 300; }
  MakeMarkers();
  PresentMap();
  SetPause = 300;												// Pause for 300ms before dropping Markers
}
function DisplayMap(iMode)									// Legacy from earlier versions to support old map files
{
  if ( iMode == 0 )
  {
    InitialMap();
  }
  else
  {
    PresentMap();
  }
}
function MakeMarkers()											// Make the InfoWindow popups, adjust Captions, and create empty Markers
{
  for ( var iEntry = 0; iEntry < LatLong.length; iEntry++ )
  {
    var fLat = fRoundNumber(LatLong[iEntry].lat(),7);
    var fLng = fRoundNumber(LatLong[iEntry].lng(),7);
    InfoWin[iEntry] = new google.maps.InfoWindow({ content:InfoWin[iEntry] + '<br>' + Caption[iEntry] + '<br>Latitude &nbsp;&nbsp; = ' + fLat + '<br>Longitude = ' + fLng });
    Caption[iEntry] = Caption[iEntry].replace(/(&|&#)\w{2,6};/g,''); // Remove HTML character encodings '&abc;' or '&#123;' not supported in Captions
    MapMark[iEntry] = new google.maps.Marker();
  }
}
function PresentMap()											// Plot map Markers and adjust map Bounds
{
  Bounds = new google.maps.LatLngBounds();
  for ( var iEntry = 0; iEntry < LatLong.length; iEntry++ )
  {
    var k = 0.2;
    var latlong = LatLong[iEntry];
    if ( latlong != 0 )										// Set map Markers and Bounds for Latitude & Longitude
    {
      DropMarker(iEntry);
      Bounds.extend(latlong);
      var ne = Bounds.getNorthEast();
      var sw = Bounds.getSouthWest();
      var n = ne.lat() - k;
      var e = ne.lng() - k;									// Enlarge bounds by 'k' in each direction
      var s = sw.lat() + k;
      var w = sw.lng() + k;
      var neNew = new google.maps.LatLng( n, e );
      var swNew = new google.maps.LatLng( s, w );
      Bounds.extend(neNew);
      Bounds.extend(swNew);
    }
  }
  Map.fitBounds(Bounds);
}
function DropMarker(iEntry)									// After delay, drop a map Marker at Latitude & Longitude with a tooltip Caption, and InfoWindow popup on click
{
  MapMark[iEntry].setMap(null);								// Remove old Marker
  setTimeout( function() {
    MapMark[iEntry] = new google.maps.Marker({ map:Map, position:LatLong[iEntry], title:Caption[iEntry], animation:Animation });
    google.maps.event.addListener(MapMark[iEntry], 'click', function() { InfoWin[iEntry].open(Map, MapMark[iEntry]); if ( Map.getZoom() < SetZoom ) { Map.setZoom(SetZoom) }; Map.panTo(LatLong[iEntry]); });
  }, iTimeout(iEntry) );
}
function fRoundNumber(fNumber,iDecPoints)					// Round floating Number to chosen Decimal Points
{
  var iPower = Math.pow(10,iDecPoints);
  var fAns = Math.round(fNumber * iPower) / iPower;
  return fAns;
}
function iTimeout(iEntry)										// Calculate time delay for Marker
{
  var iDelay = SetDelay;										// Immediate/No Animation/Synchro delay is fixed
  if ( SetDelay > 500 )
  {
    if ( iEntry < 10 )
    {
      iDelay = SetDelay * iEntry / 10;						// Cascade delay increased for each Marker
    }
    else
    {
      iDelay = SetDelay * Math.random();					// Cascade delay random when many Markers
    }
  }
  return SetPause + iDelay;
}
function SetAnimation(sMode)									// Set the Marker Animation mode
{
  Animation = null;
  if ( sMode == 'DROP' )										// 'null'=No Animation, or 'DROP'=Synchro/Cascade  
  {
    Animation = google.maps.Animation.DROP;
  }
}
function SetZoomLevel(iZoom)									// Set the map Zoom level
{
  SetZoom = parseInt(iZoom);
  if ( isNaN(SetZoom) ) { SetZoom = 12; }
  if ( SetZoom < 0 ) { SetZoom = 0; }
  if ( SetZoom > 22 ) { SetZoom = 22; }
}
function ZoomToMarker(iEntry)								// Zoom to Marker or show whole map
{
  var latlong = LatLong[iEntry];
  if ( latlong == 0 )
  {
    Map.fitBounds(Bounds);									// Missing Latitude & Longitude so show whole map
  }
  else
  {	
    Map.setZoom(SetZoom);										// Zoom and pan to Marker, and make it bounce for 3 secs
    Map.panTo(latlong);
    MapMark[iEntry].setAnimation(google.maps.Animation.BOUNCE);
    setTimeout( function() { MapMark[iEntry].setAnimation(null) }, 3000 );
  }
}
function CheckOnline(sDivId)									// Create an empty Marker to check if PC online
{
  try
  {
    MapMark[0] = new google.maps.Marker();
  }
  catch(error)
  {
    document.getElementById(sDivId).innerHTML = '<p>Your PC appears to be offline ! ! !<\/p>';
    return "Fail";
  }
}
]=]

StrMasterWeb = [=[
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html>
  <head>
    <title>Map of Locations for {titlename}</title>
    <meta name='viewport' content='initial-scale=1.0,user-scalable=no'>
{fhheaders}
    <link type='text/css' rel='stylesheet' href='http://code.google.com/apis/maps/documentation/javascript/examples/default.css'>
    <link type='text/css' rel='stylesheet' href='mapfacts.css'>
    <script type='text/javascript' src='http://maps.googleapis.com/maps/api/js?sensor=false'> </script>
    <script type='text/javascript' src='mapfacts.js'> </script>
    <script type='text/javascript'>
    function Initialize()
    {
      MakeArrays();
{javalists}
      InitialMap();
    }
    </script>
  </head>
  <body onload = 'Initialize()'>
{fhmenubar}
    <h1>
      <a href='#' onclick='PresentMap()'>Map of Locations for {titlename}</a>
    </h1>
    <div id='facts'>
      <ul>
{factslist}
      </ul>
    </div>
    <div id='map'>
    </div>
  </body>
</html>
]=]

TblRegBias = {						-- Google Geocoder Region Bias Top Level Domain Codes
	"        None",
	"ac Ascension Island",
	"ad Andorra",
	"ae United Arab Emirates",
	"af Afghanistan",
	"ag Antigua & Barbuda",
	"ai Anguilla",
	"al Albania",
	"am Armenia",
	"an Netherlands Antilles",
	"ao Angola",
	"aq Antarctica",
	"ar Argentina",
	"as American Samoa",
	"at Austria",
	"au Australia",
	"aw Aruba",
	"ax Åland",
	"az Azerbaijan",
	"ba Bosnia & Herzegovina",
	"bb Barbados",
	"bd Bangladesh",
	"be Belgium",
	"bf Burkina Faso",
	"bg Bulgaria",
	"bh Bahrain",
	"bi Burundi",
	"bj Benin",
	"bm Bermuda",
	"bn Brunei",
	"bo Bolivia",
	"br Brazil",
	"bs Bahamas",
	"bt Bhutan",
	"bv Bouvet Island",
	"bw Botswana",
	"by Belarus",
	"bz Belize",
	"ca Canada",
	"cc Cocos (Keeling) Islands",
	"cd Democratic Republic of the Congo",
	"cf Central African Republic",
	"cg Republic of the Congo",
	"ch Switzerland",
	"ci Côte d'Ivoire",
	"ck Cook Islands",
	"cl Chile",
	"cm Cameroon",
	"cn People's Republic of China",
	"co Colombia",
	"cr Costa Rica",
	"cs Czechoslovakia",
	"cu Cuba",
	"cv Cape Verde",
	"cx Christmas Island",
	"cy Cyprus",
	"cz Czech Republic",
	"dd East Germany",
	"de Germany",
	"dj Djibouti",
	"dk Denmark",
	"dm Dominica",
	"do Dominican Republic",
	"dz Algeria",
	"ec Ecuador",
	"ee Estonia",
	"eg Egypt",
	"eh Western Sahara",
	"er Eritrea",
	"es Spain",
	"et Ethiopia",
	"eu European Union",
	"fi Finland",
	"fj Fiji",
	"fk Falkland Islands",
	"fm Federated States of Micronesia",
	"fo Faroe Islands",
	"fr France",
	"ga Gabon",
	"gb Great Britain",
	"gd Grenada",
	"ge Georgia",
	"gf French Guiana",
	"gg Guernsey",
	"gh Ghana",
	"gi Gibraltar",
	"gl Greenland",
	"gm The Gambia",
	"gn Guinea",
	"gp Guadeloupe",
	"gq Equatorial Guinea",
	"gr Greece",
	"gs South Georgia & South Sandwich Islands",
	"gt Guatemala",
	"gu Guam",
	"gw Guinea-Bissau",
	"gy Guyana",
	"hk Hong Kong",
	"hm Heard Island & McDonald Islands",
	"hn Honduras",
	"hr Croatia",
	"ht Haiti",
	"hu Hungary",
	"id Indonesia",
	"ie Republic of Ireland & Northern Ireland",
	"il Israel",
	"im Isle of Man",
	"in India",
	"io British Indian Ocean Territory",
	"iq Iraq",
	"ir Iran",
	"is Iceland",
	"it Italy",
	"je Jersey",
	"jm Jamaica",
	"jo Jordan",
	"jp Japan",
	"ke Kenya",
	"kg Kyrgyzstan",
	"kh Cambodia",
	"ki Kiribati",
	"km Comoros",
	"kn Saint Kitts and Nevis",
	"kp Democratic People's Republic of Korea",
	"kr Republic of Korea",
	"kw Kuwait",
	"ky Cayman Islands",
	"kz Kazakhstan",
	"la Laos",
	"lb Lebanon",
	"lc Saint Lucia",
	"li Liechtenstein",
	"lk Sri Lanka",
	"lr Liberia",
	"ls Lesotho",
	"lt Lithuania",
	"lu Luxembourg",
	"lv Latvia",
	"ly Libya",
	"ma Morocco",
	"mc Monaco",
	"md Moldova",
	"me Montenegro",
	"mg Madagascar",
	"mh Marshall Islands",
	"mk Republic of Macedonia",
	"ml Mali",
	"mm Myanmar",
	"mn Mongolia",
	"mo Macau",
	"mp Northern Mariana Islands",
	"mq Martinique",
	"mr Mauritania",
	"ms Montserrat",
	"mt Malta",
	"mu Mauritius",
	"mv Maldives",
	"mw Malawi",
	"mx Mexico",
	"my Malaysia",
	"mz Mozambique",
	"na Namibia",
	"nc New Caledonia",
	"ne Niger",
	"nf Norfolk Island",
	"ng Nigeria",
	"ni Nicaragua",
	"nl Netherlands",
	"no Norway",
	"np Nepal",
	"nr Nauru",
	"nu Niue",
	"nz New Zealand",
	"om Oman",
	"pa Panama",
	"pe Peru",
	"pf French Polynesia",
	"pg Papua New Guinea",
	"ph Philippines",
	"pk Pakistan",
	"pl Poland",
	"pm Saint-Pierre & Miquelon",
	"pn Pitcairn Islands",
	"pr Puerto Rico",
	"ps Palestinian Territories",
	"pt Portugal",
	"pw Palau",
	"py Paraguay",
	"qa Qatar",
	"re Réunion",
	"ro Romania",
	"rs Serbia",
	"ru Russia",
	"rw Rwanda",
	"sa Saudi Arabia",
	"sb Solomon Islands",
	"sc Seychelles",
	"sd Sudan",
	"se Sweden",
	"sg Singapore",
	"sh Saint Helena",
	"si Slovenia",
	"sj Svalbard & Jan Mayen Islands",
	"sk Slovakia",
	"sl Sierra Leone",
	"sm San Marino",
	"sn Senegal",
	"so Somalia",
	"sr Suriname",
	"ss South Sudan",
	"st São Tomé & Príncipe",
	"su Soviet Union",
	"sv El Salvador",
	"sy Syria",
	"sz Swaziland",
	"tc Turks & Caicos Islands",
	"td Chad",
	"tf French Southern & Antarctic Lands",
	"tg Togo",
	"th Thailand",
	"tj Tajikistan",
	"tk Tokelau",
	"tl East Timor",
	"tm Turkmenistan",
	"tn Tunisia",
	"to Tonga",
	"tp East Timor",
	"tr Turkey",
	"tt Trinidad & Tobago",
	"tv Tuvalu",
	"tw Republic of China (Taiwan)",
	"tz Tanzania",
	"ua Ukraine",
	"ug Uganda",
	"uk United Kingdom",
	"us United States of America",
	"uy Uruguay",
	"uz Uzbekistan",
	"va Vatican City",
	"vc Saint Vincent & Grenadines",
	"ve Venezuela",
	"vg British Virgin Islands",
	"vi United States Virgin Islands",
	"vn Vietnam",
	"vu Vanuatu",
	"wf Wallis & Futuna",
	"ws Samoa",
	"ye Yemen",
	"yt Mayotte",
	"yu Yugoslavia",
	"za South Africa",
	"zm Zambia",
	"zw Zimbabwe",
}

TblLocCode = {						-- Google Geocoder Location Code Translations	(For conflicts, see later resolution tables)

	ABW="Aruba",						-- Country Codes from	http://en.wikipedia.org/wiki/ISO_3166-1_alpha-3	(ISO 3166-1 alpha-3 codes)
	AFG="Afghanistan",
	AGO="Angola",
	AIA="Anguilla",
	ALA="Åland Islands",
	ALB="Albania",
	AND="Andorra",
	ARE="United Arab Emirates",
	ARG="Argentina",
	ARM="Armenia",					-- Conflict with ARM="Armagh" Chapman Code
	ASC="Ascension Island",		-- Exceptional Reservation
	ASM="American Samoa",
	ATA="Antarctica",
	ATF="French Southern Territories",
	ATG="Antigua and Barbuda",
	AUS="Australia",
	AUT="Austria",
	AZE="Azerbaijan",
	BDI="Burundi",
	BEL="Belgium",
	BEN="Benin",
	BES="Bonaire, Sint Eustatius and Saba",
	BFA="Burkina Faso",
	BGD="Bangladesh",
	BGR="Bulgaria",
	BHR="Bahrain",
	BHS="Bahamas",
	BIH="Bosnia and Herzegovina",
	BLM="Saint Barthélemy",
	BLR="Belarus",
	BLZ="Belize",
	BMU="Bermuda",
	BOL="Bolivia",					-- Plurinational State of
	BRA="Brazil",
	BRB="Barbados",
	BRN="Brunei Darussalam",
	BTN="Bhutan",
	BVT="Bouvet Island",
	BWA="Botswana",
	CAF="Central African Republic",
	CAN="Canada",
	CCK="Cocos (Keeling) Islands",
	CHE="Switzerland",
	CHL="Chile",
	CHN="China",
	CIV="Côte d'Ivoire",
	CMR="Cameroon",
	COD="Democratic Republic of the Congo",
	COG="Congo",
	COK="Cook Islands",
	COL="Colombia",
	COM="Comoros",
	CPT="Clipperton Island",		-- Exceptional Reservation
	CPV="Cape Verde",
	CRI="Costa Rica",
	CUB="Cuba",
	CUW="Curaçao",
	CXR="Christmas Island",
	CYM="Cayman Islands",
	CYP="Cyprus",
	CZE="Czech Republic",
	DEU="Germany",
	DGA="Diego Garcia",				-- Exceptional Reservation
	DJI="Djibouti",
	DMA="Dominica",
	DNK="Denmark",
	DOM="Dominican Republic",
	DZA="Algeria",
	ECU="Ecuador",
	EGY="Egypt",
	ERI="Eritrea",
	ESH="Western Sahara",
	ESP="Spain",
	EST="Estonia",
	ETH="Ethiopia",
	FIN="Finland",
	FJI="Fiji",
	FLK="Falkland Islands (Malvinas)",
	FRA="France",
	FRO="Faroe Islands",
	FSM="Micronesia",				-- Federated States of
	FXX="France",					-- Metropolitan			-- Exceptional Reservation
	GAB="Gabon",
	GBR="United Kingdom",
	GEO="Georgia (country)",
	GGY="Guernsey",
	GHA="Ghana",
	GIB="Gibraltar",
	GIN="Guinea",
	GLP="Guadeloupe",
	GMB="Gambia",
	GNB="Guinea-Bissau",
	GNQ="Equatorial Guinea",
	GRC="Greece",
	GRD="Grenada",
	GRL="Greenland",
	GTM="Guatemala",
	GUF="French Guiana",
	GUM="Guam",
	GUY="Guyana",
	HKG="Hong Kong",
	HMD="Heard Island and McDonald Islands",
	HND="Honduras",
	HRV="Croatia",
	HTI="Haiti",
	HUN="Hungary",					-- Conflict with HUN="Huntingdonshire" Chapman Code
	IDN="Indonesia",
	IMN="Isle of Man",
	IND="India",
	IOT="British Indian Ocean Territory",
	IRL="Ireland",					-- Equals Chapman Country Code
	IRN="Iran",						-- Islamic Republic of
	IRQ="Iraq",
	ISL="Iceland",
	ISR="Israel",
	ITA="Italy",
	JAM="Jamaica",
	JEY="Jersey",
	JOR="Jordan",
	JPN="Japan",
	KAZ="Kazakhstan",
	KEN="Kenya",						-- Conflict with KEN="Kent" Chapman Code
	KGZ="Kyrgyzstan",
	KHM="Cambodia",
	KIR="Kiribati",
	KNA="Saint Kitts and Nevis",
	KOR="South Korea",				-- Republic of Korea
	KWT="Kuwait",
	LAO="Laos",						-- Lao People's Democratic Republic
	LBN="Lebanon",
	LBR="Liberia",
	LBY="Libya",
	LCA="Saint Lucia",
	LIE="Liechtenstein",
	LKA="Sri Lanka",
	LSO="Lesotho",
	LTU="Lithuania",
	LUX="Luxembourg",
	LVA="Latvia",
	MAC="Macao",
	MAF="Saint Martin",				-- (French part)
	MAR="Morocco",
	MCO="Monaco",
	MDA="Moldova",					-- Republic of
	MDG="Madagascar",
	MDV="Maldives",
	MEX="Mexico",
	MHL="Marshall Islands",
	MKD="Macedonia",				-- the former Yugoslav Republic of
	MLI="Mali",
	MLT="Malta",
	MMR="Myanmar",
	MNE="Montenegro",
	MNG="Mongolia",
	MNP="Northern Mariana Islands",
	MOZ="Mozambique",
	MRT="Mauritania",
	MSR="Montserrat",
	MTQ="Martinique",
	MUS="Mauritius",
	MWI="Malawi",
	MYS="Malaysia",
	MYT="Mayotte",
	NAM="Namibia",
	NCL="New Caledonia",
	NER="Niger",
	NFK="Norfolk Island",			-- Conflict with NFK="Norfolk" Chapman Code 
	NGA="Nigeria",
	NIC="Nicaragua",
	NIU="Niue",
	NLD="Netherlands",
	NOR="Norway",
	NPL="Nepal",
	NRU="Nauru",
	NZL="New Zealand",
	OMN="Oman",
	PAK="Pakistan",
	PAN="Panama",
	PCN="Pitcairn",
	PER="Peru",						-- Conflict with PER="Perthshire" Chapman Code
	PHL="Philippines",
	PLW="Palau",
	PNG="Papua New Guinea",
	POL="Poland",
	PRI="Puerto Rico",
	PRK="North Korea",				-- Democratic People's Republic of Korea
	PRT="Portugal",
	PRY="Paraguay",
	PSE="Palestine",				-- "Palestinian Territory, Occupied"
	PYF="French Polynesia",
	QAT="Qatar",
	REU="Réunion",
	ROU="Romania",
	RUS="Russian Federation",
	RWA="Rwanda",
	SAU="Saudi Arabia",
	SDN="Sudan",
	SEN="Senegal",
	SGP="Singapore",
	SGS="South Georgia and the South Sandwich Islands",
	SHN="Ascension, Saint Helena",-- "Saint Helena, Ascension and Tristan da Cunha"	see TAA
	SJM="Svalbard and Jan Mayen",
	SLB="Solomon Islands",
	SLE="Sierra Leone",
	SLV="El Salvador",
	SMR="San Marino",
	SOM="Somalia",					-- Conflict with SOM="Somerset" Chapman Code
	SPM="Saint Pierre and Miquelon",
	SRB="Serbia",
	SSD="South Sudan",
	STP="Sao Tome and Principe",
	SUN="USSR Russia",				-- Exceptional Reservation
	SUR="Suriname",
	SVK="Slovakia",
	SVN="Slovenia",
	SWE="Sweden",
	SWZ="Swaziland",
	SXM="Sint Maarten",				-- (Dutch part)
	SYC="Seychelles",
	SYR="Syrian Arab Republic",
	TAA="Tristan da Cunha",		-- Exceptional Reservation		see SHN
	TCA="Turks and Caicos Islands",
	TCD="Chad",
	TGO="Togo",
	THA="Thailand",
	TJK="Tajikistan",
	TKL="Tokelau",
	TKM="Turkmenistan",
	TLS="Timor-Leste",
	TON="Tonga",
	TTO="Trinidad and Tobago",
	TUN="Tunisia",
	TUR="Turkey",
	TUV="Tuvalu",
	TWN="Taiwan",					-- Province of China
	TZA="Tanzania",					-- United Republic of
	UGA="Uganda",
	UKR="Ukraine",
	UMI="United States Minor Outlying Islands",
	URY="Uruguay",
	USA="United States",
	UZB="Uzbekistan",
	VAT="Vatican City",				-- "Holy See (Vatican City State)"
	VCT="Saint Vincent and the Grenadines",
	VEN="Venezuela",				-- Bolivarian Republic of
	VGB="British Virgin Islands",
	VIR="U.S. Virgin Islands",
	VNM="Viet Nam",
	VUT="Vanuatu",
	WLF="Wallis and Futuna",
	WSM="Samoa",
	YEM="Yemen",
	ZAF="South Africa",
	ZMB="Zambia",
	ZWE="Zimbabwe",

										-- Australian State Abbreviations from 	http://en.wikipedia.org/wiki/States_and_territories_of_Australia	(Postal codes)
	ACT="Australian Capital Territory",
	JBT="Jervis Bay Territory",
	NSW="New South Wales",
	NT="Northern Territory",		-- Conflict with NT="Northwest Territories" Canadian Province
	QLD="Queensland",
	Qld="Queensland",
	SA="South Australia",
	TAS="Tasmania",
	Tas="Tasmania",
	VIC="Victoria, Australia",	-- Otherwise "Victoria, British Columbia" in Canada is chosen
	Vic="Victoria, Australia",
	WA="Western Australia",		-- Conflict with WA="Washington State" US Postal Service State Abbreviation

										-- United States Postal Service State Abbreviations from	http://en.wikipedia.org/wiki/List_of_U.S._state_abbreviations
	AL="Alabama",
	AK="Alaska",
	AZ="Arizona",
	AR="Arkansas",
	CA="California",
	CO="Colorado",
	CT="Connecticut",
	DE="Delaware",
	DC="District of Columbia",
	FL="Florida",
	GA="Georgia",
	HI="Hawaii",
	ID="Idaho",
	IL="Illinois",
	IN="Indiana",
	IA="Iowa",
	KS="Kansas",
	KY="Kentucky",
	LA="Louisiana",
	ME="Maine",
	MD="Maryland",
	MA="Massachusetts",
	MI="Michigan",
	MN="Minnesota",
	MS="Mississippi",
	MO="Missouri",
	MT="Montana",
	NE="Nebraska",
	NV="Nevada",
	NH="New Hampshire",
	NJ="New Jersey",
	NM="New Mexico",
	NY="New York State",
	NC="North Carolina",
	ND="North Dakota",
	OH="Ohio",
	OK="Oklahoma",
	OR="Oregon",
	PA="Pennsylvania",
	RI="Rhode Island",
	SC="South Carolina",
	SD="South Dakota",
	TN="Tennessee",
	TX="Texas",
	UT="Utah",
	VT="Vermont",
	VA="Virginia",
	WA="Washington State",			-- Conflict with WA="Western Australia" Australian State Abbreviation
	WV="West Virginia",
	WI="Wisconsin",
	WY="Wyoming",
	AS="American Samoa",									-- Insular Areas:
	GU="Guam",
	MP="Northern Mariana Islands",
	PR="Puerto Rico",
	VI="Virgin Islands",
	UM="United States Minor Outlying Islands",
	FM="Federated States of Micronesia",				-- Freely Associated States:
	MH="Marshall Islands",
	PW="Palau",
--!	AA="Armed Forces - Americas (except Canada)",	-- US Military Mail:
--!	AE="Armed Forces - Europe, Canada, Middle East, Africa",
--!	AP="Armed Forces - Pacific",
	CZ="Panama Canal",				-- "Canal Zone"		-- Obsolete Codes:
	PI="Philippines Islands",
	TT="Pacific Islands",			-- Trust Territory of the 
	CM="Commonwealth of the Northern Mariana Islands",

										-- Talk:List of U.S. State Abbreviations	http://en.wikipedia.org/wiki/Talk:List_of_U.S._state_abbreviations
	Ia="Indiana",
	Wn="Washington State",

										-- Canadian Province Abbreviations from	http://canadaonline.about.com/od/postalservices/a/abbreviations-provinces-canada.htm?rd=1
	AB="Alberta",
	BC="British Columbia",
	MB="Manitoba",
	NB="New Brunswick, Canada",
	NL="Newfoundland and Labrador",
	NT="Northwest Territories",	-- Conflict with NT="Northern Territory" Australian State
	NS="Nova Scotia",
	NU="Nunavut",
	ON="Ontario",
	PE="Prince Edward Island",
	QC="Quebec",
	SK="Saskatchewan",
	YT="Yukon",

										-- Chapman Codes from	http://en.wikipedia.org/wiki/Chapman_code			(superset of ISO 3166-2:GB & BS 6879)
	CHI="Channel Islands",			-- Country Codes
	ENG="England",
	IOM="Isle of Man",
	IRL="Ireland",					-- Equals Country Code ISO_3166
	SCT="Scotland",
	WLS="Wales",
	ALL="",							-- All countries

	ALD="Alderney",					-- Channel Islands
	GSY="Guernsey",
	JSY="Jersey",
	SRK="Sark",

	BDF="Bedfordshire, UK",		--  England Ancient Counties
	BRK="Berkshire, UK",
	BKM="Buckinghamshire, UK",
	CAM="Cambridgeshire, UK",
	CHS="Cheshire County, UK",
	CON="Cornwall, UK",
	CUL="Cumbria, UK",				-- "Cumberland" not recognised by Geocoder
	DBY="Derbyshire, UK",
	DEV="Devonshire, UK",
	DOR="Dorset, UK",
	DUR="County Durham, UK",
	ESS="Essex, UK",
	GLS="Gloucestershire, UK",
	HAM="Hampshire, UK",
	HEF="Herefordshire, UK",
	HRT="Hertfordshire, UK",
	HUN="Huntingdonshire",			-- Conflict with HUN="Hungary" Country Code		(was "Huntingdonshire")
	IOW="Isle of Wight, UK",
	KEN="Kent, UK",					-- Conflict with KEN="Kenya" Country Code
	LAN="Lancashire, UK",
	LEI="Leicestershire, UK",
	LIN="Lincolnshire, UK",
	LND="London, UK",				-- (City only)
	MDX="London, UK",				-- "Middlesex" not recognised by Geocoder
	NFK="Norfolk, UK",				-- Conflict with NFK="Norfolk Island" Country Code 
	NTH="Northamptonshire, UK",
	NBL="Northumberland, UK",
	NTT="Nottinghamshire, UK",
	OXF="Oxfordshire, UK",
	RUT="Rutland, UK",
	SAL="Shropshire, UK",
	SOM="Somerset, UK",				-- Conflict with SOM="Somalia" Country Code
	STS="Staffordshire, UK",
	SFK="Suffolk, UK",
	SRY="Surrey, UK",
	SSX="Sussex, UK",
	WAR="Warwickshire, UK",
	WES="Cumbria, UK",				-- "Westmorland" not recognised by Geocoder
	WIL="Wiltshire, UK",
	WOR="Worcestershire, UK",
	YKS="Yorkshire, England",
	ERY="Yorkshire, England",		-- East Riding
	NRY="Yorkshire, England",		-- North Riding
	WRY="Yorkshire, England",		-- West Riding

	ABD="Aberdeenshire, UK",		-- Scotland Ancient Counties
	ANS="Angus, UK",				-- (formerly Forfarshire)
	ARL="Argyll County, UK",		-- "Argyllshire" not recognised by Geocoder
	AYR="Ayrshire, UK",
	BAN="Moray, UK",				-- "Banffshire" not recognised by Geocoder
	BEW="Berwickshire, UK",
	BUT="Bute, UK",					-- (Buteshire)
	CAI="Caithness, UK",
	CLK="Clackmannanshire, UK",
	DFS="Dumfriesshire, UK",
	DNB="Dunbartonshire, UK",
	ELN="East Lothian, UK",		-- (formerly Haddingtonshire)
	FIF="Fife, UK",
	INV="Inverness,Highland,UK",	-- "Inverness-shire" not recognised by Geocoder with Fort Augustus
	KCD="Aberdeenshire, UK",		-- "Kincardineshire" not recognised by Geocoder
	KRS="Kinrossshire, UK",
	KKD="Kirkcudbright, UK",		-- "Kirkcudbrightshire"
	LKS="Lanarkshire, UK",
	MLN="Midlothian, UK",			-- (formerly Edinburghshire)
	MOR="Moray, UK",				-- (formerly Elginshire)
	NAI="Nairnshire, UK",
	OKI="Orkney Isles, UK",
	PEE="Peebles, UK",
	PER="Perthshire, UK",			-- Conflict with PER="Peru" Country Code
	RFW="Renfrewshire, UK",
	ROC="Ross, Highland, UK",		-- "Ross and Cromarty" not recognised by Geocoder
	ROX="Scottish Borders, UK",	-- "Roxburghshire" 
	SEL="Selkirkshire, UK",
	SHI="Shetland Isles, UK",
	STI="Stirlingshire, UK",
	SUT="Highland, UK",				-- "Sutherland" not recognised by Geocoder
	WLN="West Lothian, UK",		-- (formerly Linlithgowshire)
	WIG="Galloway, Scotland,UK",	-- "Wigtownshire" not recognised by Geocoder

	BOR="Borders, Scotland, UK",	-- Scotland 1975-1996 Regions
	CEN="Central Region, Scotland, UK",
	DGY="Dumfries and Galloway, UK",
	FIF="Fife, UK",					-- Duplicates Ancient County
	GMP="Aberdeenshire, UK",		-- "Grampian" not recognised by Geocoder
	HLD="Highland, UK",
	LTN="Lothian, UK",
	OKI="Orkney Isles, UK",		-- Duplicates Ancient County
	SHI="Shetland Isles, UK",		-- Duplicates Ancient County
	STD="Scotland, UK",				-- "Strathclyde" not recognised by Geocoder
	TAY="Perthshire, UK",			-- "Tayside" not recognised by Geocoder
	WIS="Outer Hebrides, UK",		-- "Western Isles" not recognised by Geocoder

	AGY="Anglesey, UK",				-- Wales Ancient Counties
	BRE="Breconshire, UK",			-- "Brecknock" & "Brecknockshire" not recognised by Geocoder
	CAE="Caernarvon, Wales, UK",	-- "Caernarfonshire" not recognised by Geocoder
	CGN="Cardiganshire, UK",
	CMN="Carmarthenshire, UK",
	DEN="Denbighshire, UK",
	FLN="Flintshire, UK",
	GLA="Glamorgan, UK",
	MER="Merionethshire, UK",
	MON="Monmouthshire, UK",
	MGY="Montgomeryshire, UK",
	PEM="Pembrokeshire, UK",
	RAD="Radnorshire, UK",

	CWD="Clwyd, Wales, UK",		-- Wales 1974-1996
	DFD="Dyfed, Wales, UK",
	GNT="Gwent, Wales, UK",
	GWN="Gwynedd, Wales, UK",
	MGM="Mid Glamorgan, Wales, UK",
	POW="Powys, Wales, UK",
	SGM="South Glamorgan, Wales, UK",
	WGM="Glamorgan, Wales, UK",	-- "West Glamorgan" not recognised by Geocoder

	ANT="Antrim County, UK",		-- Ireland
	ARM="Armagh County, UK",		-- Conflict with ARM="Armenia" Country Code
	CAR="Carlow County, Ireland",
	CAV="Cavan County, Ireland",
	CLA="Clare County, Ireland",
	COR="Cork County, Ireland",
	DON="Donegal County, Ireland",
	DOW="Down County, UK",
	DUB="Dublin County, Ireland",
	FER="Fermanagh County, UK",
	GAL="Galway County, Ireland",
	KER="Kerry County, Ireland",
	KID="Kildare County, Ireland",
	KIK="Kilkenny County, Ireland",
	LET="Leitrim County, Ireland",
	LEX="Laois County, Ireland",	-- "Leix" (formerly Queen's)
	LIM="Limerick County, Ireland",
	LDY="Londonderry County, UK",
	LOG="Longford County, Ireland",
	LOU="Louth County, Ireland",
	MAY="Mayo County, Ireland",
	MEA="Meath County, Ireland",
	MOG="Monaghan County, Ireland",
	OFF="Offaly County, Ireland",-- (formerly King's)
	ROS="Roscommon County, Ireland",
	SLI="Sligo County, Ireland",
	TIP="Tipperary County, Ireland",
	TYR="Tyrone County, UK",
	WAT="Waterford County, Ireland",
	WEM="Westmeath County, Ireland",
	WEX="Wexford County, Ireland",
	WIC="Wicklow County, Ireland",

										-- UK Postal County Abbreviations subset from	http://en.wikipedia.org/wiki/Postal_counties_of_the_United_Kingdom#Postal_counties_in_operation_from_1974_to_1996
	Beds="Bedfordshire, UK",		-- England
	Berks="Berkshire, UK",
	Bucks="Buckinghamshire, UK",
	Cambs="Cambridgeshire, UK",
	Glos="Gloucestershire, UK",
	Hants="Hampshire, UK",
	Herts="Hertfordshire, UK",
	Humbs="Humberside, UK",		-- N Humbs & S Humbs
	Lancs="Lancashire, UK",
	Leics="Leicestershire, UK",
	Lincs="Lincolnshire, UK",
	Middx="London, UK",
	Northants="Northamptonshire, UK",
	Northd="Northumberland, UK",
	Notts="Nottinghamshire, UK",
	Oxon="Oxfordshire, UK",
	Salop="Shropshire, UK",
	Staffs="Staffordshire, UK",
	Warks="Warwickshire, UK",
	Wilts="Wiltshire, UK",
	Worcs="Worcestershire, UK",
	Yorks="Yorkshire, England",	-- N Yorks & S Yorks & W Yorks
	Glam="Glamorgan, Wales, UK",	-- M Glam & S Glam & W Glam

										-- Conflict Resolution Codes for Country v Chapman
										-- Chapman Code takes precedence if not last in entry, or Region Bias Code = uk United Kingdom
	ARM="~Armenia~Armagh County, UK~",
	HUN="~Hungary~Huntingdonshire District, UK~",
	KEN="~Kenya~Kent, UK~",
	NFK="~Norfolk Island~Norfolk, UK~",
	PER="~Peru~Perthshire, UK~",
	SOM="~Somalia~Somerset, UK~",
										-- Conflict Resolution Codes for Australian States v Canadian/USA States
										-- Australian State takes precedence if Australia is in entry, or Region Bias Code = au Australia
	NT="#Northern Territory#Northwest Territories#",
	WA="#Western Australia#Washington State#",
}

TblGeoCode = {						-- Google Geocoder special translations to improve plotting
										-- UK County Substitutions that tend to work better with Google Geocoder
	{ "^Ecclesall Bierlow"		,	"Ecclesall"	},
	{ "^East%s.*Yorkshire"		,	"Yorkshire, England"	},
	{ "^North%s.*Yorkshire"	,	"Yorkshire, England"	},
	{ "^South%s.*Yorkshire"	,	"Yorkshire, England"	},
	{ "^West%s.*Yorkshire"		,	"Yorkshire, England"	},
	{ "^Yorkshire.*East%s.*"	,	"Yorkshire, England"	},
	{ "^Yorkshire.*North%s.*"	,	"Yorkshire, England"	},
	{ "^Yorkshire.*South%s.*"	,	"Yorkshire, England"	},
	{ "^Yorkshire.*West%s.*"	,	"Yorkshire, England"	},
}

------------------------------------------------------ Start Table Load Save
-- require "_tableloadsave"
--[[
   Save Table to File/Stringtable
   Load Table from File/Stringtable
   v 0.94
   
   Lua 5.1 compatible
   
   Userdata and indices of these are not saved
   Functions are saved via string.dump, so make sure it has no upvalues
   References are saved
   ----------------------------------------------------
   table.save( table [, filename] )
   
   Saves a table so it can be called via the table.load function again
   table must a object of type 'table'
   filename is optional, and may be a string representing a filename or true/1
   
   table.save( table )
      on success: returns a string representing the table (stringtable)
      (uses a string as buffer, ideal for smaller tables)
   table.save( table, true or 1 )
      on success: returns a string representing the table (stringtable)
      (uses io.tmpfile() as buffer, ideal for bigger tables)
   table.save( table, "filename" )
      on success: returns 1
      (saves the table to file "filename")
   on failure: returns as second argument an error msg
   ----------------------------------------------------
   table.load( filename or stringtable )
   
   Loads a table that has been saved via the table.save function
   
   on success: returns a previously saved table
   on failure: returns as second argument an error msg
   ----------------------------------------------------
   
   chillcode, http://lua-users.org/wiki/SaveTableToFile
   Licensed under the same terms as Lua itself.
]]--
do
   -- declare local variables
   --// exportstring( string )
   --// returns a "Lua" portable version of the string
   local function exportstring( s )
      s = string.format( "%q",s )
      -- to replace
      s = string.gsub( s,"\\\n","\\n" )
      s = string.gsub( s,"\r","\\r" )
      s = string.gsub( s,string.char(26),"\"..string.char(26)..\"" )
      return s
   end
--// The Save Function
function table.save(  tbl,filename )
   local charS,charE = "   ","\n"
   local file,err
   -- create a pseudo file that writes to a string and return the string
   if not filename then
      file =  { write = function( self,newstr ) self.str = self.str..newstr end, str = "" }
      charS,charE = "",""
   -- write table to tmpfile
   elseif filename == true or filename == 1 then
      charS,charE,file = "","",io.tmpfile()
   -- write table to file
   -- use io.open here rather than io.output, since in windows when clicking on a file opened with io.output will create an error
   else
      file,err = io.open( filename, "w" )
      if err then return _,err end
   end
   -- initiate variables for save procedure
   local tables,lookup = { tbl },{ [tbl] = 1 }
   file:write( "return {"..charE )
   for idx,t in ipairs( tables ) do
      if filename and filename ~= true and filename ~= 1 then
         file:write( "-- Table: {"..idx.."}"..charE )
      end
      file:write( "{"..charE )
      local thandled = {}
      for i,v in ipairs( t ) do
         thandled[i] = true
         -- escape functions and userdata
         if type( v ) ~= "userdata" then
            -- only handle value
            if type( v ) == "table" then
               if not lookup[v] then
                  table.insert( tables, v )
                  lookup[v] = #tables
               end
               file:write( charS.."{"..lookup[v].."},"..charE )
            elseif type( v ) == "function" then
               file:write( charS.."loadstring("..exportstring(string.dump( v )).."),"..charE )
            else
               local value =  ( type( v ) == "string" and exportstring( v ) ) or tostring( v )
               file:write(  charS..value..","..charE )
            end
         end
      end
      for i,v in pairs( t ) do
         -- escape functions and userdata
         if (not thandled[i]) and type( v ) ~= "userdata" then
            -- handle index
            if type( i ) == "table" then
               if not lookup[i] then
                  table.insert( tables,i )
                  lookup[i] = #tables
               end
               file:write( charS.."[{"..lookup[i].."}]=" )
            else
               local index = ( type( i ) == "string" and "["..exportstring( i ).."]" ) or string.format( "[%d]",i )
               file:write( charS..index.."=" )
            end
            -- handle value
            if type( v ) == "table" then
               if not lookup[v] then
                  table.insert( tables,v )
                  lookup[v] = #tables
               end
               file:write( "{"..lookup[v].."},"..charE )
            elseif type( v ) == "function" then
               file:write( "loadstring("..exportstring(string.dump( v )).."),"..charE )
            else
               local value =  ( type( v ) == "string" and exportstring( v ) ) or tostring( v )
               file:write( value..","..charE )
            end
         end
      end
      file:write( "},"..charE )
   end
   file:write( "}" )
   -- Return Values
   -- return stringtable from string
   if not filename then
      -- set marker for stringtable
      return file.str.."--|"
   -- return stringttable from file
   elseif filename == true or filename == 1 then
      file:seek ( "set" )
      -- no need to close file, it gets closed and removed automatically
      -- set marker for stringtable
      return file:read( "*a" ).."--|"
   -- close file and return 1
   else
      file:close()
      return 1
   end
end

--// The Load Function
function table.load( sfile )
   -- catch marker for stringtable
   if string.sub( sfile,-3,-1 ) == "--|" then
      tables,err = loadstring( sfile )
   else
      tables,err = loadfile( sfile )
   end
   if err then return _,err
   end
   tables = tables()
   for idx = 1,#tables do
      local tolinkv,tolinki = {},{}
      for i,v in pairs( tables[idx] ) do
         if type( v ) == "table" and tables[v[1]] then
            table.insert( tolinkv,{ i,tables[v[1]] } )
         end
         if type( i ) == "table" and tables[i[1]] then
            table.insert( tolinki,{ i,tables[i[1]] } )
         end
      end
      -- link values, first due to possible changes of indices
      for _,v in ipairs( tolinkv ) do
         tables[idx][v[1]] = v[2]
      end
      -- link indices
      for _,v in ipairs( tolinki ) do
         tables[idx][v[2]],tables[idx][v[1]] =  tables[idx][v[1]],nil
      end
   end
   return tables[1]
end
-- close do
end
------------------------------------------------------ End Table Load Save

-- Global Functions --

-- Split a string using separator --
function string:split(sep)
	local sep = sep or ":"
	local fields = {}
	local pattern = string.format("([^%s]+)", sep)
	self:gsub(pattern, function(c) fields[#fields+1] = c end)
	return fields
end -- function string:split

-- Split a string into numbers using separators space or comma or x --
function string:SplitNumbers()
	local tblNum = {}
	self:gsub("([^%s,x]+)", function(c) tblNum[#tblNum+1] = c end)
	for i=1, #tblNum do
		tblNum[i] = tonumber(tblNum[i])
	end
	return tblNum
end -- function string:SplitNumbers

-- Check if file exists --
function FlgFileExists(strFileName)
	if lfs.attributes(strFileName,"mode") == "file" then
		return true
	else
		return false
	end
end -- function FlgFileExists

-- Check if folder exists --
function FlgFolderExists(strFolderName)
	if lfs.attributes(strFolderName,"mode") == "directory" then
		return true
	else
		return false
	end
end -- function FlgFolderExists

-- Open File and return Handle --
function OpenFile(strFileName,strMode)
	local fileHandle, strError = io.open(strFileName,strMode)
	if fileHandle == nil then
		error("\n Unable to open file: "..strFileName.." \n "..strError.." \n")
	end
	return fileHandle
end -- function OpenFile

-- Save string to file --
function SaveStringToFile(strString,strFileName)
	local fileHandle = OpenFile(strFileName,"w")
	fileHandle:write(strString)
	fileHandle:close()
end -- function SaveStringToFile

-- Load string from file --
function StrLoadFromFile(strFileName)
	local fileHandle = OpenFile(strFileName,"r")
	local strString = fileHandle:read("*all")
	fileHandle:close()
	return strString
end -- function StrLoadFromFile

-- Return a Directory Tree entry & attributes on each iteration --
function DirTree(strDir)
	assert(strDir and strDir ~= "", "directory parameter is missing or empty")
	if string.sub(strDir, -1) == "/" then
		strDir = string.sub(strDir, 1, -2)		-- Remove trailing "/"
	end
    
	local function doYieldTree(strDir)
		for strEntry in lfs.dir(strDir) do
			if strEntry ~= "." and strEntry ~= ".." then
				strEntry = strDir.."\\"..strEntry
				local tblAttr = lfs.attributes(strEntry)
				coroutine.yield(strEntry,tblAttr)
				if tblAttr.mode == "directory" then
					doYieldTree(strEntry)
				end
			end
		end
	end -- local function doYieldTree

	return coroutine.wrap(function() doYieldTree(strDir) end)
end -- function DirTree

-- Delete file if it exists --
function DeleteFile(strFileName)
	if FlgFileExists(strFileName) then
		local fileHandle, strError = os.remove(strFileName)
		if fileHandle == nil then
			local intRepeat = 1
			repeat
				if intRepeat > 1 then ShowStatusMessage(StrRed,string.gsub(strError,strFileName:match("(.+\\).+"),"Del#"..tostring(intRepeat)..":")) end
				fhSleep(300,100)
				if FlgFileExists(strFileName) then
					fileHandle, strError = os.remove(strFileName)
				end
				intRepeat = intRepeat + 1
			until fileHandle ~= nil or intRepeat > 10
--!			if intRepeat > 10 then error(string.gsub(strError,strFileName:match("(.+\\).+"),"Del#"..tostring(intRepeat)..":")) end
		end
	end
end -- function DeleteFile

-- Show Status Colour & Message Text --
function ShowStatusMessage(strColour,strMessage)
	LblMessage.fgcolor = strColour
	LblMessage.title = strMessage
end -- function ShowStatusMessage

-- Invoke FH Shell Execute API --
function DoExecute(strExecutable)
	local isOK, intErrorCode, strErrorText = fhShellExecute(strExecutable)
	if not isOK then
		ShowStatusMessage(StrRed,strErrorText.." ("..intErrorCode..")")
	end
end -- function DoExecute

-- Inhibit Regular Expression magic characters ^$()%.[]*+-?) --
function StrPlainText(strText)
	-- Prefix every non-alphanumeric character (%W) with a % escape character, where %% is the % escape, and %1 is original character
	return strText:gsub("(%W)","%%%1")
end -- function StrPlainText

--[=[
HTML escape character encodings http://www.theukwebdesigncompany.com/articles/entity-escape-characters.php
	Null	%00=000				Codes 000-031 encoded to space by "%c"," "
	HorTab	%09=009
	CarRet	%0B=013
	US		%1F=031
	Space	%20=032				Codes 032-126 need no coding or encoded by 1st line below
	Tilde~	%7E=126
	€ 	  	%80=128	&euro;		Some character codes above 128 encoded by 2nd line below
	™		%99=153	&#8482;
	¢		%A2=162	&cent;
	£		%A3=163	&pound;
	¤		%A4=164	&curren;
	¥		%A5=165	&yen;
									Other codes 127-255 encoded to &#999; form by 3rd line below
]=]

-- Encode HTML symbols into &***; escape sequences as above --
function StrHTML_Encode(strHTML)
	-- "\n" newline is encoded as "<br>" tag, which must be unencoded from "&lt;br&gt;" to "<br>"
	-- "…" separator for Address…Place option is translated to "..." so it displays in Marker Tooltips & InfoWindows
	local tblEncodings = {
		{"\n","<br>"},	{"%c"," "},			{"&","&amp;"},	{"<","&lt;"},		{">","&gt;"},		{"\'","&apos;"},	{"\"","&quot;"},
		{"€","&euro;"},	{"™","&#8482;"},	{"¢","&cent;"},	{"£","&pound;"},	{"¤","&curren;"},	{"¥","&yen;"},
		{"&lt;br&gt;","<br>"},					{"…","..."},
		{"["..string.char(0x7F).."-"..string.char(0xFF).."]",function(char) return "&#"..string.byte(char)..";" end},
	}
	if strHTML then
		for i, tblEncode in ipairs(tblEncodings) do
			strHTML = strHTML:gsub(tblEncode[1],tblEncode[2])
		end
	else
		strHTML = ""
	end
	return strHTML
end -- function StrHTML_Encode

--[=[
Code points	Binary code 	UTF-8 bytes	Example %XX encodings
U+0000 to		0xxxxxxx		0xxxxxxx		character "$" = code point U+0024
U+007F											= 00100100
												? 00100100
												? hexadecimal %24
U+0080 to		00000yyy		110yyyyy  	character "¢" = code point U+00A2
U+07FF			yyxxxxxx		10xxxxxx		= 00000000 10100010
												? 11000010 10100010
												? hexadecimal %C2%A2
U+0800 to 	zzzzyyyy		1110zzzz		character "€" = code point U+20AC
U+FFFF			yyxxxxxx		10yyyyyy		= 00100000 10101100
								10xxxxxx		? 11100010 10000010 10101100
												? hexadecimal %E2%82%AC
U+010000 to 	000wwwzz	 	11110www	 	character "??" = code point U+024B62
U+10FFFF		zzzzyyyy		10zzzzzz		= 00000010 01001011 01100010
				yyxxxxxx		10yyyyyy		? 11110000 10100100 10101101 10100010
								10xxxxxx		? hexadecimal %F0%A4%AD%A2
]=]

-- Encode URL symbols to UTF-8 %XX codes above --
function StrURL_Encode(strURL)
	if strURL then
		-- Convert non-alphanumeric chars to Hex encoded UTF-8 format %XX or %XX%XX or %XX%XX%XX (where XX is two hex digits).
		strURL = strURL:gsub("[^0-9A-Za-z_~%-%.]",			-- 0-9 A-Z a-z _ ~ - . are the RFC 3986 section 2.3 Unreserved Characters
		function(strChar)
			if		strChar == "€" then strChar = "%E2%82%AC"	-- Encode some chars 80-9F into UTF-8 %XX%XX or %XX%XX%XX codes
			elseif	strChar == "™" then strChar = "%E2%84%A2"
			elseif	strChar == "Š" then strChar = "%C5%A0"
			elseif	strChar == "Ž" then strChar = "%C5%BD"
			elseif	strChar == "š" then strChar = "%C5%A1"
			elseif	strChar == "ž" then strChar = "%C5%BE"
			elseif	strChar == "Ÿ" then strChar = "%C5%B8"
			else
				local intChar = string.byte(strChar)
				if intChar < 0x80 then								-- ASCII chars 00-7F become %XX code	NUL-US ! " # $ % & ' ( ) * + , / : ; < = > ? @ [ \ ] ^ ` { | }
					strChar = string.format("%%%02X", intChar)
				elseif intChar < 0xA0 then						-- Characters 80-9F become "?" %3F code	 €  ‚ ƒ „ … † ‡ ˆ ‰ Š ‹ Œ  Ž   ‘ ’ " " • – — ˜ ™ š › œ  ž Ÿ 
					strChar = string.format("%%%02X", string.byte("?"))
				else													-- Characters A0-FF become UTF-8 %XX%XX	 ¡ ¢ £ ¤ ¥ ¦ § ¨ © ª « ...thru... ý þ ÿ
					local intFloor = math.floor(intChar/0x40)
					strChar = string.format("%%%02X", 0xC0 + intFloor)..string.format("%%%02X", 0x80 + intChar - intFloor*0x40)
--?					strChar = string.format("%%%02X", 0xC0 + bit32.rshift(intChar,6))..string.format("%%%02X", 0x80 + bit32.band(intChar,0x3F))	-- bit32 library only in LUA V5.2
				end
			end
			return strChar
		end)
	else
		strURL = ""
	end
	return strURL
end -- function StrURL_Encode

-- Set IsFromADDR & IsFromPLAC Flags --
function SetIsFromFlags()
	IsFromADDR = true					-- Locations From ADDR for Address…Place sub-options
	IsFromPLAC = true					-- Locations From PLAC for Address…Place sub-options
	if IntFromTag < IntFromBOTH then
--		IsFromADDR = ""					-- Locations From ADDR for Address…Place sub-options
--		IsFromPLAC = ""					-- Locations From PLAC for Address…Place sub-options
		return false
	end
--!	if IntFromTag == IntFromAP or IntFromTag == IntFromA_P_ then IsFromADDR = "-" else IsFromADDR = "+" end
--!	if IntFromTag == IntFromAP or IntFromTag == IntFrom_A_P then IsFromPLAC = "-" else IsFromPLAC = "+" end
	if IntFromTag == IntFromAP or IntFromTag == IntFromA_P_ then IsFromADDR = nil end
	if IntFromTag == IntFromAP or IntFromTag == IntFrom_A_P then IsFromPLAC = nil end
	return true
end -- function SetIsFromFlags

-- Reset Sticky Settings to Default Values --
function ResetDefaultSettings()
	IntMainX		= iup.CENTER			-- GUI Main window position X & Y co-ordinate and rastersize
	IntMainY		= iup.CENTER
	StrMainS		= "730x730"
	IntHelpX		= iup.CENTER			-- GUI Help window position X & Y co-ordinate and rastersize
	IntHelpY		= iup.CENTER
	StrHelpS		= "1010x700"
	IntDataX		= iup.CENTER			-- GUI Font/Warn window position X & Y co-ordinate
	IntDataY		= iup.CENTER
	StrFolder		= StrPublicPath		-- Output folder for Web page Maps
	StrLocation	= nil					-- Location entry unselected at startup
	StrPlotNew	= "Yes"				-- Geocode Plot new buttons warning shown
	StrWarnAns	= "Yes"				-- Quota Exceeded warning window shown
	StrGeoCode	= "ON"					-- Smart Geocoding option is ON
	IntTabPosn	= IntTabGeoLoc		-- Initial tab is Geocode Location Plots			
	IntRegBias	= 235					-- Default Geocoder Region Bias TLD Code is UK
	IntFromTag	= IntFromPLAC		-- Locations From Tag is "PLAC"
	IsFromADDR	= ""					-- Locations From ADDR for Address…Place sub-options -- Only for Adjust V3.1 below
	IsFromPLAC	= ""					-- Locations From PLAC for Address…Place sub-options -- Only for Adjust V3.1 below
	IntLocZoom	= 12					-- Google Maps Zoom for Geocode Location Plots
	IntPrivacy	= IntSwitchedOff	-- Privacy Filter is Switched Off
	IntMarkers	= IntMarkCascade	-- Markers Style is Cascade Drop
	IntMapZoom	= 12					-- Google Maps Zoom for Create Web Page Maps
end -- function ResetDefaultSettings

-- Load Sticky Settings from File --
function LoadSettings(strFileName)

	local tblStickyData = {}

	-- Load Local Parameter for this PC --
	local function strLoadLocal(strParam,strDefault)
		return tblStickyData[StrComputerName.."-"..strParam] or strDefault
	end

	-- Load Global Parameter for all PC --
	local function strLoadGlobal(strParam,strDefault)
		return tblStickyData[strParam] or strDefault
	end

	-- Ensure Window Position is on Screen --
	local function intintCheckPosition(x,y)
		local tblScrn = iup.GetGlobal("VIRTUALSCREEN"):SplitNumbers()
		-- tblScrn[1] = origin x, tblScrn[2] = origin y, tblScrn[3] = width, tblScrn[4] = height
		if tonumber(x) == nil then
			x = iup.CENTER
		elseif tonumber(x) > tblScrn[3] then
			x = iup.CENTER
		end
		if tonumber(y) == nil then
			y = iup.CENTER
		elseif tonumber(y) > tblScrn[4] then
			y = iup.CENTER
		end
		return tonumber(x),tonumber(y)
	end -- local function intintCheckPosition

	if FlgFileExists(strFileName) then
		-- Load Settings File in table lines with key & val fields
		local tblField = {}
		for strLine in io.lines(strFileName) do
			tblField = strLine:split("=")
			tblStickyData[tblField[1]] = tblField[2]
		end
		IntMainX = tonumber(strLoadLocal("MainX",IntMainX))
		IntMainY = tonumber(strLoadLocal("MainY",IntMainY))
		StrMainS = strLoadLocal			("MainS",StrMainS)
		IntHelpX = tonumber(strLoadLocal("HelpX",IntHelpX))
		IntHelpY = tonumber(strLoadLocal("HelpY",IntHelpY))
		StrHelpS = strLoadLocal			("HelpS",StrHelpS)
		IntDataX = tonumber(strLoadLocal("DataX",IntDataX))
		IntDataY = tonumber(strLoadLocal("DataY",IntDataY))
		StrFolder	= strLoadLocal			("Folder",StrFolder)
		StrLocation= strLoadGlobal			("Entry",StrLocation)
		StrPlotNew = strLoadGlobal			("PlotNew",StrPlotNew)
		StrWarnAns = strLoadGlobal			("WarnAns",StrWarnAns)
		StrGeoCode = strLoadGlobal			("GeoCode",StrGeoCode)
		IntTabPosn = tonumber(strLoadGlobal("TabPosn",IntTabPosn))
		IntRegBias = tonumber(strLoadGlobal("Region",IntRegBias))
		IntRegBias = tonumber(strLoadGlobal("RegBias",IntRegBias))
		IntFromTag = tonumber(strLoadGlobal("FromTag",IntFromTag))
		IsFromADDR = strLoadGlobal			("Is~ADDR",IsFromADDR) -- Only for Adjust V3.1 below
		IsFromPLAC = strLoadGlobal			("Is~PLAC",IsFromPLAC) -- Only for Adjust V3.1 below
		IntStorage = tonumber(strLoadGlobal("Storage",IntStorage))
		IntLocZoom = tonumber(strLoadGlobal("LocZoom",IntLocZoom))
		IntMarkers = tonumber(strLoadGlobal("Markers",IntMarkers))
		IntPrivacy = tonumber(strLoadGlobal("Privacy",IntPrivacy))
		IntMapZoom = tonumber(strLoadGlobal("MapZoom",IntMapZoom))
		IntChecked = tonumber(strLoadGlobal("Checked",IntChecked)) -- Only for Adjust V3.0 below
		IntFontSet = tonumber(strLoadGlobal("FontSet",IntFontSet))
		StrVersion = strLoadGlobal			("Version",StrIssue)
		if IntFromTag == IntFromBOTH and IntChecked then		-- Adjust V3.0 Address…Place to V3.2 Address…[Place] variant
			IntFromTag = IntFromA_P_
		end
		local tblFromTag = { "--", "-+", "+-", "++" }
		if tblFromTag[IntFromTag - 2] == IsFromADDR..IsFromPLAC then IntFromTag = IntFromTag + 2 end		-- Adjust V3.1 to V3.2 Address…Place variants
	end
	IntMainX,IntMainY = intintCheckPosition(IntMainX,IntMainY)
	IntHelpX,IntHelpY = intintCheckPosition(IntHelpX,IntHelpY)
	SetIsFromFlags()
	GUI_FontDialogue(IntFontSet) 							-- Assign font set
	SaveSettings(strFileName)									-- Save sticky data settings
end -- function LoadSettings

-- Save Sticky Settings to File --
function SaveSettings(strFileName)

	local tblStickyData = {}

	-- Save Local Parameter for this PC --
	local function doSaveLocal(strParam,param)
		tblStickyData[StrComputerName.."-"..strParam] = param
	end

	-- Save Global Parameter for all PC --
	local function doSaveGlobal(strParam,param)
		tblStickyData[strParam] = param
	end

	doSaveLocal("MainX",IntMainX)
	doSaveLocal("MainY",IntMainY)
	doSaveLocal("MainS",StrMainS)
	doSaveLocal("HelpX",IntHelpX)
	doSaveLocal("HelpY",IntHelpY)
	doSaveLocal("HelpS",StrHelpS)
	doSaveLocal("DataX",IntDataX)
	doSaveLocal("DataY",IntDataY)
	doSaveLocal("Folder",StrFolder)
	doSaveGlobal("Entry",StrLocation)
	doSaveGlobal("PlotNew",StrPlotNew)
	doSaveGlobal("WarnAns",StrWarnAns)
	doSaveGlobal("GeoCode",StrGeoCode)
	doSaveGlobal("TabPosn",IntTabPosn)
	doSaveGlobal("RegBias",IntRegBias)
	doSaveGlobal("FromTag",IntFromTag)
	doSaveGlobal("Storage",IntStorage)
	doSaveGlobal("LocZoom",IntLocZoom)
	doSaveGlobal("Privacy",IntPrivacy)
	doSaveGlobal("Markers",IntMarkers)
	doSaveGlobal("MapZoom",IntMapZoom)
	doSaveGlobal("FontSet",IntFontSet)
	doSaveGlobal("Version",StrVersion)

	local fileHandle = OpenFile(strFileName,"w")
	for strKey,strVal in pairs(tblStickyData) do
		fileHandle:write(strKey.."="..strVal.."\n")
	end
	fileHandle:close()
end -- function SaveSettings

-- Have the Latitude & Longitude been Geocoded? --
function IsNotGeocoded(tblLocData)
	if tblLocData then
		if tblLocData["lat"] == "" or tblLocData["lng"] == "" then
			return true
		end
	end
	return false
end -- function IsNotGeocoded

-- Have the Latitude & Longitude got numbers? -- 
function IsPlotted(tblLocData)
	if tblLocData then
		if tonumber(tblLocData["lat"]) and tonumber(tblLocData["lng"]) then
			return true
		end
	end
	return false
end -- function IsPlotted

-- Encode Map Marker style into a table --
function TblMarkerStyle()
	local strAnimate = "DROP"
	local strTimeout = "300"
	if IntMarkers == IntMarkNothing then strAnimate = "null" end
	if IntMarkers == IntMarkCascade then strTimeout = "2000" end
	return { Timeout=strTimeout, Animate=strAnimate }
end -- function TblMarkerStyle

-- Create the mapfacts.js & mapfacts.css files --
function MakeSharedFiles(strFolder)
	local tblMarkerStyle = TblMarkerStyle()
	local strJavaScipt = StrMasterJS
	strJavaScipt = strJavaScipt:gsub("{animate}",tblMarkerStyle["Animate"])
	strJavaScipt = strJavaScipt:gsub("{timeout}",tblMarkerStyle["Timeout"])
	strJavaScipt = strJavaScipt:gsub("{setzoom}",IntMapZoom)
	SaveStringToFile(strJavaScipt,strFolder.."\\mapfacts.js")
	SaveStringToFile(StrMasterCSS,strFolder.."\\mapfacts.css")
end -- function MakeSharedFiles

-- Open the Google Maps HTML Application --
function OpenGoogleMap()
	DeleteFile(StrFileNameHTM)
	DeleteFile(StrFileNameACT)
	MakeSharedFiles(StrPluginPath)
	if not FlgFileExists(StrFileNameHTM) then -- Create Google Maps HTML file
		local tblMarkerStyle = TblMarkerStyle()
		local strScript = StrMasterHTM
		strScript = strScript:gsub("{animate}",tblMarkerStyle["Animate"])
		strScript = strScript:gsub("{setzoom}",IntLocZoom)
		strScript = strScript:gsub("{plugin}",StrPlugin)
		SaveStringToFile(strScript,StrFileNameHTM)
	end
	OLEcontrol.com:Navigate(StrFileNameHTM)
	ShowStatusMessage(StrGreen,"Google Maps Geocoder Open")
end -- function OpenGoogleMap

-- Run Google Maps Action and wait for Synchronisation --
function RunGoogleMap(strA,str1,str2,str3,str4)
	if FlgFileExists(StrFileNameACT) then return end -- Ignore new request before old one has completed
	local intCheck = 60
	local strStatus = ""
	local strSync = ""
	if StrSync == "+" then StrSync = "*" else StrSync = "+" end		-- Alternate synchronisation characters
	SaveStringToFile("<ACT>\n"..StrSync.."\n"..tostring(strA).."\n"..tostring(str1).."\n"..tostring(str2).."\n"..tostring(str3).."\n"..tostring(str4).."\n</ACT>\n",StrFileNameACT)
	repeat
		fhSleep(50,40)									-- Check for Google Maps synchronisation, or excessive checks
		intCheck = intCheck - 1
		strStatus = OLEcontrol.com.Document:getElementById("status")
		if strStatus then								-- Retrieve synch character status from HTML Document
			strSync = string.sub(strStatus.innerText,1,1)
		end
	until strSync == StrSync or intCheck < 0
	if intCheck < 0 then
		ShowStatusMessage(StrRed,"Google Maps Geocoder Fault")
		WinHttpCopy = WinHttp
		WinHttp = nil									-- Inhibit GeocodeLocation() API function on fault
	else
		if not WinHttp then WinHttp = WinHttpCopy end
	end
--!	ShowStatusMessage(StrBlue,strStatus.innerText.."  intCheck="..tostring(intCheck)) -- Diagnostic
	DeleteFile(StrFileNameACT)						-- Remove old Google Maps Action file
end -- function RunGoogleMap

-- Mark Lat/Longitude & Location in Google Maps pane --
function MarkGoogleMap(strLatitude,strLongitude,strLocation)
	RunGoogleMap("MARK",tonumber(strLatitude),tonumber(strLongitude),strLocation)
end -- function MarkGoogleMap

-- Nullify all existing Markers from Google Maps pane --
function NullGoogleMap()
	RunGoogleMap("NULL")
end -- function NullGoogleMap

-- Plot Lat/Longitude, Caption & InfoWin data for Google Maps pane unless offline --
function PlotGoogleMap(strLatitude,strLongitude,strCaption,strInfoWin)
	if WinHttp then RunGoogleMap("PLOT",tonumber(strLatitude),tonumber(strLongitude),strCaption,strInfoWin) end
end -- function PlotGoogleMap

-- Drop multiple markers in chosen style in Google Maps pane --
function DropGoogleMap()
	local tblMarkerStyle = TblMarkerStyle()
	RunGoogleMap("DROP",tblMarkerStyle["Animate"],tblMarkerStyle["Timeout"])
end -- function DropGoogleMap

-- Zoom to selected level in Google Maps pane --
function ZoomGoogleMap(intZoomLevel)
	RunGoogleMap("ZOOM",tostring(tonumber(intZoomLevel)))
end -- function ZoomGoogleMap

-- Read map Zoom level from Google Maps pane --
function ReadGoogleMap()
	local	strStatus = OLEcontrol.com.Document:getElementById("status")
	if strStatus then
		IntGetZoom = tonumber(string.sub(strStatus.innerText,3,-1)) -- Get map zoom level
	end
end -- function ReadGoogleMap

-- Close Google Maps HTML Application --
function CloseGoogleMap()
	DeleteFile(StrFileNameACT)
	DeleteFile(StrFileNameHTM)
	DeleteFile(StrPluginPath.."\\mapfacts.js")
	DeleteFile(StrPluginPath.."\\mapfacts.css")
	ShowStatusMessage(StrGreen,"Google Maps Geocoder Closed")
	fhSleep(100)
end -- function CloseGoogleMap

-- Get Text from XML Data using Node name --
function StrGetXmlText(strData,strNode)
	return strData:match("<"..strNode..">(.-)</"..strNode..">")
end -- function StrGetXmlText

-- Determine state Index of a Plot/Map Status value --
function IntStatusIndex(strStatus,tblStates)
	local intIndex = IntPlotNoData
	if strStatus then
		for intState, strState in ipairs(tblStates) do
			if string.find(strStatus,strState) then
				intIndex = intState
				break
			end
		end
	end
	return intIndex
end -- function IntStatusIndex

-- Refresh the Latitude or Longitude value --
function RefreshValue(txtControl,txtValue,strPlotMode)
	txtValue = txtValue or ""
	strPlotMode = strPlotMode or ""
	local intIndex = IntStatusIndex(txtValue..strPlotMode,TblPlotStates)
	if intIndex == IntPlotLatLong
	or intIndex == IntPlotManual then				-- Round value to 7 decimal places
		txtValue = string.format("%4.7f",txtValue)
	end
	txtControl.value	= txtValue
	txtControl.fgcolor	= TblStatusColor[intIndex]
end -- function RefreshValue

WinHttp = luacom.CreateObject("winhttp.winhttprequest.5.1")

-- Geocode a Location Address into Latitude & Longitude --
function StrGeocodeLocation(strLocName)

	-- Update Latitude & Longitude Geocode data --
	local function setLatitudeLongitude(strLat,strLng,strLocName)
		local tblLocData = TblLocationData[strLocName]
			tblLocData["lat"] = strLat
			tblLocData["lng"] = strLng
			SaveLocationsData(strLocName)
			if strLocName == StrLocation then
				RefreshValue(TxtLatitude, tblLocData["lat"])
				RefreshValue(TxtLongitude,tblLocData["lng"])
			end
	end -- local function setLatitudeLongitude

	local strAns = ""
	local tblAns = { OK="Ok", ZERO_RESULTS=StrPlotNoPlot, INVALID_REQUEST=StrPlotInvalid, REQUEST_DENIED=StrPlotDenied, OVER_QUERY_LIMIT=StrPlotQuotaX }

	if TblLocationData[strLocName] and WinHttp then
		local tblLoc = {}
		local strLoc = strLocName
		local strSub = TblLocationData[strLocName]["sub"] or ""
		if strSub ~= "" then strLoc = strSub end			-- Replace Location with Substitute value if it exists
		if strLoc == nil then strLoc = "" end
		strLoc = string.gsub(strLoc,'".-"','')				-- Exclude double quoted text from Geocoder as a user aid
		tblLoc = strLoc:split(",…"..string.char(7))		-- Split Location into fields separated by comma, elipsis, or blob bell char
		local isAustralia = false								-- Used to resolve Australian v North American State conflicts
		if TblRegBias[IntRegBias]:match("Australia") then isAustralia = true end
		for intLoc = #tblLoc, 1, -1 do						-- Process each field from right to left according to table of abbreviation codes, etc
			local strLocn = tblLoc[intLoc]
			strLocn = strLocn:gsub("^%s*(.-)%s*$","%1")	-- Strip leading and trailing spaces
			if StrGeoCode == "ON" then						-- If the Smart Geocoding option enabled, then translate any codes, etc
				strLocn = TblLocCode[strLocn] or strLocn
				local strCountry, strChapman = strLocn:match("^~(.-)~(.-)~$")
				if strCountry and strChapman then			-- Country v Chapman Code Conflict Resolution detected
					if intLoc == #tblLoc
					and not TblRegBias[IntRegBias]:match("United Kingdom") then
						strLocn = strCountry					-- Use the Country for right-most Location field unless UK Region Bias
					else
						strLocn = strChapman					-- Otherwise use the Chapman County
					end
				end
				local strAustralia, strN_America = strLocn:match("^#(.-)#(.-)#$")
				if strAustralia and strN_America then		-- Australian v North American State Conflict Resolution detected
					if isAustralia then
						strLocn = strAustralia
					else
						strLocn = strN_America
					end
				end
				if strLocn:match("Australia") then isAustralia = true end
				for i, tblGeoCode in ipairs(TblGeoCode) do -- Translations to improve Geocoder plotting
					if string.match(strLocn.." ",tblGeoCode[1]) then
						strLocn = tblGeoCode[2]
						break
					end
				end
			end -- if StrGeoCode == "ON"
			tblLoc[intLoc] = strLocn
		end
		strLoc = table.concat(tblLoc,", ")
		local strReg = TblRegBias[IntRegBias]:sub(1,2)
		local strURL = "http://maps.googleapis.com/maps/api/geocode/xml?address="..StrURL_Encode(strLoc).."&sensor=false&region="..strReg
		local strXML = ""
		local strLat = ""
		local strLng = ""
		local intSleep = 125									-- Interval between Geocoder calls
		local intCheck = 2
		repeat
			WinHttp:Open("GET",strURL,0)						-- 0 was false
			WinHttp:Send()
			strXML = WinHttp.Responsetext					-- Status values as in tblAns above
			strAns = tblAns[StrGetXmlText(strXML,"status")]
			if strAns == "Ok" then
				strLat = StrGetXmlText(strXML,"lat")
				strLng = StrGetXmlText(strXML,"lng")
			elseif strAns == StrPlotQuotaX then				-- Try again after one second
				setLatitudeLongitude( strAns, strAns, strLocName )
				fhSleep(1000,100)
			end
			intCheck = intCheck - 1
		until strAns ~= StrPlotQuotaX or intCheck < 0
		if intCheck < 0 then
			ShowStatusMessage(StrRed,"Geocoder Daily "..StrPlotQuotaX)
			setLatitudeLongitude("", "", strLocName)		-- Do NOT record Quota Exceeded in the Latitude & Longitude fields
		else
			setLatitudeLongitude(tonumber(strLat) or strAns, tonumber(strLng) or strAns, strLocName)
		end
		fhSleep(intSleep,90)
	end
	return strAns
end -- function StrGeocodeLocation

-- Create Locations Geocode Database --
function CreateLocationsData()
	if TblLocationCode == nil then TblLocationCode = {} end
	for i, strFromTag in ipairs(TblFromTag) do -- "PLAC" and "ADDR" and "BOTH"
		if TblLocationCode[strFromTag] == nil then TblLocationCode[strFromTag] = {} end
	end
end -- function CreateLocationsData

-- Load Locations Geocode Database File --
function LoadLocationsFile()
	TblLocationCode = table.load(StrFileNameLOC)
	CreateLocationsData()
	table.save(TblLocationCode,StrFileNameLOC)
	TblLocationData = TblLocationCode[StrFromTag]
end -- function LoadLocationsFile

-- Save Locations Geocode Database File --
function SaveLocationsFile()
	table.save(TblLocationCode,StrFileNameLOC)
end -- function SaveLocationsFile

-- Import old Map Geo Code Maintenance Plugin data --
function ImportOldGeoCodeMaintData()
	if IntStorage ~= IntStoreFILE then return end
	local strMapGeoCodeName = "Map Geo Code Maintenance"
	local strMapGeoCodeFile = StrPluginPath.."\\"..strMapGeoCodeName..".dat"
	LoadLocationsFile()
	if FlgFileExists(strMapGeoCodeFile) and next(TblLocationCode["PLAC"]) == nil then
		if GUI_WarnDialogue("IMPORT "..strMapGeoCodeName,"Do you wish to import your '"..strMapGeoCodeName.."' data to\ninitialise the Place Locations data for this '"..StrPlugin.."' plugin?") == "Yes" then
			local tblLocationData = table.load(strMapGeoCodeFile)
			for strLocName, intCount in pairs(tblLocationData) do
				if strLocName ~= "" then
					TblLocationCode["PLAC"][strLocName] = {}
					if tblLocationData[strLocName]["modern"] ~= nil then
						TblLocationCode["PLAC"][strLocName]["sub"] = tblLocationData[strLocName]["modern"]
					end
					if tblLocationData[strLocName]["lat"] ~= nil then
						TblLocationCode["PLAC"][strLocName]["lat"] = tblLocationData[strLocName]["lat"]
					end
					if tblLocationData[strLocName]["long"] ~= nil then
						TblLocationCode["PLAC"][strLocName]["lng"] = tblLocationData[strLocName]["long"]
					end
				end
			end
			SaveLocationsFile()
--??		DeleteFile(strMapGeoCodeFile)	-- Should file be kept or deleted ?
		end
	end
end -- function ImportOldGeoCodeMaintData

-- Load Locations Database from File or Gedcom --
function LoadLocationsData()
	ShowStatusMessage(StrAmber,"Loading Location data, please wait…")
	if IntStorage == IntStoreFILE then
		LoadLocationsFile()
		return
	end
	CreateLocationsData()
	for i, strFromTag in ipairs(TblFromTag) do -- "PLAC" and "ADDR" and "BOTH"
		TblLocationData = TblLocationCode[strFromTag]
		local strStoreTag = TblStoreTAG[IntStorage] -- "REPO" or "SOUR"
		local strType = TblFromType[strFromTag]
		local strHead = "Map Life "..strType.." Location"
		local ptrRecord = fhNewItemPtr()
		ptrRecord:MoveToFirstRecord(strStoreTag)
		while ptrRecord:IsNotNull() do
			local strLocName = fhGetDisplayText(ptrRecord)
			local ptrType = fhGetItemPtr(ptrRecord,"~._TYPE")	-- Source Type
			local ptrRepo = fhGetItemPtr(ptrRecord,"~.REPO")	-- Source to Repository link
			local ptrNote = fhGetItemPtr(ptrRecord,"~.NOTE2")	-- Source or Repository local Note
			local ptrTarget = fhNewItemPtr()
			if IntStorage == IntStoreBOTH and fhGetValueAsText(ptrType) == strType then
				ptrRepo = fhGetValueAsLink(ptrRepo)
				if ptrRepo:IsNotNull() then
					ptrNote = fhGetItemPtr(ptrRepo,"~.NOTE2")		-- Linked Repository local Note
				end
			end
			local isHeadFound = false
			if ptrNote:IsNotNull() then
				if fhCallBuiltInFunction("GetParagraph", ptrNote, 1) == strHead then isHeadFound = true end
--?				if fhCallBuiltInFunction("GetLabelledText", ptrNote, strType) == "Location" then isHeadFound = true end	-- alternative
			end
			if IntStorage == IntStoreREPO and isHeadFound then ptrTarget = ptrRecord end
			if IntStorage == IntStoreSOUR and isHeadFound and fhGetValueAsText(ptrType) == strType then ptrTarget = ptrRecord end
			if IntStorage == IntStoreBOTH and isHeadFound and fhGetValueAsText(ptrType) == strType then ptrTarget = ptrRepo end
			if ptrTarget:IsNotNull() then
				TblLocationData[strLocName] = {}
				TblLocationData[strLocName]["rec"] = fhGetRecordId(ptrRecord)
				TblLocationData[strLocName]["sub"] = fhCallBuiltInFunction("GetLabelledText", ptrNote, "Substitute =")
				TblLocationData[strLocName]["lat"] = fhCallBuiltInFunction("GetLabelledText", ptrNote, "Latitude =")
				TblLocationData[strLocName]["lng"] = fhCallBuiltInFunction("GetLabelledText", ptrNote, "Longitude =")
				TblLocationData[strLocName]["mod"] = fhCallBuiltInFunction("GetLabelledText", ptrNote, "Plot Mode =")
			end
			ptrRecord:MoveNext("SAME_TAG")
		end -- while not ptrRecord:IsNull()
		TblLocationCode[strFromTag] = TblLocationData
--!		SaveLocationsFile() -- diagnostic
	end
	TblLocationData = TblLocationCode[StrFromTag]
end -- function LoadLocationsData

-- Create new Repository Record --
function MakeNewRepositoryRecord(strLocName)
	local ptrRecord = fhCreateItem("REPO")
	fhSetValueAsText(fhCreateItem("NAME",ptrRecord),strLocName)
	return ptrRecord, fhGetRecordId(ptrRecord)
end -- function MakeNewRepositoryRecord

-- Create new Source Record --
function MakeNewSourceRecord(strLocName)
	local ptrRecord = fhCreateItem("SOUR")
	fhSetValueAsText(fhCreateItem("TITL",ptrRecord),strLocName)
	fhSetValueAsText(fhCreateItem("_TYPE",ptrRecord),TblFromType[StrFromTag])
	return ptrRecord, fhGetRecordId(ptrRecord)
end -- function MakeNewSourceRecord

-- Save Locations Database entry to File or Gedcom --
function SaveLocationsData(strLocName)
	if IntStorage == IntStoreFILE then
		TblLocationData[strLocName]["rec"] = nil
		return
	end
	local strStoreTag = TblStoreTAG[IntStorage] -- "REPO" or "SOUR"
	local strType = TblFromType[StrFromTag]
	local strHead = "Map Life "..strType.." Location\n"
	local strData = "Substitute = \t"..TblLocationData[strLocName]["sub"].."\nLatitude = \t"..TblLocationData[strLocName]["lat"].."\nLongitude = \t"..TblLocationData[strLocName]["lng"].."\nPlot Mode = \t"..(TblLocationData[strLocName]["mod"] or "").."\n"
	local ptrNote
	local ptrRepo
	local ptrRecord = fhNewItemPtr()
	local intRecord = TblLocationData[strLocName]["rec"]
	if intRecord > 0 then
		-- Repository or Source record exists
		ptrRecord:MoveToRecordById(strStoreTag,intRecord)
		ptrNote = fhGetItemPtr(ptrRecord,"~.NOTE2")		-- Source or Repository local Note
		ptrRepo = fhGetItemPtr(ptrRecord,"~.REPO")		-- Source to Repository link
--?		if IntStorage == IntStoreBOTH and fhGetValueAsText(fhGetItemPtr(ptrRecord,"~._TYPE")) == strType then -- also check Source Type ?
		if IntStorage == IntStoreBOTH then
			ptrRepo = fhGetValueAsLink(ptrRepo)
			if ptrRepo:IsNotNull() then
				ptrNote = fhGetItemPtr(ptrRepo,"~.NOTE2")	-- Linked Repository local Note
			end
		end
	else
		-- Create new Repository or Source record
		if IntStorage == IntStoreREPO then
			ptrRecord, intRecord = MakeNewRepositoryRecord(strLocName)
		else
			ptrRecord, intRecord = MakeNewSourceRecord(strLocName)
			if IntStorage == IntStoreBOTH then	-- link Source to a new Repository
				ptrRepo = MakeNewRepositoryRecord(strLocName)
				fhSetValueAsLink(fhCreateItem("REPO",ptrRecord),ptrRepo)
				ptrRecord = ptrRepo
			end
		end
		ptrNote = fhCreateItem("NOTE2",ptrRecord)		-- Source or Repository local Note
		TblLocationData[strLocName]["rec"] = intRecord
	end
	fhSetValueAsText(ptrNote,strHead..strData)		-- Save Location Data in local Note
--!	ShowStatusMessage(StrBlue,"Locations Database Entry Saved") -- diagnostic
end -- function SaveLocationsData

-- Delete Locations Database Record in Gedcom --
function DeleteLocationRecord(intRecord)
	local strType = TblFromType[StrFromTag]
	local ptrRecord = fhNewItemPtr()
	ptrRecord:MoveToRecordById(TblStoreTAG[IntStorage],intRecord)
	if ptrRecord:IsNotNull() then
--?		if IntStorage == IntStoreBOTH and fhGetValueAsText(ptrType) == strType then -- also check Source Type ?
		if IntStorage == IntStoreBOTH then
			local ptrRepo = fhGetItemPtr(ptrRecord,"~.REPO")
			ptrRepo = fhGetValueAsLink(ptrRepo)
			if ptrRepo:IsNotNull() then
				fhDeleteItem(ptrRepo)	-- Delete Repository record linked to Source
			end
		end
		fhDeleteItem(ptrRecord)		-- Delete primary Source or Repository record
--!		ShowStatusMessage(StrBlue,"Locations Database Entry Deleted") -- diagnostic
	end
end -- function DeleteLocationRecord

-- Convert Locations Database entries from/to File or Records --
function ConvertLocationsData(intOldStorage,intNewStorage)
	local ptrSourRecord = fhNewItemPtr()
	local ptrRepoRecord = fhNewItemPtr()
	local intOldRecordId = 0
	local intNewRecordId = 0

	-- Move local Note from one record to another
	local function doMoveNotes(ptrGetRecord,ptrSetRecord)
		local ptrGetNote = fhGetItemPtr(ptrGetRecord,"~.NOTE2")
		local ptrSetNote = fhGetItemPtr(ptrSetRecord,"~.NOTE2")
		if ptrSetNote:IsNull() then
			ptrSetNote = fhCreateItem("NOTE2",ptrSetRecord)
		end
		fhSetValueAsText(ptrSetNote,fhGetValueAsText(ptrGetNote))
		if intNewStorage == IntStoreBOTH then
			fhDeleteItem(ptrGetNote)		-- Delete original local Note
		else
			fhDeleteItem(ptrGetRecord)	-- Delete original Record
		end
	end -- local function doMoveNotes

	for i, strFromTag in ipairs(TblFromTag) do -- "PLAC" and "ADDR" and "BOTH"
		StrFromTag = strFromTag
		TblLocationData = TblLocationCode[StrFromTag]
		for strLocName, tblLocData in pairs(TblLocationData) do
			intOldRecordId = tblLocData["rec"]

			if		intOldStorage == IntStoreFILE then		-- Convert Data File to Gedcom Records
				IntStorage = intNewStorage
				tblLocData["rec"] = 0
				SaveLocationsData(strLocName)

			elseif intNewStorage == IntStoreFILE then		-- Convert Gedcom Records to Data File
				IntStorage = intOldStorage
				DeleteLocationRecord(intOldRecordId)
				tblLocData["rec"] = nil

			elseif intOldStorage == IntStoreREPO then		-- Convert Repository to Source / Source & Repository
				ptrSourRecord, intNewRecordId = MakeNewSourceRecord(strLocName)
				tblLocData["rec"] = intNewRecordId
				ptrRepoRecord:MoveToRecordById("REPO",intOldRecordId)
				if intNewStorage == IntStoreSOUR then
					doMoveNotes(ptrRepoRecord,ptrSourRecord)
				elseif intNewStorage == IntStoreBOTH then
					fhSetValueAsLink(fhCreateItem("REPO",ptrSourRecord),ptrRepoRecord)
				end

			elseif intOldStorage == IntStoreSOUR then		-- Convert Source to Repository / Source & Repository
				ptrRepoRecord, intNewRecordId = MakeNewRepositoryRecord(strLocName)
				ptrSourRecord:MoveToRecordById("SOUR",intOldRecordId)
				doMoveNotes(ptrSourRecord,ptrRepoRecord)
				if intNewStorage == IntStoreREPO then
					tblLocData["rec"] = intNewRecordId
				elseif intNewStorage == IntStoreBOTH then
					fhSetValueAsLink(fhCreateItem("REPO",ptrSourRecord),ptrRepoRecord)
				end

			elseif intOldStorage == IntStoreBOTH then		-- Convert Source & Repository to Repository / Source
				ptrSourRecord:MoveToRecordById("SOUR",intOldRecordId)
				ptrRepoRecord = fhGetValueAsLink(fhGetItemPtr(ptrSourRecord,"~.REPO"))
				if intNewStorage == IntStoreREPO then
					tblLocData["rec"] = fhGetRecordId(ptrRepoRecord)
					fhDeleteItem(ptrSourRecord)
				elseif intNewStorage == IntStoreSOUR then
					doMoveNotes(ptrRepoRecord,ptrSourRecord)
				end

			end
			iup.Flush()
		end
		TblLocationCode[StrFromTag] = TblLocationData
--!		SaveLocationsFile() -- diagnostic
		fhUpdateDisplay()
	end
	if intNewStorage == IntStoreFILE then SaveLocationsFile() end
--?	if intOldStorage == IntStoreFILE then DeleteFile(StrFileNameLOC) end	-- Delete or keep Locations file ?
	StrFromTag = TblFromTag[math.min(IntFromTag,IntFromBOTH)]
	TblLocationData = TblLocationCode[StrFromTag]
	fhUpdateDisplay()
	ShowStatusMessage(StrGreen,"Locations Database Converted")
end -- function ConvertLocationsData

-- Replace control chars with space in Location name --
function StrControls2SpaceOld(strLocName)
	-- Replace \n with space is essential for TblLocationData dictionary keys & Records
	-- Replace all control chars with a space works better in GUI, Records, etc
	return string.gsub(strLocName,"[%c%s]+"," ")					-- Replace any other multiple control & layout chars with one space
end -- function StrControls2SpaceOld

-- Replace control chars with space but CRLF with blob in Location name --
function StrControls2SpaceNew(strLocName)
	-- Replace \n with blob is essential for TblLocationData dictionary keys & Records
	-- Replace all control chars with a space works better in GUI, Records, etc
	strLocName = string.gsub(strLocName or "","\n","{Cr~Lf}")			-- Replace newline chars with {Cr~Lf} temporarily
	strLocName = string.gsub(strLocName,"[%c%s]+"," ")					-- Replace any other multiple control & layout chars with one space
	strLocName = string.gsub(strLocName,"{Cr~Lf}",string.char(7))	-- Replace temporary {Cr~Lf} with one bell char blob
	return strLocName
end -- function StrControls2SpaceNew

-- Determine if special data tag of Husband/Wife for Family Record Id, or Residence or LDS Ordinations for Location Place/Address --
function IsDataTag(ptrFact)
	local strGetTag = fhGetTag(ptrFact)
	for i,strDataTag in ipairs( { "HUSB", "WIFE", "RESI", "BAPL", "CONL", "ENDL", "SLGC", "SLGS", } ) do 
		if strGetTag == strDataTag then return true end
	end
	return false
end -- function IsDataTag

-- Make Location Name and Plot/Map Data from Fact ADDR & PLAC data --
function StrMakeLocation(ptrFact)
	local strFromTag = TblFromTag[math.min(IntFromTag,IntFromBOTH)]			-- "PLAC" or "ADDR" or "BOTH"
	local strLocName = ""
	local strLocData = ""
	local strADDR = ""
	local strPLAC = ""
	if IntFromTag < IntFromBOTH then												-- "PLAC" or "ADDR" only
		strLocName = fhGetDisplayText(ptrFact,"~."..strFromTag,"MIN") 		-- "~.PLAC" or "~.ADDR" tag
		strADDR = strLocName
	else
		strADDR = fhGetDisplayText(ptrFact,"~.ADDR","MIN")						-- "BOTH" Address…Place variant
		strPLAC = fhGetDisplayText(ptrFact,"~.PLAC","MIN")
		strLocData = strADDR.."…"..strPLAC											-- Return full Address…Place variant for Plots
		if IntFromTag == IntFromP then strADDR = "" end							-- "…Place only" variant
		if IntFromTag == IntFromA then strPLAC = "" end							-- "Address… only" variant
--!		if ( IsFromADDR == "+" or strADDR ~= "" ) and ( IsFromPLAC == "+" or strPLAC ~= "" ) then
		if ( IsFromADDR or strADDR ~= "" ) and ( IsFromPLAC or strPLAC ~= "" ) then
			strLocName = strADDR.."…"..strPLAC
			strLocName = strLocName:gsub("^…$","")
		end
	end
	if IntTabPosn == IntTabCreate then
		if strFromTag ~= "PLAC" then
			strLocData = "<br>"..strADDR												-- Return the Address to append for Maps
		else
			strLocData = ""
		end
	end
	return strLocName, strLocData
end -- function StrMakeLocation

-- Create Web Page Map for one Individual --
function StrCreateWebPageMap(ptrIndi)

	local strMapFolder	= StrFolder.."\\"
	local intFactIndex	=	0	-- Relative ordinal position of Fact 
	local tblFactsData	= {}	-- Date, Fact Data, Location & Index per Fact
	local tblLocations	= {}	-- Count of Facts per Location
	local tblMapMarker	= {}	-- Map Marker number per Location
	local tblFamily		= {}	-- Record Id of Spouse Family Records
	local tblSpouse		= {}	-- Spouse Name of Spouse Family Records
	local strJavaLists	= ""	-- Map Marker Java Lists for Locations

	-- Add Fact Data to Table
	local function doAddFactData(ptrFact, strFactData)

		local strLocName, strAddress = StrMakeLocation(ptrFact)						-- Get Location name and optional Address to append to Fact
		if strLocName ~= "" then																-- Ignore empty Location
			local dtDate = fhNewDate()
			local ptrDate = fhNewItemPtr()
			ptrDate:MoveTo(ptrFact,"~.DATE")												-- Obtain the Date in order to sort Facts
			if ptrDate:IsNotNull() then
				dtDate = fhGetValueAsDate(ptrDate)
			else
				dtDate:SetSimpleDate(fhCallBuiltInFunction("Today"))
			end
			strFactData = strFactData..fhGetDisplayText(ptrFact)..strAddress		-- Add description of Fact including Place and optionally Address
			strLocName = StrControls2SpaceNew(strLocName)								-- Uses newline bell blob
			tblLocations[strLocName] = (tblLocations[strLocName] or 0) + 1			-- Count how many Facts at this Location
			intFactIndex = intFactIndex + 1
			table.insert( tblFactsData, { Date=dtDate:Clone(), FactData=strFactData, LocName=strLocName, Index=intFactIndex } )
		end
	end -- local function doAddFactData

	-- Determine if Privacy Flags allow output
	local function flagsOK(ptrIndi)
		if ( IntPrivacy == IntLivingFlag  or IntPrivacy == IntBothFlags ) and fhGetDisplayText(ptrIndi,"~._FLGS.__LIVING","MIN")  == "Y" then return false end -- or fhGetItemText(ptrIndi,"~._FLGS.__LIVING")
		if ( IntPrivacy == IntPrivateFlag or IntPrivacy == IntBothFlags ) and fhGetDisplayText(ptrIndi,"~._FLGS.__PRIVATE","MIN") == "Y" then return false end -- or fhGetItemText(ptrIndi,"~._FLGS.__PRIVATE")
		return true
	end -- local function flagsOK

	-- Process one Individual Record and associated Family Records
	local function doProcessIndividual(ptrIndi)
		-- Process Individual Facts
		local ptrFact = fhNewItemPtr()
		ptrFact:MoveToFirstChildItem(ptrIndi)
		while ptrFact:IsNotNull() do
			if fhIsFact(ptrFact) or IsDataTag(ptrFact) then
				doAddFactData(ptrFact,"")
			end
			ptrFact:MoveNext("ANY")
		end
		-- Loop all Family Facts
		local ptrFamily	= fhNewItemPtr()
		local ptrSpouse	= fhNewItemPtr()
		local ptrChild	= fhNewItemPtr()
		local intFamily	= 1
		local intSpouse	= 1
		local intChild	= 1

		-- Determine if found a new Spouse Family Record Id
		local function isNewSpouse()
			local strRecordId = fhGetRecordId(ptrFamily)
			for i,strFamilyId in ipairs(tblFamily) do
				if strFamilyId == strRecordId then return false end
			end
			return true
		end -- local function isNewSpouse

		ptrFamily:MoveTo(ptrIndi,"~.FAMS["..intFamily.."]>")
		while ptrFamily:IsNotNull() do
			-- Process Family Facts
			ptrFact:MoveToFirstChildItem(ptrFamily)
			while ptrFact:IsNotNull() do
				if fhIsFact(ptrFact) or IsDataTag(ptrFact) then
					ptrSpouse:MoveTo(ptrIndi,"~.~SPOU["..intFamily.."]>")
					if flagsOK(ptrSpouse) then
						local strSpouse = fhGetDisplayText(ptrIndi,"~.~SPOU["..intFamily.."]>NAME","MIN")
						doAddFactData(ptrFact,"with "..strSpouse..":<br>")
						if isNewSpouse() then
							tblFamily[intSpouse] = fhGetRecordId(ptrFamily)
							tblSpouse[intSpouse] = strSpouse
							intSpouse = intSpouse + 1
						end
					end
				end
				ptrFact:MoveNext("ANY")
			end
			-- Process Child Births
			intChild = 1
			ptrChild:MoveTo(ptrFamily,"~.CHIL["..intChild.."]>")
			while ptrChild:IsNotNull() do
				if flagsOK(ptrChild) then 
					ptrFact:MoveTo(ptrChild,"~.BIRT")
					if fhIsFact(ptrFact) then
						doAddFactData(ptrFact,"Child: "..fhGetDisplayText(ptrChild,"~.NAME","MIN")..":<br>")
					end
				end
				intChild = intChild + 1
				ptrChild:MoveTo(ptrFamily,"~.CHIL["..intChild.."]>")
			end
			intFamily = intFamily + 1
			ptrFamily:MoveTo(ptrIndi,"~.FAMS["..intFamily.."]>")
		end
	end -- local function doProcessIndividual

	-- Build JavaScript Map Marker Location Lists for HTML
	local function intJavaScriptLists()
		local strLatitude = ""
		local strLongitude = ""
		local intLocTotal = 0
		local intMapMarker = 0
		tblMapMarker = {}
		strJavaLists = ""
		for strLocName, intLocCount in pairs(tblLocations) do
			if IsNotGeocoded(TblLocationData[strLocName]) then
				if StrGeocodeLocation(strLocName) == StrPlotQuotaX then break end
				iup.Flush()
			end
		end
		for strLocName, intLocCount in pairs(tblLocations) do
			tblMapMarker[strLocName] = ""
			if TblLocationData[strLocName] then
				if IsPlotted(TblLocationData[strLocName]) then
					strLatitude  = TblLocationData[strLocName]["lat"]
					strLongitude = TblLocationData[strLocName]["lng"]
					tblMapMarker[strLocName] = intMapMarker			-- Track the Map Marker number for each mapped Location
					local strFactsText = " recorded Fact"
					if intLocCount > 1 then strFactsText = strFactsText.."s" end
					strJavaLists = strJavaLists.."      LatLong["..intMapMarker.."] = new google.maps.LatLng("..strLatitude..", "..strLongitude..");\n"
					strJavaLists = strJavaLists.."      InfoWin["..intMapMarker.."] = '"..intLocCount..strFactsText.." at';\n"
					strJavaLists = strJavaLists.."      Caption["..intMapMarker.."] = '"..StrHTML_Encode(strLocName).."';\n"
					intMapMarker = intMapMarker + 1
					intLocTotal = intLocTotal + intLocCount
				end
			end
		end
		return intLocTotal
	end -- local function intJavaScriptLists

	-- Build Facts List linked to Map Markers for HTML
	local function strFactsList(tblFactLink)

		-- Comparison for table sort that returns true when 1st is less than 2nd
		local function isLessThan(tbl1st,tbl2nd)
			local intResult = tbl1st["Date"]:Compare(tbl2nd["Date"])
			if intResult == 0 then 							-- Dates equal so compare Index to retain original Fact order
				return tbl1st["Index"] < tbl2nd["Index"]	-- True if 1st Index < 2nd Index
			else
				return intResult == -1 						-- True if 1st Date < 2nd Date
			end
		end -- local function isLessThan

		local strFactList = ""
		local strFactData = ""
		local strLocName = ""
		for i,strFactLink in ipairs(tblFactLink) do
			strFactList = strFactList.."        <li>"..strFactLink.."</li>\n"
		end
		table.sort(tblFactsData,isLessThan) 				-- Sort Facts Data table by Date and Index
		for i,strEntry in ipairs(tblFactsData) do
			strFactData = StrHTML_Encode(strEntry["FactData"])
			strLocName = strEntry["LocName"]
			if strLocName and strLocName ~= "" then
				if tblMapMarker[strLocName] ~= "" then
					strFactData = "<a href='#' onclick='ZoomToMarker("..tblMapMarker[strLocName]..")'>"..strFactData.."</a>"
				end
			end
			strFactList = strFactList.."        <li>"..strFactData.."</li>\n"
		end
		return strFactList
	end -- local function strFactsList

	-- Insert Link in Featured Web Page
	local function doInsertLink(strWebFile,strMapFile,strIndName)
		local strLnkText = StrPlainText("<li><a href='"..strMapFile.."'>Map of Locations for "..strIndName.."</a></li>\n")
		strWebFile = strMapFolder..strWebFile
		local strWebPage = StrLoadFromFile(strWebFile)
		if not string.match(strWebPage,strLnkText) then -- Insert link to map file, including "See also" section if necessary
			strWebPage = strWebPage:gsub("("..StrDivContent..")("..StrH1Heading..")","%1"..StrDivSeeAlso..StrTxtSeeAlso..StrEndSeeAlso.."%2")
			strWebPage = strWebPage:gsub("("..StrTxtSeeAlso..")","%1"..strLnkText)
			SaveStringToFile(strWebPage,strWebFile)
		end
	end -- local function doInsertLink

	-- Output HTML Web Page Map
	local function strCreateWebPage(ptrIndi)
			local strRecordId	= fhGetRecordId(ptrIndi)
			local strIndName	= fhGetDisplayText(ptrIndi)
			local strMapFile	= "map"..strRecordId..".html"
			local tblFactLink	= {}
			local strWebPage	= " "
			if IsFamilyTreeWebsite() then
				-- If a Family Tree CD/Website featured Individual web page exists link to/from it
				local strIndFile = "ind"..strRecordId..".html"
				if FlgFileExists(strMapFolder..strIndFile) then
					tblFactLink[1] = "<a href='"..strIndFile.."'>Detailed Facts for "..strIndName.."</a>"
					-- Also need to link from Individual page
					doInsertLink(strIndFile,strMapFile,strIndName)
				end
				-- If any Family Tree CD/Website featured Family web pages exist link to/from them
				for i,strRecordId in ipairs(tblFamily) do
					local strFamFile = "fam"..strRecordId..".html"
					if FlgFileExists(strMapFolder..strFamFile) then
						tblFactLink[i] = "<a href='"..strFamFile.."'>Detailed Facts for "..strIndName.." and "..tblSpouse[i].."</a>"
						-- Also need to link from Family web page
						doInsertLink(strFamFile,strMapFile,strIndName)
					end
				end
			end
			strWebPage = StrMasterWeb
			strWebPage = strWebPage:gsub("{fhheaders}",StrPlainText(StrMapHeaders))
			strWebPage = strWebPage:gsub("{fhmenubar}",StrPlainText(StrMapMenubar))
			strWebPage = strWebPage:gsub("{titlename}",StrPlainText(strIndName),2)
			strWebPage = strWebPage:gsub("{javalists}",StrPlainText(strJavaLists))
			strWebPage = strWebPage:gsub("{factslist}",StrPlainText(strFactsList(tblFactLink)))
			strMapFile = strMapFolder..strMapFile
			SaveStringToFile(strWebPage,strMapFile)
			return strMapFile:gsub(StrPlainText(strMapFolder),"")
	end -- local function strCreateWebPage()

	-- Main body of StrCreateWebPageMap function starts here --

	local strMapState = ""
	local strIndi = fhGetItemText(ptrIndi,"~.NAME:SURNAME_FIRST") -- or fhGetDisplayText(ptrIndi)
	intFactIndex = 0
	tblFactsData	= {}
	tblLocations	= {}
	tblFamily		= {}
	if flagsOK(ptrIndi) then
		doProcessIndividual(ptrIndi)
		if intJavaScriptLists() > 0 then
			strMapState = strCreateWebPage(ptrIndi)
		else
			strMapState = StrMapOmitted
		end
	else
		strMapState = StrMapFiltered
	end
	return strMapState
end -- function StrCreateWebPageMap

-- Does folder contain FH Family Tree CD/Website files --
function IsFamilyTreeWebsite()
	if  FlgFileExists(StrFolder.."\\fhstyle.css")
	and FlgFileExists(StrFolder.."\\_nameindex.html") then
		return true
	else
		return false
	end
end -- function IsFamilyTreeWebsite()

-- Set default or FH Family Tree CD/Website headers & menubar --
function SetWebPageMapSections()
	-- Set default headers & menubar HTML sections
	local strHeaders = "    <meta http-equiv='content-type' content='text/html; charset=utf-8'>"
	local strMenubar = " "
	if IsFamilyTreeWebsite() then
		local tblNameIndex = {}
		-- Folder contains FH Family Tree CD/Website so map file needs FH headers & FH menubar
		local fileNameIndex = io.input(StrFolder.."\\_nameindex.html")
		for strLine in io.lines() do
			table.insert(tblNameIndex,strLine)		-- Read HTML file up to first <div class=...> in body
			if strLine:find("<div class=\"fhcontent fhpage_Index\">") then break end
		end
		io.close(fileNameIndex)
		local strNameIndex = table.concat(tblNameIndex,"\n")
		-- Extract headers script from between "</title>" and "</head>"
		strHeaders = strNameIndex:gsub(".-</title>(.-)</head>.*","%1")
		-- Extract menubar script from between "<body>" and "<div class="
		strMenubar = strNameIndex:gsub(".-<body.->(.-)<div class=.*","%1")
	end
	StrMapHeaders = strHeaders
	StrMapMenubar = strMenubar
end -- function SetWebPageMapSections

-- Flag if GUI Window is Normal rather than Minimised or Maximised --
function IsNormalWindow(dialogGUI)
	-- tblScrn[1] = origin x, tblScrn[2] = origin y, tblScrn[3] = width, tblScrn[4] = height
	local tblPosn = dialogGUI.screenposition:SplitNumbers()
	local intPosX = tblPosn[1]
	local intPosY = tblPosn[2]
	if intPosX < 0 and intPosY < 0 then						-- If origin is negative (-8, -8 = Maximised, -3200, -3200 = Minimised)
		return false												-- then is Maximised or Minimised
	end
	return true
end -- function IsNormalWindow

-- GUI Font Face & Style Dialogue --
function GUI_FontDialogue(intFontSet)

	-- Note: Pixel sizes -21 = -20 & -17 = -16 & -14 = -13 and pixel sizes -22, -18 & -13 have no point size equivalent.
	local tblFontSet = {}			-- Lookup table for StrFontHead and StrFontBody font sets
	tblFontSet[IntFontPlain]		=	{ Head=StrFontFace..", Bold -16",	Body=StrFontFace..",      -16", }
	tblFontSet[IntFontBold]		=	{ Head=StrFontFace..", Bold -16",	Body=StrFontFace..", Bold -15", }
	tblFontSet[IntArialPlain]		=	{ Head="Arial,         Bold -16",	Body="Arial,              -16", }
	tblFontSet[IntArialBold]		=	{ Head="Arial,         Bold -16",	Body="Arial,         Bold -15", }
	tblFontSet[IntTahomaPlain]	=	{ Head="Tahoma,        Bold -15",	Body="Tahoma,             -16", }
	tblFontSet[IntTahomaBold]		=	{ Head="Tahoma,        Bold -15",	Body="Tahoma,        Bold -14", }

	-- Assign font set global variables
	local function doAssignFontSet(intFontSet)
		IntFontSet = intFontSet
		StrFontHead = tblFontSet[intFontSet]["Head"] -- Font for all GUI dialog header text
		StrFontBody = tblFontSet[intFontSet]["Body"] -- Font for all GUI dialog body text
	end -- local function doAssignFontSet

	-- If parameter exists, simply set it as current font set
	if intFontSet then doAssignFontSet(intFontSet) return end

	local strAnswer = "Change"

	local strFontPlainTitle	= StrFontFace.." Plain"
	local strFontBoldTitle		= StrFontFace.." Bold"
	local strArialPlainTitle	= "Arial Plain"
	local strArialBoldTitle	= "Arial Bold"
	local strTahomaPlainTitle	= "Tahoma Plain"
	local strTahomaBoldTitle	= "Tahoma Bold"

	-- Create each GUI label and button with title and tooltip
	local	lblHeadName		= iup.label	{ title=" Name :"				, tip="Names of the available Fonts"				, }
	local	lblHeadPlain		= iup.label	{ title=" Plain :"				, tip="Plain versions of the Fonts"					, }
	local	lblHeadBold		= iup.label	{ title=" Bold :"				, tip="Bold versions of the Fonts"					, }
	local	lblFontName		= iup.label	{ title="Font "..StrFontFace	, tip="Default Windows fontface"					, }
	local	btnFontPlain		= iup.button	{ title=strFontPlainTitle		, tip="Choose "..strFontPlainTitle.." style"		, }
	local	btnFontBold		= iup.button	{ title=strFontBoldTitle		, tip="Choose "..strFontBoldTitle.." style"		, }
	local	lblArialName		= iup.label	{ title="Font Arial"			, tip="Arial alternative fontface"					, }
	local	btnArialPlain	= iup.button	{ title=strArialPlainTitle	, tip="Choose "..strArialPlainTitle.." style"	, }
	local	btnArialBold		= iup.button	{ title=strArialBoldTitle		, tip="Choose "..strArialBoldTitle.." style"		, }
	local	lblTahomaName	= iup.label	{ title="Font Tahoma"			, tip="Tahoma alternative fontface"					, }
	local	btnTahomaPlain	= iup.button	{ title=strTahomaPlainTitle	, tip="Choose "..strTahomaPlainTitle.." style"	, }
	local	btnTahomaBold	= iup.button	{ title=strTahomaBoldTitle	, tip="Choose "..strTahomaBoldTitle.." style"	, }
	local	lblChoose			= iup.label	{ title="Choose your interface font style or"										, }
	local	btnClose			= iup.button	{ title="Close"					, tip="Close this Font Style window"				, }

	-- Create dialogue and turn off resize, maximize, minimize, and menubox except Close button
	local	dialogFont		= iup.dialog { title=StrPlugin.." Font Style", dialogframe="YES", background=StrWhite, startfocus=btnClose,
										iup.vbox { alignment="ACENTER", gap=StrGap, margin=StrBigMargin,
											iup.frame { font=StrFontHead, fgcolor=StrBlack, active="YES", title="Font Style",
												iup.vbox { margin=StrMinMargin,
													iup.hbox { homogeneous="YES", lblHeadName,	lblHeadPlain,	lblHeadBold,		},
													iup.hbox { homogeneous="YES", lblFontName,	btnFontPlain,	btnFontBold,		},
													iup.hbox { homogeneous="YES", lblArialName,	btnArialPlain,	btnArialBold,	},
													iup.hbox { homogeneous="YES", lblTahomaName,	btnTahomaPlain,	btnTahomaBold,	},
													iup.hbox { lblChoose, btnClose, },
												},
											},
										},
										move_cb	= function(self,x,y) IntDataX=x IntDataY=y end,
										close_cb	= function() strAnswer="Ignore" return iup.CLOSE end,
									}

	-- Assign font styles for GUI labels and buttons
	local strFontPlain		= tblFontSet	[IntFontPlain]	["Body"]
	local strFontBold		= tblFontSet	[IntFontBold]	["Body"]
	local strArialPlain		= tblFontSet	[IntArialPlain]	["Body"]
	local strArialBold		= tblFontSet	[IntArialBold]	["Body"]
	local strTahomaPlain	= tblFontSet	[IntTahomaPlain]["Body"]
	local strTahomaBold		= tblFontSet	[IntTahomaBold]	["Body"]

	-- Set other GUI attributes for labels and buttons
	for iupName, tblAttr in pairs( {
		-- Control		=	1~fgcolor	, 2~font			, 3~FontSet		, 4~action function()
		[lblHeadName]	= { StrBlack	, StrFontBody	, false			, false	},
		[lblHeadPlain]	= { StrBlack	, strFontPlain	, false			, false	},
		[lblHeadBold]	= { StrBlack	, strFontBold	, false			, false	},
		[lblFontName]	= { StrBlack	, strFontPlain	, false			, false	},
		[btnFontPlain]	= { StrGreen	, strFontPlain	, IntFontPlain	, false	},
		[btnFontBold]	= { StrGreen	, strFontBold	, IntFontBold	, false	},
		[lblArialName]	= { StrBlack	, strArialPlain	, false			, false	},
		[btnArialPlain]	= { StrGreen	, strArialPlain	, IntArialPlain	, false	},
		[btnArialBold]	= { StrGreen	, strArialBold	, IntArialBold	, false	},
		[lblTahomaName]	= { StrBlack	, strTahomaPlain, false			, false	},
		[btnTahomaPlain]= { StrGreen	, strTahomaPlain, IntTahomaPlain, false	},
		[btnTahomaBold]	= { StrGreen	, strTahomaBold	, IntTahomaBold	, false	},
		[lblChoose]		= { StrBlack	, StrFontBody	, false			, false	},
		[btnClose]		= { StrRed	, StrFontBody	, false			, dialogFont.close_cb },
		} ) do
		iupName.expand	= "YES"
		iupName.fgcolor	= tblAttr[1]
		iupName.font		= tblAttr[2]
		if tblAttr[3] then
			if tblAttr[3] == IntFontSet then iupName.active = "NO" end	-- Disable button for currently selected font
			iupName.action = function() doAssignFontSet(tblAttr[3]) return iup.CLOSE end
		end
		if tblAttr[4] then iupName.action = tblAttr[4] end
	end

	dialogFont:popup(IntDataX,IntDataY)

	if (iup.MainLoopLevel()==0) then iup.MainLoop() end

	return strAnswer
end -- function GUI_FontDialogue

-- GUI Help & Advice Dialogue --
function GUI_HelpDialogue(strOrigin)

	local function doActivateMainHelpButton()
		if BtnMainHelp then BtnMainHelp.active = "YES" end
	end -- local function doActivateMainHelpButton

	-- create the WebBrowser based on its ProgID and connect it to LuaCOM
	local	oleControl = iup.olecontrol{ "Shell.Explorer.1", designmode="NO", }
			oleControl:CreateLuaCOM()

	-- Create each GUI button with title and tooltip
	local	btnIntro	= iup.button	{ title="Introduction"		, tip="Introduction Page for Help and Advice"	, }
	local	btnGoogle	= iup.button	{ title="Google Geocoder"	, tip="Google Maps Geocoder Help and Advice"		, }
	local	btnGeoLoc	= iup.button	{ title="Geocode Plots"	, tip="Geocode Location Plots Help and Advice"	, }
	local	btnCreate	= iup.button	{ title="Create Web Maps"	, tip="Create Web Page Maps Help and Advice"		, }
	local	btnSample	= iup.button	{ title="Web Page Map"		, tip="Example Web Page Map Help and Advice"		, }
	local	btnPrefer	= iup.button	{ title="Set Preferences"	, tip="Preferences and Options Help and Advice"	, }
	local	btnClose	= iup.button	{ title="Close Window"		, tip="Close this Help and Advice window"			, }

	-- The following controls are global to allow Main GUI to alter font and restore default position
	HboxHelp		=	iup.hbox { font=StrFontBody, margin=StrMinMargin, homogeneous="YES", btnIntro, btnGoogle, btnGeoLoc, btnCreate, btnSample, btnPrefer, btnClose, }
	DialogHelp	=	iup.dialog { title=StrPlugin.." Help & Advice", background=StrWhite, startfocus=btnClose, rastersize=StrHelpS,
							iup.vbox { alignment="ACENTER", margin=StrBigMargin, expandchildren="YES",
								oleControl,
								HboxHelp,
							},
							move_cb	= function(self,x,y) if IsNormalWindow(self) then IntHelpX=x IntHelpY=y end end,
							resize_cb	= function(self) if IsNormalWindow(self) then StrHelpS=self.rastersize end end,
							close_cb	= function() doActivateMainHelpButton() end,
						}

	local strFHUG = "http://www.fhug.org.uk/wiki/doku.php?id=plugins:help:map_life_facts:"
	local tblFHUG = {"map_life_facts","google_maps_geocoder","geocode_location_plots","create_web_page_maps","web_page_map","set_preference_options"}

	-- Set other GUI control attributes
	for iupName, tblAttr in pairs( {
		-- Control	=	1~fgcolor	, 2~URL	, 3~action function()
		[btnIntro]	= { StrGreen	,	1		, false },
		[btnGoogle]	= { StrGreen	,	2		, false },
		[btnGeoLoc]	= { StrGreen	,	3		, false },
		[btnCreate]	= { StrGreen	,	4		, false },
		[btnSample]	= { StrGreen	,	5		, false },
		[btnPrefer]	= { StrGreen	,	6		, false },
		[btnClose]	= { StrRed	, false	, function() DialogHelp:destroy() doActivateMainHelpButton() end }
		} ) do
		iupName.expand	= "HORIZONTAL"
		iupName.size		= "x10"
		iupName.fgcolor	= tblAttr[1]
		if tblAttr[2] then iupName.action = function() oleControl.com:Navigate(strFHUG..tblFHUG[tblAttr[2]]) end end
		if tblAttr[3] then iupName.action = tblAttr[3] end
	end

	DialogHelp:showxy(IntHelpX,IntHelpY)		-- Show Help GUI window
	DialogHelp.rastersize=nil						-- Allow window to be resized	nil = iup.NULL

	if not strOrigin then strOrigin = "facts" end
	for intFHUG = 1, #tblFHUG do
		local strFHUG = tblFHUG[intFHUG]
		if strFHUG:match(strOrigin) then
			strOrigin = strFHUG
			break
		end
	end
	oleControl.com:Navigate(strFHUG..strOrigin)

	if (iup.MainLoopLevel()==0) then iup.MainLoop() end

end -- function GUI_HelpDialogue

-- GUI Warning Prompt Dialogue --
function GUI_WarnDialogue(strHead,strText)

	local strAnswer = "Close"

	-- Create the GUI buttons
	local	btnYes		= iup.button	{ expand="YES", fgcolor=StrGreen, title="Yes", tip="Accept the operation", action=function() strAnswer="Yes"	return iup.CLOSE end, }
	local	btnNo		= iup.button	{ expand="YES", fgcolor=StrRed	, title="No" , tip="Reject the operation", action=function() strAnswer="No"	return iup.CLOSE end, }

	-- Create dialogue and turn off resize, maximize, minimize, and menubox except Close button
	local	dialogWarn = iup.dialog { title=StrPlugin.."  "..strHead, dialogframe="YES", background=StrWhite, startfocus=btnNo,
								iup.vbox { alignment="ACENTER", gap=StrGap, margin=StrBigMargin,
									iup.frame { font=StrFontHead, fgcolor=StrAmber, title=strHead,
										iup.vbox { font=StrFontBody, fgcolor=StrBlack,
											iup.label { title=strText, tip="Description of operation to accept or reject", },
											iup.hbox { btnYes, btnNo, margin=StrMinMargin, homogeneous="YES", },
										},
									},
								},
							move_cb	= function(self,x,y) IntDataX=x IntDataY=y end,
							close_cb	= function() strAnswer="Close" end,
							}

	if iup.MainLoopLevel() == 0 then	-- called from outside Main GUI, so must use showxy() instead of popup()
		dialogWarn:showxy(IntDataX,IntDataY)
	else
		dialogWarn:popup(IntDataX,IntDataY)
	end

	if (iup.MainLoopLevel()==0) then iup.MainLoop() end
	dialogWarn:destroy()
	return strAnswer
end -- function GUI_WarnDialogue

-- GUI Some Plots Prompt Dialogue --
function GUI_PlotDialogue(tblPlotCounts)
	local intButton = 0
	local isConfirm = true
	local iupButtons = iup.vbox { gap=StrGap, margin=StrMinMargin, homogeneous="YES", }
	-- Create the GUI buttons
	for intAttr, tblAttr in ipairs( {
		-- 2~index			, 1~title							, 3~tip
		{ IntPlotLatLong	, " Plotted Locations"			, "Re-plot the Plotted Locations"	},
		{ IntPlotManual		, " Manual plot Locations"	, "Plot the Manual plot Locations"	},
		{ IntPlotNoPlot		, " No Plot Locations"			, "Plot the No Plot Locations"		},
		{ IntPlotInvalid	, " Invalid Locations"			, "Plot the Invalid Locations"		},
		{ IntPlotNoData		, " No Data Locations"			, "Plot the No Data Locations"		},
		} ) do
		local intIndex = tblAttr[1]						-- Index to Plot Counts and Status Color tables
		local intPlots = tblPlotCounts[intIndex]
		local strTitle = "Geocode Plot the "..intPlots..tblAttr[2]
		if intPlots == 1 then strTitle = strTitle:gsub("Locations","Location") end
		local btnButton = iup.button{ title=strTitle, tip=tblAttr[3], expand="YES", fgcolor=TblStatusColor[intIndex], action=function() intButton=intIndex return iup.CLOSE end }
		if intPlots == 0 then
			btnButton.active="NO"
			btnButton.font=StrFontBody:gsub(" %-"," Strikeout -")
		end
		iup.Append(iupButtons,btnButton)
	end
	local tglConfirm = iup.toggle { expand="YES", title="Confirm Every Location Geocode Plot?", tip="Choose whether each Location is plotted selectively or unconditionally", value="ON", rightbutton="YES", action=function(self,intState) isConfirm=(intState==1) end }
	local strHead = "Geocode Plot Some Locations"
	local strText = "Choose the class of Locations to Geocode Plot"
	-- Create dialogue and turn off resize, maximize, minimize, and menubox except Close button
	local	dialogPlot = iup.dialog { title=StrPlugin.."  "..strHead, dialogframe="YES", background=StrWhite, startfocus=tglConfirm,
								iup.vbox { alignment="ACENTER", gap=StrGap, margin=StrBigMargin,
									iup.frame { font=StrFontHead, fgcolor=StrBlack, title=strHead,
										iup.vbox { font=StrFontBody, fgcolor=StrBlack, gap=StrGap, margin=StrMinMargin,
											iup.label { rastersize="350x30", title=strText..":", tip=strText, },
											iupButtons, tglConfirm,
										},
									},
								},
							move_cb	= function(self,x,y) IntDataX=x IntDataY=y end,
							close_cb	= function() intButton=0 end,
							}
	dialogPlot:popup(IntDataX,IntDataY)
	if (iup.MainLoopLevel()==0) then iup.MainLoop() end
	dialogPlot:destroy()
	return intButton, isConfirm
end -- function GUI_PlotDialogue

-- GUI Skip/Plot Location Prompt Dialogue --
function GUI_SkipDialogue(strClassColor)
	local isConfirm = true
	local isGeocode = true
	-- Create the GUI buttons
	local	btnPlotThis = iup.button { title="Plot this Location", tip="Plot selected Location"	, }
	local	btnSkipThis = iup.button { title="Skip this Location", tip="Skip selected Location"	, }
	local	btnPlotRest = iup.button { title="Plot all the Rest" , tip="Plot rest of Locations"	, }
	local	btnSkipRest = iup.button { title="Skip all the Rest" , tip="Skip rest of Locations"	, }

	-- Set other GUI button attributes
	for iupName, tblAttr in pairs( {
		-- Control		=	1~isConfirm	, 2~isGeocode
		[btnPlotThis]	= { true			, true  },
		[btnSkipThis]	= { true			, false },
		[btnPlotRest]	= { false			, true  },
		[btnSkipRest]	= { false			, false },
		} ) do
		iupName.expand	= "YES"
		iupName.fgcolor	= StrGreen
		iupName.action = function() isConfirm=tblAttr[1] isGeocode=tblAttr[2] return iup.CLOSE end
	end

	local strHead = "Geocode Plot Some Locations"
	local strText = "Choose which Locations to Geocode Plot"
	-- Create dialogue and turn off resize, maximize, minimize, and menubox except Close button
	local	dialogSkip = iup.dialog { title=StrPlugin.."  "..strHead, dialogframe="YES", background=StrWhite, startfocus=btnPlotThis,
								iup.vbox { alignment="ACENTER", gap=StrGap, margin=StrBigMargin,
									iup.frame { font=StrFontHead, fgcolor=StrBlack, title=strHead,
										iup.vbox { font=StrFontBody, fgcolor=strClassColor, gap=StrGap, margin=StrMinMargin,
											iup.label { rastersize="350x30", title=strText..":", tip=strText, },
											iup.hbox { btnPlotThis, btnSkipThis, homogeneous="YES", },
											iup.hbox { btnPlotRest, btnSkipRest, homogeneous="YES", },
										},
									},
								},
							move_cb	= function(self,x,y) IntDataX=x IntDataY=y end,
							close_cb	= function() end,
							}
	dialogSkip:popup(IntDataX,IntDataY)
	if (iup.MainLoopLevel()==0) then iup.MainLoop() end
	dialogSkip:destroy()
	return isConfirm, isGeocode
end -- function GUI_SkipDialogue

-- GUI Progress Bar Table Structure --
ProgressBar = {

	Start = function(strTitle,intMax)																-- Create & start Progress Bar window
		if not DlgGauge then
			IsBarStop = false
			IntStart = os.time()
			IntDelta = 0
			StrClock = "00:00:00"
			local	btnStop	= iup.button	{ title="Stop "..strTitle, font=StrFontBody, rastersize="200x30", fgcolor=StrRed, action=function() IsBarStop = true end, }	-- Signal Stop button pressed	return iup.CLOSE -- Often caused main GUI to close !!!
					BarGauge	= iup.progressbar { rastersize="400x30", value=0, max=intMax, }	-- Progress bar maximum range
					LblText	= iup.label	{ title=" ", expand="YES", alignment="ACENTER", tip="Percentage and Time Elapsed", }
					DlgGauge	= iup.dialog	{ title=strTitle.." Progress", dialogframe="YES", background=StrWhite, -- Remove Windows minimize/maximize menu
										iup.vbox{ alignment="ACENTER", gap="10", margin=StrBigMargin,
											LblText,
											BarGauge,
											btnStop,
										},
										move_cb	= function(self,x,y) IntDataX=x IntDataY=y end,
										close_cb	= btnStop.action,									-- Windows Close button = Stop button
									}
			DlgGauge:showxy(IntDataX,IntDataY)														-- Show the Progress Bar window
		end
	end,

	SetText = function(strText)																		-- Show the Progress text message
		if DlgGauge then LblText.title = strText end
	end,

	Step = function(intStep)																			-- Step the Progress Bar forward
		if DlgGauge then
			local intVal = tonumber(BarGauge.value)
			local intMax = tonumber(BarGauge.max)
			intVal = intVal + intStep
			if intVal > intMax then intVal = intMax end											-- Ensure value does not exceed maximum
			BarGauge.value = intVal
			local intDelta = os.difftime(os.time(),IntStart)
			if IntDelta < intDelta then																-- Update clock of elapsed time
				IntDelta = intDelta
				local intHour = math.floor( intDelta / 3600 )
				local intMins = math.floor( intDelta / 60 - intHour * 60 )
				local intSecs = intDelta - intMins * 60 - intHour * 3600
				StrClock = string.format("%02d : %02d : %02d",intHour,intMins,intSecs)
			end
			LblText.title = string.format("%4d %%      %s ", math.floor( intVal / intMax * 100 ), StrClock) -- Display % and clock progress
			iup.LoopStep()
		end
	end,

	Reset = function()																					-- Reset the Progress Bar
		if DlgGauge then BarGauge.value = 0 end
	end,

	Stop = function()																					-- Check if Stop button pressed
		return IsBarStop
	end,

	Close = function()																					-- Close the Progress Bar window
		IsBarStop = false
		if DlgGauge then DlgGauge:destroy() DlgGauge = nil end
	end,

} -- end ProgressBar

-- GUI Main Dialogue --
function GUI_MainDialogue()

	-- Create the Geocode Location Plots controls with title/value and tooltip, etc
	local	btnPlotAll	= iup.button	{ title="Geocode Plot All Locations"	, tip="Geocode Plot all the Location entries", }
	local	btnPlotSome	= iup.button	{ title="Geocode Plot Some Locations"	, tip="Geocode Plot selected Location entries", }
	local	btnPlotThis	= iup.button	{ title="Geocode Plot This Location"	, tip="Geocode Plot the displayed Location entry", }

	local	lblPlotStats	= iup.label	{ title="Statistics:"					, tip="Geocoder Plot Locations Database Statistics", }
	local	lblPlotted	= iup.label	{ title=" "								, tip="Number of Locations with Geocoded Latitude/Longitude", }
	local	lblManual		= iup.label	{ title=" "								, tip="Number of Locations with Manual Latitude/Longitude", }
	local	lblNoPlot		= iup.label	{ title=" "								, tip="Number of Locations with No Plot Found by Geocoder", }
	local	lblInvalid	= iup.label	{ title=" "								, tip="Number of Locations with Invalid Request/Request Denied from Geocoder", }
	local	lblNoData		= iup.label	{ title=" "								, tip="Number of Locations not submitted to Geocoder", }
	local	lblPlotTotal	= iup.label	{ title=" "								, tip="Number of Locations listed in total", }

	local	lblLocation	= iup.label	{ title="Location:"						, tip="Select any Location to manage its Database entry", }
	local	txtLocation	= iup.text	{ value=" "	, visible="NO"			, tip="Select any Location to manage its Database entry", }
	local	btnLocation	= iup.button	{ title=" "	, floating="YES"		, tip="Select any Location to manage its Database entry", }
	local	lblSubstitute= iup.label	{ title="Substitute:"					, tip="Substitute a modern or alternative Location for this Database entry", }
	local	txtSubstitute= iup.text	{ value=" "								, tip="Substitute a modern or alternative Location for this Database entry", }
	local	lblLatitude	= iup.label	{ title="Latitude:"						, tip="Latitude for chosen Location Database entry \n from -90° S.Pole to +90° N.Pole"	, }
			TxtLatitude	= iup.text	{ value=" "								, tip="Latitude for chosen Location Database entry \n from -90° S.Pole to +90° N.Pole"	, }
	local	lblLongitude	= iup.label	{ title="Longitude:"					, tip="Longitude for chosen Location Database entry \n from -180° West to +180° East", }
			TxtLongitude	= iup.text	{ value=" "								, tip="Longitude for chosen Location Database entry \n from -180° West to +180° East", }

	local	btnLocToSub	= iup.button	{ title=" Copy Location\n  to Substitute", tip="Copy the Location text field to the Substitute text field of this entry", }
	local	btnClearAll	= iup.button	{ title=" Clear This Entry"			, tip="Clear the Substitute, Latitude, and Longitude values of this entry", }
	local	btnClearSub	= iup.button	{ title=" Clear Substitute"			, tip="Clear the Substitute value of this entry", }
	local	btnClearLat	= iup.button	{ title=" Clear Latitude"				, tip="Clear the Latitude value of this entry", }
	local	btnClearLng	= iup.button	{ title=" Clear Longitude"			, tip="Clear the Longitude value of this entry", }

	local	btnNextPlot	= iup.button	{ title="Next Plotted"					, tip="Show the succeeding (Alt=preceding) \n Plotted Lat/Lng Location entry, both Geocode and Manual", }
	local	btnNextManual= iup.button	{ title="Next Manual"					, tip="Show the succeeding (Alt=preceding) \n Nudged or Manually Plotted Lat/Lng Location entry", }
	local	btnNextSubs	= iup.button	{ title="Next Substitute"				, tip="Show the succeeding (Alt=preceding) \n Substituted Location entry, both Plotted and Unplotted", }
	local	btnNextUnplot= iup.button	{ title="Next Unplotted"				, tip="Show the succeeding (Alt=preceding) \n Unplotted Location entry (No Plot, Invalid, or No Data)", }

	local	btnMoveNorth	= iup.button	{ title="N"								, tip="Nudge the Latitude North dependent on Zoom \n (maximum +90° N.Pole)", }
	local	btnMoveSouth	= iup.button	{ title="S"								, tip="Nudge the Latitude South dependent on Zoom \n (minimum -90° S.Pole)", }
	local	btnMoveWest	= iup.button	{ title="W"								, tip="Nudge the Longitude West dependent on Zoom \n (minimum -180° West)", }
	local	btnMoveEast	= iup.button	{ title="E"								, tip="Nudge the Longitude East dependent on Zoom \n (maximum +180° East)", }

	-- Create the Create Web Page Maps controls with title/value and tooltip, etc
	local	btnMapAll		= iup.button	{ title="Map All Individuals"		, tip="Create the Web Page Maps for all the Individuals", }
	local	btnMapSome	= iup.button	{ title="Map Some Individuals"		, tip="Create the Web Page Maps for selected Individuals", }
	local	btnMapThis	= iup.button	{ title="Map This Individual"		, tip="Create a Web Page Map for the displayed Individual", }

	local	lblMapStats	= iup.label	{ title="Statistics:"					, tip="Mapped Individuals Statistics", }
	local	lblMapped		= iup.label	{ title=" "								, tip="Number of Individuals with Web Page Maps", }
	local	lblOmitted	= iup.label	{ title=" "								, tip="Number of Individuals without any Facts with Plotted Locations", }
	local	lblFiltered	= iup.label	{ title=" "								, tip="Number of Individuals excluded by the Privacy Filter", }
	local	lblNoMap		= iup.label	{ title=" "								, tip="Number of Individuals without Web Page Maps", }
	local	lblMapTotal	= iup.label	{ title=" "								, tip="Number of Individuals listed in total", }

	local	lblIndiName	= iup.label	{ title="Individual:"					, tip="Select any Individual [Record Id] to manage the Web Page Map", }
	local	txtIndiName	= iup.text	{ value=" "	, visible="NO"			, tip="Select any Individual [Record Id] to manage the Web Page Map", }
	local	btnIndiName	= iup.button	{ title=" "	, floating="YES"		, tip="Select any Individual [Record Id] to manage the Web Page Map", }
	local	lblMapState	= iup.label	{ title="Map:"							, tip="Web Page Map filename or Omitted/Filtered status", }
	local	txtMapState	= iup.text	{ value=" "	, readonly="YES"		, tip="Web Page Map filename or Omitted/Filtered status", }

	local	btnDeleteMap	= iup.button	{ title="Delete This Map"				, tip="Delete this Web Page Map file from the current Maps Folder", }
	local	btnPrevUnmap	= iup.button	{ title="Prior Unmapped"				, tip="Show the preceding Individual without a Web Page Map file", }
	local	btnNextUnmap	= iup.button	{ title="Next  Unmapped"				, tip="Show the succeeding Individual without a Web Page Map file", }
	local	btnPrevMapped= iup.button	{ title="Prior Mapped"					, tip="Show the preceding Individual with a Web Page Map file", }
	local	btnNextMapped= iup.button	{ title="Next  Mapped"					, tip="Show the succeeding Individual with a Web Page Map file", }

	-- Create the Set Preference Options controls with title/value and tooltip, etc
	local	tglGeoCode	= iup.toggle	{ title=StrGeoCodeTitle..":"			, tip="Recognise Country/State/Chapman Codes \n and other plotting enhancements", value=StrGeoCode, rightbutton="YES", }
	local	lblRegBias	= iup.label	{ title=StrRegBiasTitle..":"			, tip="Choose region biasing top level domain code for Geocoder", }
	local	lstRegBias	= iup.list	{ value=IntRegBias						, tip="Choose region biasing top level domain code for Geocoder", dropdown="YES", visible_items="30", visiblecolumns="22", }

	local	lblLocZoom	= iup.label	{ title=StrMapZoomTitle..":"			, tip="Current default Zoom level for the Geocode Location Plots Google Map", }
	local	txtLocZoom	= iup.text	{ value=IntLocZoom, readonly="YES"	, tip="Current default Zoom level for the Geocode Location Plots Google Map", }
	local	lblFromTag	= iup.label	{ title=StrFromTagTitle..":"			, tip="Choose Place or Address or both Address…Place fields for Locations", }
	local	lstFromTag	= iup.list	{ value=IntFromTag						, tip="Choose Place or Address or both Address…Place fields for Locations", dropdown="YES", visible_items="9", }
	for i = IntFromPLAC, IntFrom_A__P_ do lstFromTag[i] = TblFromName[i] end			-- Add the dropdown list values
	local	lblStorage	= iup.label	{ title=StrStorageTitle..":"			, tip="Select the storage option for the Locations Database", }
	local	lstStorage	= iup.list	{ value=IntStorage						, tip="Select the storage option for the Locations Database", dropdown="YES", "Plugin Data Folder", "Repository Records", "Source Records", "Source & Repository", }
	local	timStorage	= iup.timer	{ time=200, run="NO", }

	local	strMapFolder	= "Select the Output Folder for Web Page Maps, and if a\nFamily Tree CD/Website folder then Maps will be integrated"
	local	lblMapFolder	= iup.label	{ title="Folder:"						, tip=strMapFolder, }
	local	txtMapFolder	= iup.text	{ value=StrFolder						, tip=strMapFolder, multiline="YES", visiblelines="2", wordwrap="YES", expand="HORIZONTAL", }
	local	btnMapFolder	= iup.button	{ title="Set Maps Folder"				, tip=strMapFolder, }
	local	btnDeleteAll	= iup.button	{ title="Delete All Maps"				, tip="Delete ALL Web Page Map files from the selected Folder", }

	local	lblMapZoom	= iup.label	{ title=StrMapZoomTitle..":"			, tip="Current default Zoom level for a selected Web Page Map marker", }
	local	txtMapZoom	= iup.text	{ value=IntMapZoom, readonly="YES"	, tip="Current default Zoom level for a selected Web Page Map marker", }
	local	lblMarkers	= iup.label	{ title=StrMarkersTitle..":"			, tip="Select how Map Markers are initially placed on Web Page Maps", }
	local	lstMarkers	= iup.list	{ value=IntMarkers						, tip="Select how Map Markers are initially placed on Web Page Maps", dropdown="YES", "No Animation", "Synchro Drop", "Cascade Drop", }
	local	lblPrivacy	= iup.label	{ title=StrPrivacyTitle..":"			, tip="Exclude Individuals from Maps according to Privacy Flags", }
	local	lstPrivacy	= iup.list	{ value=IntPrivacy						, tip="Exclude Individuals from Maps according to Privacy Flags", dropdown="YES", "Living Flags", "Private Flags", "Living & Private", "Switched Off", }

	local	btnCopyPLAC	= iup.button	{ title="Copy Place Database"		, tip="Copy ALL Substitute, Latitude, and Longitude values \n from the 'Place Fields only' Locations database \n into the '…Place only' Locations database", }
	local	btnCopyADDR	= iup.button	{ title="Copy Address Database"		, tip="Copy ALL Substitute, Latitude, and Longitude values \n from the 'Address Fields only' Locations database \n into the 'Address… only' Locations database", }
	local	btnPurgeBOTH	= iup.button	{ title="Purge Addr…Place Database"	, tip="Purge ALL Substitute, Latitude, and Longitude values \n not in current '"..TblFromName[IntFromTag].."' Locations data !!!", }

	local	btnErasePLAC	= iup.button	{ title="Erase Place Database"		, tip="Erase ALL Substitute, Latitude, and Longitude values \n from the 'Place Fields only' Locations database !!!", }
	local	btnEraseADDR	= iup.button	{ title="Erase Address Database"	, tip="Erase ALL Substitute, Latitude, and Longitude values \n from the 'Address Fields only' Locations database !!!", }
	local	btnEraseBOTH	= iup.button	{ title="Erase Addr…Place Database"	, tip="Erase ALL Substitute, Latitude, and Longitude values \n from the 'Address…Place' Locations database !!!", }

	local	btnDefault	= iup.button	{ title="Restore Defaults"			, tip="Restore default Settings for Window positions/sizes, \n Tab selection, "..StrGeoCodeTitle..", "..StrRegBiasTitle..", \n "..StrFromTagTitle..", Maps Output Folder, Quota Warning, \n "..StrMapZoomTitle..", "..StrMarkersTitle..", and "..StrPrivacyTitle.." options", }
	local	btnFontSet	= iup.button	{ title=StrFontSetTitle				, tip="Choose user interface window font style", }
	local	timPrefZoom	= iup.timer	{ time=900, run="NO", }

	-- Create the Main Dialogue Common controls with title/value and tooltip, etc
	local	lblStatus		= iup.label	{ title="Status:"						, tip="Plugin status messages", }
			LblMessage	= iup.label	{ title=" "								, tip="Plugin status messages", }
			BtnMainHelp	= iup.button	{ title="   Help && Advice"			, tip="Obtain online Help and Advice from the FHUG Knowledge Base", }
	local	timMainHelp	= iup.timer	{ time=200, run="NO", }
	local	btnClose		= iup.button	{ title="Close Plugin"					, tip="Close the Plugin", }
	local	timResize		= iup.timer	{ time=200, run="NO", }

	-- Create the WebBrowser based on its ProgID and connect it to LuaCOM
	OLEcontrol = iup.olecontrol { "Shell.Explorer.1", designmode="NO", }
	OLEcontrol:CreateLuaCOM()

	CloseGoogleMap() 	-- In case earlier instance is running
	OpenGoogleMap()		-- Uses WebBrowser OLEcontrol.com:Navigate

	local	strRight	= "ARIGHT:ABOTTOM"

	-- Set other GUI control attributes
	for iupName, tblAttr in pairs( {
		-- Control		=	1~fgcolor	, 2~alignment, 3~rastersz	, 4~active		Geocode Location Plots controls
		[btnPlotAll]		= { StrGreen	, false		, false		, false	},
		[btnPlotSome]	= { StrGreen	, false		, false		, false	},
		[btnPlotThis]	= { StrGreen	, false		, false		, false	},

		[lblPlotStats]	= { StrBlack	, strRight	, "076"		, "YES"	},
		[lblPlotted]		= { TblStatusColor[IntPlotLatLong]
											, "ACENTER"	, false		, "YES"	},
		[lblManual]		= { TblStatusColor[IntPlotManual]
											, "ACENTER"	, false		, "YES"	},
		[lblNoPlot]		= { TblStatusColor[IntPlotNoPlot]
											, "ACENTER"	, false		, "YES"	},
		[lblInvalid]		= { TblStatusColor[IntPlotInvalid]
											, "ACENTER"	, false		, "YES"	},
		[lblNoData]		= { TblStatusColor[IntPlotNoData]
											, "ACENTER"	, false		, "YES"	},
		[lblPlotTotal]	= { TblStatusColor[IntPlotSumTotal]
											, "ACENTER"	, false		, "YES"	},

		[lblLocation]	= { StrBlack	, strRight	, "076"		, "YES"	},
		[txtLocation]	= { StrGreen	, false		, false		, "NO"		},
		[btnLocation]	= { StrGreen	, "ALEFT"		, false		, "YES"	},
		[lblSubstitute]	= { StrBlack	, strRight	, "076"		, "YES"	},
		[txtSubstitute]	= { StrGreen	, false		, false		, false	},
		[lblLatitude]	= { StrBlack	, strRight	, "076"		, "YES"	},
		[TxtLatitude]	= { StrGreen	, false		, false		, false	},
		[lblLongitude]	= { StrBlack	, strRight	, "076"		, "YES"	},
		[TxtLongitude]	= { StrGreen	, false		, false		, false	},

		[btnLocToSub]	= { StrGreen	, false		, "130x58"	, false	},
		[btnClearAll]	= { StrGreen	, "ALEFT"		, "130"		, false	},
		[btnClearSub]	= { StrGreen	, "ALEFT"		, "130"		, false	},
		[btnClearLat]	= { StrGreen	, "ALEFT"		, "130"		, false	},
		[btnClearLng]	= { StrGreen	, "ALEFT"		, "130"		, false	},

		[btnNextPlot]	= { StrGreen	, false		, "130"		, false	},
		[btnNextManual]	= { StrGreen	, false		, "130"		, false	},
		[btnNextSubs]	= { StrGreen	, false		, "130"		, false	},
		[btnNextUnplot]	= { StrGreen	, false		, "130"		, false	},

		[btnMoveNorth]	= { StrGreen	, false		, "020"		, false	},
		[btnMoveSouth]	= { StrGreen	, false		, "020"		, false	},
		[btnMoveWest]	= { StrGreen	, false		, "020"		, false	},
		[btnMoveEast]	= { StrGreen	, false		, "020"		, false	},

		-- Control		=	1~fgcolor	, 2~alignment, 3~rastersz	, 4~active		Create Web Page Maps controls
		[btnMapAll]		= { StrGreen	, false		, false		, false	},
		[btnMapSome]		= { StrGreen	, false		, false		, false	},
		[btnMapThis]		= { StrGreen	, false		, false		, false	},

		[lblMapStats]	= { StrBlack	, strRight	, "076"		, "YES"	},
		[lblMapped]		= { TblStatusColor[IntMapFilename]
											, "ACENTER"	, false		, "YES"	},
		[lblOmitted]		= { TblStatusColor[IntMapOmitted]
											, "ACENTER"	, false		, "YES"	},
		[lblFiltered]	= { TblStatusColor[IntMapFiltered]
											, "ACENTER"	, false		, "YES"	},
		[lblNoMap]		= { TblStatusColor[IntMapNoMap]
											, "ACENTER"	, false		, "YES"	},
		[lblMapTotal]	= { TblStatusColor[IntMapSumTotal]
											, "ACENTER"	, false		, "YES"	},

		[lblIndiName]	= { StrBlack	, strRight	, "076"		, "YES"	},
		[txtIndiName]	= { StrGreen	, false		, false		, "NO"		},
		[btnIndiName]	= { StrBlack	, "ALEFT"		, false		, "YES"	},
		[lblMapState]	= { StrBlack	, strRight	, "076"		, "YES"	},
		[txtMapState]	= { StrBlack	, false		, false		, "YES"	},

		[btnDeleteMap]	= { StrRed	, false		, "130"		, false	},
		[btnPrevMapped]	= { StrGreen	, false		, "130"		, false	},
		[btnNextMapped]	= { StrGreen	, false		, "130"		, false	},
		[btnPrevUnmap]	= { StrGreen	, false		, "130"		, false	},
		[btnNextUnmap]	= { StrGreen	, false		, "130"		, false	},

		-- Control		=	1~fgcolor	, 2~alignment, 3~rastersz	, 4~active		Set Preference Options controls
		[tglGeoCode]		= { StrGreen	, false		, "146"		, false	},
		[lblRegBias]		= { StrBlack	, strRight	, false		, false	},
		[lstRegBias]		= { StrGreen	, false		, false		, false	},

		[lblLocZoom]		= { StrBlack	, strRight	, false		, false	},
		[txtLocZoom]		= { StrBlack	, "ARIGHT"	, "025"		, false	},
		[lblFromTag]		= { StrBlack	, strRight	, false		, false	},
		[lstFromTag]		= { StrGreen	, false		, false		, false	},
		[lblStorage]		= { StrBlack	, strRight	, false		, false	},
		[lstStorage]		= { StrGreen	, false		, false		, false	},

		[lblMapFolder]	= { StrBlack	, strRight	, "076"		, "YES"	},
		[txtMapFolder]	= { StrGreen	, false		, "x60"		, "YES"	},
		[btnMapFolder]	= { StrGreen	, false		, "130"		, false	},
		[btnDeleteAll]	= { StrRed	, false		, "130"		, false	},

		[lblMapZoom]		= { StrBlack	, strRight	, false		, false	},
		[txtMapZoom]		= { StrBlack	, "ARIGHT"	, "025"		, false	},
		[lblMarkers]		= { StrBlack	, strRight	, false		, false	},
		[lstMarkers]		= { StrGreen	, false		, false		, false	},
		[lblPrivacy]		= { StrBlack	, strRight	, false		, false	},
		[lstPrivacy]		= { StrGreen	, false		, false		, false	},

		[btnCopyPLAC]	= { StrAmber	, false		, false		, false	},
		[btnCopyADDR]	= { StrAmber	, false		, false		, false	},
		[btnPurgeBOTH]	= { StrRed	, false		, false		, false	},

		[btnErasePLAC]	= { StrRed	, false		, false		, false	},
		[btnEraseADDR]	= { StrRed	, false		, false		, false	},
		[btnEraseBOTH]	= { StrRed	, false		, false		, false	},

		[btnDefault]		= { StrGreen	, false		, false		, false	},
		[btnFontSet]		= { StrGreen	, false		, false		, false	},

		-- Control		=	1~fgcolor	, 2~alignment, 3~rastersz	, 4~active		Main Dialogue Common controls
		[lblStatus]		= { StrBlack	, strRight	, "065"		, "YES"	},
		[LblMessage]		= { StrGreen	, "ALEFT"		, false		, "YES"	},
		[BtnMainHelp]	= { StrGreen	, false		, "130"		, false	},
		[btnClose]		= { StrRed	, false		, "130"		, false	},
		} ) do
		iupName.fgcolor	= tblAttr[1]
		if tblAttr[2] then iupName.alignment	= tblAttr[2] end
		if tblAttr[3] then iupName.rastersize	= tblAttr[3] else iupName.expand = "HORIZONTAL" end
		if tblAttr[4] then iupName.active		= tblAttr[4] end
	end

	-- Create the Geocode Location Plots layout
	local	vboxPlotEntry=	iup.vbox { margin="1x1",
									iup.hbox { gap=StrGap,
										iup.vbox { margin="0x0",
											iup.hbox { lblLocation, txtLocation, btnLocation, },
											iup.hbox { lblSubstitute, txtSubstitute, }, }, btnLocToSub, iup.vbox { margin="0x0", btnClearAll, btnClearSub, },	},											
									iup.hbox { gap=StrGap, lblLatitude,		TxtLatitude,	btnMoveNorth, btnMoveSouth,	btnNextPlot,		btnNextSubs,		btnClearLat,	},
									iup.hbox { gap=StrGap, lblLongitude,	TxtLongitude, btnMoveWest, btnMoveEast,	btnNextManual,	btnNextUnplot,	btnClearLng, },
								}
	local	vboxPlotData	=	iup.vbox { font=StrFontBody, margin=StrMinMargin,
									iup.hbox { gap=StrGap, lblPlotStats, iup.hbox{ lblPlotted, lblManual, lblNoPlot, lblInvalid, lblNoData, lblPlotTotal, homogeneous="YES", gap="0", }, margin="2x2", },
									vboxPlotEntry,
								}
	local	framePlotData=	iup.frame { font=StrFontHead, fgcolor=StrBlack, active="YES", title=" Manage Location Plots ",
									vboxPlotData,
								}
	local	vboxGeoLoc	=	iup.vbox { font=StrFontBody, alignment="ARIGHT", gap=StrGap,
									iup.hbox { gap="10", btnPlotAll, btnPlotSome, btnPlotThis, homogeneous="YES", margin="0x6", },
									framePlotData,
								}

	-- Create the Create Web Page Maps layout
	local	vboxMapData	=	iup.vbox { font=StrFontBody, margin=StrMinMargin,
									iup.hbox { gap=StrGap, lblMapStats, iup.hbox{ lblMapped, lblOmitted, lblFiltered, lblNoMap, lblMapTotal, homogeneous="YES", gap="0", }, margin="2x2", },
									iup.hbox { gap=StrGap, lblIndiName, txtIndiName, btnIndiName, btnPrevMapped, btnPrevUnmap, },
									iup.hbox { gap=StrGap, lblMapState, txtMapState, btnDeleteMap, btnNextMapped, btnNextUnmap, },
								}
	local	frameMapData	=	iup.frame { font=StrFontHead, fgcolor=StrBlack, title=" Manage Individual Maps ", active="YES",
									vboxMapData,
								}
	local	vboxCreate	= 	iup.vbox { font=StrFontBody, alignment="ARIGHT", gap="10", active="YES",
									iup.hbox { gap="10", btnMapAll, btnMapSome, btnMapThis, homogeneous="YES", margin="0x6", },
									frameMapData,
								}

	-- Create the Set Preference Options layout
	local	vboxPlotOpt	=	iup.vbox { font=StrFontBody, margin=StrMinMargin,
									iup.hbox { gap=StrGap, tglGeoCode, lblRegBias, lstRegBias, margin="2x12", },	-- margin="2x10", margin="2x6",
									iup.hbox { gap=StrGap, iup.hbox{ gap=StrGap, lblLocZoom, txtLocZoom, }, iup.hbox{ gap=StrGap, lblFromTag, lstFromTag, }, iup.hbox{ gap=StrGap, lblStorage, lstStorage, }, margin="0x8", },	-- margin="0x9", margin="0x1",
								}
	local	vboxMapsOpt	=	iup.vbox { font=StrFontBody, margin=StrMinMargin,
									iup.hbox { gap="20", lblMapFolder,	txtMapFolder, iup.vbox { gap=StrGap, btnMapFolder, btnDeleteAll, }, margin="0x2", },	-- margin="0x6",
									iup.hbox { gap="29", iup.hbox{ gap=StrGap, lblMapZoom, txtMapZoom, }, iup.hbox{ gap=StrGap, lblMarkers, lstMarkers, }, iup.hbox{ gap=StrGap, lblPrivacy, lstPrivacy, }, margin="0x2", },	-- margin="0x1",
								}
	local	vboxDataOpt	=	iup.vbox { font=StrFontBody, margin=StrMinMargin,
									iup.hbox { gap="12", btnCopyPLAC,  btnCopyADDR,  btnPurgeBOTH, homogeneous="YES", margin="0x15", },	-- margin="0x15", margin="0x6",
									iup.hbox { gap="12", btnErasePLAC, btnEraseADDR, btnEraseBOTH, homogeneous="YES", margin="0x8", },	-- margin="0x10", margin="0x6",
								}
	local	tabPrefer		=	iup.tabs { font=StrFontHead, padding="8x8", active="YES", tip="Select Preference Options for Location Plots, or Web Page Maps, or Database Management",
									vboxPlotOpt,	tabtitle0="  Location Plot Options  ",
									vboxMapsOpt,	tabtitle1="  Web Page Map Options  ",
									vboxDataOpt,	tabtitle2="  Database Management  ",
								}
	local	vboxPrefer	= 	iup.vbox { font=StrFontBody, alignment="ARIGHT", gap=StrGap,
									tabPrefer,
									iup.hbox { gap="100", btnDefault, btnFontSet, homogeneous="YES", margin="150x10", },
								}
	local intPreferTab	= IntTabGeoLoc	

	-- Create the Tab controls layout
	local	tabControls	=	iup.tabs { font=StrFontHead, padding="8x8", active="YES", tip="Select Geocode plots for Places/Addresses, \n Create HTML web page maps for Individuals, \n or Set Preference Options",
									vboxGeoLoc,	tabtitle0=" Geocode Location Plots ",
									vboxCreate,	tabtitle1="  Create Web Page Maps  ",
									vboxPrefer,	tabtitle2=" Set Preference Options ",
								}

	-- Combine all the above controls
	local	allControls	=	iup.vbox { font=StrFontBody, alignment="ARIGHT", active="NO", StrMinMargin,
									tabControls,
									iup.hbox { gap="20", lblStatus, LblMessage, BtnMainHelp, btnClose, margin="18x2", },
									iup.hbox { iup.vbox { OLEcontrol }, }, -- If "710" is width, "x500" is max height with no grey bar at top
								}

	-- Create the Main dialogue
	local	dialogMain	=	iup.dialog { title=StrPlugin..StrIssue, active="NO", background=StrWhite, defaultenter=btnClose, minsize="730x500", shrink="YES", rastersize=StrMainS, allControls,
									move_cb	=function(self,x,y) if IsNormalWindow(self) then IntMainX=x IntMainY=y end end,
									resize_cb	=function(self) timResize.run="NO" timResize.run="YES" end,
								}
	local function doResizeButtons()
		btnLocation.rastersize = txtLocation.rastersize
		iup.RefreshChildren(vboxGeoLoc)							-- Ensure btnLocation expands & contracts correctly
		btnIndiName.rastersize = txtIndiName.rastersize
		iup.RefreshChildren(vboxCreate)							-- Ensure btnIndiName expands & contracts correctly
	end -- local function doResizeButtons

	function timResize:action_cb()								-- Call back when dialog Resize timer expires
		timResize.run = "NO"
		if IsNormalWindow(dialogMain) then
			StrMainS = dialogMain.rastersize 					-- Preserve normal window size sticky setting
		end
		doResizeButtons()
	end -- function timResize:action_cb

	-- GUI Trees for Location (PLAC, ADDR, BOTH) and Individual (INDI) Lists --

	local tblGUI  = {}												-- Table of chosen GUI tree controls
	local tblTree = {}												-- Table of all the GUI tree controls
	local strLeaf = nil												-- Selected leaf node title
	local intLeaf = 0												-- Selected leaf node ident currently
	local intNode = 0												-- Selected leaf node ident previously
	local intLocPosX, intLocPosY									-- Position of btnLocation within window
	local intIndPosX, intIndPosY									-- Position of btnIndiName within window

	local function doColorLeafNode(intIdent,strColor)		-- Set leaf node colour in tree
		if intIdent > 0 then
			if intIdent == intNode then
				tblGUI.color = strColor							-- If highlighted then only updated saved GUI color
			else
				iup.SetAttributeId(tblGUI.tree,"COLOR",intIdent,strColor)
			end
		end
	end -- local function doColorLeafNode

	local function doSelectLeafNode(intIdent)					-- Save leaf node ident & color and highlight in tree
		if intNode > 0 then -- Restore old leaf color
			iup.SetAttributeId(tblGUI.tree,"COLOR",intNode,tblGUI.color)
		end
		intLeaf = intIdent	-- Save new leaf details
		intNode = intIdent
		tblGUI.tree.value = intNode
		tblGUI.color = iup.GetAttributeId(tblGUI.tree,"COLOR",intNode)
		iup.SetAttributeId(tblGUI.tree,"COLOR",intIdent,TblStatusColor[IntHighlight])
	end -- local function doSelectLeafNode

	local function strGetTreeLeaf(iupTree,intIdent)			-- Translate tree node ident into leaf title and color
		if tonumber(intIdent) then
			if iup.GetAttributeId(iupTree,"KIND",intIdent) == "LEAF" then
				local strColor = iup.GetAttributeId(iupTree,"COLOR",intIdent)
				if strColor == TblStatusColor[IntHighlight] then strColor = tblGUI.color end
				return iup.GetAttributeId(iupTree,"TITLE",intIdent), strColor
			end
		end
		return nil
	end -- local function strGetTreeLeaf

	local function doGetTreeLeaf(iupTree,intIdent,intStatus) -- Selection call back for tree node
		if intStatus == 1 then
			intLeaf = intIdent
			strLeaf = strGetTreeLeaf(iupTree,intIdent)		-- Set selected leaf node ident & title
		end
	end -- local function doGetTreeLeaf

	local function doExpandCollapse(iupTree,iupButton)		-- btnEx action to expand/contract tree list
		local intIdent = iupTree.value							-- Save current selected leaf node
		if string.sub(iupButton.title,1,6) == "Expand" then
			iupTree.expandall = "YES"								-- Expand all branches
			iupTree.value = intIdent								-- Restore selected leaf node
			intIdent = intIdent - 1
			iupButton.title = string.gsub(iupButton.title,"Expand","Contract")
		else
			for intIdent = 1, tonumber(iupTree.count) do		-- Contract all branches
				if iup.GetAttributeId(iupTree,"KIND",intIdent) == "BRANCH" then
					iup.SetAttributeId(iupTree,"STATE",intIdent,"COLLAPSED")
				end
			end
			iupTree.value = intIdent								-- Restore selected leaf node
			intIdent = intIdent + 1
			iupButton.title = string.gsub(iupButton.title,"Contract","Expand")
		end
		iupTree.topitem = intIdent								-- Force selected leaf node well into window
	end -- local function doExpandCollapse

	local function doBuildTreeDialogues()						-- Build all four Tree GUI for PLAC, ADDR, BOTH & INDI and set their positions

		local function doMakeTreeDialogue(intTree,strStatus,tblStates,strTree)	-- Make one instance of a Tree GUI
			local tbl	= {}
			tbl.tree	= iup.tree	{ tip="Select any "..strTree.." to manage the entry"	, rastersize="650x420", selection_cb=function(self,intIdent,intStatus) doGetTreeLeaf(self,intIdent,intStatus) end, }
			tbl.btnEx	= iup.button	{ tip="Expand / Contract the List selection"				, title="Expand "..strTree.." List"			, fgcolor=StrBlack	, expand="YES", action=function() doExpandCollapse(tbl.tree,tbl.btnEx) end, }
			tbl.btnNo	= iup.button	{ tip="Cancel the "..strTree.." List selection"			, title="Cancel "..strTree.." selection"	, fgcolor=StrRed	, expand="YES", action=function() strLeaf = nil return iup.CLOSE end, }
			tbl.btnOk	= iup.button	{ tip="OK the "..strTree.." List selection"				, title="OK "..strTree.." selection"		, fgcolor=StrGreen	, expand="YES", action=function() strLeaf = strGetTreeLeaf(tbl.tree,intLeaf) return iup.CLOSE end, }
			tbl.vbox	= iup.vbox	{ font=StrFontBody, expandchildren="YES", alignment="ACENTER", gap=StrGap, margin=StrMinMargin, tbl.tree, iup.hbox { tbl.btnNo, tbl.btnEx, tbl.btnOk, homogeneous="YES", }, }
			tbl.dialog= iup.dialog	{ title=StrPlugin.." "..strTree.." List", dialogframe="YES", background=StrWhite, startfocus=tbl.btnNo, tbl.vbox, close_cb=function() strLeaf = nil return iup.CLOSE end, }
			tblTree[intTree] = tbl
			tblTree[intTree].Status = strStatus
			tblTree[intTree].States = tblStates
		end -- local function doMakeTreeDialogue

		doMakeTreeDialogue(IntFromPLAC,"lat",TblPlotStates,"Place")
		doMakeTreeDialogue(IntFromADDR,"lat",TblPlotStates,"Address")
		doMakeTreeDialogue(IntFromBOTH,"lat",TblPlotStates,"Address…Place")
		doMakeTreeDialogue(IntFromINDI,"map",TblMapStates ,"Individual")

		-- Save position of btnLocation & btnIndiName buttons so GUI Tree appears below them
		local tblPosn = {}
		local intPosX = 0
		local intPosY = 0
		tblPosn = framePlotData.clientoffset:SplitNumbers()	-- Position of frame controls within window
		intPosX = tblPosn[1] - 60
		intPosY = tblPosn[2] + 150
		tblPosn = btnLocation.position:SplitNumbers()		-- Position of btnLocation within window
		intLocPosX = tblPosn[1] + intPosX
		intLocPosY = tblPosn[2] + intPosY
		tblPosn = frameMapData.clientoffset:SplitNumbers()	-- Position of frame controls within window
		intPosX = tblPosn[1] - 60
		intPosY = tblPosn[2] + 160
		tblPosn = btnIndiName.position:SplitNumbers()		-- Position of btnIndiName within window
		intIndPosX = tblPosn[1] + intPosX
		intIndPosY = tblPosn[2] + intPosY

	end -- local function doBuildTreeDialogues

	local function doBuildTreeNodes(tblData,strNode)		-- Build the GUI tree branches & leaves
		local intSize = 1											-- Number of Head label characters
		local strHead = ""											-- Head label of branch node
		local intHead = 0											-- Head index of branch node
		local tblHead = {}											-- Head table of index per branch
		local tblNode = {}											-- Node table of sorted items for GUI tree
		local intNode = 0											-- Node ident of strNode to be found
		local strColor = TblStatusColor[IntPlotNoData]
		tblGUI.color = strColor
		if tblGUI.tree.count then
			tblGUI.tree.delnode0 = "CHILDREN"					-- Ensure GUI tree only has root node
		end
		tblGUI.tblLeaf = {}
		for strLeaf, j in pairs(tblData) do
			if tblData[strLeaf]["use"] then						-- Is the Leaf chosen for use
				tblData[strLeaf]["use"] = nil
				table.insert(tblGUI.tblLeaf,strLeaf)			-- Create and sort Leaf table so tree is pre-sorted - also used by Plot All/Map All loops
			end
		end
		table.sort(tblGUI.tblLeaf)
		if #tblGUI.tblLeaf > 1000 then intSize = 4 end		-- Increase initial size of Head labels for large lists
		repeat
			intHead = 0
			tblHead = {}
			tblNode = {}
			for i, strLeaf in ipairs(tblGUI.tblLeaf) do		-- Increment the Head prefix size for leading ellipsis Leaf nodes
				local intPref = intSize + ( (strLeaf:match("^…") and 1) or 0 )
				strHead = string.sub(strLeaf,1,intPref)		-- Extract Head label prefix from Leaf
				if not tblHead[strHead] then
					tblHead[strHead] = intHead					-- Assign Head index to this label
					intHead = intHead + 1
				end
				local intHead = tblHead[strHead]				-- Create new Head label branch node if necessary
				if not tblNode[intHead] then
					tblNode[intHead] = { branchname=strHead, state="COLLAPSED" }
				end
				local strData = tblData[strLeaf][tblGUI.Status] or ""
				local strMode = tblData[strLeaf]["mod"] or ""
				strColor = TblStatusColor[IntStatusIndex(strData..strMode,tblGUI.States)]
				table.insert(tblNode[intHead],{ leafname=strLeaf, color=strColor })		-- Insert the Leaf node into branch node
				if strNode then
					if strNode == strLeaf then intNode = intHead + i + 1 end
				end
			end
			intSize = intSize + 2
		until #tblGUI.tblLeaf <= 1000 or intHead > 25		-- If large list and few branches (e.g. single name database), then repeat with bigger label 
		tblGUI.tree.autoredraw = "NO"
		tblGUI.dialog:map()
		iup.TreeAddNodes(tblGUI.tree,tblNode)					-- Populate the mapped tree control with branch & leaf nodes
		tblGUI.tree.autoredraw = "YES"

		if string.sub(tblGUI.btnEx.title,1,8) == "Contract" then
			local intIndent = tblGUI.tree.value
			tblGUI.tree.expandall = "YES"						-- Expand all branches
			tblGUI.tree.value = intIdent							-- Restore selected leaf node
		end

		return intNode												-- Return ident of strNode if it matched a strLeaf
	end -- local function doBuildTreeNodes

	-- GUI Common Shared Service Data & Functions --

	local isFromNew		= false									-- Signal new Locations From: Address…Place variant
	local intLocation	=	0										-- Selected entry from Location dropdown list matching StrLocation
	local strLocation	= "?"										-- Saved copies of last mapped Location values
	local strLatitude	= "?"										-- Used only by doMarkGoogleMapPlot()
	local strLongitude	= "?"
	local strSubValue	= ""										-- Saved Substitute value before editing
	local intSubCount	=	0										-- Count of Substituted Location entries
	local intLocIndex	=	0										-- Saved Location color index before editing
	local intNoData		=	0										-- Count of never Geocoded Location entries
	local intPlotted	=	0										-- Count of Lat/Lng plotted Location entries
	local intManual		=	0										-- Count of Lat/Lng manual Location entries
	local intNoPlot		=	0										-- Count of No Plot Found Geocode Location entries
	local intInvalid	=	0										-- Count of Invalid Request/Request Denied Geocode Location entries
	local intUnplotted	=	0										-- Count sum of all Location entries with no plot
	local tblPlotCounts = { 0, 0, 0, 0, 0, 0, 0, 0 }

	local function deActivateControls(tblControls)
		for i, control in ipairs(tblControls) do
			control.active = "NO"
		end
	end -- local function doActivateControls

	local function doGetGoogleMapZoom()							-- Read map Zoom level from Google Maps pane
		ReadGoogleMap()
		if IntTabPosn == IntTabPrefer then
			if intPreferTab == IntTabGeoLoc then
				IntLocZoom = IntGetZoom
				txtLocZoom.value = IntLocZoom
			end
			if intPreferTab == IntTabCreate then
				IntMapZoom = IntGetZoom
				txtMapZoom.value = IntMapZoom
			end
		end
	end -- local function doGetGoogleMapZoom

	local function doMarkGoogleMapPlot()						-- Mark the Latitude/Longitude on Google Maps pane
		local strLoc = btnLocation.title
		if strLoc..TxtLatitude.value..TxtLongitude.value ~= strLocation..strLatitude..strLongitude then
			strLocation	= strLoc									-- Only update Google Maps pane if values have changed
			strLatitude	= TxtLatitude.value
			strLongitude	= TxtLongitude.value
			strLoc = strLoc:gsub("&&","&")						-- Remove double ampersands "&" from the button title
			strLoc = strLoc:gsub("…","...")						-- Replace elipsis "…" with 3 dots so they appear in Caption and InfoWindow
			strLoc = strLoc:gsub("[%c&<>]"," ")					-- Replace control chars, "&", "<", ">" with a space, and remove non-ASCII chars
			strLoc = strLoc:gsub("["..string.char(0x7F).."-"..string.char(0xFF).."]","")
			MarkGoogleMap(strLatitude,strLongitude,strLoc)
		end
	end -- local function doMarkGoogleMapPlot

	local function doShowWarnings(strButton)					-- Show Geocode Plot button and Geocoder Quota limit warnings until inhibitted by user
		local strPlotNew = ""
		if intPlotted+intManual == 0 then StrPlotNew = "No" end	-- If no Plots then Geocode Plot button warning not needed
		if IntTabPosn == IntTabGeoLoc and StrPlotNew == "Yes" then
			strPlotNew = "!    !    !    IMPORTANT CHANGE TO GEOCODE PLOT BUTTONS    !    !    !\n'Geocode Plot All / Some Locations' buttons now function very differently.\nSee the details via the 'Help && Advice' button for a complete explanation.\n\n"
			StrWarnAns = "Yes"
		end
		if StrWarnAns == "Yes" then
			local strWarnAns = GUI_WarnDialogue("WARNING!  ADVICE!",strPlotNew.."Geocoding Location entries has a Google Geocoder 2,500 daily usage limit.\nIf 'Geocoder Daily "..StrPlotQuotaX.."' appears then 'Stop "..strButton.."'.\nReview the 'Help && Advice' page for 'Geocode Plots' for further details.\n          Do you want to continue to see this Warning in future ?\n          (Click the X Close top right to cancel "..strButton..")")
			if strWarnAns == "No" then StrWarnAns = "No" end
			if strPlotNew ~= "" then StrPlotNew = StrWarnAns end
			if strWarnAns == "Close" then return false end
		end
		return true
	end -- local function doShowWarnings

	-- GUI Geocode Location Plots Tab Functions --

	local function intLatLngIndex(strLoc)							-- Determine Location color status Index based on Lat/Longitude values
		local strMode = TblLocationData[strLoc]["mod"] or ""
		local strLat  = TblLocationData[strLoc]["lat"] or ""
		local strLng  = TblLocationData[strLoc]["lng"] or ""
		local intLatIndex = IntStatusIndex(strLat..strMode,tblGUI.States)
		local intLngIndex = IntStatusIndex(strLng..strMode,tblGUI.States)
		if intLatIndex == intLngIndex then
			return intLatIndex
		else
			return IntPlotInvalid
		end
	end -- local function intLatLngIndex

	local function doSavePlotData(strOpt)							-- Optionally save current Location Substitute value and Lat/Long color Index
		if strOpt then
			strSubValue = TblLocationData[StrLocation]["sub"] or ""
			intLocIndex = intLatLngIndex(StrLocation)
		end
	end -- local function doSavePlotData

	local function doShowPlotData(strOpt)							-- Calculate and display Geocoded Location statistics
		if strOpt then													-- If Substitute/Latitude/Longitude edit then delta adjust for current Location only
			if strSubValue ~= "" then intSubCount = intSubCount - 1 end
			local strSubValue  = TblLocationData[StrLocation]["sub"] or ""
			if strSubValue ~= "" then intSubCount = intSubCount + 1 end
			tblPlotCounts[intLocIndex] = tblPlotCounts[intLocIndex] - 1
			local intLocIndex = intLatLngIndex(StrLocation)
			tblPlotCounts[intLocIndex] = tblPlotCounts[intLocIndex] + 1
		else																-- Otherwise recalculate statistics for entire set of Locations
			intSubCount = 0
			for intLocIndex = 1, #tblGUI.States do
				tblPlotCounts[intLocIndex] = 0
			end
			for intLoc, strLoc in ipairs(tblGUI.tblLeaf) do
				local strSub  = TblLocationData[strLoc]["sub"] or ""
				if strSub ~= "" then intSubCount = intSubCount + 1 end
				local intLocIndex = intLatLngIndex(strLoc)
				tblPlotCounts[intLocIndex] = tblPlotCounts[intLocIndex] + 1
			end
		end
		intNoData 	= tblPlotCounts[IntPlotNoData]
		intPlotted	= tblPlotCounts[IntPlotLatLong]
		intManual		= tblPlotCounts[IntPlotManual]
		intNoPlot 	= tblPlotCounts[IntPlotNoPlot]
		intInvalid	= 0
		for intIndex = IntPlotInvalid, #tblGUI.States do
			intInvalid = intInvalid + tblPlotCounts[intIndex]
		end
		tblPlotCounts[IntPlotInvalid] = intInvalid
		intUnplotted	= intNoPlot + intInvalid + intNoData 
		lblPlotted.title	= intPlotted.." Plotted"
		lblManual.title		= intManual.." Manual"
		lblNoPlot.title		= intNoPlot.." "..StrPlotNoPlot
		lblInvalid.title	= intInvalid.." Invalid"
		lblNoData.title		= intNoData.." "..StrPlotNoData
		lblPlotTotal.title	= #tblGUI.tblLeaf.." Total"
	end -- local function doShowPlotData

	local function doRefreshLocation(strLoc,valOpt)			-- Refresh the Location Entry details (valOpt = nil, true, false, "Sub", "Lat" or "Lng")
		local strSub = ""
		local strLat = ""
		local strLng = ""
		local strMod = ""
		if valOpt == nil then valOpt = true end
		if strLoc then
			local tblLoc = TblLocationData[strLoc]
			strSub = tblLoc["sub"]
			strLat = tblLoc["lat"]
			strLng = tblLoc["lng"]
			strMod = tblLoc["mod"] or ""
		else
			strLoc = StrClickHere
		end
		btnLocation.title = strLoc:gsub("&","&&")				-- Duplicate ampersands "&" so they appear in button title
		if valOpt ~= "Sub" then
			txtSubstitute.value = strSub
		end
		if valOpt == "Lat" then
			TxtLatitude.fgcolor = TblStatusColor[IntStatusIndex(TxtLatitude.value..strMod,TblPlotStates)]
		else
			RefreshValue(TxtLatitude, strLat, strMod)
		end
		if valOpt == "Lng" then
			TxtLongitude.fgcolor = TblStatusColor[IntStatusIndex(TxtLongitude.value..strMod,TblPlotStates)]
		else
			RefreshValue(TxtLongitude, strLng, strMod)
		end
		local strColor = TxtLatitude.fgcolor
		if strColor ~= TxtLongitude.fgcolor then
			strColor = TblStatusColor[IntPlotInvalid]
		end
		btnLocation.fgcolor = strColor
		txtSubstitute.fgcolor = strColor
		doColorLeafNode(intLocation,strColor)
		if valOpt then
			doSelectLeafNode(intLocation)						-- Optionally select Entry in list and Mark on Google Maps pane
			if StrLocation then
				if valOpt == true then
					strLocation	= "?"
					strLatitude	= "?"
					strLongitude	= "?"
				end
				doMarkGoogleMapPlot()
			else
				if IntTabPosn == IntTabPrefer then 
					MarkGoogleMap(51.500,-0.125,"Central London")
				else
					MarkGoogleMap("","","")
				end
			end
		end	
	end -- local function doRefreshLocation

	local function doGeoLocTabShared(strOpt)					-- Geocode Location Plots tab actions before & after button functions 
		if StrLocation then 										-- Save current Location entry to database
			TblLocationData[StrLocation]["sub"] = txtSubstitute.value
			TblLocationData[StrLocation]["lat"] = TxtLatitude.value
			TblLocationData[StrLocation]["lng"] = TxtLongitude.value
			SaveLocationsData(StrLocation)
			doRefreshLocation(StrLocation,strOpt or "Loc")
		end
		if not strOpt and IntStorage == IntStoreFILE then SaveLocationsFile() end
	end -- local function doGeoLocTabShared

	local tblGeoLocControls = { allControls, btnClearAll, vboxPlotEntry, btnLocation, btnMoveNorth, btnMoveSouth, btnMoveEast, btnMoveWest, btnNextPlot, btnNextManual, btnNextSubs, btnNextUnplot, btnPlotThis, btnPlotSome, btnPlotAll, }

	local function doGeoLocTabPrefix(strOpt)					-- Geocode Location Plots tab actions before button functions 
		deActivateControls(tblGeoLocControls)
		if strOpt ~= "Lat" then TxtLatitude.active  = "NO" end
		if strOpt ~= "Lng" then TxtLongitude.active = "NO" end
		ShowStatusMessage(StrGreen,"OK")
		doGeoLocTabShared(strOpt)
		doSavePlotData(strOpt)
	end -- local function doGeoLocTabPrefix

	local function doGeoLocTabSuffix(strOpt)					-- Geocode Location Plots tab actions after button functions 
		doGeoLocTabShared(strOpt)
		doShowPlotData(strOpt)										-- Show the Geocoded Location statistics
		allControls.active = "YES"
		tabControls.active = "YES"
		if TxtLatitude.fgcolor == TxtLongitude.fgcolor then
			if intPlotted + intManual > 0 then					-- Enable controls for Plotted/Manual entries
				btnNextPlot.active		= "YES"
			end
			if intManual > 0 then									-- Enable controls for Manual entries
				btnNextManual.active	= "YES"
			end
			if intSubCount > 0 then								-- Enable controls for Substitute entries
				btnNextSubs.active		= "YES"
			end
			if intUnplotted > 0 then								-- Enable controls for Failed/Invalid/NoData entries
				btnNextUnplot.active	= "YES"
			end
			if TxtLatitude.fgcolor == TblStatusColor[IntPlotLatLong]
			or TxtLatitude.fgcolor == TblStatusColor[IntPlotManual] then
				btnMoveNorth.active		= "YES"					-- Enable nudge North & South controls
				btnMoveSouth.active		= "YES"
			end
			if TxtLongitude.fgcolor == TblStatusColor[IntPlotLatLong]
			or TxtLongitude.fgcolor == TblStatusColor[IntPlotManual] then
				btnMoveEast.active		= "YES"					-- Enable nudge East & West controls
				btnMoveWest.active		= "YES"
			end
			btnLocation.active		= "YES"
		else
			local strColor = TblStatusColor[IntPlotInvalid]
			ShowStatusMessage(strColor,"Erroneous Latitude/Longitude values")
			btnLocation.fgcolor		= strColor
			txtSubstitute.fgcolor	= strColor
			doColorLeafNode(intLocation,strColor)
		end
		if StrLocation then 									-- Enable current Location entry controls
			btnClearAll.active		= "YES"
			vboxPlotEntry.active	= "YES"
			txtSubstitute.active	= "YES"
			TxtLatitude.active		= "YES"
			TxtLongitude.active		= "YES"
			if not IsPlotted(TblLocationData[StrLocation]) then
				btnPlotThis.active		= "YES"
			end
		end
		btnPlotAll.active		= "YES"
		btnPlotSome.active		= "YES"
	end -- local function doGeoLocTabSuffix

	local function doBuildLocationsList()						-- Build the Locations list from Database and Gedcom
		ShowStatusMessage(StrAmber,"Loading Location list, please wait…")
		local intFromTag = math.min(IntFromTag,IntFromBOTH)
		local strFromTag = TblFromTag[intFromTag]
		StrFromTag = strFromTag
		tblGUI = tblTree[intFromTag]
		TblLocationData = TblLocationCode[strFromTag]
--[[
		if strFromTag == "BOTH" then													-- Fix change from Address + Place to Address…Place
			for strOldLoc, tblLoc in pairs(TblLocationData) do
				if string.find(strOldLoc,"…") then break end						-- But not if ellipsis "…" already exists
				local strNewLoc = string.gsub(strOldLoc," %+ ","…")
				if strNewLoc ~= strOldLoc then
					TblLocationData[strNewLoc] = tblLoc
					TblLocationData[strOldLoc] = {}
				end
			end
		end
]]
		if next(TblLocationData) == nil or not tblGUI.tree.count or isFromNew then
			isFromNew = false
			local ptrRecord = fhNewItemPtr()										-- Either the Database is empty or GUI tree is empty or new Address…Place variant
			local tblLocations = {}
			for i, strRecordType in ipairs({"INDI","FAM"}) do
				ptrRecord:MoveToFirstRecord(strRecordType)
				while ptrRecord:IsNotNull() do										-- Search all Individual & Family Records for Facts
					local ptrFact = fhNewItemPtr()
					ptrFact:MoveToFirstChildItem(ptrRecord)
					while ptrFact:IsNotNull() do
						if fhIsFact(ptrFact) or IsDataTag(ptrFact) then			-- Search all Facts for "ADDR" &/or "PLAC" Locations
							local strLocName, strLocFull = StrMakeLocation(ptrFact)
							if strLocFull ~= ""											-- Ignore empty "Address…Place" variant Location
							and intPreferTab == IntTabGeoLoc then					-- Ignore unless on Location Plot Options tab
								strLocFull = StrControls2SpaceNew(strLocFull)	-- New format with newline = bell blob
								if not tblLocations[strLocFull] then				-- Log every "ADDR…PLAC" Location found
									tblLocations[strLocFull] = true
								end
								local strAddr = strLocFull:gsub("….*","…")
								if not tblLocations[strAddr] then					-- Log every "ADDR…" Location found
									tblLocations[strAddr] = true
								end
								local strPlac = strLocFull:gsub(".-…","…")
								if not tblLocations[strPlac] then					-- Log every "…PLAC" Location found
									tblLocations[strPlac] = true
								end
							end
							if strLocName ~= "" then									-- Ignore empty Location
								strLocName = StrControls2SpaceNew(strLocName)	-- New format with newline = bell blob
								if not tblLocations[strLocName] then				-- Log every Location found
									tblLocations[strLocName] = true
								end
								if not TblLocationData[strLocName] then			-- Add new Location to data
									TblLocationData[strLocName] = { rec = 0, sub = "", lat = "", lng = "", mod = "" }
									SaveLocationsData(strLocName)
								end
								TblLocationData[strLocName]["use"] = true			-- Location is chosen for use in GUI tree
							end
						end
						ptrFact:MoveNext()
					end
					ptrRecord:MoveNext()
				end
			end
			for strLocName, tblLocData in pairs(TblLocationData) do
				if not tblLocations[strLocName] then								-- Delete old Location from data
					if IntStorage ~= IntStoreFILE then DeleteLocationRecord(tblLocData["rec"]) end
					TblLocationData[strLocName] = nil								-- tblLocData = nil does not always work
				end
			end
			intLocation = doBuildTreeNodes(TblLocationData,StrLocation)
--?			if IntStorage == IntStoreFILE then SaveLocationsFile() end		-- Always maintain a database file as backup ?
		end
		ShowStatusMessage(StrGreen,"OK")
		if intLocation == 0 then
			intLocation = tonumber(tblGUI.tree.value)
			StrLocation = strGetTreeLeaf(tblGUI.tree,intLocation)
		end
		strLeaf = StrLocation 
		doRefreshLocation(StrLocation)
	end -- local function doBuildLocationsList

	local function doGeoLocTabSettings()						-- Initial settings for Geocode Location Plots tab 
		strLocation	= "?"
		strLatitude	= "?"
		strLongitude	= "?"
		ZoomGoogleMap(IntLocZoom)
		doGeoLocTabPrefix()
		doBuildLocationsList()
		doGeoLocTabSuffix()
	end -- local function doGeoLocTabSettings

	local function doGeocodePlot(intRange,isConfirm,strClass,isColorOK) -- Plot Range of Locations that match Class Color
		doGeoLocTabPrefix()
		if intRange > IntQuotaLimit then intRange = IntQuotaLimit + 9 end
		local isPlottingOK = true
		if intRange > 9 then isPlottingOK = doShowWarnings("Plotting Locations") end
		if isPlottingOK then
			local intLoc = intLocation							-- Remember current selected Location
			local intStart = intLoc
			TxtLatitude.active	= "YES"							-- Allow Lat/Long to appear in colour
			TxtLongitude.active	= "YES"
			dialogMain.active	= "NO"
			local isGeocode = true
			if not isConfirm then
				ProgressBar.Start("Plotting Locations",intRange)
			end
			local intMax = tonumber(tblGUI.tree.count)		-- Cannot traverse tblGUI.tblLeaf instead, while doRefreshLocation needs GUI tree ident
			if intLoc == 0 then intLoc = 1 end
			for intCount = 0, intMax do							-- Loop once more than number of Locations to return to start Location
				if intLoc > intMax then intLoc = 1 end
				if intLoc < 1 then intLoc = intMax end
				local strLoc, strColor = strGetTreeLeaf(tblGUI.tree,intLoc)
				if strLoc then
					if isColorOK(strColor,strClass) then		-- Is Location entry Color in correct Class
						intLocation = intLoc
						StrLocation = strLoc
						doRefreshLocation(strLoc,isConfirm)		-- Show the Geocoding Location details before plot
						if intCount == 0
						or intLocation ~= intStart then			-- Always include first Location, but skip when start Location reappears
							if isConfirm then
								isConfirm, isGeocode = GUI_SkipDialogue(strClass)
							end
							intRange = intRange - 1
							if isGeocode then
								doSavePlotData("Loc")
								TblLocationData[StrLocation]["mod"] = ""	-- Cancel any Manual Mode
								StrGeocodeLocation(StrLocation)
								doRefreshLocation(StrLocation,isConfirm)	-- Show the Geocoding Location details after plot
								doShowPlotData("Loc")
								if isConfirm then
									fhSleep(1500,100)
								elseif intRange > 1 then
									ProgressBar.Start("Plotting Locations",intRange)
								end 
							elseif not isConfirm then
								break
							end 
							ProgressBar.Step(1)
						end
					end
					if ProgressBar.Stop() then break end
				end
				intLoc = intLoc + 1
			end
			TxtLatitude.active	= "NO"
			TxtLongitude.active	= "NO"
			doRefreshLocation(StrLocation)
			ProgressBar.Close()
			dialogMain.active = "YES"
			dialogMain.bringfront = "YES"
		end
		doGeoLocTabSuffix()
	end -- local function doGeocodePlot

	local function isColorMisMatch(strColor,strExclude)
		return strColor ~= strExclude
	end

	function btnPlotAll:action()									-- Action for Geocode Plot All Locations button
		local intMaximum = #tblGUI.tblLeaf
		local strExclude = " "										-- Exclude no Locations
		if intManual > 0 then
			if GUI_WarnDialogue("Geocode Plot All to include Manual Plots?","Do you wish to include the "..intManual.." Manual plot Locations in this Geocode Plot All?") ~= "Yes" then
				intMaximum = intMaximum - intManual
				strExclude = TblStatusColor[IntPlotManual]	-- Exclude only Manual Plots
			end
		end 
		doGeocodePlot( intMaximum, false, strExclude, function(strColor,strExclude) return strColor ~= strExclude end )
	end -- function btnPlotAll:action

	function btnPlotSome:action()								-- Action for Geocode Plot Some Locations button
		local intSome, isConfirm = GUI_PlotDialogue(tblPlotCounts)
		if intSome > 0 then doGeocodePlot( tblPlotCounts[intSome], isConfirm, TblStatusColor[intSome], function(strColor,strInclude) return strColor == strInclude end ) end
	end -- function btnPlotSome:action

	function btnPlotThis:action()								-- Action for Geocode Plot This Location button
		doGeoLocTabPrefix()
		if StrLocation then
			TblLocationData[StrLocation]["mod"] = ""
			StrGeocodeLocation(StrLocation)
			doRefreshLocation(StrLocation)
		end
		doGeoLocTabSuffix()
	end -- function btnPlotThis:action

	function btnLocation:action()								-- Action for Location button
		doGeoLocTabPrefix()
		strLeaf = nil
		tblGUI.dialog:popup(IntMainX+intLocPosX,IntMainY+intLocPosY)
		if strLeaf then
			StrLocation = strLeaf
			intLocation = intLeaf
			doRefreshLocation(StrLocation)
		end
		doGeoLocTabSuffix()
	end -- function btnLocation:action

	function btnLocToSub:action()								-- Action for Copy Loc to Sub button
		doGeoLocTabPrefix()
		txtSubstitute.value = StrLocation
		if TxtLatitude.fgcolor  ~= TblStatusColor[IntPlotLatLong] then RefreshValue(TxtLatitude, "") end
		if TxtLongitude.fgcolor ~= TblStatusColor[IntPlotLatLong] then RefreshValue(TxtLongitude,"") end
		TblLocationData[StrLocation]["mod"] = ""
		doGeoLocTabSuffix()
	end -- function btnLocToSub:action

	function txtSubstitute:action(strChar,strValue)			-- Action when Substitute text is edited
		doGeoLocTabPrefix("Sub")
		TxtLatitude.value = ""
		TxtLongitude.value = ""
		TblLocationData[StrLocation]["mod"] = ""
		if strChar == 0 and strValue == txtSubstitute.value then
			doGeoLocTabSuffix("Sub")								-- Delete nothing at left or right special case
			strChar = iup.IGNORE
		end
		return strChar
	end -- function txtSubstitute:action

	function txtSubstitute:valuechanged_cb()					-- Call back after Substitute text is edited
		doGeoLocTabSuffix("Sub")
	end -- function txtSubstitute:valuechanged_cb

	function TxtLatitude:action(strChar,strValue)			-- Action when Latitude text is edited
		doGeoLocTabPrefix("Lat")
		local fltValue = tonumber(strValue)
		if fltValue then
			if fltValue < -90 or fltValue > 90 then
				doGeoLocTabSuffix("Lat")
				strChar = iup.IGNORE
			end
		end
		TblLocationData[StrLocation]["mod"] = "Manual"
		if strChar == 0 and strValue == TxtLatitude.value then
			strLatitude = "?"
			doGeoLocTabSuffix("Lat")								-- Delete nothing at left or right special case
			strChar = iup.IGNORE
		end
		return strChar
	end -- function TxtLatitude:action

	function TxtLatitude:valuechanged_cb()						-- Call back after Latitude text is edited
		doGeoLocTabSuffix("Lat")
	end -- function TxtLatitude:valuechanged_cb

	function TxtLongitude:action(strChar,strValue)			-- Action when Longitude text is edited
		doGeoLocTabPrefix("Lng")
		local fltValue = tonumber(strValue)
		if fltValue then
			if fltValue < -180 or fltValue > 180 then
				doGeoLocTabSuffix("Lng")
				strChar = iup.IGNORE
			end
		end
		TblLocationData[StrLocation]["mod"] = "Manual"
		if strChar == 0 and strValue == TxtLongitude.value then
			strLongitude = "?"
			doGeoLocTabSuffix("Lng")								-- Delete nothing at left or right special case
			strChar = iup.IGNORE
		end
		return strChar
	end -- function TxtLongitude:action

	function TxtLongitude:valuechanged_cb()					-- Call back after Longitude text is edited
		doGeoLocTabSuffix("Lng")
	end -- function TxtLongitude:valuechanged_cb

	function btnClearAll:action()								-- Action for Clear Entry button
		doGeoLocTabPrefix()
		txtSubstitute.value	= ""
		TxtLatitude.value	= ""
		TxtLongitude.value	= ""
		TblLocationData[StrLocation]["mod"] = ""
		doGeoLocTabSuffix()
	end -- function btnClearAll:action

	function btnClearSub:action()								-- Action for Clear Substitute button
		doGeoLocTabPrefix()
		txtSubstitute.value = ""
		doGeoLocTabSuffix()
	end -- function btnClearSub:action

	function btnClearLat:action()								-- Action for Clear Latitude button
		doGeoLocTabPrefix()
		TxtLatitude.value	= ""
		TblLocationData[StrLocation]["mod"] = ""
		doGeoLocTabSuffix()
	end -- function btnClearLat:action

	function btnClearLng:action()								-- Action for Clear Longitude button
		doGeoLocTabPrefix()
		TxtLongitude.value	= ""
		TblLocationData[StrLocation]["mod"] = ""
		doGeoLocTabSuffix()
	end -- function btnClearLng:action

	local function doMovePlot(control,intSign,strOpt)		-- Move Latitude/Longitude plot
		doGeoLocTabPrefix(strOpt)
		doGetGoogleMapZoom()
		TblLocationData[StrLocation]["mod"] = "Manual"
		RefreshValue(control,string.format("%4.7f",control.value + ( 32 / 2 ^ IntGetZoom ) * intSign),"Manual")
		doGeoLocTabSuffix(strOpt)
	end -- local function doMovePlot

	function btnMoveNorth:action()								-- Action for move N button
		doMovePlot(TxtLatitude,1,"Lat")
		if tonumber(TxtLatitude.value) > 90 then RefreshValue(TxtLatitude,90,"Manual") end
	end

	function btnMoveSouth:action()								-- Action for move S button
		doMovePlot(TxtLatitude,-1,"Lat")
		if tonumber(TxtLatitude.value) < -90 then RefreshValue(TxtLatitude,-90,"Manual") end
	end

	function btnMoveEast:action()								-- Action for move E button
		doMovePlot(TxtLongitude,1,"Lng")
		if tonumber(TxtLongitude.value) > 180 then RefreshValue(TxtLongitude,TxtLongitude.value-360,"Manual") end
	end

	function btnMoveWest:action()								-- Action for move W button
		doMovePlot(TxtLongitude,-1,"Lng")
		if tonumber(TxtLongitude.value) < -180 then RefreshValue(TxtLongitude,TxtLongitude.value+360,"Manual") end
	end

	local function doNextLocation(isCondition)			-- Find Next/Prior Location that matches Condition
		doGeoLocTabPrefix()
		local intCount = 0
		local intMax = tonumber(tblGUI.tree.count)
		local intLoc = intLocation
		local strLoc = ""
		local tblLoc = {}
		local intWay = 1
		strKeyState = iup.GetGlobal("MODKEYSTATE")			-- State of Shft, Ctrl, Alt, sYs keys in format of 4 chars "SCAY" or space if not pressed
		if strKeyState:match("A") then intWay = -1 end		-- Alt key reverses direction
		repeat
			intCount = intCount + 1
			intLoc = intLoc + intWay
			if intLoc > intMax then intLoc = 1 end
			if intLoc < 1 then intLoc = intMax end
			strLoc = strGetTreeLeaf(tblGUI.tree,intLoc)
			if strLoc then
				tblLoc = TblLocationData[strLoc]
				if isCondition(tblLoc,intLoc) then
					StrLocation = strLoc
					intLocation = intLoc
					doRefreshLocation(StrLocation)
					doGeoLocTabSuffix()
					return
				end
			end
		until intCount == intMax
		doGeoLocTabSuffix()
	end -- local function doNextLocation

	function btnNextPlot:action()								-- Action for Next Plotted entry button
		doNextLocation( function(tblLoc,intLoc) return IsPlotted(tblLoc) end )
	end

	function btnNextManual:action()								-- Action for Next Manual entry button
		doNextLocation( function(tblLoc,intLoc) local strLoc, strColor = strGetTreeLeaf(tblGUI.tree,intLoc) return strColor == TblStatusColor[IntPlotManual] end )
	end

	function btnNextSubs:action()								-- Action for Next Substitute entry button
		doNextLocation( function(tblLoc,intLoc) return ( tblLoc["sub"] or "" ) ~= "" end )
	end

	function btnNextUnplot:action()								-- Action for Next Unplotted entry button
		doNextLocation( function(tblLoc,intLoc) return not IsPlotted(tblLoc) end )
	end

	-- GUI Create Web Page Maps Tab Functions --

	local	tblIndiNames = {}
	local	strIndiName	=	nil										-- Selected entry from Individual dropdown list
	local	intIndiName	=	0
	local	intNoMap		=	0										-- Count of Individuals without Web Page Maps
	local	intMapped		=	0										-- Count of Individuals with Web Page Maps
	local	intOmitted	=	0										-- Count of Individuals with no Facts with Locations
	local	intFiltered	=	0										-- Count of Individuals excluded by Privacy Filter
	local intUnmapped	=	0										-- Count sum of all Individuals with no Web Page Map
	local	tblMapCounts	= { 0, 0, 0, 0, 0, }

	local function doCountMapData()								-- Calculate the Mapped/Filtered/Omitted statistics
		for i = 1, #tblGUI.States do
			tblMapCounts[i] = 0
		end
		for i, strIndiName in ipairs(tblGUI.tblLeaf) do
			local intIndex = IntStatusIndex(tblIndiNames[strIndiName][tblGUI.Status],tblGUI.States)
			tblMapCounts[intIndex] = tblMapCounts[intIndex] + 1
		end
	end -- local function doCountMapData

	local function doListMapData()								-- Show the Mapped/Filtered/Omitted statistics or Folder status
		intNoMap		=	tblMapCounts[IntMapNoMap]
		intMapped		=	tblMapCounts[IntMapFilename]
		intOmitted	=	tblMapCounts[IntMapOmitted]
		intFiltered	=	tblMapCounts[IntMapFiltered]
		intUnmapped	=	intOmitted + intFiltered + intNoMap
		lblMapped.title		= intMapped.." Mapped"
		lblOmitted.title	= intOmitted.." "..StrMapOmitted
		lblFiltered.title	= intFiltered.." "..StrMapFiltered
		lblNoMap.title		= intNoMap.." "..StrMapNoMap
		lblMapTotal.title	= #tblGUI.tblLeaf.." Total"
	end -- local function doListMapData

	local function doShowMapData()								-- Calculate and show the Mapped/Filtered/Omitted statistics
		doCountMapData()
		doListMapData()
	end -- local function doShowMapData

	local function doPresentMap(strMapName)					-- Display map of Individual plot Markers
		local strMapFile = StrFolder.."\\"..strMapName
		if FlgFileExists(strMapFile) then
			local intBeg
			local intEnd
			local strOne
			local strTwo
			local intLatitude	= nil
			local intLongitude	= nil
			local strInfoWin	= nil
			local strCaption	= nil
			local intPlot		= 0
			local fileHandle	= io.input(strMapFile)
			for strLine in io.lines() do							-- Check "Map of Locations for ..." refers to correct Individual
				intBeg,intEnd,strOne = strLine:find("<title>Map of Locations for (.*)</title>$")
				if strOne then
					if strOne == fhGetDisplayText(tblIndiNames[strIndiName]["ptr"]) then break end
					ShowStatusMessage(StrRed,strMapName.." for "..strOne:gsub("&","&&"))
					MarkGoogleMap("","","")
					io.close(fileHandle)
					return
				end
			end
			NullGoogleMap()
			ShowStatusMessage(StrAmber,"Mapping Plot Markers, please wait…")
			fileHandle:seek("set",700)							-- Skip header of Map file
			for strLine in io.lines() do
				intBeg,intEnd,strOne,strTwo = strLine:find("LatLong%[%d-%] = new google%.maps%.LatLng%((.-),(.-)%);")
				if strOne then intLatitude  = tonumber(strOne) end
				if strTwo then intLongitude = tonumber(strTwo) end
				intBeg,intEnd,strOne = strLine:find("InfoWin%[%d-%] = '(.*)';")
				if strOne then strInfoWin = strOne end
				intBeg,intEnd,strOne = strLine:find("Caption%[%d-%] = '(.*)';")
				if strOne then strCaption = strOne end
				if intLatitude and intLongitude and strInfoWin and strCaption then
					strCaption = strCaption:gsub("&#?%w+;","")
					PlotGoogleMap(intLatitude,intLongitude,strCaption,strInfoWin)
					intLatitude	= nil
					intLongitude	= nil
					strInfoWin	= nil
					strCaption	= nil
					intPlot = intPlot + 1
				end
				if strLine:find("InitialMap") or intPlot > 30 then break end -- Skip tail of Map file
			end
			io.close(fileHandle)
			ShowStatusMessage(StrGreen,"OK")
			DropGoogleMap()
		end
	end  -- local function doPresentMap

	local function doRefreshIndiName(strIndiName,intStep)	-- Refresh the current IndiName Entry details and optionally statistics
		local strColor = TblStatusColor[IntMapNoMap]
		if strIndiName then
			local strMapState = tblIndiNames[strIndiName]["map"]
			local intIndex = IntStatusIndex(strMapState,TblMapStates)
			strColor = TblStatusColor[intIndex]
			doColorLeafNode(intIndiName,strColor)
			btnIndiName.title	= strIndiName:gsub("&","&&")	-- Duplicate ampersands "&" so they appear in button title
			btnIndiName.fgcolor	= strColor
			txtMapState.value	= strMapState
			txtMapState.fgcolor	= strColor
			if not intStep then
				intStep = 0											-- Do not update the statistics
				doSelectLeafNode(intIndiName)					-- Select leaf node in GUI tree list
				if IntTabPosn == IntTabCreate then
					if intIndex == IntMapFilename then
						doPresentMap(strMapState)
					else
						MarkGoogleMap("","","")
					end
				end
			end
			tblMapCounts[intIndex] = tblMapCounts[intIndex] + intStep -- Optionally update Mapped/Filtered/Omitted statistics
		else
			btnIndiName.title	= StrClickHere
			btnIndiName.fgcolor	= strColor
			txtMapState.value	= ""
			txtMapState.fgcolor	= strColor
		end
	end -- local function doRefreshIndiName

	local function doShowFolderStatus()							-- Show status of Map Output Folder
		if FlgFolderExists(StrFolder) then
			ShowStatusMessage(StrGreen,"OK")
		else
			ShowStatusMessage(StrRed,"Output Folder does not exist")
		end
	end -- local function doShowFolderStatus

	local tblCreateControls = { allControls, btnPrevMapped, btnNextMapped, btnPrevUnmap, btnNextUnmap, btnDeleteMap, btnMapThis, btnMapAll, btnMapSome, vboxCreate }

	local function doCreateTabPrefix()							-- Create Web Page Maps tab actions before button functions 
		deActivateControls(tblCreateControls)
		doShowFolderStatus()
	end -- local function doCreateTabPrefix

	local function doCreateTabSuffix()							-- Create Web Page Maps tab actions after button functions 
		doShowMapData()
		allControls.active = "YES"
		tabControls.active = "YES"
		if intMapped > 0 then										-- Enable controls for Mapped entries
			btnPrevMapped.active	= "YES"	
			btnNextMapped.active	= "YES"	
		end
		if intUnmapped > 0 then 									-- Enable controls for Omitted/Filtered/NoMap entries
			btnPrevUnmap.active	= "YES"	
			btnNextUnmap.active	= "YES"	
		end
		if FlgFolderExists(StrFolder) then						-- Enable controls for Delete/Map entries
			btnMapSome.active	= "YES"
			btnMapAll.active	= "YES"
			if txtMapState.fgcolor == TblStatusColor[IntMapFilename] then
				btnDeleteMap.active = "YES"
			end
			if intIndiName > 0 then
				btnMapThis.active	= "YES"
			end
		end
		vboxCreate.active		= "YES"
		btnIndiName.active		= "YES"
	end -- local function doCreateTabSuffix

	local function strMakeIndiName(ptrRecord)					-- Make record pointer into Individual list Name
		local strIndiName	= fhGetItemText(ptrRecord,"~.NAME:SURNAME_FIRST")
		local strRecordId	= fhGetRecordId(ptrRecord)
		return strIndiName.." ["..strRecordId.."]"
	end -- local function strMakeIndiName

	local function doBuildIndiNamesList()						-- Build the IndiNames list from Gedcom
		ShowStatusMessage(StrAmber,"Loading Individuals list, please wait…")
		tblGUI = tblTree[IntFromINDI]
		if next(tblIndiNames) == nil then
			local ptrRecord = fhNewItemPtr()
			ptrRecord:MoveToFirstRecord("INDI")
			while ptrRecord:IsNotNull() do
				local strIndiName = strMakeIndiName(ptrRecord)
				tblIndiNames[strIndiName] = {}
				tblIndiNames[strIndiName]["ptr"] = ptrRecord:Clone()
				tblIndiNames[strIndiName]["map"] = ""
				tblIndiNames[strIndiName]["use"] = true		-- Individual is chosen for use
				ptrRecord:MoveNext("SAME_TAG")
			end
			local ptrList = fhGetCurrentRecordSel("INDI")
			if #ptrList >= 1 then
				strIndiName = strMakeIndiName(ptrList[1])		-- Preset to currently selected Individual
			end
		end
		if not tblGUI.tree.count then
			ShowStatusMessage(StrAmber,"Loading Individuals data, please wait…")
			if FlgFolderExists(StrFolder) then					-- Update Map State for every Individual
				for strIndiName, tblIndiName in pairs(tblIndiNames) do
					local strRecordId = fhGetRecordId(tblIndiNames[strIndiName]["ptr"])
					local strMapName = "map"..strRecordId..".html"
					if not FlgFileExists(StrFolder.."\\"..strMapName) then strMapName = "" end
					tblIndiNames[strIndiName]["map"] = strMapName
				end
			end
			ShowStatusMessage(StrAmber,"Loading Individuals tree, please wait…")
			intIndiName = doBuildTreeNodes(tblIndiNames,strIndiName)
		end
		doShowFolderStatus()
		doRefreshIndiName(strIndiName)
	end -- local function doBuildIndiNamesList

	local function doCreateTabSettings()						-- Initial settings for Create Web Page Maps tab
		ZoomGoogleMap(IntMapZoom)
		doCreateTabPrefix()
		doBuildIndiNamesList()
		doCreateTabSuffix()
	end -- local function doCreateTabSettings

	local function doEraseMapFile(strMapFile)					-- Erase web page hyperlinks and delete map file
		if FlgFileExists(strMapFile) then
			-- Does folder contains FH Family Tree CD/Website?
			if IsFamilyTreeWebsite() then
				-- If so then remove map file hyperlink(s) from web page file
				local strHyperlink = StrPlainText("<li><a href='"..strMapFile:gsub("^"..StrPlainText(StrFolder).."\\","").."'>Map of Locations for ")..".-</a></li>\n"
--				local strHyperlink = StrPlainText("<p><a href='"..strMapFile:gsub("^"..StrPlainText(StrFolder).."\\","").."'>Map of Locations for ")..".-</a></p>\n"
				for strLine in io.lines(strMapFile) do
					-- Find hyperlink to web page file and extract its file name
					local strWebFile = string.match(strLine, "<li><a href='(%w-%.html)'>Detailed Facts for ")
					if strWebFile then
						strWebFile = StrFolder.."\\"..strWebFile
						local strWebPage = StrLoadFromFile(strWebFile)
						strWebPage = strWebPage:gsub(strHyperlink,"")	-- Remove hyperlink to map file
						strWebPage = strWebPage:gsub(StrDivSeeAlso..StrTxtSeeAlso..StrEndSeeAlso,"")	-- Remove empty "See also" section
						SaveStringToFile(strWebPage,strWebFile)
					end
				end	
			end
			DeleteFile(strMapFile)
		end
	end -- local function doEraseMapFile

	function btnMapAll:action()									-- Action for Map All Individuals button
		doCreateTabPrefix()
		if FlgFolderExists(StrFolder) then
			local isMappingOK = true
			local intIndividuals = tonumber(tblGUI.tree.count)
			if intIndividuals > 9 then isMappingOK = doShowWarnings("Web Page Mapping") end
			if isMappingOK then
				local strMapName = ""
				local intIndividual = intIndiName				-- Preserve current Individual selected
				dialogMain.active = "NO"
				ProgressBar.Start("Web Page Mapping",intIndividuals)
				MakeSharedFiles(StrFolder)
				SetWebPageMapSections()
				for intIndividual = 1, intIndividuals do
					ProgressBar.Step(1)
					local strIndiName = strGetTreeLeaf(tblGUI.tree,intIndividual)
					if strIndiName then
						intIndiName = intIndividual
						doRefreshIndiName(strIndiName,-1)
						if txtMapState.fgcolor == TblStatusColor[IntMapFilename] then
							doEraseMapFile(StrFolder.."\\"..txtMapState.value)	-- Unlink and Delete old Web Page Map file
						end
						tblIndiNames[strIndiName]["map"] = StrCreateWebPageMap(tblIndiNames[strIndiName]["ptr"])
						doRefreshIndiName(strIndiName,1)
						doListMapData()
						iup.Flush()
					end
					if ProgressBar.Stop() then break end
				end
				if #tblGUI.tblLeaf == 1 and txtMapState.fgcolor == TblStatusColor[IntMapFilename] then
					strMapName = txtMapState.value
				end
				intIndiName = intIndividual						-- Restore current Individual selected
				doRefreshIndiName(strIndiName)
				ProgressBar.Close()
				dialogMain.active = "YES"
				dialogMain.bringfront = "YES"
				DoExecute(StrFolder.."\\"..strMapName)
			end
		end
		doCreateTabSuffix()
	end -- function btnMapAll:action

	function btnMapSome:action()									-- Action for Map Some Individuals button
		doCreateTabPrefix()
		if FlgFolderExists(StrFolder) then
			local isMappingOK = doShowWarnings("Web Page Mapping")
			if isMappingOK then
				local ptrList = fhPromptUserForRecordSel("INDI")
				dialogMain.bringfront = "YES"
				if #ptrList > 0 then
					local strMapName = ""
					dialogMain.active = "NO"
					ProgressBar.Start("Web Page Mapping",#ptrList)
					MakeSharedFiles(StrFolder)
					SetWebPageMapSections()
					for i, ptrRecord in ipairs(ptrList) do		-- Loop all listed Individual Records
						ProgressBar.Step(1)
						local strIndiName = strMakeIndiName(ptrRecord)
						doRefreshIndiName(strIndiName,-1)
						if txtMapState.fgcolor == TblStatusColor[IntMapFilename] then
							doEraseMapFile(StrFolder.."\\"..txtMapState.value)	-- Unlink and Delete old Web Page Map file
						end
						tblIndiNames[strIndiName]["map"] = StrCreateWebPageMap(ptrRecord)
						doRefreshIndiName(strIndiName,1)
						doListMapData()
						iup.Flush()
						if ProgressBar.Stop() then break end
					end
					if #ptrList == 1 and txtMapState.fgcolor == TblStatusColor[IntMapFilename] then
						strMapName = txtMapState.value
					end
					doRefreshIndiName(strIndiName)
					ProgressBar.Close()
					dialogMain.active = "YES"
					dialogMain.bringfront = "YES"
					DoExecute(StrFolder.."\\"..strMapName)
				end
			end
		end
		doCreateTabSuffix()
	end -- function btnMapSome:action

	function btnMapThis:action()									-- Action for Map This Individual button
		doCreateTabPrefix()
		if FlgFolderExists(StrFolder) then
			if intIndiName > 0 then
				MakeSharedFiles(StrFolder)
				SetWebPageMapSections()
				if txtMapState.fgcolor == TblStatusColor[IntMapFilename] then
					doEraseMapFile(StrFolder.."\\"..txtMapState.value)	-- Unlink and Delete old Web Page Map file
				end
				tblIndiNames[strIndiName]["map"] = StrCreateWebPageMap(tblIndiNames[strIndiName]["ptr"])
				doRefreshIndiName(strIndiName)
				dialogMain.bringfront = "YES"
				if txtMapState.fgcolor == TblStatusColor[IntMapFilename] then
					DoExecute(StrFolder.."\\"..txtMapState.value)		-- Display new Web Page Map file
				end
			end
		end
		doCreateTabSuffix()
	end -- function btnMapThis:action

	function btnDeleteMap:action()								-- Action for Delete This Map button
		doCreateTabPrefix()
		doEraseMapFile(StrFolder.."\\"..txtMapState.value)	-- Unlink and Delete this Web Page Map file
		tblIndiNames[strIndiName]["map"] = ""
		doRefreshIndiName(strIndiName)
		ShowStatusMessage(StrGreen,"Web Page Map deleted")
		doCreateTabSuffix()
	end -- function btnDeleteMap:action

	function btnIndiName:action()								-- Action for Individual button
		doCreateTabPrefix()
		strLeaf = nil
		tblGUI.dialog:popup(IntMainX+intIndPosX,IntMainY+intIndPosY)
		if strLeaf then
			strIndiName = strLeaf
			intIndiName = intLeaf
			doRefreshIndiName(strIndiName)
		end
		doCreateTabSuffix()
	end -- function btnIndiName:action

	local function doSuccessorIndiName(intWay,isMapped)		-- Find Prior/Next Map/No Map Individual
		doCreateTabPrefix()											-- intWay=-1/+1 & isMapped=1/nil
		local intCount = 0
		local intMax = tonumber(tblGUI.tree.count)
		local intLoc = intIndiName
		local strLoc = ""
		local tblLoc = {}
		repeat
			intCount = intCount + 1
			intLoc = intLoc + intWay
			if intLoc > intMax then intLoc = 1 end
			if intLoc < 1 then intLoc = intMax end
			strLoc = strGetTreeLeaf(tblGUI.tree,intLoc)
			if strLoc then
				local strMap = tblIndiNames[strLoc]["map"]
				if string.find(strMap,"^"..StrMapFilename.."$") == isMapped then
					strIndiName = strLoc
					intIndiName = intLoc
					doRefreshIndiName(strIndiName)
					doCreateTabSuffix()
					return
				end
			end
		until intCount == intMax
		doCreateTabSuffix()
	end -- local function doSuccessorIndiName

	function btnPrevMapped:action()								-- Action for Prior Mapped entry button
		doSuccessorIndiName(-1,1)
	end

	function btnNextMapped:action()								-- Action for Next Mapped entry button
		doSuccessorIndiName(1,1)
	end

	function btnPrevUnmap:action()								-- Action for Prior Unmapped entry button
		doSuccessorIndiName(-1,nil)
	end

	function btnNextUnmap:action()								-- Action for Next Unmapped entry button
		doSuccessorIndiName(1,nil)
	end

	-- GUI Set Preference Options Tab Functions --

	local tblPreferControls = { allControls, btnCopyPLAC, btnCopyADDR, btnPurgeBOTH, btnErasePLAC, btnEraseADDR, btnEraseBOTH, btnDeleteAll, vboxPrefer }

	local function doPreferTabPrefix()							-- Set Preference Options tab actions before button functions 
		timPrefZoom.run	= "NO"
		deActivateControls(tblPreferControls)
		doShowFolderStatus()
	end -- local function doPreferTabPrefix

	local function doPreferTabSuffix()							-- Set Preference Options tab actions after button functions 
		allControls.active	= "YES"
		tabControls.active	= "YES"
		tabPrefer.active	= "YES"
		if FlgFolderExists(StrFolder) then						-- Enable controls for Delete Map entries
			btnDeleteAll.active	= "YES"
		end
		if IntFromTag >= IntFromBOTH then						-- Enable Purge Addr…Place button and update tooltip
			btnPurgeBOTH.active	= "YES"
			btnPurgeBOTH.tip	= btnPurgeBOTH.tip:gsub(" '.+' "," '"..TblFromName[IntFromTag].."' ")
		end
		vboxPrefer.active		= "YES"
		btnCopyPLAC.active		= "YES"
		btnCopyADDR.active		= "YES"
		btnErasePLAC.active		= "YES"
		btnEraseADDR.active		= "YES"
		btnEraseBOTH.active		= "YES"
		timPrefZoom.run			= "YES"
	end -- local function doPreferTabActions

	local function doDropStyleMarkers()							-- Drop example Markers in chosen style
		local strInfoWin = "1 Recorded Fact at"
		NullGoogleMap()
		PlotGoogleMap(51.500,-0.125,"Central London",strInfoWin)
		PlotGoogleMap(51.625,-0.375,"North West London",strInfoWin)
		PlotGoogleMap(51.625, 0.125,"North East London",strInfoWin)
		PlotGoogleMap(51.375, 0.125,"South East London",strInfoWin)
		PlotGoogleMap(51.375,-0.375,"South West London",strInfoWin)
		DropGoogleMap()
	end -- local function doDropStyleMarkers

	local function doPreferTabSettings(intTab)				-- Initial settings for Set Preference Options tab
		doPreferTabPrefix()
		tabPrefer.valuepos = intTab
		intPreferTab = intTab
		if intPreferTab == IntTabGeoLoc then
			tblGUI = tblTree[math.min(IntFromTag,IntFromBOTH)]
			ZoomGoogleMap(IntLocZoom)
			if btnLocation.fgcolor == TblStatusColor[IntPlotLatLong] then
				doMarkGoogleMapPlot()
			else
				MarkGoogleMap(51.500,-0.125,"Central London")
			end
		elseif intPreferTab == IntTabCreate then
			doBuildIndiNamesList()
			doDropStyleMarkers()
		else
			MarkGoogleMap("","","")
		end
		doPreferTabSuffix()
	end -- local function doPreferTabSettings

	function tabPrefer:tabchangepos_cb(intNew,intOld)		-- Call back when Set Preference Options tab position is changed  
		tabPrefer.active = "NO"
		SaveSettings(StrStickyFile)								-- Save sticky data settings
		doPreferTabSettings(intNew)
	end -- function tabPrefer:tabchangepos_cb

	function timPrefZoom:action_cb()							-- Call back when Pref Zoom timer expires
		timPrefZoom.run = "NO"
		doGetGoogleMapZoom()
		timPrefZoom.run = "YES"
	end -- function timMapZoom:action_cb

	function tglGeoCode:action(intState)						-- Action for Smart Geocoding toggle
		doPreferTabPrefix()
		if intState == 0 then StrGeoCode = "OFF" end
		if intState == 1 then StrGeoCode = "ON" end
		SaveSettings(StrStickyFile)								-- Save sticky data settings
		doPreferTabSuffix()
	end -- function tglGeoCode:action

	function lstRegBias:action(strText,intItem,intState)	-- Action when Region Bias Code is chosen
		if intState == 1 then
			if intItem ~= IntRegBias then
				doPreferTabPrefix()
				IntRegBias = intItem
				SaveSettings(StrStickyFile)						-- Save sticky data settings
				doPreferTabSuffix()
			end
		end
	end -- function lstRegBias:action

	function lstFromTag:action(strText,intItem,intState)	-- Action when Locations Source is chosen
		if intState == 1 then
			if intItem ~= IntFromTag then
				doPreferTabPrefix()
				if math.min(intItem,IntFromBOTH) ~= math.min(IntFromTag,IntFromBOTH) then
					StrLocation = nil								-- Switching GUI so reset chosen Location
					intLocation = 0
				end
				IntFromTag = intItem
				isFromNew = SetIsFromFlags()
				ZoomGoogleMap(IntLocZoom)
				doBuildLocationsList()
				SaveSettings(StrStickyFile)						-- Save sticky data settings
				doPreferTabSuffix()
			end
		end
	end -- function lstFromTag:action

	function lstStorage:action(strText,intItem,intState)	-- Action when Database Store is chosen
		if intState == 1 then
			if intItem ~= IntStorage then
				doPreferTabPrefix()
				local strRecords = ",\nbut other data you've added to the Records MAY NOT BE PRESERVED"
				if IntStorage == IntStoreFILE then
					strRecords = ",\nbut will create Source &&/or Repository Records in your Gedcom data"
				end
				local strCitations = ""
				if ( IntStorage == IntStoreSOUR and intItem == IntStoreBOTH )
				or ( IntStorage == IntStoreBOTH and intItem == IntStoreSOUR ) then
					strCitations = ",\nand maintain any associated Citations of your data Source Records"
				end
				if GUI_WarnDialogue("WARNING!  BEWARE!","Changing the Database Storage option will preserve all Geocode data"..strCitations..strRecords..".\n    Do you wish to continue with this Database Storage change?") == "Yes" then
					ConvertLocationsData(IntStorage,intItem)
					IntStorage = intItem
					SaveSettings(StrStickyFile)					-- Save sticky data settings
				else
					timStorage.run = "YES"							-- See action call back below
				end
				doPreferTabSuffix()
			end
		end
	end -- function lstStorage:action

	function timStorage:action_cb()								-- Call back when Database Storage change cancelled timer expires
		timStorage.run = "NO"
		lstStorage.value = IntStorage							-- Appears to be only way to ignore & reset drop list selection
	end -- function timStorage:action_cb

	local function doUpdateMapStatus()							-- Update Map State for every Individual
		ShowStatusMessage(StrAmber,"Loading Individuals data, please wait…")
		for intIndiName = 1, tonumber(tblGUI.tree.count) do
			local strIndiName = strGetTreeLeaf(tblGUI.tree,intIndiName)
			if strIndiName then
				local strRecordId = fhGetRecordId(tblIndiNames[strIndiName]["ptr"])
				local strMapName = "map"..strRecordId..".html"
				local strColor = TblStatusColor[IntMapFilename]
				if not FlgFileExists(StrFolder.."\\"..strMapName) then
					strMapName = ""
					strColor = TblStatusColor[IntMapNoMap]
				end
				tblIndiNames[strIndiName]["map"] = strMapName
				doColorLeafNode(intIndiName,strColor)
			end
		end
		doShowFolderStatus()
		doRefreshIndiName(strIndiName)
	end -- local function doUpdateMapStatus

	function txtMapFolder:valuechanged_cb()					-- Call back after Output Folder text is edited
		doPreferTabPrefix()
		if StrFolder ~= txtMapFolder.value then
			StrFolder = txtMapFolder.value
			doUpdateMapStatus()
			SaveSettings(StrStickyFile)							-- Save sticky data settings
		end
		doPreferTabSuffix()
	end -- function txtMapFolder:valuechanged_cb

	function btnMapFolder:action()								-- Action for Select Output Folder button
		doPreferTabPrefix()
		local strFolder = StrFolder
		local strDirectory = strFolder
		if not FlgFolderExists(StrFolder) then strDirectory = StrPublicPath end
		local dialogFolder = iup.filedlg{dialogtype="DIR", title="Please select output folder", directory=strDirectory}
		dialogFolder:popup (iup.CENTER, iup.CENTER)
		if dialogFolder.status == "-1" then
			ShowStatusMessage(StrAmber,"No folder selected")
		else
			StrFolder = dialogFolder.value
			if StrFolder ~= strFolder then doUpdateMapStatus() end
			SaveSettings(StrStickyFile)							-- Save sticky data settings
		end
		txtMapFolder.value = StrFolder
		doPreferTabSuffix()
	end -- function btnMapFolder:action

	function btnDeleteAll:action()								-- Action for Delete All Maps button
		doPreferTabPrefix()
		if GUI_WarnDialogue("WARNING!  BEWARE!","All the Web Page Maps will be deleted from the Output Folder.\n   Do you wish to continue to Delete these Web Page Maps?") == "Yes" then
			for strMapFile, tblAttr in DirTree(StrFolder) do
				if string.find(strMapFile,"\\"..StrMapFilename.."$") then doEraseMapFile(strMapFile) end	-- Unlink and Delete every Web Page Map file
				if string.find(strMapFile,"\\mapfacts%.%l+$") then DeleteFile(strMapFile) end				-- Delete mapfacts.css & mapfacts.js files
			end
			for strIndiName, tblIndiName in pairs(tblIndiNames) do
				if strIndiName then tblIndiNames[strIndiName]["map"] = "" end
			end
			doRefreshIndiName(strIndiName)
			ShowStatusMessage(StrGreen,"Web Page Maps deleted")
		end
		doPreferTabSuffix()
	end -- function btnDeleteAll:action

	function lstMarkers:action(strText,intItem,intState)	-- Action when Markers Style is chosen
		if intState == 1 then
			doPreferTabPrefix()
			IntMarkers = intItem
			doDropStyleMarkers()
			SaveSettings(StrStickyFile)							-- Save sticky data settings
			doPreferTabSuffix()
		end
	end -- function lstMarkers:action

	function lstPrivacy:action(strText,intItem,intState)	-- Action when Privacy Filter is chosen
		if intState == 1 then
			IntPrivacy = intItem
			SaveSettings(StrStickyFile)							-- Save sticky data settings
		end
	end -- function lstPrivacy:action

	local function strRecords()									-- Return text for delete data in Records message
		if IntStorage == IntStoreFILE then
			return ""
		else
			return "\n and delete any other data that you may have added to the Location Records"
		end
	end -- local function strRecords

	local function doCopyLocations(intFromTag)				-- Copy Place or Address Database to Address…Place Database
		doPreferTabPrefix()
		local strSourceName = TblFromName[intFromTag]
		local strTargetName = TblFromName[intFromTag - IntFromPLAC + IntFromBOTH]
		if GUI_WarnDialogue("WARNING!  BEWARE!","Copying the '"..strSourceName.."' Locations Database will overwrite ALL Geocode data"..strRecords().."\n in all the '"..strTargetName.."' entries in the 'Address…Place' Locations database.\n\n   Do you wish to continue to Copy the '"..strSourceName.."' Locations Database?\n") == "Yes" then
			local strSaveTag = StrFromTag						-- Save original StrFromTag
			StrFromTag = TblFromTag[IntFromBOTH]
			TblLocationData = TblLocationCode[StrFromTag]	-- Target Address…Place database
			local strPrefix = ""
			local strSuffix = "…"
			if intFromTag == IntFromPLAC then					-- Set "…" prefix/suffix for Location name in Address…Place database
				strPrefix = "…"
				strSuffix = ""
			end
			for strLocName, tblLocData in pairs(TblLocationCode[TblFromTag[intFromTag]]) do
				strLocName = strPrefix..strLocName..strSuffix
				if not TblLocationData[strLocName] then		-- Add new target Location to data
					TblLocationData[strLocName] = { rec = 0, sub = "", lat = "", lng = "", mod = "" }
				end
				TblLocationData[strLocName]["sub"] = tblLocData["sub"] or ""
				TblLocationData[strLocName]["lat"] = tblLocData["lat"] or ""
				TblLocationData[strLocName]["lng"] = tblLocData["lng"] or ""
				TblLocationData[strLocName]["mod"] = tblLocData["mod"] or ""
				SaveLocationsData(strLocName)
			end
			StrFromTag = strSaveTag								-- Restore saved StrFromTag
			ShowStatusMessage(StrGreen,"'"..strSourceName.."' Database Copied")
			fhUpdateDisplay()
		end
		doPreferTabSuffix()
	end -- local function doCopyLocations

	function btnCopyPLAC:action()								-- Action for Copy Place Database button
		doCopyLocations(IntFromPLAC)
	end -- function btnCopyPLAC:action

	function btnCopyADDR:action()								-- Action for Copy Address Database button
		doCopyLocations(IntFromADDR)
	end -- function btnCopyADDR:action

	function btnPurgeBOTH:action()								-- Action for Purge Addr…Place Database button
		doPreferTabPrefix()
		if IntFromTag >= IntFromBOTH then
			local strFromName = TblFromName[IntFromTag]
			if GUI_WarnDialogue("WARNING!  BEWARE!","Purging the '"..strFromName.."' Locations Database will ERASE ALL Geocode data"..strRecords().."\n for all those Location entries not currently included in the Location list.\n\n   Do you wish to continue to Purge the '"..strFromName.."' Locations Database?\n") == "Yes" then
				isFromNew = SetIsFromFlags()
				doBuildLocationsList()									-- Rebuild list without Locations not included
				ShowStatusMessage(StrGreen,"'"..strFromName.."' Database Purged")
				fhUpdateDisplay()
			end
		end
		doPreferTabSuffix()
	end -- function btnPurgeBOTH:action

	local function doEraseLocation(intFromTag)				-- 1="PLAC" or 2="ADDR" or 3="BOTH"
		doPreferTabPrefix()
		local strFromTag = TblFromTag[intFromTag]
		if intFromTag == IntFromBOTH then intFromTag = IntFromAP end
		local strFromName = TblFromName[intFromTag]
		if GUI_WarnDialogue("WARNING!  BEWARE!","Erasing the '"..strFromName.."' Locations Database will ERASE ALL Geocode data"..strRecords()..".\n\n   Do you wish to continue to Erase the '"..strFromName.."' Locations Database?\n") == "Yes" then
			if IntStorage == IntStoreFILE then
				TblLocationCode[strFromTag] = {}
				SaveLocationsFile()
			else
				TblLocationData = TblLocationCode[strFromTag]
				for strLocName, tblLocData in pairs(TblLocationData) do
					DeleteLocationRecord(tblLocData["rec"])
				end
				TblLocationCode[strFromTag] = {}
			end
			ShowStatusMessage(StrGreen,"'"..strFromName.."' Database Erased")
			fhUpdateDisplay()
		end
		doPreferTabSuffix()
	end -- local function doEraseLocation

	function btnErasePLAC:action()								-- Action for Erase Place Database button
		doEraseLocation(IntFromPLAC)
	end -- function btnErasePLAC:action

	function btnEraseADDR:action()								-- Action for Erase Address Database button
		doEraseLocation(IntFromADDR)
	end -- function btnEraseADDR:action

	function btnEraseBOTH:action()								-- Action for Erase Addr…Place Database button
		doEraseLocation(IntFromBOTH)
	end -- function btnEraseBOTH:action

	function btnDefault:action()									-- Action for Restore Defaults button
		timPrefZoom.run = "NO"
		ResetDefaultSettings()
		if	BtnMainHelp.active == "NO" then						-- If Help button inactive, then Help is active, so redisplay its dialogue
			DialogHelp.rastersize = StrHelpS
			DialogHelp:showxy(IntHelpX,IntHelpY)
		end
		lstFromTag.value		= IntFromTag						-- Reset controls & redisplay Main dialogue
		txtLocZoom.value		= IntLocZoom
		txtMapFolder.value		= StrFolder
		lstMarkers.value		= IntMarkers
		lstPrivacy.value		= IntPrivacy
		txtMapZoom.value		= IntMapZoom
		dialogMain.rastersize	= StrMainS
		dialogMain:showxy(IntMainX,IntMainY)
		local tblPosn = dialogMain.screenposition:SplitNumbers()
		IntMainX = tblPosn[1]
		IntMainY = tblPosn[2]
		doResizeButtons()
		tabControls.valuepos	= IntTabPosn
		doGeoLocTabSettings()
		SaveSettings(StrStickyFile)								-- Save sticky data settings
	end -- function btnDefault:action

	local tblLocToSub = { "130x59", "130x57", "130x53", "130x53", "130x55", "130x52", } -- btnLocToSub rastersize for each font set

	function btnFontSet:action()									-- Action for User Interface Font button
		doPreferTabPrefix()
		local strAnswer = GUI_FontDialogue()
		doPreferTabSuffix()
		if strAnswer == "Change" then
			for i, control in ipairs({ framePlotData, frameMapData, tabPrefer, tabControls, }) do
				control.font = StrFontHead
			end
			for i, control in ipairs({ vboxPlotData, vboxGeoLoc, vboxMapData, vboxCreate, vboxPlotOpt, vboxMapsOpt, vboxDataOpt, vboxPrefer, allControls, tblTree[IntFromPLAC].vbox, tblTree[IntFromADDR].vbox, tblTree[IntFromBOTH].vbox, tblTree[IntFromINDI].vbox }) do
				control.font = StrFontBody
			end
			if	BtnMainHelp.active == "NO" then					-- If Help button inactive, then Help is active, so update its font
				HboxHelp.font = StrFontBody
			end
			btnLocToSub.rastersize = tblLocToSub[IntFontSet] -- Adjust button size for font set
			SaveSettings(StrStickyFile)							-- Save sticky data settings
		end
	end -- function btnFontSet:action

	-- GUI Main Dialogue Global Functions --

	function tabControls:tabchangepos_cb(intNew,intOld)		-- Call back when Main tab position is changed  
		timPrefZoom.run = "NO"
		tabControls.active = "NO"
		IntTabPosn = intNew
		if IntTabPosn == IntTabGeoLoc then
			doGeoLocTabSettings()
		elseif IntTabPosn == IntTabCreate then
			doCreateTabSettings()
		elseif IntTabPosn == IntTabPrefer then
			doPreferTabSettings(intOld)
		end
		if IntStorage == IntStoreFILE then SaveLocationsFile() end
		SaveSettings(StrStickyFile)								-- Save sticky data settings
	end -- function tabControls:tabchangepos_cb

	function BtnMainHelp:action()								-- Action for Help & Advice button
		BtnMainHelp.active = "NO"
		if intPlotted == 0 then GUI_HelpDialogue()
		elseif IntTabPosn == IntTabGeoLoc then GUI_HelpDialogue("plots")
		elseif IntTabPosn == IntTabCreate then GUI_HelpDialogue("create")
		elseif IntTabPosn == IntTabPrefer then GUI_HelpDialogue("prefer") end
	end -- function BtnMainHelp:action

	function timMainHelp:action_cb()							-- Call back when Main Help startup timer expires
		timMainHelp.run = "NO"
		if IntTabPosn == IntTabGeoLoc
		and intPlotted == 0 then
			BtnMainHelp.active = "NO"
			GUI_HelpDialogue("facts")								-- Startup splash Main Help for first time user
		end
	end -- function timMainHelp:action_cb

	local function doCloseMain()
		timPrefZoom.run = "NO"
		fhSleep(100)
		if IntTabPosn == IntTabGeoLoc then doGeoLocTabPrefix() end
		if IntTabPosn == IntTabCreate then doCreateTabPrefix() end
		if IntTabPosn == IntTabPrefer then doPreferTabPrefix() end
		if IntStorage == IntStoreFILE then SaveLocationsFile() end
		CloseGoogleMap()
	end -- local function doCloseMain

	function btnClose:action()									-- Action for Close Plugin button
		doCloseMain()
		return iup.CLOSE 
	end -- function btnClose:action

	function dialogMain:close_cb()								-- Call back when GUI window Close pressed
		if allControls.active == "NO" then
			allControls.active	= "YES"							-- Needed in case of faults that leave controls inactive
			return iup.IGNORE
		else
			doCloseMain()
			return iup.CLOSE
		end
	end -- function dialogMain:close_cb

	-- GUI Main Dialogue Initialisation --

	dialogMain:showxy(IntMainX,IntMainY)

	tabControls.valuepos	= IntTabPosn							-- Adjust tab selection
	btnLocToSub.rastersize	= tblLocToSub[IntFontSet]			-- Adjust button size
	btnLocation.position	= txtLocation.position				-- Adjust button positions
	iup.RefreshChildren(vboxGeoLoc)
	btnIndiName.position	= txtIndiName.position
	iup.RefreshChildren(vboxCreate)

	local strRegBiasTip = lstRegBias.tip						-- Populate Region Bias list
	lstRegBias.tip = nil											-- Temporarily erase tooltip to speed up appenditem
	lstRegBias.autoredraw = "NO"
	lstRegBias.removeitem = nil
	for i,strRegBias in ipairs(TblRegBias) do
		lstRegBias.appenditem = strRegBias
	end
	lstRegBias.autoredraw = "YES"
	lstRegBias.tip = strRegBiasTip
	lstRegBias.value = IntRegBias

	doBuildTreeDialogues()
	LoadLocationsData()
	doBuildLocationsList()

	if IntTabPosn == IntTabGeoLoc then
		doGeoLocTabPrefix()
		doGeoLocTabSuffix()
	elseif IntTabPosn == IntTabCreate then
		doCreateTabPrefix()
		doBuildIndiNamesList()
		doCreateTabSuffix()
	elseif IntTabPosn == IntTabPrefer then
		doPreferTabSettings(IntTabGeoLoc)
	end
	dialogMain.active = "YES"
	allControls.active = "YES"
	timMainHelp.run = "YES"

	if (iup.MainLoopLevel()==0) then iup.MainLoop() end

end -- function GUI_MainDialogue

-- Main body of Plugin script starts here --

	fhInitialise(5,0,0,"save_recommended")

	PresetGlobalConstants()			-- Preset global data constants

	ResetDefaultSettings()				-- Preset default sticky settings

	IntStorage = IntStoreFILE			-- Geocode Locations Database store
	IntFontSet = IntFontPlain			-- Font Face & Style default

	LoadSettings(StrStickyFile)		-- Load sticky data settings

	ImportOldGeoCodeMaintData()

	GUI_MainDialogue()

	SaveSettings(StrStickyFile)		-- Save sticky data settings

	fhUpdateDisplay()
