--[[
@Title:			Improve Website or CD DVD HTML
@Author:			Mike Tate
@Version:			2.3
@LastUpdated:	13 May 2013
@Description:	Ensure user URL are hyperlinks, abbreviate long URL, offer alternative image popups, add Table of Contents pages, add alternate & married names and ids to Index of Names, and create GenDex file.
@V2.3:				Add 'Table of Pictures/Reports/Downloads' pages, remove Folder selection from tab, plus minor improvements.
@V2.2:				Replace integer with string parameters, add Custom Large Screen Popups, convert CP1252 to UTF-8, add Create GenDex tab, minor string library updates,
					and swap first DOCTYPE line XHTML Strict with Transitional depending if target="_blank" is enabled (alternative is onclick="window.open(this.href,'_blank');return false;").
@V2.1:				Improve analysis of anchor tag attributes without quotes, and fix indefinite strHyper loop bug.
@V2.0:				Change GUI to tabbed interface.
@V1.9:				Support more URL syntax options, replace {{DATE:QUAL}} with today's date & {{FILE:QUAL}} with file name/path, and other minor updates.
@V1.8:				Ensure HTML symbols in Identities are escaped, and gsub pattern symbols in abbreviated URL are escaped.
@V1.7:				Prototype ProgressBar, allow Identities per Name, abbreviate long URL, convert URL & popups on all HTML pages, process my locations database, plus bug fixes.
@V1.6:				Improve fhpopup.js XHTML compatibility, exclude URL in image popup title, minor GUI changes, and update to FlgFolderExists().
@V1.5:				Popups allow multi-line titles & single quotes (') in titles, retain original page position, and reduce initial zoom of small images.
@V1.4:				Check HTML folder contains V5 XHTL, and fix minor bugs.
@V1.3:				Provide alternative image popups feature.
@V1.2:				Index of Names tooltip title="Married/Alternate Name", choice of Style for added names, Check Version in Store bug fix due to "-" in name!
@V1.1:				Better name sorting using setlocale() with non-alphabetic surnames first.
					Use XHTML anchor tag id="letter" format instead of deprecated name="letter" in _nameindex.html.
					Convert user URL into hyperlinks optionally opening in a new tab/window.
					Allow user HTML anchor tag format to specify Hyperlinks.
					Made all window positions and settings sticky.
@V1.0:				Initial version.
]]
	StrPlugin		= "Improve Website or CD DVD HTML"	-- Plugin title & version
	StrVersion	= " Version 2.3 "

	require "iuplua"										-- To access GUI window builder
	require "lfs"											-- To access LUA filing system
	require "iupluaole"										-- To access OLE subsystem
	require "luacom"										-- To access COM subsystem

	os.setlocale("C","collate")							-- Set standard ASCII collation order

Str_lytebox_js = [=[
//**************************************************************************************************/
//	Lytebox v5.5
//
//	 Author: Markus F. Hay
//  Website: http://lytebox.com  (http://dolem.com/lytebox)
//	   Date: January 26, 2012
//	License: Creative Commons Attribution 3.0 License (http://creativecommons.org/licenses/by/3.0/)
//**************************************************************************************************/
function Lytebox(bInitialize, aHttp) {
	/*** Language Configuration ***/
	
		// English - configure for your language or customize as needed. 
		// Note that these values will be seen by users when mousing over buttons.
		this.label = new Object();
		this.label['close']		= 'Close (Esc)';
		this.label['prev'] 		= 'Previous (\u2190)';	// Previous (left arrow)
		this.label['next'] 		= 'Next (\u2192)'; 		// Next (right arrow)
		this.label['play'] 		= 'Play (spacebar)';
		this.label['pause'] 	= 'Pause (spacebar)';
		this.label['print'] 	= 'Print';
		this.label['image'] 	= 'Image %1 of %2';		// %1 = active image, %2 = total images
		this.label['page'] 		= 'Page %1 of %2'; 		// %1 = active page, %2 = total pages
		
	
	/*** Configure Lytebox ***/
	
		this.theme   			= (typeof lyteboxTheme !== 'undefined') && /^(black|grey|red|green|blue|gold|orange)$/i.test(lyteboxTheme) ? lyteboxTheme : 'grey'; // themes: black (default), grey, red, green, blue, gold, orange
		this.roundedBorder		= true; 		// controls whether or not the viewer uses rounded corners (false = square corners)
		this.innerBorder		= true;			// controls whether to show the inner border around image/html content
		this.outerBorder		= true;			// controls whether to show the outer grey (or theme) border
		this.resizeSpeed		= 8;			// controls the speed of the image resizing (1=slowest and 10=fastest)
		this.maxOpacity			= 20;			// higher opacity = darker overlay, lower opacity = lighter overlay
		this.borderSize			= 12;			// if you adjust the padding in the CSS, you will need to update this variable -- otherwise, leave this alone...
		this.appendQS			= false;		// if true, will append request_from=lytebox to the QS. Use this with caution as it may cause pages to not render
		this.fixedPosition		= this.isMobile() ? false : true;	// if true, viewer will remain in a fixed position, otherwise page scrolling will be allowed
		this.inherit			= true;			// controls whether or not data-lyte-options are inherited from the first link in a grouped set
		
		this.__hideObjects		= true;			// controls whether or not objects (such as Flash, Java, etc.) should be hidden when the viewer opens
		this.__autoResize		= true;			// controls whether or not images should be resized if larger than the browser window dimensions
		this.__doAnimations		= true;			// controls ALL animation effects (i.e. overlay fade in/out, image resize transition, etc.)
		this.__animateOverlay	= false;		// controls ONLY the overlay (background darkening) effects, and whether or not to fade in/out
		this.__forceCloseClick 	= false;		// if true, users are forced to click on the "Close" button when viewing content
		this.__refreshPage		= false;		// force page refresh after closing Lytebox
		this.__showPrint		= false;		// true to show print button, false to hide
		this.__navType			= 3;			// 1 = "Prev/Next" buttons on top left and left
												// 2 = "Prev/Next" buttons in navigation bar
												// 3 = navType_1 + navType_2 (show both)
													
		// These two options control the position of the title/counter and navigation buttons. Note that for mobile devices,
		// the title is displayed on top and the navigation on the bottom. This is due to the view area being limited.
		// You can customize this for non-mobile devices by changing the 2nd condition (: false) to true (: true)
		this.__navTop			= this.isMobile() ? false : false; // true to show the buttons on the top right, false to show them on bottom right (default)
		this.__titleTop			= this.isMobile() ? true : false;  // true to show the title on the top left, false to show it on the bottom left (default)
	
	
	/*** Configure HTML Content / Media Viewer Options ***/
	
		this.__width			= '80%';		// default width of content viewer
		this.__height			= '80%';		// default height of content viewer
		this.__scrolling		= 'auto';		// controls whether or not scrolling is allowed in the content viewer -- options are auto|yes|no
		this.__loopPlayback		= false;		// controls whether or not embedded media is looped (swf, avi, mov, etc.)
		this.__autoPlay			= true;			// controls whether or not to autoplay embedded media
		this.__autoEmbed		= true;			// controls whether or not to automatically embed media in an object tag
	
	
	/*** Configure Slideshow Options ***/
	
		this.__slideInterval	= 4000;			// change value (milliseconds) to increase/decrease the time between "slides"
		this.__showNavigation	= false;		// true to display Next/Prev buttons/text during slideshow, false to hide
		this.__showClose		= true;			// true to display the Close button, false to hide
		this.__showDetails		= true;			// true to display image details (caption, count), false to hide
		this.__showPlayPause	= true;			// true to display pause/play buttons next to close button, false to hide
		this.__autoEnd			= true;			// true to automatically close Lytebox after the last image is reached, false to keep open
		this.__pauseOnNextClick	= false;		// true to pause the slideshow when the "Next" button is clicked
		this.__pauseOnPrevClick = true;			// true to pause the slideshow when the "Prev" button is clicked
		this.__loopSlideshow	= false;		// true to continuously loop through slides, false otherwise
	
	
	/*** Configure Event Callbacks ***/
	
		this.__beforeStart		= '';			// function to call before the viewer starts
		this.__afterStart		= '';			// function to call after the viewer starts
		this.__beforeEnd		= '';			// function to call before the viewer ends (after close click)
		this.__afterEnd			= '';			// function to call after the viewer ends
	
		
	/*** Configure Lytetip (tooltips) Options ***/
		this.__changeTipCursor 	= true; 		// true to change the cursor to 'help', false to leave default (inhereted)
		this.__tipDecoration	= 'dotted';		// controls the text-decoration (underline) of the tip link (dotted|solid|none)
		this.__tipStyle 		= 'classic';	// sets the default tip style if none is specified via data-lyte-options. Possible values are classic, info, help, warning, error
		this.__tipRelative		= true;			// if true, tips will be positioned relative to the element. if false, tips will be absolutely positioned on the page.
												// if you are having issues with tooltips not being properly positioned, then set this to false


	this.navTypeHash = new Object();
	this.navTypeHash['Hover_by_type_1'] 	= true;
	this.navTypeHash['Display_by_type_1'] 	= false;
	this.navTypeHash['Hover_by_type_2'] 	= false;
	this.navTypeHash['Display_by_type_2']	= true;
	this.navTypeHash['Hover_by_type_3'] 	= true;
	this.navTypeHash['Display_by_type_3'] 	= true;
	this.resizeWTimerArray		= new Array();
	this.resizeWTimerCount		= 0;
	this.resizeHTimerArray		= new Array();
	this.resizeHTimerCount		= 0;
	this.changeContentTimerArray= new Array();
	this.changeContentTimerCount= 0;
	this.overlayTimerArray		= new Array();
	this.overlayTimerCount		= 0;
	this.imageTimerArray		= new Array();
	this.imageTimerCount		= 0;
	this.timerIDArray			= new Array();
	this.timerIDCount			= 0;
	this.slideshowIDArray		= new Array();
	this.slideshowIDCount		= 0;
	this.imageArray	 = new Array();
	this.slideArray	 = new Array();
	this.frameArray	 = new Array();
	this.contentNum = null;
	this.aPageSize = new Array();
	this.overlayLoaded = false;
	this.checkFrame();
	this.isSlideshow 	= false;
	this.isLyteframe 	= false;
	this.tipSet	 		= false;
	this.ieVersion = this.ffVersion = this.chromeVersion = this.operaVersion = this.safariVersion = -1;
	this.ie = this.ff = this.chrome = this.opera = this.safari = false;
	this.setBrowserInfo();
	this.classAttribute = (((this.ie && this.doc.compatMode == 'BackCompat') || (this.ie && this.ieVersion <= 7)) ? 'className' : 'class');
	this.classAttribute = (this.ie && (document.documentMode == 8 || document.documentMode == 9)) ? 'class' : this.classAttribute;
	this.isReady = false;
	if (bInitialize) {
		this.http = aHttp;
		this.bodyOnscroll = document.body.onscroll;
		if(this.resizeSpeed > 10) { this.resizeSpeed = 10; }
		if(this.resizeSpeed < 1) { this.resizeSpeed = 1; }
		var ie8Duration = 2;
			var isWinXP = (navigator.userAgent.match(/windows nt 5.1/i) || navigator.userAgent.match(/windows nt 5.2/i) ? true : false);
		this.resizeDuration = (11 - this.resizeSpeed) * (this.ie ? (this.ieVersion >= 9 ? 6 : (this.ieVersion == 8 ? (this.doc.compatMode == 'BackCompat' ? ie8Duration : ie8Duration - 1) : 3)) : 7);
			this.resizeDuration = this.ff ? (11 - this.resizeSpeed) * (this.ffVersion < 6 ? 3 : (isWinXP ? 6 : 12)) : this.resizeDuration;
		this.resizeDuration = this.chrome ? (11 - this.resizeSpeed) * 5 : this.resizeDuration;
		this.resizeDuration = this.safari ? (11 - this.resizeSpeed) * 20 : this.resizeDuration;
			this.resizeDuration = this.isMobile() ? (11 - this.resizeSpeed) * 2 : this.resizeDuration;
		if (window.name != 'lbIframe') {
			this.initialize();
		}
	} else {
		this.http = new Array();
		if (typeof $ == 'undefined') {
			$ = function (id) {
					if ($.cache[id] === undefined) {
						$.cache[id] = document.getElementById(id) || false;
					}
					return $.cache[id];
				};
			$.cache = {};
		}
	}
}
Lytebox.prototype.setBrowserInfo = function() {
	var ua = navigator.userAgent.toLowerCase();
	this.chrome = ua.indexOf('chrome') > -1;
	this.ff = ua.indexOf('firefox') > -1;
	this.safari = !this.chrome && ua.indexOf('safari') > -1;
	this.opera = ua.indexOf('opera') > -1;
	this.ie = /*@cc_on!@*/false;
	if (this.chrome) {
		var re = new RegExp("chrome/([0-9]{1,}[\.0-9]{0,})");
		if (re.exec(ua) != null) {
			this.chromeVersion = parseInt( RegExp.$1 );
		}
	}
	if (this.ff) {
		var re = new RegExp("firefox/([0-9]{1,}[\.0-9]{0,})");
		if (re.exec(ua) != null) {
			this.ffVersion = parseInt( RegExp.$1 );
		}
	}
	if (this.ie) {
		var re = new RegExp("msie ([0-9]{1,}[\.0-9]{0,})");
		if (re.exec(ua) != null) {
			this.ieVersion = parseInt( RegExp.$1 );
		}
	}
	if (this.opera) {
		var re = new RegExp("opera/([0-9]{1,}[\.0-9]{0,})");
		if (re.exec(ua) != null) {
			this.operaVersion = parseInt( RegExp.$1 );
		}
	}
	if (this.safari) {
		var re = new RegExp("version/([0-9]{1,}[\.0-9]{0,})");
		if (re.exec(ua) != null) {
			this.safariVersion = parseInt( RegExp.$1 );
		}
	}
};
Lytebox.prototype.initialize = function() {
	this.updateLyteboxItems();
	var oBody = this.doc.getElementsByTagName('body').item(0);
	if (this.doc.$('lbOverlay')) { oBody.removeChild(this.doc.$('lbOverlay')); }
	if (this.doc.$('lbMain')) {	oBody.removeChild(this.doc.$('lbMain')); }
	if (this.doc.$('lbLauncher')) { oBody.removeChild(this.doc.$('lbLauncher')); }
	var oLauncher = this.doc.createElement('a');
		oLauncher.setAttribute('id','lbLauncher');
		oLauncher.setAttribute(this.classAttribute, 'lytebox');
		oLauncher.style.display = 'none';
		oBody.appendChild(oLauncher);
	var oOverlay = this.doc.createElement('div');
		oOverlay.setAttribute('id','lbOverlay');
		oOverlay.setAttribute(this.classAttribute, this.theme);
		if (this.ie && (this.ieVersion <= 6 || (this.ieVersion <= 9 && this.doc.compatMode == 'BackCompat'))) {
			oOverlay.style.position = 'absolute';
		}
		oOverlay.style.display = 'none';
		oBody.appendChild(oOverlay);
	var oLytebox = this.doc.createElement('div');
		oLytebox.setAttribute('id','lbMain');
		oLytebox.style.display = 'none';
		oBody.appendChild(oLytebox);
	var oOuterContainer = this.doc.createElement('div');
		oOuterContainer.setAttribute('id','lbOuterContainer');
		oOuterContainer.setAttribute(this.classAttribute, this.theme);
		if (this.roundedBorder) {
			oOuterContainer.style.MozBorderRadius = '8px';
			oOuterContainer.style.borderRadius = '8px';
		}
		oLytebox.appendChild(oOuterContainer);
	var oTopContainer = this.doc.createElement('div');
		oTopContainer.setAttribute('id','lbTopContainer');
		oTopContainer.setAttribute(this.classAttribute, this.theme);
		if (this.roundedBorder) {
			oTopContainer.style.MozBorderRadius = '8px';
			oTopContainer.style.borderRadius = '8px';
		}
		oOuterContainer.appendChild(oTopContainer);
	var oTopData = this.doc.createElement('div');
		oTopData.setAttribute('id','lbTopData');
		oTopData.setAttribute(this.classAttribute, this.theme);
		oTopContainer.appendChild(oTopData);
	var oTitleTop = this.doc.createElement('span');
		oTitleTop.setAttribute('id','lbTitleTop');
		oTopData.appendChild(oTitleTop);
	var oNumTop = this.doc.createElement('span');
		oNumTop.setAttribute('id','lbNumTop');
		oTopData.appendChild(oNumTop);
	var oTopNav = this.doc.createElement('div');
		oTopNav.setAttribute('id','lbTopNav');
		oTopContainer.appendChild(oTopNav);
	var oCloseTop = this.doc.createElement('a');
		oCloseTop.setAttribute('id','lbCloseTop');
		oCloseTop.setAttribute('title', this.label['close']);
		oCloseTop.setAttribute(this.classAttribute, this.theme);
		oCloseTop.setAttribute('href','javascript:void(0)');
		oTopNav.appendChild(oCloseTop);
	var oPrintTop = this.doc.createElement('a');
		oPrintTop.setAttribute('id','lbPrintTop')
		oPrintTop.setAttribute('title', this.label['print']);
		oPrintTop.setAttribute(this.classAttribute, this.theme);
		oPrintTop.setAttribute('href','javascript:void(0)');
		oTopNav.appendChild(oPrintTop);
	var oNextTop = this.doc.createElement('a');
		oNextTop.setAttribute('id','lbNextTop');
		oNextTop.setAttribute('title', this.label['next']);
		oNextTop.setAttribute(this.classAttribute, this.theme);
		oNextTop.setAttribute('href','javascript:void(0)');
		oTopNav.appendChild(oNextTop);
	var oPauseTop = this.doc.createElement('a');
		oPauseTop.setAttribute('id','lbPauseTop');
		oPauseTop.setAttribute('title', this.label['pause']);
		oPauseTop.setAttribute(this.classAttribute, this.theme);
		oPauseTop.setAttribute('href','javascript:void(0)');
		oPauseTop.style.display = 'none';
		oTopNav.appendChild(oPauseTop);
	var oPlayTop = this.doc.createElement('a');
		oPlayTop.setAttribute('id','lbPlayTop');
		oPlayTop.setAttribute('title', this.label['play']);
		oPlayTop.setAttribute(this.classAttribute, this.theme);
		oPlayTop.setAttribute('href','javascript:void(0)');
		oPlayTop.style.display = 'none';
		oTopNav.appendChild(oPlayTop);
	var oPrevTop = this.doc.createElement('a');
		oPrevTop.setAttribute('id','lbPrevTop');
		oPrevTop.setAttribute('title', this.label['prev']);
		oPrevTop.setAttribute(this.classAttribute, this.theme);
		oPrevTop.setAttribute('href','javascript:void(0)');
		oTopNav.appendChild(oPrevTop);
	var oIframeContainer = this.doc.createElement('div');
		oIframeContainer.setAttribute('id','lbIframeContainer');
		oIframeContainer.style.display = 'none';
		oOuterContainer.appendChild(oIframeContainer);
	var oIframe = this.doc.createElement('iframe');
		oIframe.setAttribute('id','lbIframe');
		oIframe.setAttribute('name','lbIframe')
		oIframe.setAttribute('frameBorder','0');
		if (this.innerBorder) {
			oIframe.setAttribute(this.classAttribute, this.theme);
		}
		oIframe.style.display = 'none';
		oIframeContainer.appendChild(oIframe);
	var oImageContainer = this.doc.createElement('div');
		oImageContainer.setAttribute('id','lbImageContainer');
		oOuterContainer.appendChild(oImageContainer);
	var oLyteboxImage = this.doc.createElement('img');
		oLyteboxImage.setAttribute('id','lbImage');
		if (this.innerBorder) {
			oLyteboxImage.setAttribute(this.classAttribute, this.theme);
		}
		oImageContainer.appendChild(oLyteboxImage);
	var oLoading = this.doc.createElement('div');
		oLoading.setAttribute('id','lbLoading');
		oLoading.setAttribute(this.classAttribute, this.theme);
		oOuterContainer.appendChild(oLoading);
	var oBottomContainer = this.doc.createElement('div');
		oBottomContainer.setAttribute('id','lbBottomContainer');
		oBottomContainer.setAttribute(this.classAttribute, this.theme);
		if (this.roundedBorder) {
			oBottomContainer.style.MozBorderRadius = '8px';
			oBottomContainer.style.borderRadius = '8px';
		}
		oOuterContainer.appendChild(oBottomContainer);
	var oDetailsBottom = this.doc.createElement('div');
		oDetailsBottom.setAttribute('id','lbBottomData');
		oDetailsBottom.setAttribute(this.classAttribute, this.theme);
		oBottomContainer.appendChild(oDetailsBottom);
	var oTitleBottom = this.doc.createElement('span');
		oTitleBottom.setAttribute('id','lbTitleBottom');
		oDetailsBottom.appendChild(oTitleBottom);
	var oNumBottom = this.doc.createElement('span');
		oNumBottom.setAttribute('id','lbNumBottom');
		oDetailsBottom.appendChild(oNumBottom);
	var oDescBottom = this.doc.createElement('span');
		oDescBottom.setAttribute('id','lbDescBottom');
		oDetailsBottom.appendChild(oDescBottom);
	var oHoverNav = this.doc.createElement('div');
		oHoverNav.setAttribute('id','lbHoverNav');
		oImageContainer.appendChild(oHoverNav);
	var oBottomNav = this.doc.createElement('div');
		oBottomNav.setAttribute('id','lbBottomNav');
		oBottomContainer.appendChild(oBottomNav);
	var oPrevHov = this.doc.createElement('a');
		oPrevHov.setAttribute('id','lbPrevHov');
		oPrevHov.setAttribute('title', this.label['prev']);
		oPrevHov.setAttribute(this.classAttribute, this.theme);
		oPrevHov.setAttribute('href','javascript:void(0)');
		oHoverNav.appendChild(oPrevHov);
	var oNextHov = this.doc.createElement('a');
		oNextHov.setAttribute('id','lbNextHov');
		oNextHov.setAttribute('title', this.label['next']);
		oNextHov.setAttribute(this.classAttribute, this.theme);
		oNextHov.setAttribute('href','javascript:void(0)');
		oHoverNav.appendChild(oNextHov);
	var oClose = this.doc.createElement('a');
		oClose.setAttribute('id','lbClose');
		oClose.setAttribute('title', this.label['close']);
		oClose.setAttribute(this.classAttribute, this.theme);
		oClose.setAttribute('href','javascript:void(0)');
		oBottomNav.appendChild(oClose);
	var oPrint = this.doc.createElement('a');
		oPrint.setAttribute('id','lbPrint');
		oPrint.setAttribute('title', this.label['print']);
		oPrint.setAttribute(this.classAttribute, this.theme);
		oPrint.setAttribute('href','javascript:void(0)');
		oPrint.style.display = 'none';
		oBottomNav.appendChild(oPrint);
	var oNext = this.doc.createElement('a');
		oNext.setAttribute('id','lbNext');
		oNext.setAttribute('title', this.label['next']);
		oNext.setAttribute(this.classAttribute, this.theme);
		oNext.setAttribute('href','javascript:void(0)');
		oBottomNav.appendChild(oNext);
	var oPause = this.doc.createElement('a');
		oPause.setAttribute('id','lbPause');
		oPause.setAttribute('title', this.label['pause']);
		oPause.setAttribute(this.classAttribute, this.theme);
		oPause.setAttribute('href','javascript:void(0)');
		oPause.style.display = 'none';
		oBottomNav.appendChild(oPause);
	var oPlay = this.doc.createElement('a');
		oPlay.setAttribute('id','lbPlay');
		oPlay.setAttribute('title', this.label['play']);
		oPlay.setAttribute(this.classAttribute, this.theme);
		oPlay.setAttribute('href','javascript:void(0)');
		oPlay.style.display = 'none';
		oBottomNav.appendChild(oPlay);
	var oPrev = this.doc.createElement('a');
		oPrev.setAttribute('id','lbPrev');
		oPrev.setAttribute('title', this.label['prev']);
		oPrev.setAttribute(this.classAttribute, this.theme);
		oPrev.setAttribute('href','javascript:void(0)');
		oBottomNav.appendChild(oPrev);
	var iframes = (this.isFrame && window.parent.frames[window.name].document) ? window.parent.frames[window.name].document.getElementsByTagName('iframe') : document.getElementsByTagName('iframe');
	for (var i = 0; i < iframes.length; i++) {
		if (/youtube/i.test(iframes[i].src)) {
			iframes[i].src += ((/\?/.test(iframes[i].src)) ? '&' : '?') + 'wmode=transparent';
		}
	}
	this.isReady = true;
};
Lytebox.prototype.updateLyteboxItems = function() {
	var anchors = (this.isFrame && window.parent.frames[window.name].document) ? window.parent.frames[window.name].document.getElementsByTagName('a') : document.getElementsByTagName('a');
		anchors = (this.isFrame) ? anchors : document.getElementsByTagName('a');
	var areas = (this.isFrame && window.parent.frames[window.name].document) ? window.parent.frames[window.name].document.getElementsByTagName('area') : document.getElementsByTagName('area');
	var lyteLinks = this.combine(anchors, areas);
	var myLink = relAttribute = revAttribute = classAttribute = dataOptions = dataTip = tipDecoration = tipStyle = tipImage = tipHtml = aSetting = sName = sValue = sExt = aUrl = null;
	var bImage = bRelative = false;
	for (var i = 0; i < lyteLinks.length; i++) {
		myLink = lyteLinks[i];
		relAttribute = String(myLink.getAttribute('rel'));
		classAttribute = String(myLink.getAttribute(this.classAttribute));
		if (myLink.getAttribute('href')) {
			sType = classAttribute.match(/lytebox|lyteshow|lyteframe/i);
			sType = this.isEmpty(sType) ? relAttribute.match(/lytebox|lyteshow|lyteframe/i) : sType;
			dataOptions = String(myLink.getAttribute('data-lyte-options'));
			dataOptions = this.isEmpty(dataOptions) ? String(myLink.getAttribute('rev')) : dataOptions;
			aUrl = myLink.getAttribute('href').split('?');
			sExt = aUrl[0].split('.').pop().toLowerCase();
			bImage = (sExt == 'png' || sExt == 'jpg' || sExt == 'jpeg' || sExt == 'gif' || sExt == 'bmp');
			if (sType && sType.length >= 1) {
				if (this.isMobile() && /youtube/i.test(myLink.getAttribute('href'))) {
					myLink.target = '_blank';
				} else if (bImage && (dataOptions.match(/slide:true/i) || sType[0].toLowerCase() == 'lyteshow')) {
					myLink.onclick = function () { $lb.start(this, true, false); return false; }
				} else if (bImage) {
					myLink.onclick = function () { $lb.start(this, false, false); return false; }
				} else {
					myLink.onclick = function () { $lb.start(this, false, true); return false; }
				}
			}
			dataTip = String(myLink.getAttribute('data-tip'));
			dataTip = this.isEmpty(dataTip) ? myLink.getAttribute('title') : dataTip;
			if (classAttribute.toLowerCase().match('lytetip') && !this.isEmpty(dataTip) && !this.tipsSet) {
				if (this.__changeTipCursor) { myLink.style.cursor = 'help'; }
				tipDecoration = this.__tipDecoration;
				tipStyle = this.__tipStyle;
				bRelative = this.__tipRelative;
				if (!this.isEmpty(dataOptions)) {
					aOptions = dataOptions.split(' ');
					for (var j = 0; j < aOptions.length; j++) {
						aSetting = aOptions[j].split(':');
						sName = (aSetting.length > 1 ? this.trim(aSetting[0]).toLowerCase() : '');
						sValue = (aSetting.length > 1 ? this.trim(aSetting[1]) : '');
						switch(sName) {
							case 'tipstyle':
								tipStyle = (/classic|info|help|warning|error/.test(sValue) ? sValue : tipStyle); break;
							case 'changetipcursor':
								myLink.style.cursor = (/true|false/.test(sValue) ? (sValue == 'true' ? 'help' : '') : myLink.style.cursor); break;
							case 'tiprelative':
								bRelative = (/true|false/.test(sValue) ? (sValue == 'true') : bRelative); break;
							case 'tipdecoration':
								tipDecoration = (/dotted|solid|none/.test(sValue) ? sValue : tipDecoration); break;
						}
					}
				}
				if (tipDecoration != 'dotted') {
					myLink.style.borderBottom = (tipDecoration == 'solid' ? '1px solid' : 'none');
				}
				switch(tipStyle) {
					case 'info': tipStyle = 'lbCustom lbInfo'; tipImage = 'lbTipImg lbInfoImg'; break;
					case 'help': tipStyle = 'lbCustom lbHelp'; tipImage = 'lbTipImg lbHelpImg'; break;
					case 'warning': tipStyle = 'lbCustom lbWarning'; tipImage = 'lbTipImg lbWarningImg'; break;
					case 'error': tipStyle = 'lbCustom lbError'; tipImage = 'lbTipImg lbErrorImg'; break;
					case 'classic': tipStyle = 'lbClassic'; tipImage = ''; break;
					default: tipStyle = 'lbClassic'; tipImage = '';
				}
				if ((this.ie && this.ieVersion <= 7) || (this.ieVersion == 8 && this.doc.compatMode == 'BackCompat')) {
					tipImage = '';
					if (tipStyle != 'lbClassic' && !this.isEmpty(tipStyle)) {
						tipStyle += ' lbIEFix';
					}
				}
				var aLinkPos = this.findPos(myLink);
				if ((this.ie && (this.ieVersion <= 6 || this.doc.compatMode == 'BackCompat')) || bRelative) {
					myLink.style.position = 'relative';
				}
				tipHtml = myLink.innerHTML;
				myLink.innerHTML = '';
				if ((this.ie && this.ieVersion <= 6 && this.doc.compatMode != 'BackCompat') || bRelative) {
					myLink.innerHTML = tipHtml + '<span class="' + tipStyle + '">' + (tipImage ? '<div class="' + tipImage + '"></div>' : '') + dataTip + '</span>';
				} else {
					myLink.innerHTML = tipHtml + '<span class="' + tipStyle + '" style="left:'+aLinkPos[0]+'px;top:'+(aLinkPos[1]+aLinkPos[2])+'px;">' + (tipImage ? '<div class="' + tipImage + '"></div>' : '') + dataTip + '</span>';
				}
				if (classAttribute.match(/lytebox|lyteshow|lyteframe/i) == null) {
					myLink.setAttribute('title','');
				}
			}
		}
	}
	this.tipsSet = true;
};
Lytebox.prototype.launch = function(args) {
	var sUrl = this.isEmpty(args.url) ? '' : String(args.url);
	var sOptions = this.isEmpty(args.options) ? '' : String(args.options);
	var sTitle = this.isEmpty(args.title) ? '' : args.title;
	var sDesc = this.isEmpty(args.description) ? '' : args.description;
	var bSlideshow = /slide:true/i.test(sOptions);
	if (this.isEmpty(sUrl)) {
		return false;
	}
	if (!this.isReady) {
		this.timerIDArray[this.timerIDCount++] = setTimeout("$lb.launch({ url: '" + sUrl + "', options: '" + sOptions + "', title: '" + sTitle + "', description: '" + sDesc + "' })", 100);
		return;
	} else {
		for (var i = 0; i < this.timerIDCount; i++) { window.clearTimeout(this.timerIDArray[i]); }
	}
	var aUrl = sUrl.split('?');
	var sExt = aUrl[0].split('.').pop().toLowerCase();
	var bImage = (sExt == 'png' || sExt == 'jpg' || sExt == 'jpeg' || sExt == 'gif' || sExt == 'bmp');
	var oLauncher = this.doc.$('lbLauncher');
		oLauncher.setAttribute('href', sUrl);
		oLauncher.setAttribute('data-lyte-options', sOptions);
		oLauncher.setAttribute('data-title', sTitle);
		oLauncher.setAttribute('data-description', sDesc);
	this.updateLyteboxItems();
	this.start(oLauncher, bSlideshow, (bImage ? false : true));
};
Lytebox.prototype.start = function(oLink, bSlideshow, bFrame) {
	var dataOptions = String(oLink.getAttribute('data-lyte-options'));
		dataOptions = this.isEmpty(dataOptions) ? String(oLink.getAttribute('rev')) : dataOptions;
	this.setOptions(dataOptions);
	this.isSlideshow = (bSlideshow ? true : false);
	this.isLyteframe = (bFrame ? true : false);
	if (!this.isEmpty(this.beforeStart)) {
		var callback = window[this.beforeStart];
		if (typeof callback === 'function') {
			if (!callback(this.args)) { return; }
		}
	}
	if (this.ie && this.ieVersion <= 6) { this.toggleSelects('hide'); }
	if (this.hideObjects) { this.toggleObjects('hide'); }
	if (this.isFrame && window.parent.frames[window.name].document) {
		window.parent.$lb.printId = (this.isLyteframe ? 'lbIframe' : 'lbImage');
	} else {
		this.printId = (this.isLyteframe ? 'lbIframe' : 'lbImage');
	}
	this.aPageSize	= this.getPageSize();
	var objOverlay	= this.doc.$('lbOverlay');
	var objBody		= this.doc.getElementsByTagName("body").item(0);
	objOverlay.style.height = this.aPageSize[1] + "px";
	objOverlay.style.display = '';
	this.fadeIn({ id: 'lbOverlay', opacity: (this.doAnimations && this.animateOverlay && (!this.ie || this.ieVersion >= 9) ? 0 : this.maxOpacity) });
	var anchors = (this.isFrame && window.parent.frames[window.name].document) ? window.parent.frames[window.name].document.getElementsByTagName('a') : document.getElementsByTagName('a');
		anchors = (this.isFrame) ? anchors : document.getElementsByTagName('a');
	var areas = (this.isFrame && window.parent.frames[window.name].document) ? window.parent.frames[window.name].document.getElementsByTagName('area') : document.getElementsByTagName('area');
	var lyteLinks = this.combine(anchors, areas);
	var sType = sExt = aUrl = null;
	this.frameArray = [];
	this.frameNum = 0;
	this.imageArray = [];
	this.imageNum = 0;
	this.slideArray = [];
	this.slideNum = 0;
	if (this.isEmpty(this.group)) {
		dataOptions = String(oLink.getAttribute('data-lyte-options'));
		dataOptions = this.isEmpty(dataOptions) ? String(oLink.getAttribute('rev')) : dataOptions;
		if (this.isLyteframe) {			
			this.frameArray.push(new Array(oLink.getAttribute('href'), (!this.isEmpty(oLink.getAttribute('data-title')) ? oLink.getAttribute('data-title') : oLink.getAttribute('title')), oLink.getAttribute('data-description'), dataOptions));
		} else {
			this.imageArray.push(new Array(oLink.getAttribute('href'), (!this.isEmpty(oLink.getAttribute('data-title')) ? oLink.getAttribute('data-title') : oLink.getAttribute('title')), oLink.getAttribute('data-description'), dataOptions));
		}
	} else {
		for (var i = 0; i < lyteLinks.length; i++) {
			var myLink = lyteLinks[i];
			dataOptions = String(myLink.getAttribute('data-lyte-options'));
			dataOptions = this.isEmpty(dataOptions) ? String(myLink.getAttribute('rev')) : dataOptions;
			if (myLink.getAttribute('href') && dataOptions.toLowerCase().match('group:' + this.group)) {
				sType = String(myLink.getAttribute(this.classAttribute)).match(/lytebox|lyteshow|lyteframe/i);
				sType = this.isEmpty(sType) ? myLink.getAttribute('rel').match(/lytebox|lyteshow|lyteframe/i) : sType;
				aUrl = myLink.getAttribute('href').split('?');
				sExt = aUrl[0].split('.').pop().toLowerCase();
				bImage = (sExt == 'png' || sExt == 'jpg' || sExt == 'jpeg' || sExt == 'gif' || sExt == 'bmp');
				if (sType && sType.length >= 1) {
					if (bImage && (dataOptions.match(/slide:true/i) || sType[0].toLowerCase() == 'lyteshow')) {
						this.slideArray.push(new Array(myLink.getAttribute('href'), (!this.isEmpty(myLink.getAttribute('data-title')) ? myLink.getAttribute('data-title') : myLink.getAttribute('title')), myLink.getAttribute('data-description'), dataOptions));
					} else if (bImage) {
						this.imageArray.push(new Array(myLink.getAttribute('href'), (!this.isEmpty(myLink.getAttribute('data-title')) ? myLink.getAttribute('data-title') : myLink.getAttribute('title')), myLink.getAttribute('data-description'), dataOptions));
					} else {
						this.frameArray.push(new Array(myLink.getAttribute('href'), (!this.isEmpty(myLink.getAttribute('data-title')) ? myLink.getAttribute('data-title') : myLink.getAttribute('title')), myLink.getAttribute('data-description'), dataOptions));
					}
				}
			}
		}
		if (this.isLyteframe) {
			this.frameArray = this.removeDuplicates(this.frameArray);
			while(this.frameArray[this.frameNum][0] != oLink.getAttribute('href')) { this.frameNum++; }
		} else if (bSlideshow) {
			this.slideArray = this.removeDuplicates(this.slideArray);
			try {
				while(this.slideArray[this.slideNum][0] != oLink.getAttribute('href')) { this.slideNum++; }
			} catch(e) {
			}
		} else {
			this.imageArray = this.removeDuplicates(this.imageArray);
			while(this.imageArray[this.imageNum][0] != oLink.getAttribute('href')) { this.imageNum++; }
		}
	}
	this.changeContent(this.isLyteframe ? this.frameNum : (this.isSlideshow ? this.slideNum : this.imageNum));
};
Lytebox.prototype.changeContent = function(iContentNum) {
	this.contentNum = iContentNum;
	if (!this.overlayLoaded) {
		this.changeContentTimerArray[this.changeContentTimerCount++] = setTimeout("$lb.changeContent(" + this.contentNum + ")", 250);
		return;
	} else {
		for (var i = 0; i < this.changeContentTimerCount; i++) { window.clearTimeout(this.changeContentTimerArray[i]); }
	}
	var sDataLyteOptions = (this.isLyteframe) ? this.frameArray[this.contentNum][3] : (this.isSlideshow ? this.slideArray[this.contentNum][3] : this.imageArray[this.contentNum][3]);
	if (!this.inherit || /inherit:false/i.test(sDataLyteOptions)) {
		this.setOptions(String(sDataLyteOptions));
	} else {
		var sDataLyteOptions1 = String((this.isLyteframe) ? this.frameArray[0][3] : (this.isSlideshow ? this.slideArray[0][3] : this.imageArray[0][3]));
		if (this.isLyteframe) {
			var sWidth = sHeight = null;
			try { sWidth = sDataLyteOptions.match(/width:\d+(%|px|)/i)[0]; } catch(e) { }
			try { sHeight = sDataLyteOptions.match(/height:\d+(%|px|)/i)[0]; } catch(e) { }
			if (!this.isEmpty(sWidth)) {
				sDataLyteOptions1 = sDataLyteOptions1.replace(/width:\d+(%|px|)/i, sWidth);
			}
			if (!this.isEmpty(sHeight)) {
				sDataLyteOptions1 = sDataLyteOptions1.replace(/height:\d+(%|px|)/i, sHeight);
			}
		}
		this.setOptions(sDataLyteOptions1);
	}
	var object = this.doc.$('lbMain');
		object.style.display = '';
	var iDivisor = 40;
	if (this.autoResize && this.fixedPosition) {
		if (this.ie && (this.ieVersion <= 7 || this.doc.compatMode == 'BackCompat')) {
			object.style.top = (this.getPageScroll() + (this.aPageSize[3] / iDivisor)) + "px";
			var ps = (this.aPageSize[3] / iDivisor);
			this.scrollHandler = function(){
				$lb.doc.$('lbMain').style.top = ($lb.getPageScroll() + ps) + 'px';
			}
			this.bodyOnscroll = document.body.onscroll;
			if (window.addEventListener) {
				window.addEventListener('scroll', this.scrollHandler);
			} else if (window.attachEvent) {
				window.attachEvent('onscroll', this.scrollHandler);
			}
			object.style.position = "absolute";
		} else {
			object.style.top = ((this.aPageSize[3] / iDivisor)) + "px";
			object.style.position = "fixed";
		}
	} else {
		object.style.position = "absolute";
		object.style.top = (this.getPageScroll() + (this.aPageSize[3] / iDivisor)) + "px";
	}
	this.doc.$('lbOuterContainer').style.paddingBottom = '0';
	if (!this.outerBorder) {
		this.doc.$('lbOuterContainer').style.border = 'none';
	} else {
		this.doc.$('lbOuterContainer').setAttribute(this.classAttribute, this.theme);
	}
	if (this.forceCloseClick) {
		this.doc.$('lbOverlay').onclick = '';
	} else {
		this.doc.$('lbOverlay').onclick = function() { $lb.end(); return false; }
	}
	this.doc.$('lbMain').onclick = function(e) {
		var e = e;
		if (!e) {
			if (window.parent.frames[window.name] && (parent.document.getElementsByTagName('frameset').length <= 0)) {
				e = window.parent.window.event;
			} else {
				e = window.event;
			}
		}
		var id = (e.target ? e.target.id : e.srcElement.id);
		if ((id == 'lbMain') && (!$lb.forceCloseClick)) { $lb.end(); return false; }
	}
	this.doc.$('lbPrintTop').onclick = this.doc.$('lbPrint').onclick = function() { $lb.printWindow(); return false; }
	this.doc.$('lbCloseTop').onclick = this.doc.$('lbClose').onclick = function() { $lb.end(); return false; }
	this.doc.$('lbPauseTop').onclick = function() { $lb.togglePlayPause("lbPauseTop", "lbPlayTop"); return false; }
	this.doc.$('lbPause').onclick = function() { $lb.togglePlayPause("lbPause", "lbPlay"); return false; }
	this.doc.$('lbPlayTop').onclick = function() { $lb.togglePlayPause("lbPlayTop", "lbPauseTop"); return false; }
	this.doc.$('lbPlay').onclick = function() { $lb.togglePlayPause("lbPlay", "lbPause"); return false; }
	if (this.isSlideshow && this.showPlayPause && this.isPaused) {
		this.doc.$('lbPlay').style.display = '';
		this.doc.$('lbPause').style.display = 'none';
	}
	if (this.isSlideshow) {
		for (var i = 0; i < this.slideshowIDCount; i++) { window.clearTimeout(this.slideshowIDArray[i]); }
	}
	if (!this.outerBorder) {
		this.doc.$('lbOuterContainer').style.border = 'none';
	} else {
		this.doc.$('lbOuterContainer').setAttribute(this.classAttribute, this.theme);
	}
	var iDecreaseMargin = 10;
	if (this.titleTop || this.navTop) {
		this.doc.$('lbTopContainer').style.visibility = 'hidden';
		iDecreaseMargin += this.doc.$('lbTopContainer').offsetHeight;
	} else {
		this.doc.$('lbTopContainer').style.display = 'none';
	}
	this.doc.$('lbBottomContainer').style.display = 'none';
	this.doc.$('lbImage').style.display = 'none';
	this.doc.$('lbIframe').style.display = 'none';
	this.doc.$('lbPrevHov').style.display = 'none';
	this.doc.$('lbNextHov').style.display =  'none';
	this.doc.$('lbIframeContainer').style.display = 'none';
	this.doc.$('lbLoading').style.marginTop = '-' + iDecreaseMargin + 'px';
	this.doc.$('lbLoading').style.display = '';
	if (this.isLyteframe) {
		var iframe = $lb.doc.$('lbIframe');
			iframe.src = 'about:blank';
		var w = this.trim(this.width);
		var h = this.trim(this.height);
		if (/\%/.test(w)) {
			var percent = parseInt(w);
			w = parseInt((this.aPageSize[2]-50)*percent/100);
			w = w+'px';
		}
		if (/\%/.test(h)) {
			var percent = parseInt(h);
			h = parseInt((this.aPageSize[3]-150)*percent/100);
			h = h+'px';
		}
		if (this.autoResize) {
			var x = this.aPageSize[2] - 50;
			var y = this.aPageSize[3] - 150;
			w = (parseInt(w) > x ? x : w) + 'px';
			h = (parseInt(h) > y ? y : h) + 'px';
		}
		iframe.height = this.height = h;
		iframe.width = this.width = w;
		iframe.scrolling = this.scrolling;
		var oDoc = iframe.contentWindow || iframe.contentDocument;
		try {
			if (oDoc.document) {
				oDoc = oDoc.document;
			}
			oDoc.body.style.margin = 0;
			oDoc.body.style.padding = 0;
			if (this.ie && this.ieVersion <= 8) {
				oDoc.body.scroll = this.scrolling;
				oDoc.body.overflow = this.scrolling = 'no' ? 'hidden' : 'auto';
			}
		} catch(e) { }
		this.resizeContainer(parseInt(this.width), parseInt(this.height));
	} else {
		this.imgPreloader = new Image();
		this.imgPreloader.onload = function() {
			var imageWidth = $lb.imgPreloader.width;
			var imageHeight = $lb.imgPreloader.height;
			if ($lb.autoResize) {
				var x = $lb.aPageSize[2] - 50;
				var y = $lb.aPageSize[3] - 150;
				if (imageWidth > x) {
					imageHeight = Math.round(imageHeight * (x / imageWidth));
					imageWidth = x; 
					if (imageHeight > y) { 
						imageWidth = Math.round(imageWidth * (y / imageHeight));
						imageHeight = y; 
					}
				} else if (imageHeight > y) { 
					imageWidth = Math.round(imageWidth * (y / imageHeight));
					imageHeight = y; 
					if (imageWidth > x) {
						imageHeight = Math.round(imageHeight * (x / imageWidth));
						imageWidth = x;
					}
				}
			}
			var lbImage = $lb.doc.$('lbImage');
			lbImage.src = $lb.imgPreloader.src;
			lbImage.width = imageWidth;
			lbImage.height = imageHeight;
			$lb.resizeContainer(imageWidth, imageHeight);
			$lb.imgPreloader.onload = function() {};
		}
		this.imgPreloader.src = (this.isSlideshow ? this.slideArray[this.contentNum][0] : this.imageArray[this.contentNum][0]);
	}
};
Lytebox.prototype.resizeContainer = function(iWidth, iHeight) {
	this.resizeWidth = iWidth;
	this.resizeHeight = iHeight;
	this.wCur = this.doc.$('lbOuterContainer').offsetWidth;
	this.hCur = this.doc.$('lbOuterContainer').offsetHeight;
	this.xScale = ((this.resizeWidth  + (this.borderSize * 2)) / this.wCur) * 100;
	this.yScale = ((this.resizeHeight  + (this.borderSize * 2)) / this.hCur) * 100;
	var wDiff = (this.wCur - this.borderSize * 2) - this.resizeWidth;
	var hDiff = (this.hCur - this.borderSize * 2) - this.resizeHeight;
	this.wDone = (wDiff == 0);
	if (!(hDiff == 0)) {
		this.hDone = false;
		this.resizeH('lbOuterContainer', this.hCur, this.resizeHeight + this.borderSize * 2, this.getPixelRate(this.hCur, this.resizeHeight));
	} else {
		this.hDone = true;
		if (!this.wDone) {
			this.resizeW('lbOuterContainer', this.wCur, this.resizeWidth + this.borderSize * 2, this.getPixelRate(this.wCur, this.resizeWidth));
		}
	}
	if ((hDiff == 0) && (wDiff == 0)) {
		if (this.ie){ this.pause(250); } else { this.pause(100); } 
	}
	this.doc.$('lbPrevHov').style.height = this.resizeHeight + "px";
	this.doc.$('lbNextHov').style.height = this.resizeHeight + "px";
	if (this.hDone && this.wDone) {
		if (this.isLyteframe) {
			this.loadContent();
		} else {
			this.showContent();
		}
	}
};
Lytebox.prototype.loadContent = function() {
	try {
		var iframe = this.doc.$('lbIframe');
		var uri = this.frameArray[this.contentNum][0];
		if (!this.inline && this.appendQS) {
			uri += ((/\?/.test(uri)) ? '&' : '?') + 'request_from=lytebox';
		}
		if (this.autoPlay && /youtube/i.test(uri)) {
			uri += ((/\?/.test(uri)) ? '&' : '?') + 'autoplay=1';
		}
			if (!this.autoEmbed || (this.ff && (uri.match(/.pdf|.mov|.wmv/i)))) {
			this.frameSource = uri;
			this.showContent();
			return;
		}
		if (this.ie) {
			iframe.onreadystatechange = function() {
				if ($lb.doc.$('lbIframe').readyState == "complete") {
					$lb.showContent();
					$lb.doc.$('lbIframe').onreadystatechange = null;
				}
			};
		} else {
			iframe.onload = function() {
				$lb.showContent();
				$lb.doc.$('lbIframe').onload = null;
			};
		}
		if (this.inline || (uri.match(/.mov|.avi|.wmv|.mpg|.mpeg|.swf/i))) {
			iframe.src = 'about:blank';
			this.frameSource = '';
			var sHtml = (this.inline) ? this.doc.$(uri.substr(uri.indexOf('#') + 1, uri.length)).innerHTML : this.buildObject(parseInt(this.width), parseInt(this.height), uri);
			var oDoc = iframe.contentWindow || iframe.contentDocument;
			if (oDoc.document) {
				oDoc = oDoc.document;
			}
			oDoc.open();
			oDoc.write(sHtml);
			oDoc.close();
			oDoc.body.style.margin = 0;
			oDoc.body.style.padding = 0;
			if (!this.inline) {
				oDoc.body.style.backgroundColor = '#fff';
				oDoc.body.style.fontFamily = 'Verdana, Helvetica, sans-serif';
				oDoc.body.style.fontSize = '0.9em';
			}
			this.frameSource = '';
		} else {
			this.frameSource = uri;
			iframe.src = uri;
		}
	} catch(e) { }
};
Lytebox.prototype.showContent = function() {
	if (this.isSlideshow) {
		if(this.contentNum == (this.slideArray.length - 1)) {
			if (this.loopSlideshow) {
				this.slideshowIDArray[this.slideshowIDCount++] = setTimeout("$lb.changeContent(0)", this.slideInterval);
			} else if (this.autoEnd) {
				this.slideshowIDArray[this.slideshowIDCount++] = setTimeout("$lb.end('slideshow')", this.slideInterval);
			}
		} else {
			if (!this.isPaused) {
				this.slideshowIDArray[this.slideshowIDCount++] = setTimeout("$lb.changeContent("+(this.contentNum+1)+")", this.slideInterval);
			}
		}
		this.doc.$('lbHoverNav').style.display = (this.ieVersion != 6 && this.showNavigation && this.navTypeHash['Hover_by_type_' + this.navType] ? '' : 'none');
		this.doc.$('lbCloseTop').style.display = (this.showClose && this.navTop ? '' : 'none');
		this.doc.$('lbClose').style.display = (this.showClose && !this.navTop ? '' : 'none');
		this.doc.$('lbBottomData').style.display = (this.showDetails ? '' : 'none');
		this.doc.$('lbPauseTop').style.display = (this.showPlayPause && this.navTop ? (!this.isPaused ? '' : 'none') : 'none');
		this.doc.$('lbPause').style.display = (this.showPlayPause && !this.navTop ? (!this.isPaused ? '' : 'none') : 'none');
		this.doc.$('lbPlayTop').style.display = (this.showPlayPause && this.navTop ? (!this.isPaused ? 'none' : '') : 'none');
		this.doc.$('lbPlay').style.display = (this.showPlayPause && !this.navTop ? (!this.isPaused ? 'none' : '') : 'none');
		this.doc.$('lbPrevTop').style.display = (this.navTop && this.showNavigation && this.navTypeHash['Display_by_type_' + this.navType] ? '' : 'none');
		this.doc.$('lbPrev').style.display = (!this.navTop && this.showNavigation && this.navTypeHash['Display_by_type_' + this.navType] ? '' : 'none');
		this.doc.$('lbNextTop').style.display = (this.navTop && this.showNavigation && this.navTypeHash['Display_by_type_' + this.navType] ? '' : 'none');
		this.doc.$('lbNext').style.display = (!this.navTop && this.showNavigation && this.navTypeHash['Display_by_type_' + this.navType] ? '' : 'none');
	} else {
		this.doc.$('lbHoverNav').style.display = (this.ieVersion != 6 && this.navTypeHash['Hover_by_type_' + this.navType] && !this.isLyteframe ? '' : 'none');
		if ((this.navTypeHash['Display_by_type_' + this.navType] && !this.isLyteframe && this.imageArray.length > 1) || (this.frameArray.length > 1 && this.isLyteframe)) {
			this.doc.$('lbPrevTop').style.display = (this.navTop ? '' : 'none');
			this.doc.$('lbPrev').style.display = (!this.navTop ? '' : 'none');
			this.doc.$('lbNextTop').style.display = (this.navTop ? '' : 'none');
			this.doc.$('lbNext').style.display = (!this.navTop ? '' : 'none');
		} else {
			this.doc.$('lbPrevTop').style.display = 'none';
			this.doc.$('lbPrev').style.display = 'none';
			this.doc.$('lbNextTop').style.display = 'none';
			this.doc.$('lbNext').style.display = 'none';
		}
		this.doc.$('lbCloseTop').style.display = (this.navTop ? '' : 'none');
		this.doc.$('lbClose').style.display = (!this.navTop ? '' : 'none');				
		this.doc.$('lbBottomData').style.display = '';
		this.doc.$('lbPauseTop').style.display = 'none';
		this.doc.$('lbPause').style.display = 'none';
		this.doc.$('lbPlayTop').style.display = 'none';
		this.doc.$('lbPlay').style.display = 'none';
	}
	this.doc.$('lbPrintTop').style.display = (this.showPrint && this.navTop ? '' : 'none');
	this.doc.$('lbPrint').style.display = (this.showPrint && !this.navTop ? '' : 'none');
	this.updateDetails();
	this.doc.$('lbLoading').style.display = 'none';
	this.doc.$('lbImageContainer').style.display = (this.isLyteframe ? 'none' : '');
	this.doc.$('lbIframeContainer').style.display = (this.isLyteframe ? '' : 'none');
	if (this.isLyteframe) {
		if (!this.isEmpty(this.frameSource)) {
			this.doc.$('lbIframe').src = this.frameSource;
		}
		this.doc.$('lbIframe').style.display = '';
		this.fadeIn({ id: 'lbIframe', opacity: (this.doAnimations && (!this.ie || this.ieVersion >= 9) ? 0 : 100) });
	} else {
		this.doc.$('lbImage').style.display = '';
		this.fadeIn({ id: 'lbImage', opacity: (this.doAnimations && (!this.ie || this.ieVersion >= 9) ? 0 : 100) });
		this.preloadNeighborImages();
	}
	if (!this.isEmpty(this.afterStart)) {
		var callback = window[this.afterStart];
		if (typeof callback === 'function') {
			callback(this.args);
		}
	}
};
Lytebox.prototype.updateDetails = function() {
	var sTitle = (this.isSlideshow ? this.slideArray[this.contentNum][1] : (this.isLyteframe ? this.frameArray[this.contentNum][1] : this.imageArray[this.contentNum][1]));
	var sDesc  = (this.isSlideshow ? this.slideArray[this.contentNum][2] : (this.isLyteframe ? this.frameArray[this.contentNum][2] : this.imageArray[this.contentNum][2]));
	if (this.ie && this.ieVersion <= 7 || (this.ieVersion >= 8 && this.doc.compatMode == 'BackCompat')) {
		this.doc.$(this.titleTop ? 'lbTitleBottom' : 'lbTitleTop').style.display = 'none';
		this.doc.$(this.titleTop ? 'lbTitleTop' : 'lbTitleBottom').style.display = (this.isEmpty(sTitle) ? 'none' : 'block');
	}
	this.doc.$('lbDescBottom').style.display = (this.isEmpty(sDesc) ? 'none' : '');
	this.doc.$(this.titleTop ? 'lbTitleTop' : 'lbTitleBottom').innerHTML = (this.isEmpty(sTitle) ? '' : sTitle);
	this.doc.$(this.titleTop ? 'lbTitleBottom' : 'lbTitleTop').innerHTML = '';
	this.doc.$(this.titleTop ? 'lbNumBottom' : 'lbNumTop').innerHTML = '';
	this.updateNav();
	if (this.titleTop || this.navTop) {
		this.doc.$('lbTopContainer').style.display = 'block';
		this.doc.$('lbTopContainer').style.visibility = 'visible';
	} else {
		this.doc.$('lbTopContainer').style.display = 'none';
	}
	var object = (this.titleTop ? this.doc.$('lbNumTop') : this.doc.$('lbNumBottom'));
	if (this.isSlideshow && this.slideArray.length > 1) {
		object.innerHTML = this.label['image'].replace('%1', this.contentNum + 1).replace('%2', this.slideArray.length);
	} else if (this.imageArray.length > 1 && !this.isLyteframe) {
		object.innerHTML = this.label['image'].replace('%1', this.contentNum + 1).replace('%2', this.imageArray.length);
	} else if (this.frameArray.length > 1 && this.isLyteframe) {
		object.innerHTML = this.label['page'].replace('%1', this.contentNum + 1).replace('%2', this.frameArray.length);
	} else {
		object.innerHTML = '';
	}
	var bAddSpacer = !(this.titleTop || (this.isEmpty(sTitle) && this.isEmpty(object.innerHTML)));
	this.doc.$('lbDescBottom').innerHTML = (this.isEmpty(sDesc) ? '' : (bAddSpacer ? '<br style="line-height:0.6em;" />' : '') + sDesc);
	var iNavWidth = 0;
	if (this.ie && this.ieVersion <= 7 || (this.ieVersion >= 8 && this.doc.compatMode == 'BackCompat')) {
		iNavWidth = 39 + (this.showPrint ? 39 : 0) + (this.isSlideshow && this.showPlayPause ? 39 : 0);
		if ((this.isSlideshow && this.slideArray.length > 1 && this.showNavigation && this.navType != 1) ||
			(this.frameArray.length > 1 && this.isLyteframe) ||
			(this.imageArray.length > 1 && !this.isLyteframe && this.navType != 1)) {
				iNavWidth += 39*2;
		}
	}
	this.doc.$('lbBottomContainer').style.display = (!(this.titleTop && this.navTop) || !this.isEmpty(sDesc) ? 'block' : 'none');
	if (this.titleTop && this.navTop) {
		if (iNavWidth > 0) {
			this.doc.$('lbTopNav').style.width = iNavWidth + 'px';
		}
		this.doc.$('lbTopData').style.width = (this.doc.$('lbTopContainer').offsetWidth - this.doc.$('lbTopNav').offsetWidth - 15) + 'px';
		if (!this.isEmpty(sDesc)) {
			this.doc.$('lbDescBottom').style.width = (this.doc.$('lbBottomContainer').offsetWidth - 15) + 'px';
		}
	} else if ((!this.titleTop || !this.isEmpty(sDesc)) && !this.navTop) {
		if (iNavWidth > 0) {
			this.doc.$('lbBottomNav').style.width = iNavWidth + 'px';
		}
		this.doc.$('lbBottomData').style.width = (this.doc.$('lbBottomContainer').offsetWidth - this.doc.$('lbBottomNav').offsetWidth - 15) + 'px';
		this.doc.$('lbDescBottom').style.width = this.doc.$('lbBottomData').style.width;
	}
	this.fixBottomPadding();
	this.aPageSize = this.getPageSize();
	var iMainTop = parseInt(this.doc.$('lbMain').style.top);
	if ((this.ie && this.ieVersion <= 7) || (this.ieVersion >= 8 && this.doc.compatMode == 'BackCompat')) {
		iMainTop = (this.ie ? parseInt(this.doc.$('lbMain').style.top) - this.getPageScroll() : parseInt(this.doc.$('lbMain').style.top));
	}
	var iOverlap = (this.doc.$('lbOuterContainer').offsetHeight + iMainTop) - this.aPageSize[3];
	var iDivisor = 40;
	if (iOverlap > 0 && this.autoResize && this.fixedPosition) {
		if (this.ie && (this.ieVersion <= 7 || this.doc.compatMode == 'BackCompat')) {
			document.body.onscroll = this.bodyOnscroll;
			if (window.removeEventListener) {
				window.removeEventListener('scroll', this.scrollHandler);
			} else if (window.detachEvent) {
				window.detachEvent('onscroll', this.scrollHandler);
			}
		}
		this.doc.$('lbMain').style.position = "absolute";
		this.doc.$('lbMain').style.top = (this.getPageScroll() + (this.aPageSize[3] / iDivisor)) + "px";
	}
};
Lytebox.prototype.updateNav = function() {
	if (this.isSlideshow) {
		if (this.contentNum != 0) {
			if (this.navTypeHash['Display_by_type_' + this.navType] && this.showNavigation) {
				this.doc.$(this.navTop ? 'lbPrevTop' : 'lbPrev').setAttribute(this.classAttribute, this.theme);
				this.doc.$(this.navTop ? 'lbPrevTop' : 'lbPrev').style.display = '';
				this.doc.$(this.navTop ? 'lbPrevTop' : 'lbPrev').onclick = function() {
					if ($lb.pauseOnPrevClick) { $lb.togglePlayPause($lb.navTop ? 'lbPauseTop' : 'lbPause', $lb.navTop ? 'lbPlayTop' : 'lbPlay'); }
					$lb.changeContent($lb.contentNum - 1); return false;
				}
			}
			if (this.navTypeHash['Hover_by_type_' + this.navType]) {
				var object = this.doc.$('lbPrevHov');
				object.style.display = '';
				object.onclick = function() {
					if ($lb.pauseOnPrevClick) { $lb.togglePlayPause($lb.navTop ? 'lbPauseTop' : 'lbPause', $lb.navTop ? 'lbPlayTop' : 'lbPlay'); }
					$lb.changeContent($lb.contentNum - 1); return false;
				}
			}
		} else {
			if (this.navTypeHash['Display_by_type_' + this.navType]) {
				this.doc.$(this.navTop ? 'lbPrevTop' : 'lbPrev').setAttribute(this.classAttribute, this.theme + 'Off');
				this.doc.$(this.navTop ? 'lbPrevTop' : 'lbPrev').onclick = function() { return false; }
			}
		}
		if (this.contentNum != (this.slideArray.length - 1) && this.showNavigation) {
			if (this.navTypeHash['Display_by_type_' + this.navType]) {
				this.doc.$(this.navTop ? 'lbNextTop' : 'lbNext').setAttribute(this.classAttribute, this.theme);
				this.doc.$(this.navTop ? 'lbNextTop' : 'lbNext').style.display = '';
				this.doc.$(this.navTop ? 'lbNextTop' : 'lbNext').onclick = function() {
					if ($lb.pauseOnNextClick) { $lb.togglePlayPause($lb.navTop ? 'lbPauseTop' : 'lbPause', $lb.navTop ? 'lbPlayTop' : 'lbPlay'); }
					$lb.changeContent($lb.contentNum + 1); return false;
				}
			}
			if (this.navTypeHash['Hover_by_type_' + this.navType]) {
				var object = this.doc.$('lbNextHov');
				object.style.display = '';
				object.onclick = function() {
					if ($lb.pauseOnNextClick) { $lb.togglePlayPause($lb.navTop ? 'lbPauseTop' : 'lbPause', $lb.navTop ? 'lbPlayTop' : 'lbPlay'); }
					$lb.changeContent($lb.contentNum + 1); return false;
				}
			}
		} else {
			if (this.navTypeHash['Display_by_type_' + this.navType]) { 
				this.doc.$(this.navTop ? 'lbNextTop' : 'lbNext').setAttribute(this.classAttribute, this.theme + 'Off');
				this.doc.$(this.navTop ? 'lbNextTop' : 'lbNext').onclick = function() { return false; }
			}
		}
	} else if (this.isLyteframe) {
		if(this.contentNum != 0) {
			this.doc.$(this.navTop ? 'lbPrevTop' : 'lbPrev').setAttribute(this.classAttribute, this.theme);
			this.doc.$(this.navTop ? 'lbPrevTop' : 'lbPrev').style.display = '';
			this.doc.$(this.navTop ? 'lbPrevTop' : 'lbPrev').onclick = function() {
				$lb.changeContent($lb.contentNum - 1); return false;
			}
		} else {
			this.doc.$(this.navTop ? 'lbPrevTop' : 'lbPrev').setAttribute(this.classAttribute, this.theme + 'Off');
			this.doc.$(this.navTop ? 'lbPrevTop' : 'lbPrev').onclick = function() { return false; }
		}
		if(this.contentNum != (this.frameArray.length - 1)) {
			this.doc.$(this.navTop ? 'lbNextTop' : 'lbNext').setAttribute(this.classAttribute, this.theme);
			this.doc.$(this.navTop ? 'lbNextTop' : 'lbNext').style.display = '';
			this.doc.$(this.navTop ? 'lbNextTop' : 'lbNext').onclick = function() {
				$lb.changeContent($lb.contentNum + 1); return false;
			}
		} else {
			this.doc.$(this.navTop ? 'lbNextTop' : 'lbNext').setAttribute(this.classAttribute, this.theme + 'Off');
			this.doc.$(this.navTop ? 'lbNextTop' : 'lbNext').onclick = function() { return false; }
		}
	} else {
		if(this.contentNum != 0) {
			if (this.navTypeHash['Display_by_type_' + this.navType]) {
				this.doc.$(this.navTop ? 'lbPrevTop' : 'lbPrev').setAttribute(this.classAttribute, this.theme);
				this.doc.$(this.navTop ? 'lbPrevTop' : 'lbPrev').style.display = '';
				this.doc.$(this.navTop ? 'lbPrevTop' : 'lbPrev').onclick = function() {
					$lb.changeContent($lb.contentNum - 1); return false;
				}
			}
			if (this.navTypeHash['Hover_by_type_' + this.navType]) {
				var object2 = this.doc.$('lbPrevHov');
				object2.style.display = '';
				object2.onclick = function() {
					$lb.changeContent($lb.contentNum - 1); return false;
				}
			}
		} else {
			if (this.navTypeHash['Display_by_type_' + this.navType]) {
				this.doc.$(this.navTop ? 'lbPrevTop' : 'lbPrev').setAttribute(this.classAttribute, this.theme + 'Off');
				this.doc.$(this.navTop ? 'lbPrevTop' : 'lbPrev').onclick = function() { return false; }
			}
		}
		if(this.contentNum != (this.imageArray.length - 1)) {
			if (this.navTypeHash['Display_by_type_' + this.navType]) {
				this.doc.$(this.navTop ? 'lbNextTop' : 'lbNext').setAttribute(this.classAttribute, this.theme);
				this.doc.$(this.navTop ? 'lbNextTop' : 'lbNext').style.display = '';
				this.doc.$(this.navTop ? 'lbNextTop' : 'lbNext').onclick = function() {
					$lb.changeContent($lb.contentNum + 1); return false;
				}
			}
			if (this.navTypeHash['Hover_by_type_' + this.navType]) {
				var object2 = this.doc.$('lbNextHov');
				object2.style.display = '';
				object2.onclick = function() {
					$lb.changeContent($lb.contentNum + 1); return false;
				}
			}
		} else {
			if (this.navTypeHash['Display_by_type_' + this.navType]) { 
				this.doc.$(this.navTop ? 'lbNextTop' : 'lbNext').setAttribute(this.classAttribute, this.theme + 'Off');
				this.doc.$(this.navTop ? 'lbNextTop' : 'lbNext').onclick = function() { return false; }
			}
		}
	}
	this.enableKeyboardNav();
};
Lytebox.prototype.fixBottomPadding = function() {
	if (!((this.ieVersion == 7 || this.ieVersion == 8 || this.ieVersion == 9) && this.doc.compatMode == 'BackCompat') && this.ieVersion != 6) {
		var titleHeight = this.doc.$('lbTopContainer').offsetHeight + 5;
		var offsetHeight = (titleHeight == 5 ? 0 : titleHeight) + this.doc.$('lbBottomContainer').offsetHeight;
		this.doc.$('lbOuterContainer').style.paddingBottom = (offsetHeight + 5) + 'px';
	}
};
Lytebox.prototype.enableKeyboardNav = function() { document.onkeydown = this.keyboardAction; };
Lytebox.prototype.disableKeyboardNav = function() { document.onkeydown = ''; };
Lytebox.prototype.keyboardAction = function(e) {
	var keycode = key = escape = null;
	keycode	= (e == null) ? event.keyCode : e.which;
	key		= String.fromCharCode(keycode).toLowerCase();
	escape  = (e == null) ? 27 : e.DOM_VK_ESCAPE;
	if ((key == 'x') || (key == 'c') || (keycode == escape || keycode == 27)) {
		parent.$lb.end();
	} else if (keycode == 32 && $lb.isSlideshow && $lb.showPlayPause) {
		if ($lb.isPaused) {
			$lb.togglePlayPause($lb.navTop ? 'lbPlayTop' : 'lbPlay', $lb.navTop ? 'lbPauseTop' : 'lbPause');
		} else {
			$lb.togglePlayPause($lb.navTop ? 'lbPauseTop' : 'lbPause', $lb.navTop ? 'lbPlayTop' : 'lbPlay');
		}
		return false;
	} else if (key == 'p' || keycode == 37) {
		if ($lb.isSlideshow) {
			if($lb.contentNum != 0) {
				$lb.disableKeyboardNav();
				$lb.changeContent($lb.contentNum - 1);
			}
		} else if ($lb.isLyteframe) {
			if($lb.contentNum != 0) {
				$lb.disableKeyboardNav();
				$lb.changeContent($lb.contentNum - 1);
			}
		} else {
			if($lb.contentNum != 0) {
				$lb.disableKeyboardNav();
				$lb.changeContent($lb.contentNum - 1);
			}
		}
	} else if (key == 'n' || keycode == 39) {
		if ($lb.isSlideshow) {
			if($lb.contentNum != ($lb.slideArray.length - 1)) {
				$lb.disableKeyboardNav();
				$lb.changeContent($lb.contentNum + 1);
			}
		} else if ($lb.isLyteframe) {
			if($lb.contentNum != ($lb.frameArray.length - 1)) {
				$lb.disableKeyboardNav();
				$lb.changeContent($lb.contentNum + 1);
			}
		} else {
			if($lb.contentNum != ($lb.imageArray.length - 1)) {
				$lb.disableKeyboardNav();
				$lb.changeContent($lb.contentNum + 1);
			}
		}
	}
};
Lytebox.prototype.preloadNeighborImages = function() {
	if (this.isSlideshow) {
		if ((this.slideArray.length - 1) > this.contentNum) {
			var preloadNextImage = new Image();
				preloadNextImage.src = this.slideArray[this.contentNum + 1][0];
		}
		if (this.contentNum > 0) {
			var preloadPrevImage = new Image();
				preloadPrevImage.src = this.slideArray[this.contentNum - 1][0];
		}
	} else {
		if ((this.imageArray.length - 1) > this.contentNum) {
			var preloadNextImage = new Image();
				preloadNextImage.src = this.imageArray[this.contentNum + 1][0];
		}
		if (this.contentNum > 0) {
			var preloadPrevImage = new Image();
				preloadPrevImage.src = this.imageArray[this.contentNum - 1][0];
		}
	}
};
Lytebox.prototype.togglePlayPause = function(sHideId, sShowId) {
	if (this.isSlideshow && (sHideId == 'lbPauseTop' || sHideId == 'lbPause')) {
		for (var i = 0; i < this.slideshowIDCount; i++) { window.clearTimeout(this.slideshowIDArray[i]); }
	}
	this.doc.$(sHideId).style.display = 'none';
	this.doc.$(sShowId).style.display = '';
	if (sHideId == 'lbPlayTop' || sHideId == 'lbPlay') {
		this.isPaused = false;
		if (this.contentNum == (this.slideArray.length - 1)) {
			if (this.loopSlideshow) {
				this.changeContent(0);
			} else if (this.autoEnd) {
				this.end();
			}
		} else {
			this.changeContent(this.contentNum + 1);
		}
	} else {
		this.isPaused = true;
	}
};
Lytebox.prototype.end = function(sCaller) {
	var closeClick = (sCaller == 'slideshow' ? false : true);
	if (this.isSlideshow && this.isPaused && !closeClick) { return; }
	if (!this.isEmpty(this.beforeEnd)) {
		var callback = window[this.beforeEnd];
		if (typeof callback === 'function') {
			if (!callback(this.args)) { return; }
		}
	}
	this.disableKeyboardNav();
	document.body.onscroll = this.bodyOnscroll;
	if (this.refreshPage) {
		var uri_href = top.location.href;
		var reg=/\#.*$/g;
		uri_href=uri_href.replace(reg, "");
		top.location.href = uri_href;
		return;
	}
	this.doc.$('lbMain').style.display = 'none';
	this.fadeOut({ id: 'lbOverlay', opacity: (this.doAnimations && this.animateOverlay && (!this.ie || this.ieVersion >= 9) ? this.maxOpacity : 0), speed: 5, display: 'none' });
	this.toggleSelects('visible');
	if (this.hideObjects) { this.toggleObjects('visible'); }
	this.doc.$('lbOuterContainer').style.width = '200px';
	this.doc.$('lbOuterContainer').style.height = '200px';
	if (this.inline && this.safari) {
		var iframe = this.doc.$('lbIframe');
		var oDoc = iframe.contentWindow || iframe.contentDocument;
		if (oDoc.document) {
			oDoc = oDoc.document;
		}
		oDoc.open();
		oDoc.write('<html><head></head><body></body></html>');
		oDoc.close();
	}
	if (this.isSlideshow) {
		for (var i = 0; i < this.slideshowIDCount; i++) { window.clearTimeout(this.slideshowIDArray[i]); }
		this.isPaused = false;
	}
	if (!this.isEmpty(this.afterEnd)) {
		var callback = window[this.afterEnd];
		if (typeof callback === 'function') {
			callback(this.args);
		}
	}
};
Lytebox.prototype.checkFrame = function() {
	if (window.parent.frames[window.name] && (parent.document.getElementsByTagName('frameset').length <= 0) && window.name != 'lbIframe') {
		this.isFrame = true;
		this.doc = parent.document;
	} else {
		this.isFrame = false;
		this.doc = document;
	}
	this.doc.$ = this.doc.getElementById;
};
Lytebox.prototype.getPixelRate = function(iCurrent, iDim) {
	var diff = (iDim > iCurrent) ? iDim - iCurrent : iCurrent - iDim;
	if (diff >= 0 && diff <= 100) { return (100 / this.resizeDuration); }
	if (diff > 100 && diff <= 200) { return (150 / this.resizeDuration); }
	if (diff > 200 && diff <= 300) { return (200 / this.resizeDuration); }
	if (diff > 300 && diff <= 400) { return (250 / this.resizeDuration); }
	if (diff > 400 && diff <= 500) { return (300 / this.resizeDuration); }
	if (diff > 500 && diff <= 600) { return (350 / this.resizeDuration); }
	if (diff > 600 && diff <= 700) { return (400 / this.resizeDuration); }
	if (diff > 700) { return (450 / this.resizeDuration); }
};
Lytebox.prototype.fadeIn = function(args) {
	var sId = this.isEmpty(args.id) ? '' : args.id;
	var iSpeed = (this.isEmpty(args.speed) ? 5 : (parseInt(args.speed) > 5 ? 5 : parseInt(args.speed)));
		iSpeed = isNaN(iSpeed) ? 5 : iSpeed;
	var iOpacity = this.isEmpty(args.opacity) ? 0 : parseInt(args.opacity);
		iOpacity = isNaN(iOpacity) ? 0 : iOpacity;
	var sDisplay = this.isEmpty(args.display) ? '' : args.display;
	var sVisibility = this.isEmpty(args.visibility) ? '' : args.visibility;
	var oElement = this.doc.$(sId);
	var iIncrement = iSpeed;
	if (/lbImage|lbIframe|lbOverlay|lbBottomContainer|lbTopContainer/.test(sId)) {
		iIncrement = this.ff ? (this.ffVersion >= 6 ? 2 : 5) : (this.safari ? 3 : (this.ieVersion <= 8 ? 10 : 5));
		iIncrement = this.isMobile() ? 20 : iIncrement;
		iIncrement = (sId == 'lbOverlay' ? iIncrement * 2 : iIncrement);
		iIncrement = (sId == 'lbIframe' ? 100 : iIncrement);
	} else if (this.ieVersion == 7 || this.ieVersion == 8) {
		iIncrement = 10;
	}
	oElement.style.opacity = (iOpacity / 100);
	oElement.style.filter = "alpha(opacity=" + (iOpacity) + ")";
	if (iOpacity >= 100 && (sId == 'lbImage' || sId == 'lbIframe')) {
		try { oElement.style.removeAttribute("filter"); } catch(e) {}
		this.fixBottomPadding();
	} else if (iOpacity >= this.maxOpacity && sId == 'lbOverlay') {
		for (var i = 0; i < this.overlayTimerCount; i++) { window.clearTimeout(this.overlayTimerArray[i]); }
		this.overlayLoaded = true;
		return;
	} else if (iOpacity >= 100 && (sId == 'lbBottomContainer' || sId == 'lbTopContainer')) {
		try { oElement.style.removeAttribute("filter"); } catch(e) {}
		for (var i = 0; i < this.imageTimerCount; i++) { window.clearTimeout(this.imageTimerArray[i]); }
		this.doc.$('lbOverlay').style.height = this.aPageSize[1] + "px";
	} else if (iOpacity >= 100) {
		for (var i = 0; i < this.imageTimerCount; i++) { window.clearTimeout(this.imageTimerArray[i]); }
	} else {
		if (sId == 'lbOverlay') {
			this.overlayTimerArray[this.overlayTimerCount++] = setTimeout("$lb.fadeIn({ id: '" + sId + "', opacity: " + (iOpacity + iIncrement) + ", speed: " + iSpeed + " })", 1);
		} else {
			this.imageTimerArray[this.imageTimerCount++] = setTimeout("$lb.fadeIn({ id: '" + sId + "', opacity: " + (iOpacity + iIncrement) + ", speed: " + iSpeed + " })", 1);
		}
	}
};
Lytebox.prototype.fadeOut = function(args) {
	var sId = this.isEmpty(args.id) ? '' : args.id;
	var iSpeed = (this.isEmpty(args.speed) ? 5 : (parseInt(args.speed) > 5 ? 5 : parseInt(args.speed)));
		iSpeed = isNaN(iSpeed) ? 5 : iSpeed;
	var iOpacity = this.isEmpty(args.opacity) ? 100 : parseInt(args.opacity);
		iOpacity = isNaN(iOpacity) ? 100 : iOpacity;
	var sDisplay = this.isEmpty(args.display) ? '' : args.display;
	var sVisibility = this.isEmpty(args.visibility) ? '' : args.visibility;
	var oElement = this.doc.$(sId);
	if (this.ieVersion == 7 || this.ieVersion == 8) {
		iSpeed *= 2;
	}
	oElement.style.opacity = (iOpacity / 100);
	oElement.style.filter = "alpha(opacity=" + iOpacity + ")";
	if (iOpacity <= 0) {
		try {
			if (!this.isEmpty(sDisplay)) {
				oElement.style.display = sDisplay;
			}
			if (!this.isEmpty(sVisibility)) {
				oElement.style.visibility = sVisibility;
			}
		} catch(err) { }
		if (sId == 'lbOverlay') {
			this.overlayLoaded = false;
			if (this.isLyteframe) {
				this.doc.$('lbIframe').src = 'about:blank';
				this.initialize();
			}
		} else {
			for (var i = 0; i < this.timerIDCount; i++) { window.clearTimeout(this.timerIDArray[i]); }
		}
	} else if (sId == 'lbOverlay') {
		this.overlayTimerArray[this.overlayTimerCount++] = setTimeout("$lb.fadeOut({ id: '" + sId + "', opacity: " + (iOpacity - (iSpeed * 2)) + ", speed: " + iSpeed + ", display: '" + sDisplay + "', visibility: '" + sVisibility + "' })", 1);
	} else {
		this.timerIDArray[this.timerIDCount++] = setTimeout("$lb.fadeOut({ id: '" + sId + "', opacity: " + (iOpacity - iSpeed) + ", speed: " + iSpeed + ", display: '" + sDisplay + "', visibility: '" + sVisibility + "' })", 1);
	}
};
Lytebox.prototype.resizeW = function(sId, iCurrentW, iMaxW, iPixelRate, iSpeed) {
	var object = this.doc.$(sId);
	var newW = (this.doAnimations ? iCurrentW : iMaxW);
	object.style.width = (newW) + "px";
	if (newW < iMaxW) {
		newW += (newW + iPixelRate >= iMaxW) ? (iMaxW - newW) : iPixelRate;
	} else if (newW > iMaxW) {
		newW -= (newW - iPixelRate <= iMaxW) ? (newW - iMaxW) : iPixelRate;
	}
	this.resizeWTimerArray[this.resizeWTimerCount++] = setTimeout("$lb.resizeW('" + sId + "', " + newW + ", " + iMaxW + ", " + iPixelRate + ", " + (iSpeed) + ")", iSpeed);
	if (parseInt(object.style.width) == iMaxW) {
		this.wDone = true;
		for (var i = 0; i < this.resizeWTimerCount; i++) { window.clearTimeout(this.resizeWTimerArray[i]); }
		if (this.isLyteframe) {
			this.loadContent();
		} else {
			this.showContent();
		}
	}
};
Lytebox.prototype.resizeH = function(sId, iCurrentH, iMaxH, iPixelRate, iSpeed) {
	var object = this.doc.$(sId);
	var newH = (this.doAnimations ? iCurrentH : iMaxH);
	object.style.height = (newH) + "px";
	if (newH < iMaxH) {
		newH += (newH + iPixelRate >= iMaxH) ? (iMaxH - newH) : iPixelRate;
	} else if (newH > iMaxH) {
		newH -= (newH - iPixelRate <= iMaxH) ? (newH - iMaxH) : iPixelRate;
	}
	this.resizeHTimerArray[this.resizeHTimerCount++] = setTimeout("$lb.resizeH('" + sId + "', " + newH + ", " + iMaxH + ", " + iPixelRate + ", " + (iSpeed+.02) + ")", iSpeed+.02);
	if (parseInt(object.style.height) == iMaxH) {
		this.hDone = true;
		for (var i = 0; i < this.resizeHTimerCount; i++) { window.clearTimeout(this.resizeHTimerArray[i]); }
		this.resizeW('lbOuterContainer', this.wCur, this.resizeWidth + this.borderSize * 2, this.getPixelRate(this.wCur, this.resizeWidth));
	}
};
Lytebox.prototype.getPageScroll = function() {
	if (self.pageYOffset) {
		return this.isFrame ? parent.pageYOffset : self.pageYOffset;
	} else if (this.doc.documentElement && this.doc.documentElement.scrollTop){
		return this.doc.documentElement.scrollTop;
	} else if (document.body) {
		return this.doc.body.scrollTop;
	}
};
Lytebox.prototype.getPageSize = function() {
	var xScroll, yScroll, windowWidth, windowHeight;
	if (window.innerHeight && window.scrollMaxY) {
		xScroll = this.doc.scrollWidth;
		yScroll = (this.isFrame ? parent.innerHeight : self.innerHeight) + (this.isFrame ? parent.scrollMaxY : self.scrollMaxY);
	} else if (this.doc.body.scrollHeight > this.doc.body.offsetHeight){
		xScroll = this.doc.body.scrollWidth;
		yScroll = this.doc.body.scrollHeight;
	} else {
		xScroll = this.doc.getElementsByTagName("html").item(0).offsetWidth;
		yScroll = this.doc.getElementsByTagName("html").item(0).offsetHeight;
		xScroll = (xScroll < this.doc.body.offsetWidth) ? this.doc.body.offsetWidth : xScroll;
		yScroll = (yScroll < this.doc.body.offsetHeight) ? this.doc.body.offsetHeight : yScroll;
	}
	if (self.innerHeight) {
		windowWidth = (this.isFrame) ? parent.innerWidth : self.innerWidth;
		windowHeight = (this.isFrame) ? parent.innerHeight : self.innerHeight;
	} else if (document.documentElement && document.documentElement.clientHeight) {
		windowWidth = this.doc.documentElement.clientWidth;
		windowHeight = this.doc.documentElement.clientHeight;
		windowWidth = (windowWidth == 0) ? this.doc.body.clientWidth : windowWidth;
		windowHeight = (windowHeight == 0) ? this.doc.body.clientHeight : windowHeight;
	} else if (document.body) {
		windowWidth = this.doc.getElementsByTagName("html").item(0).clientWidth;
		windowHeight = this.doc.getElementsByTagName("html").item(0).clientHeight;
		windowWidth = (windowWidth == 0) ? this.doc.body.clientWidth : windowWidth;
		windowHeight = (windowHeight == 0) ? this.doc.body.clientHeight : windowHeight;
	}
	var pageHeight = (yScroll < windowHeight) ? windowHeight : yScroll;
	var pageWidth = (xScroll < windowWidth) ? windowWidth : xScroll;
	return new Array(pageWidth, pageHeight, windowWidth, windowHeight);
};
Lytebox.prototype.toggleObjects = function(sState) {
	var objects = this.doc.getElementsByTagName("object");
	for (var i = 0; i < objects.length; i++) {
		objects[i].style.visibility = (sState == "hide") ? 'hidden' : 'visible';
	}
	var embeds = this.doc.getElementsByTagName("embed");
	for (var i = 0; i < embeds.length; i++) {
		embeds[i].style.visibility = (sState == "hide") ? 'hidden' : 'visible';
	}
	if (this.isFrame) {
		for (var i = 0; i < parent.frames.length; i++) {
			try {
				objects = parent.frames[i].window.document.getElementsByTagName("object");
				for (var j = 0; j < objects.length; j++) {
					objects[j].style.visibility = (sState == "hide") ? 'hidden' : 'visible';
				}
			} catch(e) {}
			
			try {
				embeds = parent.frames[i].window.document.getElementsByTagName("embed");
				for (var j = 0; j < embeds.length; j++) {
					embeds[j].style.visibility = (sState == "hide") ? 'hidden' : 'visible';
				}
			} catch(e) {}
		}
	}
};
Lytebox.prototype.toggleSelects = function(sState) {
	var selects = this.doc.getElementsByTagName("select");
	for (var i = 0; i < selects.length; i++ ) {
		selects[i].style.visibility = (sState == "hide") ? 'hidden' : 'visible';
	}
	if (this.isFrame) {
		for (var i = 0; i < parent.frames.length; i++) {
			try {
				selects = parent.frames[i].window.document.getElementsByTagName("select");
				for (var j = 0; j < selects.length; j++) {
					selects[j].style.visibility = (sState == "hide") ? 'hidden' : 'visible';
				}
			} catch(e) {}
		}
	}
};
Lytebox.prototype.pause = function(iMillis) {
	var now = new Date();
	var exitTime = now.getTime() + iMillis;
	while (true) {
		now = new Date();
		if (now.getTime() > exitTime) { return; }
	}
};
Lytebox.prototype.combine = function(aAnchors, aAreas) {
	var lyteLinks = [];
	for (var i = 0; i < aAnchors.length; i++) {
		lyteLinks.push(aAnchors[i]);
	}
	for (var i = 0; i < aAreas.length; i++) {
		lyteLinks.push(aAreas[i]);
	}
	return lyteLinks;
};
Lytebox.prototype.removeDuplicates = function (aArray) {
	var aNew = new Array();
	o:for(var i = 0, n = aArray.length; i < n; i++) {
		for(var x = 0, y = aNew.length; x < y; x++) {
			if (aNew[x][0].toLowerCase() == aArray[i][0].toLowerCase()) { continue o; }
		}
		aNew[aNew.length] = aArray[i];
	}
	return aNew;
};
Lytebox.prototype.printWindow = function () {
	var w = this.isLyteframe ? 800 : this.imgPreloader.width + 20;
	var h = this.isLyteframe ? 600 : this.imgPreloader.height + 20;
	var left = parseInt((screen.availWidth/2) - (w/2));
	var top = parseInt((screen.availHeight/2) - (h/2));
	var wOpts = "width=" + w + ",height=" + h + ",left=" + left + ",top=" + top + "screenX=" + left + ",screenY=" + top + "directories=0,location=0,menubar=0,resizable=0,scrollbars=0,status=0,titlebar=0,toolbar=0";
	var d = new Date();
	var wName = 'Print' + d.getTime();
	var wUrl = document.getElementById(this.printId).src;
	this.wContent = window.open(wUrl, wName, wOpts);
	this.wContent.focus();
	var t = setTimeout("$lb.printContent()",1000);
};
Lytebox.prototype.printContent = function() {
	try {
		if (this.wContent.document.readyState == 'complete') {
			this.wContent.print();
			this.wContent.close();
			this.wContent = null;
		} else {
			var t = setTimeout("$lb.printContent()",1000);
		}
	} catch(e) { }
};
Lytebox.prototype.setOptions = function(sOptions) {
	this.args = '';
	this.group = '';
	this.inline = false;
	this.hideObjects = this.__hideObjects;
	this.autoResize = this.__autoResize;
	this.doAnimations = this.__doAnimations;
	this.animateOverlay = this.__animateOverlay;
	this.forceCloseClick = this.__forceCloseClick;
	this.refreshPage = this.__refreshPage;
	this.showPrint = this.__showPrint;
	this.navType = this.__navType;
	this.titleTop = this.__titleTop;
	this.navTop = this.__navTop;
	this.beforeStart = this.__beforeStart;
	this.afterStart = this.__afterStart
	this.beforeEnd = this.__beforeEnd;
	this.afterEnd = this.__afterEnd;
	this.scrolling = this.__scrolling;
	this.width = this.__width;
	this.height = this.__height;
	this.loopPlayback = this.__loopPlayback;
	this.autoPlay = this.__autoPlay;
	this.autoEmbed = this.__autoEmbed;
	this.slideInterval = this.__slideInterval;
	this.showNavigation = this.__showNavigation;
	this.showClose = this.__showClose;
	this.showDetails = this.__showDetails;
	this.showPlayPause = this.__showPlayPause;
	this.autoEnd = this.__autoEnd;
	this.pauseOnNextClick = this.__pauseOnNextClick;
	this.pauseOnPrevClick = this.__pauseOnPrevClick;
	this.loopSlideshow = this.__loopSlideshow;
	var sName = sValue = '';
	var aSetting = null;
	var aOptions = sOptions.split(' ');
	for (var i = 0; i < aOptions.length; i++) {
		aSetting = aOptions[i].split(':');
		sName = (aSetting.length > 1 ? this.trim(aSetting[0]).toLowerCase() : '');
		sValue = (aSetting.length > 1 ? this.trim(aSetting[1]): '');
		switch(sName) {
			case 'group':			this.group = (sName == 'group' ? (!this.isEmpty(sValue) ? sValue.toLowerCase() : '') : ''); break;
			case 'hideobjects':		this.hideObjects = (/true|false/.test(sValue) ? (sValue == 'true') : this.__hideObjects); break;
			case 'autoresize':		this.autoResize = (/true|false/.test(sValue) ? (sValue == 'true') : this.__autoResize); break;
			case 'doanimations':	this.doAnimations = (/true|false/.test(sValue) ? (sValue == 'true') : this.__doAnimations); break;
			case 'animateoverlay':	this.animateOverlay = (/true|false/.test(sValue) ? (sValue == 'true') : this.__animateOverlay); break;
			case 'forcecloseclick':	this.forceCloseClick = (/true|false/.test(sValue) ? (sValue == 'true') : this.__forceCloseClick); break;
			case 'refreshpage':		this.refreshPage = (/true|false/.test(sValue) ? (sValue == 'true') : this.__refreshPage); break;
			case 'showprint':		this.showPrint = (/true|false/.test(sValue) ? (sValue == 'true') : this.__showPrint); break;
			case 'navtype':			this.navType = (/[1-3]{1}/.test(sValue) ? parseInt(sValue) : this.__navType); break;
			case 'titletop':		this.titleTop = (/true|false/.test(sValue) ? (sValue == 'true') : this.__titleTop); break;
			case 'navtop':			this.navTop = (/true|false/.test(sValue) ? (sValue == 'true') : this.__navTop); break;
			case 'beforestart':		this.beforeStart = (!this.isEmpty(sValue) ? sValue : this.__beforeStart); break;
			case 'afterstart':		this.afterStart = (!this.isEmpty(sValue) ? sValue : this.__afterStart); break;
			case 'beforeend':		this.beforeEnd = (!this.isEmpty(sValue) ? sValue : this.__beforeEnd); break;
			case 'afterend':		this.afterEnd = (!this.isEmpty(sValue) ? sValue : this.__afterEnd); break;
			case 'args': 			this.args = (!this.isEmpty(sValue) ? sValue : ''); break;
			case 'scrollbars':		this.scrolling = (/auto|yes|no/.test(sValue) ? sValue : this.__scrolling); break;
			case 'scrolling':		this.scrolling = (/auto|yes|no/.test(sValue) ? sValue : this.__scrolling); break;
			case 'width':			this.width = (/\d(%|px|)/.test(sValue) ? sValue : this.__width); break;
			case 'height':			this.height = (/\d(%|px|)/.test(sValue) ? sValue : this.__height); break;
			case 'loopplayback':	this.loopPlayback = (/true|false/.test(sValue) ? (sValue == 'true') : this.__loopPlayback); break;
			case 'autoplay':		this.autoPlay = (/true|false/.test(sValue) ? (sValue == 'true') : this.__autoPlay); break;
			case 'autoembed':		this.autoEmbed = (/true|false/.test(sValue) ? (sValue == 'true') : this.__autoEmbed); break;
			case 'inline':			this.inline = (/true|false/.test(sValue) ? (sValue == 'true') : false);
			case 'slideinterval':	this.slideInterval = (/\d/.test(sValue) ? parseInt(sValue) : this.__slideInterval); break;
			case 'shownavigation':	this.showNavigation = (/true|false/.test(sValue) ? (sValue == 'true') : this.__showNavigation); break;
			case 'showclose':		this.showClose = (/true|false/.test(sValue) ? (sValue == 'true') : this.__showClose); break;
			case 'showdetails':		this.showDetails = (/true|false/.test(sValue) ? (sValue == 'true') : this.__showDetails); break;
			case 'showplaypause':	this.showPlayPause = (/true|false/.test(sValue) ? (sValue == 'true') : this.__showPlayPause); break;
			case 'autoend':			this.autoEnd = (/true|false/.test(sValue) ? (sValue == 'true') : this.__autoEnd); break;
			case 'pauseonnextclick': this.pauseOnNextClick = (/true|false/.test(sValue) ? (sValue == 'true') : this.__pauseOnNextClick); break;
			case 'pauseonprevclick': this.pauseOnPrevClick = (/true|false/.test(sValue) ? (sValue == 'true') : this.__pauseOnPrevClick); break;
			case 'loopslideshow':	this.loopSlideshow = (/true|false/.test(sValue) ? (sValue == 'true') : this.__loopSlideshow); break;
		}
	}
};
	Lytebox.prototype.buildObject = function(w, h, url) {
	var object = '';
	var classId = '';
	var codebase = '';
	var pluginsPage = '';
	var auto = this.autoPlay ? 'true' : 'false';
	var loop = this.loopPlayback ? 'true' : 'false';
	var type = url.match(/.mov|.avi|.wmv|.mpg|.mpeg|.swf/i);
	switch(type[0]) {
	case '.mov':
			codebase = 'http://www.apple.com/qtactivex/qtplugin.cab';
			pluginsPage = 'http://www.apple.com/quicktime/';
			classId = 'clsid:02BF25D5-8C17-4B23-BC80-D3488ABDDC6B';
			object 	= '<object classid="' + classId + '" width="' + w + '" height="' + h + '" codebase="' + codebase + '">'
					+ '<param name="src" value="' + url + '">'
					+ '<param name="autoplay" value="' + auto + '">'
					+ '<param name="loop" value="' + loop + '">'
					+ '<param name="controller" value="true">'
					+ '<embed src="' + url + '" width="' + w + '" height="' + h + '" autoplay="' + auto + '" loop="' + loop + '" controller="true" pluginspage="' + pluginsPage + '"></embed>'
					+ '</object>';
			if (this.getQuicktimeVersion() <= 0) {
				object	= '<div style="padding:1em;">'
						+ '<h2>QUICKTIME PLAYER</h2>'
						+ '<p>Content on this page requires a newer version of QuickTime. Please click the image link below to download and install the latest version.</p>'
						+ '<p><a href="http://www.apple.com/quicktime/" target="_blank"><img src="http://images.apple.com/about/webbadges/images/qt7badge_getQTfreeDownload.gif" alt="Get QuickTime" border="0" /></a></p>'
						+ '</div>';
			}
			break;
		case '.avi':
		case '.mpg':
		case '.mpeg':
		case '.wmv':
			classId = 'clsid:02BF25D5-8C17-4B23-BC80-D3488ABDDC6B';			
			object 	= '<object classid="' + classId + '" width="' + w + '" height="' + h + '" codebase="' + codebase + '">'
					+ '<param name="src" value="' + url + '">'
					+ '<param name="autoplay" value="' + auto + '">'
					+ '<param name="loop" value="' + loop + '">'
					+ '<param name="controller" value="true">'
					+ '<object type="video/quicktime" data="' + url + '" width="' + w + '" height="' + h + '">'
					+ '<param name="controller" value="false">'
					+ '<param name="autoplay" value="' + auto + '">'
					+ '<param name="loop" value="' + loop + '">'
					+ '</object>' 
					+ '</object>';
			break;
		case '.swf':
			classId = 'clsid:D27CDB6E-AE6D-11cf-96B8-444553540000';
			object 	= '<object classid="' + classId + '" width="' + w + '" height="' + h + '" codebase="' + codebase + '">'
					+ '<param name="movie" value="' + url + '">'
					+ '<param name="quality" value="high">'
					+ '<param name="wmode" value="opaque">'
					+ '<!--[if !IE]>-->'
					+ '<object type="application/x-shockwave-flash" data="' + url + '" width="' + w + '" height="' + h + '">'
					+ '<!--<![endif]-->'
					+ '<param name="quality" value="high">'
					+ '<param name="wmode" value="opaque">'
					+ '<div style="padding:1em;">'
					+ '<h2>FLASH PLAYER</h2>'
					+ '<p>Content on this page requires a newer version of Adobe Flash Player. Please click the image link below to download and install the latest version.</p>'
					+ '<p><a href="http://www.adobe.com/go/getflashplayer" target="_blank"><img src="http://www.adobe.com/macromedia/style_guide/images/160x41_Get_Flash_Player.jpg" alt="Get Adobe Flash player" border="0" /></a></p>'
					+ '</div>'
					+ '<!--[if !IE]>-->'
					+ '</object>'
					+ '<!--<![endif]-->'
					+ '</object>';
			break;
	}
	return object;
};
Lytebox.prototype.getQuicktimeVersion = function() {
	var agent = navigator.userAgent.toLowerCase(); 
	var version = -1;
	if (navigator.plugins != null && navigator.plugins.length > 0) {
		for (i=0; i < navigator.plugins.length; i++ ) {
			var plugin = navigator.plugins[i];
			if (plugin.name.indexOf('QuickTime') > -1) {
				version = parseFloat(plugin.name.substring(18));
			}
		}
	} else if (this.autoEmbed && agent.indexOf('msie') != -1 && parseInt(navigator.appVersion) >= 4 && agent.indexOf('win') != -1 && agent.indexOf('16bit') == -1) {
		var control = null;
		try {
			control = new ActiveXObject('QuickTime.QuickTime');
		} catch (e) { }
		if (control) {
			isInstalled = true;
		}			
		try {
			control = new ActiveXObject('QuickTimeCheckObject.QuickTimeCheck');
		} catch (e) { return; }
		if (control) {
			isInstalled = true;
			version = control.QuickTimeVersion.toString(16);
			version = version.substring(0, 1) + '.' + version.substring(1, 3);
			version = parseInt(version);
		}
	}
	return version;
};
Lytebox.prototype.findPos = function(el) {
	if (this.ie && this.doc.compatMode == 'BackCompat') {
		return [0, 16, 12];
	}
	var left = 0;
	var top = 0;
	var height = 0;
	height = el.offsetHeight + 6;
	if (el.offsetParent) {
		do {
			left += el.offsetLeft;
			top += el.offsetTop;
		} while (el = el.offsetParent);
	}
	return [left, top, height];
};
Lytebox.prototype.isMobile = function() {
	var ua = navigator.userAgent;
	return (ua.match(/ipad/i) != null)
		|| (ua.match(/ipod/i) != null)
		|| (ua.match(/iphone/i) != null)
		|| (ua.match(/android/i) != null)
		|| (ua.match(/opera mini/i) != null)
		|| (ua.match(/blackberry/i) != null)
		|| (ua.match(/(pre\/|palm os|palm|hiptop|avantgo|plucker|xiino|blazer|elaine)/i) != null)
		|| (ua.match(/(iris|3g_t|windows ce|opera mobi|windows ce; smartphone;|windows ce; iemobile)/i) != null)
		|| (ua.match(/(mini 9.5|vx1000|lge |m800|e860|u940|ux840|compal|wireless| mobi|ahong|lg380|lgku|lgu900|lg210|lg47|lg920|lg840|lg370|sam-r|mg50|s55|g83|t66|vx400|mk99|d615|d763|el370|sl900|mp500|samu3|samu4|vx10|xda_|samu5|samu6|samu7|samu9|a615|b832|m881|s920|n210|s700|c-810|_h797|mob-x|sk16d|848b|mowser|s580|r800|471x|v120|rim8|c500foma:|160x|x160|480x|x640|t503|w839|i250|sprint|w398samr810|m5252|c7100|mt126|x225|s5330|s820|htil-g1|fly v71|s302|-x113|novarra|k610i|-three|8325rc|8352rc|sanyo|vx54|c888|nx250|n120|mtk |c5588|s710|t880|c5005|i;458x|p404i|s210|c5100|teleca|s940|c500|s590|foma|samsu|vx8|vx9|a1000|_mms|myx|a700|gu1100|bc831|e300|ems100|me701|me702m-three|sd588|s800|8325rc|ac831|mw200|brew |d88|htc\/|htc_touch|355x|m50|km100|d736|p-9521|telco|sl74|ktouch|m4u\/|me702|8325rc|kddi|phone|lg |sonyericsson|samsung|240x|x320|vx10|nokia|sony cmd|motorola|up.browser|up.link|mmp|symbian|smartphone|midp|wap|vodafone|o2|pocket|kindle|mobile|psp|treo)/i) != null);
};
Lytebox.prototype.validate = function(args) {
	var reTest = sName = '';
	var bValid = false;
	var oElement = this.isEmpty(args.id) ? (this.isEmpty(args.element) ? null : args.element) : document.getElementById(args.id);
	var sInput = this.isEmpty(args.value) ? '' : String(args.value);
	var sType = this.isEmpty(args.type) ? '' : String(args.type).toLowerCase();
	var sRegex = this.isEmpty(args.regex) ? '' : args.regex;
	var sCCType = (/visa|mc|amex|diners|discover|jcb/.test(args.ccType) ? args.ccType : '');
	var sImageType = this.isEmpty(args.imageType) ? '' : String(args.imageType.toLowerCase());
	var iMin = (/^\d+$/.test(args.min) ? parseInt(args.min) : 0);
	var iMax = (/^\d+$/.test(args.max) ? parseInt(args.max) : 0);
	var bInclusive = args.inclusive ? true : (/true|false/.test(args.inclusive) ? (args.inclusive == 'true') : true);
	var bAllowComma = args.allowComma ? true : (/true|false/.test(args.allowComma) ? (args.allowComma == 'true') : true);
	var bAllowWhitespace = args.allowWhiteSpace ? true : (/true|false/.test(args.allowWhiteSpace) ? (args.allowWhiteSpace == 'true') : true);
	if ((this.isEmpty(sInput) && this.isEmpty(oElement)) || (this.isEmpty(sType) && this.isEmpty(sRegex))) {
		return false;
	}
	var sInput = this.isEmpty(sInput) ? oElement.value : sInput;
	if (!this.isEmpty(sRegex)) {
		bValid = sRegex.test(sInput);
	} else {
		switch(sType) {
			case 'alnum':
				bValid = (bAllowWhitespace ? /^[a-z0-9\s]+$/i.test(sInput) : /^[a-z0-9]+$/i.test(sInput)); break;
			case 'alpha':
				bValid = (bAllowWhitespace ? /^[a-z\s]+$/i.test(sInput) : /^[a-z]+$/i.test(sInput)); break;
			case 'between':
				var iInput = bAllowComma ? parseInt(sInput.replace(/\,/g,'')) : parseInt(sInput);
				bValid = (bInclusive ? (iInput >= iMin && iInput <= iMax) : (iInput > iMin && iInput < iMax)); break;
			case 'ccnum':
				if (this.isEmpty(sCCType)) {
					bValid = /^(?:4[0-9]{12}(?:[0-9]{3})?|5[1-5][0-9]{14}|6(?:011|5[0-9][0-9])[0-9]{12}|3[47][0-9]{13}|3(?:0[0-5]|[68][0-9])[0-9]{11}|(?:2131|1800|35\d{3})\d{11})$/.test(sInput); break;
				} else {
					switch(sCCType) {
						case 'visa':
							bValid = /^4[0-9]{12}(?:[0-9]{3})?$/.test(sInput); break;
						case 'mc':
							bValid = /^5[1-5][0-9]{14}$/.test(sInput); break;
						case 'amex':
							bValid = /^3[47][0-9]{13}$/.test(sInput); break;
						case 'diners':
							bValid = /^3(?:0[0-5]|[68][0-9])[0-9]{11}$/.test(sInput); break;
						case 'discover':
							bValid = /^6(?:011|5[0-9]{2})[0-9]{12}$/.test(sInput); break;
						case 'jcb':
							bValid = /^(?:2131|1800|35\d{3})\d{11}$/.test(sInput); break;
						default:
							bValid = false;
					}
				}
			case 'date':
				var date = new Date(sInput);
				bValid = !(date.toString() == 'NaN' || date.toString() == 'Invalid Date'); break;
			case 'digits':
				bValid = /^\d+$/.test(sInput); break;
			case 'email':
				bValid = /^([a-z0-9_\.\-])+\@(([a-z0-9\-])+\.)+([a-z0-9]{2,4})+$/i.test(sInput); break;
			case 'float':
				bValid = /^[-+]?[0-9]*\.?[0-9]+$/.test(bAllowComma ? sInput.replace(/\,/g,'') : sInput); break;
			case 'image':
				if (this.isEmpty(sImageType)) {
					bValid = /^(png|jpg|jpeg|gif)$/i.test(sInput.split('.').pop()); break;
				} else {
					bValid = (sInput.split('.').pop().toLowerCase().match(sImageType) ? true : false); break;
				}
			case 'int':
			case 'integer':
				bValid = /^[-+]?\d+$/.test(sInput.replace(/\,/g,'')); break;
			case 'len':
			case 'length':
				bValid = (iMin == iMax) ? (sInput.length == iMin) : (sInput.length >= iMin && sInput.length <= iMax); break;
			case 'phone':
				bValid = /^\(?(\d{3})\)?[- ]?(\d{3})[- ]?(\d{4})$/.test(sInput); break;
			case 'notempty':
				bValid = !this.isEmpty(sInput); break;
			case 'ssn':
				bValid = /^[0-9]{3}\-?[0-9]{2}\-?[0-9]{4}$/.test(sInput); break;
			case 'url':
				bValid = /\b((?:[a-z][\w-]+:(?:\/{1,3}|[a-z0-9%])|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,4}\/)(?:[^\s()<>]+|\(([^\s()<>]+|(\([^\s()<>]+\)))*\))+(?:\(([^\s()<>]+|(\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?""'']))/i.test(sInput); break;
			case 'zip':
				bValid = /^\d{5}$|^\d{5}-\d{4}$/.test(sInput); break;
		}
	}
	return bValid;
};
Lytebox.prototype.ajax = function(args) {
	var iIndex = this.http.length;
	var oRequest = this.getRequestObject();
	this.http[iIndex] = oRequest;
	var oHttpArgs = args;
	oHttpArgs.index = iIndex;
	oHttpArgs.method = !(/get|post/i.test(oHttpArgs.method)) ? 'get' : oHttpArgs.method;
	oHttpArgs.cache = !(/true|false/.test(oHttpArgs.cache)) ? true : (oHttpArgs.cache == 'true' || oHttpArgs.cache);
	if (!this.isEmpty(oHttpArgs.timeout) && (/^\d+$/.test(oHttpArgs.timeout))) {
		oHttpArgs.timerId = setTimeout("$lb.http["+iIndex+"].abort()", oHttpArgs.timeout);
	}
	oRequest.onreadystatechange = function() {
		return function() {
			if (oRequest.readyState == 4 && oRequest.status == 200) {
				if (document.getElementById(oHttpArgs.updateId)) {
					try {
						document.getElementById(oHttpArgs.updateId).innerHTML = oRequest.responseText;
					} catch(e) { alert(e.description ); };
				}
				if (typeof oHttpArgs.success === 'function') {
					oHttpArgs.success(oRequest);
				}
				window.clearTimeout(oHttpArgs.timerId);
				$lb.http[oHttpArgs.index] = null;
			} else if (oRequest.readyState == 4 && oRequest.status != 200) {
				if (typeof oHttpArgs.fail === 'function') {
					oHttpArgs.fail(oRequest);
				}
				window.clearTimeout(oHttpArgs.timerId);
				$lb.http[oHttpArgs.index] = null;
			}
		} (oRequest, oHttpArgs);
	}
	if (oHttpArgs.method.toLowerCase() == 'post') {
		var oForm = document.getElementById(oHttpArgs.form);
		var bStripTags = !(/true|false/.test(args.stripTags)) ? false : (args.stripTags == 'true' || args.stripTags);
		var sParams = (oForm == null ? this.serialize({ name: oHttpArgs.form, stripTags: bStripTags }) : this.serialize({ element: oForm, stripTags: bStripTags }));
		var sTimestamp = (!oHttpArgs.cache ? ((/\&/.test(sParams)) ? '&' : '') + new Date().getTime() : '');
		oRequest.open('post', oHttpArgs.url, true);
		oRequest.setRequestHeader('Content-type','application/x-www-form-urlencoded');
		oRequest.send(sParams + sTimestamp);
	} else {
		var sTimestamp = (!oHttpArgs.cache ? ((/\?/.test(oHttpArgs.url)) ? '&' : '?') + new Date().getTime() : '');
		oRequest.open('get', oHttpArgs.url  + sTimestamp, true);
		oRequest.send();
	}
};
Lytebox.prototype.serialize = function(args) {
	var sParams = sValue = '';
	var bStripTags = !(/true|false/.test(args.stripTags)) ? false : (args.stripTags == 'true' || args.stripTags);
	var oElements = this.isEmpty(args.id) ? (this.isEmpty(args.element) ? null : args.element) : document.getElementById(args.id);
	if (oElements == null) {
		for (var i = 0; i < document.forms.length; i++) {
			if (document.forms[i].name == args.name) {
				oElements = document.forms[i].elements;
			}
		}
	}
	for (var i = 0; i < oElements.length; i++) {
		if ((oElements[i].type == 'checkbox' && !oElements[i].checked) ||
			(oElements[i].type == 'radio' && !oElements[i].checked) ||
			(oElements[i].disabled) || (oElements[i].name == '') || (oElements[i].type == 'reset')) {
			continue;
		}
		if (oElements[i].type == 'select-multiple') {
			for (var j = 0; j < oElements[i].options.length; j++) {
				if (oElements[i].options[j].selected == true) {
					sParams += (sParams == '' ? '' : '&') + oElements[i].name + '=' + encodeURIComponent(oElements[i].options[j].value);
				}
			}
		} else {
			sValue = bStripTags ? this.stripTags({ value: oElements[i].value }) : oElements[i].value;
			sParams += (sParams == '' ? '' : '&') + oElements[i].name + '=' + encodeURIComponent(sValue);
		}
	}
	return sParams;
};
Lytebox.prototype.getRequestObject = function () {
	var oReq = null;
	if (window.XMLHttpRequest) {
		try { oReq = new XMLHttpRequest(); } catch (e) { }
	} else if (typeof ActiveXObject != 'undefined') {
		try {
			oReq = new ActiveXObject("Msxml2.XMLHTTP");
		} catch (e) {
			try { oReq = new ActiveXObject("Microsoft.XMLHTTP"); } catch (e) { }
		}
	}
	return oReq;
};
Lytebox.prototype.isEmpty = function(args) {
	var sValue = '';
	try {
		sValue = this.isEmpty(args.value) ? args : args.value;
	} catch(e) {
		sValue = args;
	}
	return (this.trim(sValue) == '' || sValue == 'null' || sValue == null || typeof(sValue) == 'undefined');
};
Lytebox.prototype.stripTags = function(args) {
	var oElement = this.isEmpty(args.id) ? (this.isEmpty(args.element) ? null : args.element) : document.getElementById(args.id);
	if (!this.isEmpty(oElement)) {
		oElement.value = String(oElement.value).replace(/(<([^>]+)>)/ig, '');
	} else {
		var sValue = '';
		try {
			sValue = this.isEmpty(args.value) ? args : args.value;
		} catch(e) {
			sValue = args;
		}
		return (this.trim(sValue) == '[object Object]') ? '' : String(sValue).replace(/(<([^>]+)>)/ig, '');
	}
};
Lytebox.prototype.trim = function(args) {
	var sValue = '';
	try {
		sValue = this.isEmpty(args.value) ? args : args.value;
	} catch(e) {
		sValue = args;
	}
	return String(sValue).replace(/^\s+|\s+$/g, '');
};
Lytebox.prototype.capitalize = function (args) {
	return String(args.value ? args.value : args).replace( /(^|\s)([a-z])/g , function(m,p1,p2){return p1+p2.toUpperCase();});
};
Lytebox.prototype.hasClass = function (args) {
	var sClass = this.isEmpty(args.name) ? '' : args.name;
	var oElement = this.isEmpty(args.id) ? (this.isEmpty(args.element) ? null : args.element) : document.getElementById(args.id);
	return new RegExp('(\\s|^)' + sClass + '(\\s|$)').test(oElement.className);
};
Lytebox.prototype.addClass = function (args) {
	var sClass = this.isEmpty(args.name) ? '' : args.name;
	var oElement = this.isEmpty(args.id) ? (this.isEmpty(args.element) ? null : args.element) : document.getElementById(args.id);
	var aClasses = sClass.split(' ');
	for (var i = 0; i < aClasses.length; i++) {
		if (!this.hasClass({ element: oElement, name: aClasses[i] })) {
			oElement.className += ' ' + aClasses[i];
		}
	}
};
Lytebox.prototype.removeClass = function (args) {
	var sClass = this.isEmpty(args.name) ? '' : args.name;
	var oElement = this.isEmpty(args.id) ? (this.isEmpty(args.element) ? null : args.element) : document.getElementById(args.id);
	var aClasses = sClass.split(' ');
	for (var i = 0; i < aClasses.length; i++) {
		if (this.hasClass({ element: oElement, name: aClasses[i] })) {
			oElement.className = oElement.className.replace(new RegExp('(\\s|^)' + aClasses[i] + '(\\s|$)'), ' ').replace(/\s+/g, ' ').replace(/^\s|\s$/, '');
		}
	}
};
if (window.addEventListener) {
	window.addEventListener("load", initLytebox, false);
} else if (window.attachEvent) {
	window.attachEvent("onload", initLytebox);
} else {
	window.onload = function() {initLytebox();}
}
function initLytebox() { myLytebox = $lb = new Lytebox(true, $lb.http); }
myLytebox = $lb = new Lytebox(false);
]=]

Str_lytebox_css = [=[
#lbOverlay { position: fixed; top: 0; left: 0; z-index: 99997; width: 100%; height: 100%; }
	#lbOverlay.black { background-color: #000000; }
	#lbOverlay.grey { background-color: #000000; }
	#lbOverlay.red { background-color: #330000; }
	#lbOverlay.green { background-color: #003300; }
	#lbOverlay.blue { background-color: #011D50; }
	#lbOverlay.gold { background-color: #666600; }
	#lbOverlay.orange { background-color: #FFBB48; }

#lbMain { position: absolute; left: 0; width: 100%; z-index: 99998; text-align: center; line-height: 0; display:-moz-inline-stack; }
#lbMain a img { border: 1px solid #ffffff; }

#lbOuterContainer {	position: relative; background-color: #fff; width: 200px; height: 200px; margin: 0 auto; }
	#lbOuterContainer.black { border: 2px solid #CCCCCC; background-color: #000000; }
	#lbOuterContainer.grey { border: 2px solid #888888; }
	#lbOuterContainer.red { border: 2px solid #DD0000; }
	#lbOuterContainer.green { border: 2px solid #00B000; }
	#lbOuterContainer.blue { border: 2px solid #5F89D8; }
	#lbOuterContainer.gold { border: 2px solid #B0B000; }
	#lbOuterContainer.orange { border: 2px solid #D15211; }

#lbTopContainer, #lbBottomContainer { 
	font: 0.85em Verdana, Helvetica, sans-serif; background-color: #fff; width: 100%; line-height: 1.4em; font-size: 0.9em;
	overflow: hidden; margin: 0 auto; padding: 0; position: relative; z-index: 14; display: none;
}
#lbTopContainer { overflow: hidden; margin-top: 5px; }
#lbTopContainer.black, #lbBottomContainer.black { background-color: #000000; }
#lbTopContainer.grey, #lbTopContainer.red, #lbTopContainer.green, #lbTopContainer.blue, #lbTopContainer.gold, #lbTopContainer.orange,
#lbBottomContainer.grey, #lbBottomContainer.red, #lbBottomContainer.green, #lbBottomContainer.blue, #lbBottomContainer.gold, #lbBottomContainer.orange {
	background-color: #ffffff;
}
	
#lbImage, #lbIframe { border: none; }
#lbImage.black, #lbIframe.black { border: 1px solid #CCCCCC; }
	#lbImage.grey, #lbIframe.grey { border: 1px solid #888888; }
	#lbImage.red, #lbIframe.red { border: 1px solid #DD0000; }
	#lbImage.green, #lbIframe.green { border: 1px solid #00B000; }
	#lbImage.blue, #lbIframe.blue { border: 1px solid #5F89D8; }
	#lbImage.gold, #lbIframe.gold { border: 1px solid #B0B000; }
	#lbImage.orange, #lbIframe.orange { border: 1px solid #D15211; }
#lbImageContainer, #lbIframeContainer { padding: 10px; z-index: 12; }
#lbLoading {
	height: 100%; width: 100%; margin-top: -10px;
	background: url('loading_white.gif') center no-repeat;
}
#lbLoading.black { background: url('loading_black.gif') center no-repeat; }

#lbHoverNav { position: absolute; top: 0; left: 0; height: 100%; width: 100%; z-index: 10; }
#lbImageContainer>#lbHoverNav { left: 0; }
#lbHoverNav a { outline: none; }

#lbPrevHov { width: 48%; height: 100%; background: transparent url('blank.gif') no-repeat; display: block; left: 0; float: left; margin-left: 3px; border: none !important; }
	#lbPrevHov.black:hover, #lbPrevHov.black:visited { background: url('prev_black_t.png') left 30% no-repeat; }
	#lbPrevHov.grey:hover, #lbPrevHov.grey:visited { background: url('prev_grey_t.png') left 30% no-repeat; }
	#lbPrevHov.red:hover, #lbPrevHov.red:visited { background: url('prev_red_t.png') left 30% no-repeat; }
	#lbPrevHov.green:hover, #lbPrevHov.green:visited { background: url('prev_green_t.png') left 30% no-repeat; }
	#lbPrevHov.blue:hover, #lbPrevHov.blue:visited { background: url('prev_blue_t.png') left 30% no-repeat; }
	#lbPrevHov.gold:hover, #lbPrevHov.gold:visited { background: url('prev_gold_t.png') left 30% no-repeat; }
	#lbPrevHov.orange:hover, #lbPrevHov.orange:visited { background: url('prev_orange_t.png') left 30% no-repeat; }
	
#lbNextHov { width: 48%; height: 100%; background: transparent url('blank.gif') no-repeat; display: block; right: 0; float: right; margin-right: 3px; border: none !important; }
	#lbNextHov.black:hover, #lbNextHov.black:visited { background: url('next_black_t.png') right 30% no-repeat; }
	#lbNextHov.grey:hover, #lbNextHov.grey:visited { background: url('next_grey_t.png') right 30% no-repeat; }
	#lbNextHov.red:hover, #lbNextHov.red:visited { background: url('next_red_t.png') right 30% no-repeat; }
	#lbNextHov.green:hover, #lbNextHov.green:visited { background: url('next_green_t.png') right 30% no-repeat; }
	#lbNextHov.blue:hover, #lbNextHov.blue:visited { background: url('next_blue_t.png') right 30% no-repeat; }
	#lbNextHov.gold:hover, #lbNextHov.gold:visited { background: url('next_gold_t.png') right 30% no-repeat; }
	#lbNextHov.orange:hover, #lbNextHov.orange:visited { background: url('next_orange_t.png') right 30% no-repeat; }
	
#lbPrev, #lbPrevTop { width: 26px; height: 28px; float: right; margin: 0 0 1px 8px; border: none !important; }
	#lbPrev.black, #lbPrevTop.black { background: url('prev_black.png') no-repeat; }
	#lbPrev.blackOff, #lbPrevTop.blackOff { background: url('prev_black_off.png') no-repeat; cursor: default; }
	#lbPrev.grey, #lbPrevTop.grey { background: url('prev_grey.png') no-repeat; }
	#lbPrev.greyOff, #lbPrevTop.greyOff { background: url('prev_grey_off.png') no-repeat; cursor: default; }
	#lbPrev.red, #lbPrevTop.red { background: url('prev_red.png') no-repeat; }
	#lbPrev.redOff, #lbPrevTop.redOff { background: url('prev_red_off.png') no-repeat; cursor: default; }
	#lbPrev.green, #lbPrevTop.green { background: url('prev_green.png') no-repeat; }
	#lbPrev.greenOff, #lbPrevTop.greenOff { background: url('prev_green_off.png') no-repeat; cursor: default; }
	#lbPrev.blue, #lbPrevTop.blue { background: url('prev_blue.png') no-repeat; }
	#lbPrev.blueOff, #lbPrevTop.blueOff { background: url('prev_blue_off.png') no-repeat; cursor: default; }
	#lbPrev.gold, #lbPrevTop.gold { background: url('prev_gold.png') no-repeat; }
	#lbPrev.goldOff, #lbPrevTop.goldOff { background: url('prev_gold_off.png') no-repeat; cursor: default; }
	#lbPrev.orange, #lbPrevTop.orange { background: url('prev_orange.png') no-repeat; }
	#lbPrev.orangeOff, #lbPrevTop.orangeOff { background: url('prev_orange_off.png') no-repeat; cursor: default; }
	
#lbNext, #lbNextTop { width: 26px; height: 28px; float: right; margin: 0 0 1px 8px; border: none !important; }
	#lbNext.black, #lbNextTop.black { background: url('next_black.png') no-repeat; }
	#lbNext.blackOff, #lbNextTop.blackOff { background: url('next_black_off.png') no-repeat; cursor: default; }
	#lbNext.grey, #lbNextTop.grey { background: url('next_grey.png') no-repeat; }
	#lbNext.greyOff, #lbNextTop.greyOff { background: url('next_grey_off.png') no-repeat; cursor: default; }
	#lbNext.red, #lbNextTop.red { background: url('next_red.png') no-repeat; }
	#lbNext.redOff, #lbNextTop.redOff { background: url('next_red_off.png') no-repeat; cursor: default; }
	#lbNext.green, #lbNextTop.green { background: url('next_green.png') no-repeat; }
	#lbNext.greenOff, #lbNextTop.greenOff { background: url('next_green_off.png') no-repeat; cursor: default; }
	#lbNext.blue, #lbNextTop.blue { background: url('next_blue.png') no-repeat; }
	#lbNext.blueOff, #lbNextTop.blueOff { background: url('next_blue_off.png') no-repeat; cursor: default; }
	#lbNext.gold, #lbNextTop.gold { background: url('next_gold.png') no-repeat; }
	#lbNext.goldOff, #lbNextTop.goldOff { background: url('next_gold_off.png') no-repeat; cursor: default; }
	#lbNext.orange, #lbNextTop.orange { background: url('next_orange.png') no-repeat; }
	#lbNext.orangeOff, #lbNextTop.orangeOff { background: url('next_orange_off.png') no-repeat; cursor: default; }
	
#lbTopData, #lbBottomData { float: left; text-align: left; padding-left: 10px; }
#lbBottomData { padding-bottom: 0.5em; }
	#lbBottomData.black, #lbTopData.black { color: #ffffff; }
	#lbBottomData.grey, #lbTopData.grey { color: #333333; }
	#lbBottomData.red, #lbTopData.red { color: #620000; }
	#lbBottomData.green, #lbTopData.green { color: #003300; }
	#lbBottomData.blue, #lbTopData.blue { color: #01379E; }
	#lbBottomData.gold, #lbTopData.gold { color: #666600; }
	#lbBottomData.orange, #lbTopData.orange { color: #D15211; }

#lbTopNav, #lbBottomNav { float: right; text-align: right; padding-right: 10px; }
#lbNumTop, #lbNumBottom { font-style: italic; }
#lbDescBottom { display: block; }
#lbTitleTop, #lbTopNav { margin-top: 0.3em; }
#lbTitleTop, #lbTitleBottom { display: block; font-weight: bold; }

#lbClose, #lbCloseTop { width: 64px; height: 28px; float: right; margin: 0 0 1px 8px; border: none !important; }
	#lbClose.black, #lbCloseTop.black { background: url('close_black.png') no-repeat; }
	#lbClose.grey, #lbCloseTop.grey { background: url('close_grey.png') no-repeat; }
	#lbClose.red, #lbCloseTop.red { background: url('close_red.png') no-repeat; }
	#lbClose.green, #lbCloseTop.green { background: url('close_green.png') no-repeat; }
	#lbClose.blue, #lbCloseTop.blue { background: url('close_blue.png') no-repeat; }
	#lbClose.gold, #lbCloseTop.gold { background: url('close_gold.png') no-repeat; }
	#lbClose.orange, #lbCloseTop.orange { background: url('close_orange.png') no-repeat; }
	
#lbPrint, #lbPrintTop { width: 26px; height: 28px; float: right; margin: 0 0 1px 8px; border: none !important; }
	#lbPrint.black, #lbPrintTop.black { background: url('print_black.png') no-repeat; }
	#lbPrint.grey, #lbPrintTop.grey { background: url('print_grey.png') no-repeat; }
	#lbPrint.red, #lbPrintTop.red { background: url('print_red.png') no-repeat; }
	#lbPrint.green, #lbPrintTop.green { background: url('print_green.png') no-repeat; }
	#lbPrint.blue, #lbPrintTop.blue { background: url('print_blue.png') no-repeat; }
	#lbPrint.gold, #lbPrintTop.gold { background: url('print_gold.png') no-repeat; }
	#lbPrint.orange, #lbPrintTop.orange { background: url('print_orange.png') no-repeat; }

#lbPlay, #lbPlayTop { width: 26px; height: 28px; float: right; margin: 0 0 1px 8px; border: none !important; }
	#lbPlay.black, #lbPlayTop.black { background: url('play_black.png') no-repeat; }
	#lbPlay.grey, #lbPlayTop.grey { background: url('play_grey.png') no-repeat; }
	#lbPlay.red, #lbPlayTop.red { background: url('play_red.png') no-repeat; }
	#lbPlay.green, #lbPlayTop.green { background: url('play_green.png') no-repeat; }
	#lbPlay.blue, #lbPlayTop.blue { background: url('play_blue.png') no-repeat; }
	#lbPlay.gold, #lbPlayTop.gold { background: url('play_gold.png') no-repeat; }
	#lbPlay.orange, #lbPlayTop.orange { background: url('play_orange.png') no-repeat; }
	
#lbPause, #lbPauseTop { width: 26px; height: 28px; float: right; margin: 0 0 1px 8px; border: none !important; }
	#lbPause.black, #lbPauseTop.black { background: url('pause_black.png') no-repeat; }
	#lbPause.grey, #lbPauseTop.grey { background: url('pause_grey.png') no-repeat; }
	#lbPause.red, #lbPauseTop.red { background: url('pause_red.png') no-repeat; }
	#lbPause.green, #lbPauseTop.green { background: url('pause_green.png') no-repeat; }
	#lbPause.blue, #lbPauseTop.blue { background: url('pause_blue.png') no-repeat; }
	#lbPause.gold, #lbPauseTop.gold { background: url('pause_gold.png') no-repeat; }
	#lbPause.orange, #lbPauseTop.orange { background: url('pause_orange.png') no-repeat; }
	
/* Some extra padding on the bottom buttons so it's not too close to the border. */
#lbClose, #lbPrint, #lbPlay, #lbPause { margin: 0 0 6px 8px; }

/* Lytetip */
* html a:hover { background: transparent; }

.lytetip { outline: none; border-bottom: 1px dotted; z-index:24; text-decoration:none; }
.lytetip span {
	color: #000000;
	position: absolute;
	top: 2em; left:0;
	padding: 0.5em 0.8em;
	font: 10pt "Trebuchet MS", Arial, Helvetica, sans-serif !important;
	background: #F4F5FB; 
	border: 1px solid #888888;	
	border-radius: 5px 5px; -moz-border-radius: 5px; -webkit-border-radius: 5px;
	-webkit-box-shadow: 1px 2px 3px 0px #949494;-moz-box-shadow: 1px 2px 3px 0px #949494;box-shadow: 1px 2px 3px 0px #949494;
	width: 240px;
	filter: alpha(opacity:95);
	KHTMLOpacity: 0.95;
	MozOpacity: 0.95;
	opacity: 0.95;
	text-align: left;
	display: none;
}

.lytetip:hover { z-index:25; color: #aaaaff; background:; text-decoration: none; }
.lytetip:hover span { display: block; }
.lytetip:hover em {	font-size: 1.2em; font-weight: bold; display: block; padding: 0 0 0.6em 0; }
.lytetip:hover .lbTipImg { border: 0; margin: -20px 0 0 -36px; float: left; position: absolute; height: 32px; width: 32px; }
.lbErrorImg { background: url('error.png'); }
.lbInfoImg { background: url('info.png'); }
.lbHelpImg { background: url('help.png'); }
.lbWarningImg { background: url('warning.png'); }
span.lbCustom { padding: 0.5em 0.8em 0.5em 1.5em !important; }
span.lbIEFix { padding: 0.5em 0.8em !important; }
.lytetip .lbError { background: #FFE7D7; border: 1px solid #FF3334; }
.lytetip .lbInfo, .lytetip .lbHelp { background: #D2EEF7; border: 1px solid #2BB0D7; }
.lytetip .lbWarning { background: #FFFFAA; border: 1px solid #FFAD33; }
]=]

Str_fhpopup_custom = [=[
  /*
   * Family Historian JavaScript Image Popup Function
   * fhpopup(id) takes an anchor tag id and creates the HTML script to render in the popup window
   * fhresize(zoom) adjusts the size of the image in the popup window
   * fhwindow(zoom) determines the size and shape of the popup window
   * fhsmaller() and fhbigger() shrink or enlarge the image
   * fhclientheight() and fhclientwidth() return the window height and width for most browsers
   */
  function fhpopup(id)
  {
   var filename = document.getElementById(id).getAttribute("href");
   var caption = document.getElementById(id).getAttribute("title");
   var height = fhclientheight();
   var width = fhclientwidth();
   if (height < 600) height = 600;
   if (width < 600) width = 600;

   openwindow=window.open('','popup','channelmode=no,fullscreen=no,toolbar=no,location=no,directories=no,status=no,menubar=no,scrollbars=yes,resizable=yes');
   openwindow.document.writeln('<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">');
   openwindow.document.writeln('<html xmlns="http://www.w3.org/1999/xhtml">');
   openwindow.document.writeln(' <head>');
   openwindow.document.writeln('  <title>popup</title>');
   openwindow.document.writeln('  <link type="text/css" rel="stylesheet" href="fhstyle.css" />');
   openwindow.document.writeln('  <script type="text/javascript">');
   openwindow.document.writeln('//<![CDATA[');

   openwindow.document.writeln('var original_height = '+height+';');
   openwindow.document.writeln('var original_width = '+width+';');
   openwindow.document.writeln('var maximum_height = original_height;');
   openwindow.document.writeln('var maximum_width = original_width;');
   openwindow.document.writeln('var image_height = 0;');
   openwindow.document.writeln('var image_width = 0;');
   openwindow.document.writeln('var size = 0;');

   openwindow.document.writeln('function fhresize(zoom)');
   openwindow.document.writeln('{');
//   openwindow.document.writeln(' var window_height = fhclientheight() + 75;');
//   openwindow.document.writeln(' var window_width = fhclientwidth() + 25;');
//   openwindow.document.writeln(' if (window_height > original_height) maximum_height = window_height;');
//   openwindow.document.writeln(' if (window_width > original_width) maximum_width = window_width;');
   openwindow.document.writeln(' if (zoom <= 0)');
   openwindow.document.writeln(' {');
   openwindow.document.writeln('  if (zoom < 0)');
   openwindow.document.writeln('  {');
   openwindow.document.writeln('   image_height = document.images[0].height;');
   openwindow.document.writeln('   image_width = document.images[0].width;');
   openwindow.document.writeln('  }');
   openwindow.document.writeln('  zoom = image_height / maximum_height;');
   openwindow.document.writeln('  if (zoom > 1) zoom = 1;');
   openwindow.document.writeln('  zoom = fhwindow(zoom);');
   openwindow.document.writeln(' }');
   openwindow.document.writeln(' else');
   openwindow.document.writeln(' {');
   openwindow.document.writeln('  size = zoom;');
   openwindow.document.writeln('  zoom = fhwindow(zoom);');
   openwindow.document.writeln(' }');
   openwindow.document.writeln(' document.images[0].style.width = zoom * 99 + "%";');
   openwindow.document.writeln(' document.images[0].style.height = "auto";');
   openwindow.document.writeln('}');

   openwindow.document.writeln('function fhwindow(zoom)');
   openwindow.document.writeln('{');
   openwindow.document.writeln(' if (zoom < 1) zoom = 1;');
   openwindow.document.writeln(' size = zoom;');
   openwindow.document.writeln(' var window_top = 150;');
   openwindow.document.writeln(' var window_side = 1;');
   openwindow.document.writeln(' var window_height = image_height * zoom + window_top;');
   openwindow.document.writeln(' var window_width = image_width * zoom + window_side;');
   openwindow.document.writeln(' if (window_height > maximum_height)');
   openwindow.document.writeln(' {');
   openwindow.document.writeln('  window_height = maximum_height;');
   openwindow.document.writeln('  window_width = (window_height - window_top) * image_width / image_height + window_side;');
   openwindow.document.writeln(' }');
   openwindow.document.writeln(' else if (window_width > maximum_width)');
   openwindow.document.writeln(' {');
   openwindow.document.writeln('  window_width = maximum_width;');
   openwindow.document.writeln('  window_height = (window_width - window_side) * image_height / image_width + window_top;');
   openwindow.document.writeln(' }');
   openwindow.document.writeln(' var window_minimum = 320;');
   openwindow.document.writeln(' var window_margin = 50;');
   openwindow.document.writeln(' if (window_height < window_minimum)');
   openwindow.document.writeln(' {');
   openwindow.document.writeln('  window_height = window_minimum;');
   openwindow.document.writeln('  window_width = (window_height - window_top) * image_width / image_height + window_side;');
   openwindow.document.writeln('  size = (window_width - window_margin) / image_width;');
   openwindow.document.writeln('  zoom = 1;');
   openwindow.document.writeln(' }');
   openwindow.document.writeln(' if (window_width < window_minimum)');
   openwindow.document.writeln(' {');
   openwindow.document.writeln('  window_width = window_minimum;');
   openwindow.document.writeln('  window_height = (window_width - window_side) * image_height / image_width + window_top;');
   openwindow.document.writeln('  size = (window_width - window_margin) / image_width;');
   openwindow.document.writeln('  zoom = 1;');
   openwindow.document.writeln(' }');
   openwindow.document.writeln(' window.resizeTo(window_width,window_height);');
   openwindow.document.writeln(' return zoom;');
   openwindow.document.writeln('}');

   openwindow.document.writeln('function fhsmaller()');
   openwindow.document.writeln('{');
   openwindow.document.writeln(' size = size * 3 / 4;');
   openwindow.document.writeln(' if (size < 1) size = 1;');
   openwindow.document.writeln(' fhresize(size);');
   openwindow.document.writeln('}');

   openwindow.document.writeln('function fhbigger()');
   openwindow.document.writeln('{');
   openwindow.document.writeln(' size = size * 4 / 3;');
   openwindow.document.writeln(' fhresize(size);');
   openwindow.document.writeln('}');

   openwindow.document.writeln('function fhclientheight()');
   openwindow.document.writeln('{');
   openwindow.document.writeln(' return fhfilterresults(');
   openwindow.document.writeln('  window.innerHeight ? window.innerHeight : 0,');
   openwindow.document.writeln('  document.documentElement ? document.documentElement.clientHeight : 0,');
   openwindow.document.writeln('  document.body ? document.body.clientHeight : 0');
   openwindow.document.writeln(' );');
   openwindow.document.writeln('}');

   openwindow.document.writeln('function fhclientwidth()');
   openwindow.document.writeln('{');
   openwindow.document.writeln(' return fhfilterresults(');
   openwindow.document.writeln('  window.innerWidth ? window.innerWidth : 0,');
   openwindow.document.writeln('  document.documentElement ? document.documentElement.clientWidth : 0,');
   openwindow.document.writeln('  document.body ? document.body.clientWidth : 0');
   openwindow.document.writeln(' );');
   openwindow.document.writeln('}');

   openwindow.document.writeln('function fhfilterresults(n_win, n_docel, n_body)');
   openwindow.document.writeln('{');
   openwindow.document.writeln(' var n_result = n_win ? n_win : 0;');
   openwindow.document.writeln(' if (n_docel && (!n_result || (n_result > n_docel)))');
   openwindow.document.writeln('  n_result = n_docel;');
   openwindow.document.writeln(' return n_body && (!n_result || (n_result > n_body)) ? n_body : n_result;');
   openwindow.document.writeln('}');

   openwindow.document.writeln('//]]>');
   openwindow.document.writeln('  </script>');
   openwindow.document.writeln(' </head>');
   openwindow.document.writeln(' <body onload="fhresize(-9)">');
   openwindow.document.writeln(' <form style="position:fixed; top:2px; left:2px; z-index:1;" action="javascript:void(0)">');
   openwindow.document.writeln('  <input type="button" value="Reset" onclick="fhresize(0)" />');
   openwindow.document.writeln('  <input type="button" value="Smaller" onclick="fhsmaller()" />');
   openwindow.document.writeln('  <input type="button" value="Bigger" onclick="fhbigger()" />');
   openwindow.document.writeln('  <input type="button" value="Close" onclick="javascript:self.close()" />');
   openwindow.document.writeln(' </form>');
   openwindow.document.writeln(' <div style="position:absolute; margin: 0px 2px; z-index:0; text-align:center;">');
   openwindow.document.writeln('  <p style="font-size:80%;">&nbsp;</p>');
   openwindow.document.writeln('  <p><img src="'+filename+'" title="'+caption+'" alt="'+caption+'" /></p>');
   openwindow.document.writeln('  <p><b>'+caption+'</b></p>');
   openwindow.document.writeln(' </div>');
   openwindow.document.writeln(' </body>');
   openwindow.document.writeln('</html>');
   openwindow.document.close();
   openwindow.focus();

   function fhclientheight()
   {
    return fhfilterresults(
     window.innerHeight ? window.innerHeight : 0,
     document.documentElement ? document.documentElement.clientHeight : 0,
     document.body ? document.body.clientHeight : 0
    );
   }

   function fhclientwidth()
   {
    return fhfilterresults(
     window.innerWidth ? window.innerWidth : 0,
     document.documentElement ? document.documentElement.clientWidth : 0,
     document.body ? document.body.clientWidth : 0
    );
   }

   function fhfilterresults(n_win, n_docel, n_body)
   {
    var n_result = n_win ? n_win : 0;
    if (n_docel && (!n_result || (n_result > n_docel)))
     n_result = n_docel;
    return n_body && (!n_result || (n_result > n_body)) ? n_body : n_result;
   }
  }
]=]

Str_fhpopup_screen = [=[
	/*
	 * Family Historian JavaScript Fullscreen Image Popup Function
	 * fhpopup(id) takes an anchor tag id and creates the HTML script to render in the popup window
	 * fhresize() adjusts the width and height of the image to nearly fill the window depending on their aspect ratios
	 */
	function fhpopup(id)
	{
	 var filename = document.getElementById(id).getAttribute("href");
	 var caption = document.getElementById(id).getAttribute("title");
	 openwindow=window.open('','popup','channelmode=no,fullscreen=no,toolbar=no,location=no,directories=no,status=no,menubar=no,scrollbars=yes,resizable=yes');
	 openwindow.document.writeln('<html><head><title>popup</title>');
	 openwindow.document.writeln('<link type="text/css" rel="stylesheet" href="fhstyle.css">');
	 openwindow.document.writeln('<script type="text/javascript">');
	 openwindow.document.writeln('function fhresize()');
	 openwindow.document.writeln('{');
	 openwindow.document.writeln(' var window_height = document.body.clientHeight;');
	 openwindow.document.writeln(' var window_width = document.body.clientWidth;');
	 openwindow.document.writeln(' var image_height = document.images[0].height;');
	 openwindow.document.writeln(' var image_width = document.images[0].width;');
	 openwindow.document.writeln(' var height_ratio = image_height / window_height;');
	 openwindow.document.writeln(' var width_ratio = image_width / window_width;');
	 openwindow.document.writeln(' if (height_ratio > width_ratio)');
	 openwindow.document.writeln(' {');
	 openwindow.document.writeln('  document.images[0].style.height = "90%";');
	 openwindow.document.writeln('  document.images[0].style.width = "auto";');
	 openwindow.document.writeln(' }');
	 openwindow.document.writeln(' else');
	 openwindow.document.writeln(' {');
	 openwindow.document.writeln('  document.images[0].style.height = "auto";');
	 openwindow.document.writeln('  document.images[0].style.width = "95%";');
	 openwindow.document.writeln(' }');
	 openwindow.document.writeln('}');
	 openwindow.document.writeln('</script>');
	 openwindow.document.writeln('</head><body><center>');
	 openwindow.document.writeln('<form action="javascript:void(0)">');
	 openwindow.document.writeln('<input type="button" value="Close Popup Window" onclick="javascript:self.close()">');
	 openwindow.document.writeln('</form>');
	 openwindow.document.writeln('<p><img src="'+filename+'" title="'+caption+'" alt="'+caption+'" onload="fhresize()" border="1"></p>');
	 openwindow.document.writeln('<p><b>'+caption+'</b></p>');
	 openwindow.document.writeln('</center></body></html>');
	 openwindow.document.close();
	 openwindow.focus();
	}
]=]

	TblUTF = { }										-- Table of Code Page 1252 to UTF-8 multi-byte encodings as defined at http://en.wikipedia.org/wiki/UTF-8
	TblUTF[""] = string.char(0xE2,0x82,0xAC)
	TblUTF[string.char(0x81)]= ""
	TblUTF[""] = string.char(0xE2,0x80,0x9A)
	TblUTF[""] = string.char(0xC6,0x92)
	TblUTF[""] = string.char(0xE2,0x80,0x9E)
	TblUTF[""] = string.char(0xE2,0x80,0xA6)
	TblUTF[""] = string.char(0xE2,0x80,0xA0)
	TblUTF[""] = string.char(0xE2,0x80,0xA1)
	TblUTF[""] = string.char(0xCB,0x86)
	TblUTF[""] = string.char(0xE2,0x80,0xB0)
	TblUTF[""] = string.char(0xC5,0xA0)
	TblUTF[""] = string.char(0xE2,0x80,0xB9)
	TblUTF[""] = string.char(0xC5,0x92)
	TblUTF[string.char(0x8D)]= ""
	TblUTF[""] = string.char(0xC5,0xBD)
	TblUTF[string.char(0x8F)]= ""
	TblUTF[string.char(0x90)]= ""
	TblUTF[""] = string.char(0xE2,0x80,0x98)
	TblUTF[""] = string.char(0xE2,0x80,0x99)
	TblUTF[""] = string.char(0xE2,0x80,0x9C)
	TblUTF[""] = string.char(0xE2,0x80,0x9D)
	TblUTF[""] = string.char(0xE2,0x80,0xA2)
	TblUTF[""] = string.char(0xE2,0x80,0x93)
	TblUTF[""] = string.char(0xE2,0x80,0x94)
	TblUTF[""] = string.char(0xCB,0x9C)
	TblUTF[""] = string.char(0xE2,0x84,0xA2)
	TblUTF[""] = string.char(0xC5,0xA1)
	TblUTF[""] = string.char(0xE2,0x80,0xBA)
	TblUTF[""] = string.char(0xC5,0x93)
	TblUTF[string.char(0x9D)]= ""
	TblUTF[""] = string.char(0xC5,0xBE)
	TblUTF[""] = string.char(0xC5,0xB8)
	TblUTF[string.char(0xA0)]= string.char(0xC2,0xA0)		-- No Break Space
	TblUTF[""] = string.char(0xC2,0xA1)
	TblUTF[""] = string.char(0xC2,0xA2)
	TblUTF[""] = string.char(0xC2,0xA3)
	TblUTF[""] = string.char(0xC2,0xA4)
	TblUTF[""] = string.char(0xC2,0xA5)
	TblUTF[""] = string.char(0xC2,0xA6)
	TblUTF[""] = string.char(0xC2,0xA7)
	TblUTF[""] = string.char(0xC2,0xA8)
	TblUTF[""] = string.char(0xC2,0xA9)
	TblUTF[""] = string.char(0xC2,0xAA)
	TblUTF[""] = string.char(0xC2,0xAB)
	TblUTF[""] = string.char(0xC2,0xAC)
	TblUTF[""] = string.char(0xC2,0xAD)
	TblUTF[""] = string.char(0xC2,0xAE)
	TblUTF[""] = string.char(0xC2,0xAF)
	TblUTF[""] = string.char(0xC2,0xB0)
	TblUTF[""] = string.char(0xC2,0xB1)
	TblUTF[""] = string.char(0xC2,0xB2)
	TblUTF[""] = string.char(0xC2,0xB3)
	TblUTF[""] = string.char(0xC2,0xB4)
	TblUTF[""] = string.char(0xC2,0xB5)
	TblUTF[""] = string.char(0xC2,0xB6)
	TblUTF[""] = string.char(0xC2,0xB7)
	TblUTF[""] = string.char(0xC2,0xB8)
	TblUTF[""] = string.char(0xC2,0xB9)
	TblUTF[""] = string.char(0xC2,0xBA)
	TblUTF[""] = string.char(0xC2,0xBB)
	TblUTF[""] = string.char(0xC2,0xBC)
	TblUTF[""] = string.char(0xC2,0xBD)
	TblUTF[""] = string.char(0xC2,0xBE)
	TblUTF[""] = string.char(0xC2,0xBF)
	TblUTF[""] = string.char(0xC3,0x80)
	TblUTF[""] = string.char(0xC3,0x81)
	TblUTF[""] = string.char(0xC3,0x82)
	TblUTF[""] = string.char(0xC3,0x83)
	TblUTF[""] = string.char(0xC3,0x84)
	TblUTF[""] = string.char(0xC3,0x85)
	TblUTF[""] = string.char(0xC3,0x86)
	TblUTF[""] = string.char(0xC3,0x87)
	TblUTF[""] = string.char(0xC3,0x88)
	TblUTF[""] = string.char(0xC3,0x89)
	TblUTF[""] = string.char(0xC3,0x8A)
	TblUTF[""] = string.char(0xC3,0x8B)
	TblUTF[""] = string.char(0xC3,0x8C)
	TblUTF[""] = string.char(0xC3,0x8D)
	TblUTF[""] = string.char(0xC3,0x8E)
	TblUTF[""] = string.char(0xC3,0x8F)
	TblUTF[""] = string.char(0xC3,0x90)
	TblUTF[""] = string.char(0xC3,0x91)
	TblUTF[""] = string.char(0xC3,0x92)
	TblUTF[""] = string.char(0xC3,0x93)
	TblUTF[""] = string.char(0xC3,0x94)
	TblUTF[""] = string.char(0xC3,0x95)
	TblUTF[""] = string.char(0xC3,0x96)
	TblUTF[""] = string.char(0xC3,0x97)
	TblUTF[""] = string.char(0xC3,0x98)
	TblUTF[""] = string.char(0xC3,0x99)
	TblUTF[""] = string.char(0xC3,0x9A)
	TblUTF[""] = string.char(0xC3,0x9B)
	TblUTF[""] = string.char(0xC3,0x9C)
	TblUTF[""] = string.char(0xC3,0x9D)
	TblUTF[""] = string.char(0xC3,0x9E)
	TblUTF[""] = string.char(0xC3,0x9F)
	TblUTF[""] = string.char(0xC3,0xA0)
	TblUTF[""] = string.char(0xC3,0xA1)
	TblUTF[""] = string.char(0xC3,0xA2)
	TblUTF[""] = string.char(0xC3,0xA3)
	TblUTF[""] = string.char(0xC3,0xA4)
	TblUTF[""] = string.char(0xC3,0xA5)
	TblUTF[""] = string.char(0xC3,0xA6)
	TblUTF[""] = string.char(0xC3,0xA7)
	TblUTF[""] = string.char(0xC3,0xA8)
	TblUTF[""] = string.char(0xC3,0xA9)
	TblUTF[""] = string.char(0xC3,0xAA)
	TblUTF[""] = string.char(0xC3,0xAB)
	TblUTF[""] = string.char(0xC3,0xAC)
	TblUTF[""] = string.char(0xC3,0xAD)
	TblUTF[""] = string.char(0xC3,0xAE)
	TblUTF[""] = string.char(0xC3,0xAF)
	TblUTF[""] = string.char(0xC3,0xB0)
	TblUTF[""] = string.char(0xC3,0xB1)
	TblUTF[""] = string.char(0xC3,0xB2)
	TblUTF[""] = string.char(0xC3,0xB3)
	TblUTF[""] = string.char(0xC3,0xB4)
	TblUTF[""] = string.char(0xC3,0xB5)
	TblUTF[""] = string.char(0xC3,0xB6)
	TblUTF[""] = string.char(0xC3,0xB7)
	TblUTF[""] = string.char(0xC3,0xB8)
	TblUTF[""] = string.char(0xC3,0xB9)
	TblUTF[""] = string.char(0xC3,0xBA)
	TblUTF[""] = string.char(0xC3,0xBB)
	TblUTF[""] = string.char(0xC3,0xBC)
	TblUTF[""] = string.char(0xC3,0xBD)
	TblUTF[""] = string.char(0xC3,0xBE)
	TblUTF[""] = string.char(0xC3,0xBF)

-- Global Data Constants Definition --
function PresetGlobalConstants()

	-- GUI Global Constants

	StrRed				= "255 0 0"							-- Color attributes (must exclude leading zeros & spaces to allow value comparisons)
	StrAmber			= "250 160 0"
	StrGreen			= "0 120 0"
	StrBlue			= "0 0 255"
	StrGray			= "120 120 120"
	StrBlack			= "0 0 0"
	StrWhite			= "255 255 255"
	StrGap 			= "2"									-- Gap & Margin attributes
	StrMinMargin		= "1x1"
	StrBigMargin		= "8x8"
	StrFontSetTitle	= "Set Interface Font"
	IntFontPlain		= 1										-- Font Face & Style values for IntFontSet
	IntFontBold		= 2
	IntArialPlain	= 3
	IntArialBold		= 4
	IntTahomaPlain	= 5
	IntTahomaBold	= 6
	StrFontFace		= iup.GetGlobal("DEFAULTFONT"):gsub(",.*","")

	-- Filename Global Constants

	StrComputerName = os.getenv("COMPUTERNAME")

	StrStickyFile = fhGetPluginDataFileName()
	-- Allow plugins with variant filenames to use same plugin data files
	StrStickyFile = StrStickyFile:gsub("\\"..StrPlugin..".+%.[D,d][A,a][T,t]$","\\"..StrPlugin..".dat")
	if StrStickyFile == "" then
		-- Use standalone GEDCOM path & filename..".fh_data\Plugin Data\" as the folder + the Plugin Filename..".dat"
		StrStickyFile = fhGetContextInfo("CI_GEDCOM_FILE")
		StrStickyFile = StrStickyFile:gsub("%.[G,g][E,e][D,d]",".fh_data")
		lfs.mkdir(StrStickyFile)
		StrStickyFile = StrStickyFile.."\\Plugin Data"
		lfs.mkdir(StrStickyFile)
		StrStickyFile = StrStickyFile.."\\"..StrPlugin..".dat"
	end

	-- Plugin data folder path name
	StrPluginPath = StrStickyFile:gsub("\\"..StrPlugin.."%.[D,d][A,a][T,t]$","")

	-- Plugin data file root name
	local strPluginRoot = StrPluginPath.."\\"..StrPlugin

	-- Public data folder path name
	StrPublicPath = fhGetContextInfo("CI_PROJECT_PUBLIC_FOLDER")
	if StrPublicPath == "" then StrPublicPath = StrPluginPath end

end -- function PresetGlobalConstants

-- Split a string using separator --
function string.split(str,sep)
	local sep = sep or ","
	local fields = {}
	local pattern = string.format("([^%s]+)", sep)
	str:gsub(pattern, function(c) fields[#fields+1] = c end)
	return fields
end -- function string.split

-- Split a string into numbers using separators space or comma or x --
function string.SplitNumbers(self)
	local tblNum = {}
	self:gsub("([^%s,x]+)", function(c) tblNum[#tblNum+1] = c end)
	for i=1, #tblNum do
		tblNum[i] = tonumber(tblNum[i])
	end
	return tblNum
end -- function string.SplitNumbers

-- Hide magic pattern symbols	^ $ ( ) % . [ ] * + - ?
function string.plain(strText)
	-- Prefix every non-alphanumeric character (%W) with a % escape character,
	-- where %% is the % escape, and %1 is the original character capture.
	strText = (strText or ""):gsub("(%W)","%%%1")
	return strText
end -- function string.plain

-- string.matches is plain text version of string.match()
function string.matches(strText,strFind,intInit)
	strFind = (strFind or ""):gsub("(%W)","%%%1")						-- Hide magic pattern symbols
	return strText:match(strFind,intInit)
end -- function string.matches

-- string.replace is plain text version of string.gsub()
function string.replace(strTxt,strOld,strNew,intNum)
	strOld = (strOld or ""):gsub("(%W)","%%%1")							-- Hide magic pattern symbols
	return strTxt:gsub(strOld,function() return strNew end,intNum)	-- Hide % capture symbols
end -- function string.replace

-- string.convert is pattern without captures version of string.gsub()
function string.convert(strTxt,strOld,strNew,intNum)
	strNew = strNew:gsub("%%","%%%%")										-- Hide % capture symbols
	return strTxt:gsub(strOld,strNew,intNum)
end -- function string.convert

-- Check if file exists --
function FlgFileExists(strFileName)
	if lfs.attributes(strFileName,"mode") == "file" then
		return true
	else
		return false
	end
end -- function FlgFileExists

-- Check if folder exists --
function FlgFolderExists(strFolderName)
	if lfs.attributes(strFolderName:gsub("\\$",""),"mode") == "directory" then
		return true
	else
		return false
	end
end -- function FlgFolderExists

-- Open File and return Handle --
function OpenFile(strFileName,strMode)
	local fileHandle, strError = io.open(strFileName,strMode)
	if fileHandle == nil then
		error("\n Unable to open file in \""..strMode.."\" mode. \n "..strFileName.." \n "..strError.." \n")
	end
	return fileHandle
end -- function OpenFile

-- Save string to file --
function SaveStringToFile(strString,strFileName)
	local fileHandle = OpenFile(strFileName,"w")
	fileHandle:write(strString)
	assert(fileHandle:close())
end -- function SaveStringToFile

-- Delete file if it exists --
function DeleteFile(strFileName)
	if FlgFileExists(strFileName) then
		local fileHandle, strError = os.remove(strFileName)
		if fileHandle == nil then
			local intRepeat = 1
			repeat
				if intRepeat > 1 and ShowStatusMessage then ShowStatusMessage(StrRed,strError:gsub(strFileName:match("(.+\\).+"),"Del#"..tostring(intRepeat)..":")) end
				fhSleep(300,100)
				if FlgFileExists(strFileName) then
					fileHandle, strError = os.remove(strFileName)
				end
				intRepeat = intRepeat + 1
			until fileHandle ~= nil or intRepeat > 10
			if intRepeat > 10 and not ShowStatusMessage then error(strError:gsub(strFileName:match("(.+\\).+"),"Del#"..tostring(intRepeat)..":")) end
		end
	end
end -- function DeleteFile

-- Encode HTML symbols into &***; escape sequences --
function StrHTML_Encode(strHTML)
	-- "\n" newline is encoded as "<br>" tag [which must be unencoded from "&lt;br&gt;" to "<br>"]
	local tblEncodings = {
		{"%c"," "},	{"&","&amp;"},	{"<","&lt;"},	{">","&gt;"},	{"\'","&apos;"},	{"\"","&quot;"},	{"\n","<br>"},
	}
	if strHTML then
		for i, tblEncode in ipairs(tblEncodings) do
local x = tblEncode[1]
			strHTML = strHTML:gsub(tblEncode[1],tblEncode[2])
		end
	else
		strHTML = ""
	end
	return strHTML
end -- function StrHTML_Encode

-- Translate Code Page 1252 to UTF-8 multi-byte encoding --
function StrCP1252_UTF8(strText)
	if strText:match("[-]") then								-- If line contains CP1252 characters that need translating then
		local strTran = ""
		local strChar = ""
		for i=1, strText:len() do									-- Step through each character in line
			strChar = strText:sub(i,i)
			strChar = TblUTF[strChar] or strChar				-- Perform character translation to UTF-8 bytes
			strTran = strTran..strChar
		end
		strText = strTran
	end
	return strText
end -- function StrCP1252_UTF8

-- Obtain Version in Plugin Store by Id or Name --
function StrVersionInStore(strPlugin)
	local strType = "name="
	if tonumber(strPlugin) then strType = "id=" end
	if strPlugin then
		local http = luacom.CreateObject("winhttp.winhttprequest.5.1")
		local strRequest ="http://www.family-historian.co.uk/lnk/checkpluginversion.php?"..strType..strPlugin
 		http:Open("GET",strRequest,false)
		http:Send()
		local strReturn = http.Responsebody
		local strVersion = "0"
		if strReturn ~= nil then
			strVersion = strReturn:match("(%d.*),%d*")
		end
		return strVersion or "0"
	else
		return "0"
	end
end -- function StrVersionInStore

-- Check if New Version Available --
function CheckVersionInStore(strOldVer)
	local strPlugin = fhGetContextInfo("CI_PLUGIN_NAME")
	local strNewVer = StrVersionInStore(strPlugin:gsub(" %- .*",""))
	if strNewVer > strOldVer:match("[^%d]*([%d%.]*)") then
		iup.Alarm(strPlugin..strOldVer,"Later Version "..strNewVer.." of this Plugin is available from the Family Historian 'Plugin Store'.","OK")
	end
end -- function CheckVersionInStore

-- Flag if GUI Window is Normal rather than Minimised or Maximised --
function IsNormalWindow(dialogGUI)
	-- tblScrn[1] = origin x, tblScrn[2] = origin y, tblScrn[3] = width, tblScrn[4] = height
	local tblPosn = dialogGUI.screenposition:SplitNumbers()
	local intPosX = tblPosn[1]
	local intPosY = tblPosn[2]
	if intPosX < 0 and intPosY < 0 then						-- If origin is negative (-8, -8 = Maximised, -3200, -3200 = Minimised)
		return false												-- then is Maximised or Minimised
	end
	return true
end -- function IsNormalWindow

-- GUI Font Face & Style Dialogue --
function GUI_FontDialogue(intFontSet)

	-- Note: Pixel sizes -21 = -20 & -17 = -16 & -14 = -13 and pixel sizes -22, -18 & -13 have no point size equivalent.
	local tblFontSet = {}			-- Lookup table for StrFontHead and StrFontBody font sets
	tblFontSet[IntFontPlain]		=	{ Head=StrFontFace..", Bold -16",	Body=StrFontFace..",      -16", }
	tblFontSet[IntFontBold]		=	{ Head=StrFontFace..", Bold -16",	Body=StrFontFace..", Bold -15", }
	tblFontSet[IntArialPlain]		=	{ Head="Arial,         Bold -16",	Body="Arial,              -16", }
	tblFontSet[IntArialBold]		=	{ Head="Arial,         Bold -16",	Body="Arial,         Bold -15", }
	tblFontSet[IntTahomaPlain]	=	{ Head="Tahoma,        Bold -15",	Body="Tahoma,             -16", }
	tblFontSet[IntTahomaBold]		=	{ Head="Tahoma,        Bold -15",	Body="Tahoma,        Bold -14", }

	-- Assign font set global variables
	local function doAssignFontSet(intFontSet)
		IntFontSet = intFontSet
		StrFontHead = tblFontSet[intFontSet]["Head"] -- Font for all GUI dialog header text
		StrFontBody = tblFontSet[intFontSet]["Body"] -- Font for all GUI dialog body text
	end -- local function doAssignFontSet

	-- If parameter exists, simply set it as current font set
	if intFontSet then doAssignFontSet(intFontSet) return end

	local strAnswer = "Change"

	local strFontPlainTitle	= StrFontFace.." Plain"
	local strFontBoldTitle		= StrFontFace.." Bold"
	local strArialPlainTitle	= "Arial Plain"
	local strArialBoldTitle	= "Arial Bold"
	local strTahomaPlainTitle	= "Tahoma Plain"
	local strTahomaBoldTitle	= "Tahoma Bold"

	-- Create each GUI label and button with title and tooltip
	local	lblHeadName		= iup.label	{ title=" Name :"				, tip="Names of the available Fonts"				, }
	local	lblHeadPlain		= iup.label	{ title=" Plain :"				, tip="Plain versions of the Fonts"					, }
	local	lblHeadBold		= iup.label	{ title=" Bold :"				, tip="Bold versions of the Fonts"					, }
	local	lblFontName		= iup.label	{ title="Font "..StrFontFace	, tip="Default Windows fontface"					, }
	local	btnFontPlain		= iup.button	{ title=strFontPlainTitle		, tip="Choose "..strFontPlainTitle.." style"		, }
	local	btnFontBold		= iup.button	{ title=strFontBoldTitle		, tip="Choose "..strFontBoldTitle.." style"		, }
	local	lblArialName		= iup.label	{ title="Font Arial"			, tip="Arial alternative fontface"					, }
	local	btnArialPlain	= iup.button	{ title=strArialPlainTitle	, tip="Choose "..strArialPlainTitle.." style"	, }
	local	btnArialBold		= iup.button	{ title=strArialBoldTitle		, tip="Choose "..strArialBoldTitle.." style"		, }
	local	lblTahomaName	= iup.label	{ title="Font Tahoma"			, tip="Tahoma alternative fontface"					, }
	local	btnTahomaPlain	= iup.button	{ title=strTahomaPlainTitle	, tip="Choose "..strTahomaPlainTitle.." style"	, }
	local	btnTahomaBold	= iup.button	{ title=strTahomaBoldTitle	, tip="Choose "..strTahomaBoldTitle.." style"	, }
	local	lblChoose			= iup.label	{ title="Choose your interface font style or"										, }
	local	btnClose			= iup.button	{ title="Close"					, tip="Close this Font Style window"				, }

	-- Create dialogue and turn off resize, maximize, minimize, and menubox except Close button
	local	dialogFont		= iup.dialog { title=(StrPlugin or "").." Font Style", dialogframe="YES", background=StrWhite, startfocus=btnClose,
										iup.vbox { alignment="ACENTER", gap=StrGap, margin=StrBigMargin,
											iup.frame { font=StrFontHead, fgcolor=StrBlack, active="YES", title="Font Style",
												iup.vbox { margin=StrMinMargin,
													iup.hbox { homogeneous="YES", lblHeadName,	lblHeadPlain,	lblHeadBold,		},
													iup.hbox { homogeneous="YES", lblFontName,	btnFontPlain,	btnFontBold,		},
													iup.hbox { homogeneous="YES", lblArialName,	btnArialPlain,	btnArialBold,	},
													iup.hbox { homogeneous="YES", lblTahomaName,	btnTahomaPlain,	btnTahomaBold,	},
													iup.hbox { lblChoose, btnClose, },
												},
											},
										},
										move_cb	= function(self,x,y) IntDataX=x IntDataY=y end,
										close_cb	= function() strAnswer="Ignore" return iup.CLOSE end,
									}

	-- Assign font styles for GUI labels and buttons
	local strFontPlain		= tblFontSet	[IntFontPlain]	["Body"]
	local strFontBold		= tblFontSet	[IntFontBold]	["Body"]
	local strArialPlain		= tblFontSet	[IntArialPlain]	["Body"]
	local strArialBold		= tblFontSet	[IntArialBold]	["Body"]
	local strTahomaPlain	= tblFontSet	[IntTahomaPlain]["Body"]
	local strTahomaBold		= tblFontSet	[IntTahomaBold]	["Body"]

	-- Set other GUI attributes for labels and buttons
	for iupName, tblAttr in pairs( {
		--	Control		=	1~fgcolor	, 2~font			, 3~FontSet		, 4~action function()
		[lblHeadName]	= { StrBlack	, StrFontBody	, false			, false	},
		[lblHeadPlain]	= { StrBlack	, strFontPlain	, false			, false	},
		[lblHeadBold]	= { StrBlack	, strFontBold	, false			, false	},
		[lblFontName]	= { StrBlack	, strFontPlain	, false			, false	},
		[btnFontPlain]	= { StrGreen	, strFontPlain	, IntFontPlain	, false	},
		[btnFontBold]	= { StrGreen	, strFontBold	, IntFontBold	, false	},
		[lblArialName]	= { StrBlack	, strArialPlain	, false			, false	},
		[btnArialPlain]	= { StrGreen	, strArialPlain	, IntArialPlain	, false	},
		[btnArialBold]	= { StrGreen	, strArialBold	, IntArialBold	, false	},
		[lblTahomaName]	= { StrBlack	, strTahomaPlain, false			, false	},
		[btnTahomaPlain]= { StrGreen	, strTahomaPlain, IntTahomaPlain, false	},
		[btnTahomaBold]	= { StrGreen	, strTahomaBold	, IntTahomaBold	, false	},
		[lblChoose]		= { StrBlack	, StrFontBody	, false			, false	},
		[btnClose]		= { StrRed	, StrFontBody	, false			, dialogFont.close_cb },
		} ) do
		iupName.expand	= "YES"
		iupName.fgcolor	= tblAttr[1]
		iupName.font		= tblAttr[2]
		if tblAttr[3] then
			if tblAttr[3] == IntFontSet then iupName.active = "NO" end	-- Disable button for currently selected font
			iupName.action = function() doAssignFontSet(tblAttr[3]) return iup.CLOSE end
		end
		if tblAttr[4] then iupName.action = tblAttr[4] end
	end

	if iup.MainLoopLevel() == 0 then	-- called from outside Main GUI, so must use showxy() instead of popup()
		dialogFont:showxy(IntDataX,IntDataY)
	else
		dialogFont:popup(IntDataX,IntDataY)
	end

	if (iup.MainLoopLevel()==0) then iup.MainLoop() end

	return strAnswer
end -- function GUI_FontDialogue

-- Progress Bar Function Prototype --
function NewProgressBar(tblGauge)

	local tblGauge	= tblGauge or {}							-- Optional table of external parameters
	local strFont	= tblGauge.Font	or nil						-- Font dialogue default is current font
	local strButton	= tblGauge.Button	or "255 0 0"			-- Button colour default is red
	local strBehind	= tblGauge.Behind	or "255 255 255"	-- Background colour default is white
	local intShowX	= tblGauge.ShowX	or iup.CENTER		-- Show window default position is central
	local intShowY	= tblGauge.ShowY	or iup.CENTER
	local intMax, intVal, intPercent, intStart, intDelta, intScale, strClock, isBarStop
	local lblText, barGauge, lblDelta, btnStop, dlgGauge

	local function doFocus()										-- Bring the Progress Bar window into Focus
		dlgGauge.bringfront="YES"									-- If used too often, inhibits other windows scroll bars, etc
	end -- local function doFocus

	local function doUpdate()										-- Update the Progress Gauge and the Delta % with clock
		barGauge.value = intVal
		lblDelta.title = string.format("%4d %%      %s ",intPercent,strClock)
	end -- local function doUpdate

	local function doReset()										-- Reset all dialogue variables and Update display
		intVal		= 0													-- Current value of Progress Bar
		intPercent= 0.01											-- Percentage of progress
		intStart	= os.time()										-- Start time of progress
		intDelta	= 0													-- Delta time of progress
		intScale	= math.ceil( intMax / 1000 )					-- Scale of percentage per second of progress (initial guess is corrected in Step function)
		strClock	= "00 : 00 : 00"								-- Clock delta time display
		isBarStop	= false											-- Stop button pressed signal
		doUpdate()
		doFocus()
	end -- local function doReset

	local tblProgressBar = {

		Start = function(strTitle,intMaximum)					-- Create & start Progress Bar window
			if not dlgGauge then
				strTitle	= strTitle or ""						-- Dialogue and button title
				intMax		= intMaximum or 100						-- Maximun range of Progress Bar, default is 100
				local strSize = tostring( math.max( 100, string.len(" Stop "..strTitle) * 8 ) ).."x30"			-- Adjust Stop button size to Title
				lblText	= iup.label	{ title=" ", expand="YES", alignment="ACENTER", tip="Progress Message" }
				barGauge	= iup.progressbar { rastersize="400x30", value=0, max=intMax, tip="Progress Bar" }
				lblDelta	= iup.label	{ title=" ", expand="YES", alignment="ACENTER", tip="Percentage and Elapsed Time" }
				btnStop	= iup.button	{ title=" Stop "..strTitle, rastersize=strSize, fgcolor=strButton, tip="Stop Progress Button", action=function() isBarStop = true end }	-- Signal Stop button pressed	return iup.CLOSE -- Often caused main GUI to close !!!
				dlgGauge	= iup.dialog	{ title=strTitle.." Progress ", font=strFont, dialogframe="YES", background=strBehind,	-- Remove Windows minimize/maximize menu
									iup.vbox{ alignment="ACENTER", gap="10", margin="10x10",
										lblText,
										barGauge,
										lblDelta,
										btnStop,
									},
									move_cb	= function(self,x,y) tblGauge.ShowX = x tblGauge.ShowY = y end,
									close_cb	= btnStop.action,	-- Windows Close button = Stop button
								}
				dlgGauge:showxy(intShowX,intShowY)				-- Show the Progress Bar window
				doReset()												-- Reset the Progress Bar display
			end
		end,

		Message = function(strText)								-- Show the Progress Bar message
			if dlgGauge then lblText.title = strText end
		end,

		Step = function(intStep)									-- Step the Progress Bar forward
			if dlgGauge then
				intVal = intVal + ( intStep or 1 )				-- Default step is 1
				local intNew = math.ceil( intVal / intMax * 100 * intScale ) / intScale
				if intPercent ~= intNew then						-- Update progress once per percent or per second, whichever is smaller
					intPercent = math.max( 0.1, intNew )		-- Ensure percentage is greater than zero
					if intVal > intMax then intVal = intMax intPercent = 100 end		-- Ensure values do not exceed maximum
					intNew = os.difftime(os.time(),intStart)
					if intDelta < intNew then						-- Update clock of elapsed time
						intDelta = intNew
						intScale = math.ceil( intDelta / intPercent )	-- Scale of seconds per percentage step
						local intHour = math.floor( intDelta / 3600 )
						local intMins = math.floor( intDelta / 60 - intHour * 60 )
						local intSecs = intDelta - intMins * 60 - intHour * 3600
						strClock = string.format("%02d : %02d : %02d",intHour,intMins,intSecs)
					end
					doUpdate()										-- Update the Progress Bar display
				end
				iup.LoopStep()
			end
		end,

		Focus = function()
			if dlgGauge then doFocus() end						-- Bring the Progress Bar window to front
		end,

		Reset = function()											-- Reset the Progress Bar display
			if dlgGauge then doReset() end
		end,

		Stop = function()											-- Check if Stop button pressed
			iup.LoopStep()
			return isBarStop
		end,

		Close = function()											-- Close the Progress Bar window
			isBarStop = false
			if dlgGauge then dlgGauge:destroy() dlgGauge = nil end
		end,

	} -- end ProgressBar
	return tblProgressBar
end -- function NewProgressBar

-- My Progress Bar with Parameters
function MyProgressBar()
	tblGauge = {														-- Pass parameters into Progress Bar function prototype
		Font	= StrFontBody,
		Button	= StrRed,
		Behind	= StrWhite,
		ShowX	= IntDataX,
		ShowY	= IntDataY	}
	return NewProgressBar(tblGauge)
end -- function MyProgressBar

-- Reset Sticky Settings to Default Values --
function ResetDefaultSettings()
	IntMainX		= iup.CENTER			-- GUI Main window position X & Y co-ordinate and rastersize
	IntMainY		= iup.CENTER
	IntHelpX		= iup.CENTER			-- GUI Help window position X & Y co-ordinate and rastersize
	IntHelpY		= iup.CENTER
	StrHelpS		= "1030x730"
	IntDataX		= iup.CENTER			-- ProgressBar window position X & Y co-ordinate
	IntDataY		= iup.CENTER
--	StrFolder		= StrPublicPath		-- Folder for Website/CD-DVD HTML pages
	IntPages		=	1					-- Hyperlinks open in same Page
	IntChars		=	1					-- Hyperlinks never abbreviated
	IntPopup		=	1					-- Image Popups use default Lytebox v4.0
	StrToPs		= "OFF"				-- Table of Pictures disabled
	StrToRs		= "OFF"				-- Table of Reports disabled
	StrToDs		= "OFF"				-- Table of Downloads disabled
	StrMenu		= "OFF"				-- Links in Menu Bar disabled
	IntNames		=	1					-- Index of Names for Primary Names only
	IntStyle		=	1					-- Index of Names added names in italics
	IntIdent		=	1					-- Index of Names with no Identity data
	IntGenDex		=	4					-- GenDex excludes Individuals with Private/Living flags
	IntTabPosn	= nil					-- Initial tab position undefined
end -- function ResetDefaultSettings

-- Load Sticky Settings from File --
function LoadSettings(strFileName)

	local tblStickyData = {}

	-- Load Local Parameter for this PC --
	local function strLoadLocal(strParam,strDefault)
		return tblStickyData[StrComputerName.."-"..strParam] or strDefault
	end

	-- Load Global Parameter for all PC --
	local function strLoadGlobal(strParam,strDefault)
		return tblStickyData[strParam] or strDefault
	end

	-- Ensure Window Position is on Screen --
	local function intintCheckPosition(x,y)
		local tblScrn = iup.GetGlobal("VIRTUALSCREEN"):SplitNumbers()
		-- tblScrn[1] = origin x, tblScrn[2] = origin y, tblScrn[3] = width, tblScrn[4] = height
		if tonumber(x) == nil then
			x = iup.CENTER
		elseif tonumber(x) > tblScrn[3] then
			x = iup.CENTER
		end
		if tonumber(y) == nil then
			y = iup.CENTER
		elseif tonumber(y) > tblScrn[4] then
			y = iup.CENTER
		end
		return tonumber(x),tonumber(y)
	end -- local function intintCheckPosition

	if FlgFileExists(strFileName) then
		-- Load Settings File in table lines with key & val fields
		local tblField = {}
		for strLine in io.lines(strFileName) do
			tblField = strLine:split("=")
			tblStickyData[tblField[1]] = tblField[2]
		end
		IntMainX = tonumber(strLoadLocal("MainX",IntMainX))
		IntMainY = tonumber(strLoadLocal("MainY",IntMainY))
		IntHelpX = tonumber(strLoadLocal("HelpX",IntHelpX))
		IntHelpY = tonumber(strLoadLocal("HelpY",IntHelpY))
		StrHelpS = strLoadLocal			("HelpS",StrHelpS)
		IntDataX = tonumber(strLoadLocal("DataX",IntDataX))
		IntDataY = tonumber(strLoadLocal("DataY",IntDataY))
		StrFolder	= strLoadLocal			("Folder",StrFolder)
		IntPages	= tonumber(strLoadGlobal("Pages",IntPages))
		IntChars	= tonumber(strLoadGlobal("Chars",IntChars))
		IntPopup	= tonumber(strLoadGlobal("Popup",IntPopup))
		StrToPs	= strLoadGlobal			 ("ToPs",StrToPs)
		StrToRs	= strLoadGlobal			 ("ToRs",StrToRs)
		StrToDs	= strLoadGlobal			 ("ToDs",StrToDs)
		StrMenu	= strLoadGlobal			 ("Menu",StrMenu)
		IntNames	= tonumber(strLoadGlobal("Index",IntNames))	-- Legacy "Index" setting
		IntNames	= tonumber(strLoadGlobal("Names",IntNames))
		IntStyle	= tonumber(strLoadGlobal("Style",IntStyle))
		IntIdent	= tonumber(strLoadGlobal("Ident",IntIdent))
		IntGenDex	= tonumber(strLoadGlobal("GenDex",IntGenDex))
		IntTabPosn= tonumber(strLoadGlobal("TabPosn",IntTabPosn))
		IntFontSet= tonumber(strLoadGlobal("FontSet",IntFontSet))
	end
	IntMainX,IntMainY = intintCheckPosition(IntMainX,IntMainY)
	IntHelpX,IntHelpY = intintCheckPosition(IntHelpX,IntHelpY)
	IntDataX,IntDataY = intintCheckPosition(IntDataX,IntDataY)
	GUI_FontDialogue(IntFontSet)								-- Assign font set
	SaveSettings(strFileName)									-- Save sticky data settings
end -- function LoadSettings

-- Save Sticky Settings to File --
function SaveSettings(strFileName)

	local tblStickyData = {}

	-- Save Local Parameter for this PC --
	local function doSaveLocal(strParam,param)
		tblStickyData[StrComputerName.."-"..strParam] = param
	end

	-- Save Global Parameter for all PC --
	local function doSaveGlobal(strParam,param)
		tblStickyData[strParam] = param
	end

	doSaveLocal("MainX",IntMainX)
	doSaveLocal("MainY",IntMainY)
	doSaveLocal("HelpX",IntHelpX)
	doSaveLocal("HelpY",IntHelpY)
	doSaveLocal("HelpS",StrHelpS)
	doSaveLocal("DataX",IntDataX)
	doSaveLocal("DataY",IntDataY)
	doSaveLocal("Folder",StrFolder)
	doSaveGlobal("Pages",IntPages)
	doSaveGlobal("Chars",IntChars)
	doSaveGlobal("Popup",IntPopup)
	doSaveGlobal("ToPs",StrToPs)
	doSaveGlobal("ToRs",StrToRs)
	doSaveGlobal("ToDs",StrToDs)
	doSaveGlobal("Menu",StrMenu)
	doSaveGlobal("Names",IntNames)
	doSaveGlobal("Style",IntStyle)
	doSaveGlobal("Ident",IntIdent)
	doSaveGlobal("GenDex",IntGenDex)
	doSaveGlobal("TabPosn",IntTabPosn)
	doSaveGlobal("FontSet",IntFontSet)

	local fileHandle = OpenFile(strFileName,"w")
	for strKey,strVal in pairs(tblStickyData) do
		fileHandle:write(strKey.."="..strVal.."\n")
	end
	fileHandle:close()
end -- function SaveSettings

-- GUI Help & Advice Dialogue --
function GUI_HelpDialogue(strOrigin)

	local function doActivateMainHelpButton()
		if BtnHelp then BtnHelp.active = "YES" end
	end -- local function doActivateMainHelpButton

	-- create the WebBrowser based on its ProgID and connect it to LuaCOM
	local	oleControl = iup.olecontrol{ "Shell.Explorer.1", designmode="NO", }
			oleControl:CreateLuaCOM()

	-- Create each GUI button with title and tooltip
	local	btnIntro	= iup.button	{ title="Introduction"			, tip="Improve HTML plugin Help and Advice" }
	local	btnHyper	= iup.button	{ title="Hyperlinks / Text"	, tip="Hyperlinks / Text tab Help and Advice" }
	local	btnPopup	= iup.button	{ title="Image Popups"			, tip="Image Popups tab Help and Advice" }
	local	btnTable	= iup.button	{ title="Content Tables"		, tip="Content Tables tab Help and Advice" }
	local	btnIndex	= iup.button	{ title="Index of Names"		, tip="Index of Names tab Help and Advice" }
	local	btnGenDex	= iup.button	{ title="Create GenDex"		, tip="Create GenDex tab Help and Advice" }
	local	btnClose	= iup.button	{ title="Close Window"			, tip="Close this Help and Advice window" }

	-- The following controls are global to allow Main GUI to alter font and restore default position
	HboxHelp		=	iup.hbox { font=StrFontBody, margin=StrMinMargin, homogeneous="YES", btnIntro, btnHyper, btnPopup, btnTable, btnIndex, btnGenDex, btnClose, }
	DialogHelp	=	iup.dialog { title=StrPlugin.." Help & Advice", background=StrWhite, startfocus=btnClose, rastersize=StrHelpS,
							iup.vbox { alignment="ACENTER", margin=StrBigMargin, expandchildren="YES",
								oleControl,
								HboxHelp,
							},
							move_cb	= function(self,x,y) if IsNormalWindow(self) then IntHelpX=x IntHelpY=y end end,
							resize_cb	= function(self) if IsNormalWindow(self) then StrHelpS=self.rastersize end end,
							close_cb	= function() doActivateMainHelpButton() end,
						}

	local strFHUG = "http://www.fhug.org.uk/wiki/doku.php?id=plugins:help:improve_html:"
	local tblFHUG = {"improve_html","hyperlinks","imagepopup","itemtables","name_index","creategendex"}

	-- Set other GUI control attributes
	for iupName, tblAttr in pairs( {
		-- Control	=	1~fgcolor	, 2~URL	, 3~action function()
		[btnIntro]	= { StrGreen	,	1		, false },
		[btnHyper]	= { StrGreen	,	2		, false },
		[btnPopup]	= { StrGreen	,	3		, false },
		[btnTable]	= { StrGreen	,	4		, false },
		[btnIndex]	= { StrGreen	,	5		, false },
		[btnGenDex]	= { StrGreen	,	6		, false },
		[btnClose]	= { StrRed	, false	, function() DialogHelp:destroy() doActivateMainHelpButton() end }
		} ) do
		iupName.expand	= "HORIZONTAL"
		iupName.size		= "x10"
		iupName.fgcolor	= tblAttr[1]
		if tblAttr[2] then iupName.action = function() oleControl.com:Navigate(strFHUG..tblFHUG[tblAttr[2]]) end end
		if tblAttr[3] then iupName.action = tblAttr[3] end
	end

	DialogHelp:showxy(IntHelpX,IntHelpY)		-- Show Help GUI window
	DialogHelp.rastersize=nil						-- Allow window to be resized	nil = iup.NULL

	if not strOrigin then strOrigin = "improve_html" end
	for intFHUG = 1, #tblFHUG do
		local strFHUG = tblFHUG[intFHUG]
		if strFHUG:match(strOrigin) then
			strOrigin = strFHUG
			break
		end
	end
	oleControl.com:Navigate(strFHUG..strOrigin)

	if (iup.MainLoopLevel()==0) then iup.MainLoop() end

end -- function GUI_HelpDialogue

-- Convert all URL & Hypertext in every required HTML Web/CD/DVD page --

function IntImproveHTML(strFolder,intPages,intChars)

	-- Convert any URL into Hyperlinks and translate any Text placeholders --

	local tblPages	= { '', ' target="_blank"' }																	-- Target page options
	local tblChars	= { 999, 30, 50, 70, 90 }																		-- URL length options
	local tblAnchor = {}																								-- Table of Anchor parameters
	tblAnchor.Style = ' class="fhextlink"'																			-- Set class style anchor attribute as used by FH
	tblAnchor.Pages	= tblPages[intPages]																			-- Set target page anchor attribute for GUI option
	tblAnchor.Chars	= tonumber(tblChars[intChars])																-- Set abbreviated URL char length for GUI option
	tblAnchor.Match = '[%w#&/:;=@_%%%+%-%.%?]+[^%s%p]'															-- Set pattern for unquoted URL
						-- [%w@:/=&;#_%?%.%+%-%%] allows URL to contain alphanumeric characters %w and symbols # & / : ; = @ _ % + - . ?
						-- [^%s%p] prevents last character from being tabs/spaces %s or punctuation %p symbols # & / : ; = @ _ % + - . ? , " ' < > !  $ ^ * ( ) { } [ ] ~ | \  ` 
						-- For details see http://en.wikipedia.org/wiki/Uniform_resource_locator and http://en.wikipedia.org/wiki/URI_scheme

	-- Parse any Anchor tag into its component parts and adjust class & target attributes, and link text length

	local function strParse(strAnchor,tblAnchor)
		local strStyle = tblAnchor.Style
		local strPages = tblAnchor.Pages
		local strMatch = tblAnchor.Match
		local strAttr, strLink = strAnchor:match('<a(%s.-)>(.-)</a>')										-- Split anchor tag into attributes and link text parts
		-- Parse attributes with value in "double-quotes"  or enclosed in 'single-quotes'      or without any quotes at all               or use default value
		local strHref   = strAttr:match('(%shref=".-")')   or strAttr:match("(%shref='.-')")   or strAttr:match('(%shref='..strMatch..')') or ' href="http://www.null.com"'
		local strClass  = strAttr:match('(%sclass=".-")')  or strAttr:match("(%sclass='.-')")  or strAttr:match('(%sclass='..strMatch..')') or strStyle
		local strTarget = strAttr:match('(%starget=".-")') or strAttr:match("(%starget='.-')") or strAttr:match('(%starget='..strMatch..')') or strPages
		strAttr   = strAttr:replace(strHref,''):replace(strClass,''):replace(strTarget,''):gsub('^%s+',' '):gsub('%s+$','')
		strHref   = strHref:gsub('%shref=([^\'"].-[^\'"])$',' href="%1"')									-- Add missing quotes to href=URL
		strClass  = strClass:gsub('%sclass=([^\'"].-[^\'"])$',' class="%1"')								-- Add missing quotes to class=style
		strTarget = strTarget:gsub('%starget=([^\'"].-[^\'"])$',' target="%1"')							-- Add missing quotes to target=page
		if strHref:match('href=%pmailto:') then
			strTarget = ''																								-- Remove target attribute from mailto protocol scheme
		elseif strTarget == tblPages[1]
			 or strTarget == tblPages[2] then
			strTarget = strPages																						-- Set target attribute for all other protocol schemes
		end
		local intChars = tblAnchor.Chars																			-- Abbreviate long URL link text to chosen character length
		local strTail  = '...'	
		local strURL   = strHref:match('%shref=%p(.-)%p$')														-- Extract URL from href="URL"
		local intLink  = strLink:len() - strTail:len()
		if strURL == strLink																							-- Abbreviations apply only if URL matches link text
		or ( strURL:sub(1,intLink) == strLink:sub(1,intLink) and strLink:match(strTail..'$') ) then	-- or URL matches abbreviated link text
			if strURL:len() > intChars then
				strLink = strURL:sub(1,intChars)..strTail															-- Apply abbreviated link text
			else
				strLink = strURL																						-- Cancel abbreviated link text
			end
		end
		return '<a'..strClass..strHref..strTarget..strAttr..'>'..strLink..'</a>'							-- Compose entire anchor
	end -- local function strParse

	-- Convert all URL protocol schemes, plus class & target attributes, and link text length

	local function strHyper(strSource,tblAnchor)
		local strString = strSource
		if strString:matches('://')
		or strString:matches('mailto:')
		or strString:matches('www.') then																			-- Recognise user <a href="url">link</a> format and convert to valid XHTML
			strString = strString:gsub('&lt;a%s(.-href=.-)&gt;(.-)&lt;/a&gt;','<a %1>%2</a>')			-- Convert URL from FH text field where < = &lt; and > = &gt;
			local strPrefix,strAnchor,strSuffix = strString:match('(.-)(<a%s[^<>]-href=.-</a>)(.*)')	-- Split text line into text prefix, anchor tag, and text suffix
			if strAnchor then																							-- Existing URL hyperlink anchor tag found
				strAnchor = strParse(strAnchor,tblAnchor)															-- Parse anchor into its component parts and reassemble
				strString = strHyper(strPrefix,tblAnchor)..strAnchor..strHyper(strSuffix,tblAnchor)		-- Recursively call strHyper for prefix and suffix
			else
				local strMatch = tblAnchor.Match
				strString = strString:gsub('(&[lg]t;)','<<%1>>')												-- Protect symbols < &lt; and > &gt;
				for i, strScheme in ipairs( { '(.)(http://', '(.)(https://', '(.)(ftp://', '([^/])(www%.', '(.)(mailto:' } ) do
					strString = strString:gsub(strScheme..strMatch..')','%1<a href="%2">%2</a>')			-- Repeat for each URL protocol scheme and www. without a scheme
				end
				strString = strString:gsub('<<(&[lg]t;)>>','%1')												-- Unprotect symbols < &lt; and > &gt;
				if strString ~= strSource then strString = strHyper(strString,tblAnchor) end				-- Prevent indefinite recursion loop
			end
			strString = strString:gsub(' href=(%p)www%.',' href=%1http://www%.')							-- Add the http:// scheme to href="www.
		end
		return strString
	end -- local function strHyper

	-- Process my Locations Database only if 'myloc.html' exists

	local function strMyLoc(strString,tblAnchor,strFolder,strFile)

		local strTarget = tblAnchor.Pages
		local strClass  = tblAnchor.Style

		-- Insert hyperlink <a href='myloc.html'>Locations</a> into standard menubar			e.g. before	<li><span class="fhmenuend">
		strString = strString:gsub('<li><span class="fhmenuend">',"<li><span><a href='myloc.html'>Locations</a></span></li>\n<li><span class='fhmenuend'>")

		if strFile:match('^fam%d+%.html$') or strFile:match('^ind%d+%.html$') then
			-- Convert source location entry into locations database hyperlink					e.g. ~ Database Address ~.  Custom Id: 9999.<	allowing for illegally embedded anchor
			strString = strString:gsub('~ (.-)<a (.-)</a>(.-) ~%.  Custom Id: ([0-9]-)%.<','Locations Database Record <a'..strClass..' href="myloc.html#locsid%4"'..strTarget..'>%1 %3</a> <a %2</a><')
			strString = strString:gsub('~ (.-) ~%.  Custom Id: ([0-9]-)%.<','Locations Database Record <a'..strClass..' href="myloc.html#locsid%2"'..strTarget..'>%1</a><')
		end

		if strFile == 'index.html' then
			-- Insert 'Close Window' button 															e.g. before	<div class="FhWelcome">
			strString = strString:gsub('<div class="FhWelcome">',"<center>\n<form action='javascript:void(0)'>\n<input type='button' value='Close Window' onclick='javascript:window.close()'>\n</form>\n</center>\n<div class='FhWelcome'>")
			-- Change home page ToC hyperlink for Locations Database								e.g. from "toc[2-5].html" to "myloc.html"
			strString = strString:gsub('<li><a href="toc[2-5].html">Locations Database</a></li>','<li><a href="myloc.html">Locations Database</a></li>')
		end

		if strFile == 'myloc.html' then
			-- Convert <title> to 'Locations Database'												e.g. <title>~ Database Address ~</title>
			strString = strString:gsub('<title>~ .- ~</title>','<title>Locations Database</title>')
			-- Insert 'Locations Database' heading after menubar section before content		e.g. before	<div class="fhcontent ...">
			strString = strString:gsub('<div class="fhcontent (.-)">',"<p class='FhPageTitleCentred'>Locations Database</p>\n<div class='fhcontent %1'>")
			-- Convert >RecordId~ to hyperlink anchor targets										e.g. <h1 class="FhHdg1">[9999] Database Address</h1>
			strString = strString:gsub('<h1 class="FhHdg1">%[([0-9]-)%] (.-)</h1>',"\n<a name='locsid%1' id='locsid%1'></a>\n<h1 class='FhHdg1'>%2</h1>")
			if strString == '<body>' then
				local strFile = 'x-canvas.jpg'																		-- Define 'x-canvas.jpg' background image file
				if FlgFileExists(StrPublicPath..'\\'..strFile) then
					local fileSource = assert(io.open(StrPublicPath..'\\'..strFile,'rb'))
					local fileTarget, strError = io.open(strFolder..'\\'..strFile,'wb')
					fileTarget:write(fileSource:read('*all'))														-- Copy entire 'x-canvas.jpg' background image
					assert(fileSource:close())
					assert(fileTarget:close())
				end
				local str_mystyle_css = [=[
				body                { background: url('x-canvas.jpg') #D8D0BC ; }      /* Background image file or colour */
				.FhSiteTitle        { font-size:22pt; font-weight:bold; color:green; } /* Title font size, weight & colour */
				.FhPageTitle        { font-size:20pt; font-weight:bold; color:green; }
				.FhPageTitleCentred { font-size:20pt; font-weight:bold; color:green; }
				]=]
				SaveStringToFile(str_mystyle_css,strFolder..'\\mystyle.css')									-- Create custom 'mystyle.css' style sheet
			end
		end

		return strString
	end -- local function strMyLoc

	-- Determine if my Locations Database needs processing

	local function isMyToC(strFolder,strFile)
		-- If file is 'index.html' with '<li><a href="toc[2-5].html">Locations Database</a></li>' then rename "toc[2-5].html" to "myloc.html" and set isMyLoc = true
		local isMyLoc = false
		if strFile == 'index.html' then
			for strLine in io.lines(strFolder..'\\index.html') do
				local strToC = strLine:match('^<li><a href="(toc[2-5].html)">Locations Database</a></li>$')
				if strToC then
					local isOK, strErr = os.rename(strFolder..'\\'..strToC,strFolder..'\\myloc.html')
					isMyLoc = true
					break
				end
			end
		end
		if strFile == 'myloc.html' then isMyLoc = true end
		return isMyLoc
	end -- local function isMyToC

	-- Determine if file is HTML that needs converting
 
	local function isHTML(strFile)
		return
			strFile == 'index.html'			or																		-- Home Welcome page
			strFile == '_contact.html'		or																		-- Contact Details page
			strFile == '_statistics.html'	or																		-- Statistics page
			strFile == '_nameindex.html'		or																		-- Index of Names page
			strFile:match('^fam%d+%.html$')	or																		-- 'fam99.html' Family pages
			strFile:match('^ind%d+%.html$')	or																		-- 'ind99.html' Individual pages 
			strFile:match('^toc%d+%.html$')	or																		-- 'toc99.html' ToC pages
			strFile == 'myloc.html'																					-- 'myloc.html' my Locations Database page
	end -- local function isHTML

	-- Search each HTML file and convert any URL

	local ProgressBar = MyProgressBar()																				-- Create the ProgressBar functions
	local intLine = 0																									-- Count of lines with converted URL
	local intFile = 0																									-- Count of suitable HTML files
	local isMyLoc = false
	local datDate = fhNewDate()
	datDate:SetSimpleDate(fhCallBuiltInFunction('Today'))														-- Obtain date for {{DATE:***}}

	for strFile in lfs.dir(strFolder) do
		if isMyToC(strFolder,strFile) then isMyLoc = true end													-- Is my Locations Database present?
		if isHTML(strFile) then intFile = intFile + 1 end														-- Count suitable HTML files
	end
	if intFile > 100 then
		ProgressBar.Start("Converting URL",intFile)																-- Start progress bar
	end
	for strFile in lfs.dir(strFolder) do
		if isHTML(strFile) then																						-- Suitable HTML file found
			ProgressBar.Message(strFile)
			strPath = strFolder..'\\'..strFile
			local tblFile = {}																							-- Table of lines in file
			local flgSave = false																						-- Flag if file needs saving 
			local flgLine = false																						-- Flag if line needs converting
			for strLine in io.lines(strPath) do																		-- Read each HTML file line by line
				if strLine:match("<!DOCTYPE html PUBLIC") then
					local strType = strLine
					if tblAnchor.Pages:match("target=") then														-- Workaround for target="_blank"
						strLine = strLine:gsub("Strict","Transitional"):gsub("strict","transitional")	-- Alter DOCTYPE XHTML to Transitional
					else
						strLine = strLine:gsub("Transitional","Strict"):gsub("transitional","strict")	-- Restore DOCTYPE XHTML to Strict
					end
					if strLine ~= strType then flgSave = true end
				end
				if strLine == '<head>' and strFile == 'myloc.html' then flgLine = true end				-- Convert <head> <title> in myloc.html
				if strLine == '<body>' then flgLine = true end													-- Convert <body> lines otherwise
				if strLine == '<div class="FhIndexList">' then flgLine = false end							-- Exclude Index List in _nameindex.html
				if strLine == '</div>' then flgLine = true end													-- Resume after </div> at end of List
				if strLine:match('^<a href="img') then flgLine = false end									-- Exclude popup image title
				if strLine:match('^<img src="img') then flgLine = true end									-- Resume after popup image
				if flgLine then
					local strLink = strHyper(strLine,tblAnchor)													-- Convert anchor hyperlinks
					if strLink:match('{{%u-:[%w_]-}}') then														-- Convert special DATE & FILE text
						strLink = strLink:gsub('{{DATE:(.-)}}', function(strQual) return datDate:GetDisplayText(strQual) end )
						strLink = strLink:gsub('{{FILE:NAME}}', StrHTML_Encode(strFile) )
						strLink = strLink:gsub('{{FILE:PATH}}', StrHTML_Encode(strPath) )
					end
					if isMyLoc then strLink = strMyLoc(strLink,tblAnchor,strFolder,strFile) end			-- Convert my Locations Database
					if strLine ~= strLink then																		-- Converted line detected
						strLine = strLink
						intLine = intLine + 1																			-- Count converted lines
						flgSave = true
					end
				end
				table.insert(tblFile,strLine)
			end
			if flgSave then																								-- Only save changed HTML files
				SaveStringToFile(table.concat(tblFile,'\n'),strPath)
			end
			ProgressBar.Step(1)
		end
		if ProgressBar.Stop() then break end
	end
	ProgressBar.Close()																									-- Close the Progress Bar and retrieve its window position
	IntDataX = tblGauge.ShowX
	IntDataY = tblGauge.ShowY
	return intLine
end -- function IntImproveHTML

-- Convert all image Popups in every required HTML Web/CD/DVD page --

function IntImprovePopup(strFolder,strPopup)

	-- Convert any anchor tag Popups --

	local function strAnchor(strLine,strPopup,strName)
		local flgLine = false
		if strPopup:match("Lytebox") then																			-- Convert any fhpopup to lytebox popup anchor
			strLine = strLine:gsub("<a href=(.+) id=.+ onclick='fhpopup%(.+%);return false;' ",'<a href=%1 rel="lytebox" ')
			flgLine = strLine:match('<a href=(.+) rel="lytebox" ')
		else																												-- Convert any lytebox popup to fhpopup anchor
			strLine = strLine:gsub('<a href=(.+) rel="lytebox" ','<a href=%1 id='..strName.." onclick='fhpopup("..strName..");return false;' ")
			flgLine = strLine:match("<a href=(.+) id=.+ onclick='fhpopup%(.+%);return false;' ")
		end
		return strLine, flgLine
	end -- local function strAnchor

	-- Determine if file is HTML that needs popup conversion
 
	local function isHTML(strFile)
		return
			strFile == 'index.html'			or																		-- Home Welcome page
			strFile:match('^fam%d+%.html$')	or																		-- 'fam99.html' Family pages
			strFile:match('^ind%d+%.html$')	or																		-- 'ind99.html' Individual pages 
			strFile:match('^toc%d+%.html$')	or																		-- 'toc99.html' ToC pages
			strFile == 'myloc.html'																					-- 'myloc.html' my Locations Database page
	end -- local function isHTML

	-- Search each HTML file and convert any Popups --

	local ProgressBar = MyProgressBar()																				-- Create the ProgressBar functions
	local isBarStop
	local intLine = 0																									-- Count of lines with converted URL
	local intFile = 0																									-- Count of suitable HTML files
	for strFile in lfs.dir(strFolder) do
		if isHTML(strFile) then intFile = intFile + 1 end														-- Count suitable HTML files
	end
	if intFile > 100 then
		ProgressBar.Start("Converting Popups",intFile)															-- Start progress bar
	end
	for strFile in lfs.dir(strFolder) do
		if isHTML(strFile) then																						-- Suitable HTML file found
			ProgressBar.Message(strFile)
			strFile = strFolder..'\\'..strFile
			local tblFile = {}																							-- Table of lines in file
			local intHref = 0																							-- Count of popup per file for href id
			local flgHead = true																						-- Flag if line in <head> ( else <body> )
			for strLine in io.lines(strFile) do																		-- Read each HTML file line by line
				if strLine == '<body>' then flgHead = false end
				if flgHead then																							-- Adjust lines in <head>
					local strLytebox = '<link rel="stylesheet" href="lytebox.css" type="text/css" media="screen" />'
					if strPopup:match("Lytebox") then
						if strLine:match('src="fhpopup.js"') then													-- Convert from fhpopup to lytebox
							strLine = strLine:gsub('src="fhpopup.js"','src="lytebox.js"')
							table.insert(tblFile,strLine)
							strLine = strLytebox
							flgHead = false
						end
					else
						strLine = strLine:gsub('src="lytebox.js"','src="fhpopup.js"')						-- Convert from lytebox to fhpopup
						if strLine:match(strLytebox) then
							strLine = ''
							flgHead = false
						end
					end
				else
					local strHref, flgLine = strAnchor(strLine,strPopup,'"fh'..intHref..'"')				-- Convert popup anchor in <body>
					if flgLine then
						strLine = strHref
						intLine = intLine + 1																			-- Count converted popup lines
						intHref = intHref + 1																			-- Count popup per file for href id
					end
				end
				if strLine ~= '' then table.insert(tblFile,strLine) end
			end
			SaveStringToFile(table.concat(tblFile,'\n'),strFile)												-- Save changed HTML files
			ProgressBar.Step(1)
		end
		isBarStop = ProgressBar.Stop()
		if isBarStop then break end
	end
	ProgressBar.Close()																									-- Close the Progress Bar and retrieve its window position
	IntDataX = tblGauge.ShowX
	IntDataY = tblGauge.ShowY

	local strLytebox = '\\Family Historian\\Web\\Lytebox'														-- Locate the C:\Program Files\Family Historian\Web\Lytebox path
	local strProgram = os.getenv("PROGRAMFILES")..strLytebox
	if not FlgFolderExists(strProgram) then																		-- Try alternative Program Files OS Path on 64-bit PC
		strProgram = ( os.getenv("PROGRAMW6432") or os.getenv("PROGRAMFILES") )..strLytebox
	end
	if not FlgFolderExists(strProgram) then
		fhMessageBox('\n\nError! Cannot find Lytebox installation folder:\n'..strProgram..'\n\n')
		return -1
	end

	if strPopup:match("Lytebox") then
		for strFile in lfs.dir(strProgram) do																		-- Copy lytebox v4.0 JavaScript & CSS & image files
			if strFile:match('^[%w_]+%.%w+$') then
				local fileSource = assert(io.open(strProgram..'\\'..strFile,'rb'))
				local fileTarget, strError = io.open(strFolder..'\\'..strFile,'wb')
				fileTarget:write(fileSource:read('*all'))															-- Copy entire file contents
				assert(fileSource:close())
				assert(fileTarget:close())
			end
		end
		if strPopup:match("5.5") then																				-- Create lytebox v5.5 JavaScript & CSS files
			SaveStringToFile(Str_lytebox_js,strFolder..'\\lytebox.js')
			SaveStringToFile(Str_lytebox_css,strFolder..'\\lytebox.css')
		end
		if not isBarStop then																							-- Delete the fhpopup JavaScript file
			DeleteFile(strFolder..'\\fhpopup.js')
		end
	else
		if strPopup:match("Zoom & Scroll") then
			SaveStringToFile(Str_fhpopup_custom,strFolder..'\\fhpopup.js')									-- Create the fhpopup Custom JavaScript file
		else
			SaveStringToFile(Str_fhpopup_screen,strFolder..'\\fhpopup.js')									-- Create the fhpopup Screen JavaScript file
		end
		if not isBarStop then																							-- Delete all the Lytebox files
			for strFile in lfs.dir(strProgram) do
				if strFile:match('^[%w_]+%.%w+$') then
					DeleteFile(strFolder..'\\'..strFile)
				end
			end
		end
	end
	return intLine
end -- function IntImprovePopup

-- Create new Table of Pictures/Reports/Downloads pages for chosen Contents items --

function IntImproveTable(strFolder,tglToPs,tglToRs,tglToDs,isMenu)

	-- Insert HTML line into every table page file --

	local function tableInsert(tblTables,strLine)
		for intTable, tblTable in ipairs(tblTables) do
			local strLine = strLine:replace("<tblTable.name>",tblTable.name)			-- Substitute table page name in title lines 
			table.insert(tblTable.html,strLine)
		end
	end -- local function tableInsert

	-- Does ToC link refer to required Picture/Report/Download file --

	local function isTableLink(tblTable,strLink)
		if tblTable.name == "Downloads" then													-- Table of Downloads link cannot be .html file
			return tblTable.chosen and not strLink:match("^<li><a href=%p%l%l%l[%l%d]+%.html")
		else
			local strFile = strLink:match("^<li><a href=%p(toc%d+%.html)")
			if tblTable.chosen and strFile then
				for strLine in io.lines(strFolder.."\\"..strFile) do						-- Read toc99.html until fhcontent fhpage reached
					if strLine:match("^<div class=%pfhcontent fhpage") then
						if strLine:match("_Picture") then
							return ( tblTable.name == "Pictures" )								-- Picture file for Table of Pictures ?
						else
							return ( tblTable.name == "Reports" )								-- Report file for Table of Reports ?
						end
					end
				end
			end
			return false
		end
	end -- local function isTableLink

	local tblIndex = {}																				-- New contents of index.html
	local intTables = 0																				-- Number of created table pages
	local tblTables =																				-- Details per table page type
		{	--		Table Name		Enabled ?			Table Filename and Content	Hyperlinks
			{ name="Pictures" , chosen=tglToPs, file="_topindex.html", html={}, links=0 },
			{ name="Reports"  , chosen=tglToRs, file="_torindex.html", html={}, links=0 },
			{ name="Downloads", chosen=tglToDs, file="_todindex.html", html={}, links=0 },
		}
	local isIncluded = "Head"																		-- Identify index.html heading lines in table page files

	for strLine in io.lines(strFolder.."\\index.html") do									-- Read index.html lines & remove comment tags to restore ToC links
		strLine = strLine:gsub("^<!%-%-See Table of %u%l+<li>(.*)</li>%-%->$","<li>%1</li>")
		if strLine:match("^<p class=%pFhSiteTitle%p>") then
			isIncluded = nil																		-- Exclude the index.html Welcome section from table page files
		elseif strLine:match("^<div class=%pFhTOC%p>$") then
			isIncluded = "ToC"																		-- Identify the index.html Table of Centents (ToC) section
		end
		if not strLine:match("^<li><a href='_%l+%.html'>Table of %u%l+</a></li>$") then -- Discard the Table of Pictures/Reports/Downloads links at end of ToC
			if isIncluded then
				if strLine:match("^<title>Welcome</title>$") then							-- Adjust page <title> of table page files
					tableInsert(tblTables,"<title><tblTable.name></title>")
				elseif isIncluded == "ToC" then
					if strLine:match("^<p class=%pFhPageTitle%p>Contents</p>$") then	-- Adjust FhPageTitle of table page files
						tableInsert(tblTables,"<p class='FhPageTitle'>Table of <tblTable.name></p>")
					elseif strLine:match("^<li><a href=.+</a></li>$") then					-- Determine which ToC links to include in each table page file
						for intTable, tblTable in ipairs(tblTables) do
							if isTableLink(tblTable,strLine) then
								table.insert(tblTable.html,strLine)								-- Include in table page, but comment out of index.html
								strLine = "<!--See Table of "..tblTable.name..strLine.."-->"
								tblTable.links = tblTable.links + 1
								break																	-- Break out of loop once a link has been matched
							end
						end
					elseif not strLine:match("^<li><a class=.+ href=.+</a></li>$") then-- Exclude external ToC links
						tableInsert(tblTables,strLine)											-- Copy other ToC lines to each table page file
						if strLine:match("^</ul>$") then
							for intTable, tblTable in ipairs(tblTables) do					-- Insert Table of Pictures/Reports/Downloads links at end of index.html ToC
								if tblTable.links > 0 then
									table.insert(tblIndex,"<li><a href='"..tblTable.file.."'>Table of "..tblTable.name.."</a></li>")
								end
							end
							isIncluded = "Tail"														-- Identify index.html trailing lines in table page files
						end
					end
				else
					tableInsert(tblTables,strLine)												-- Copy all "Head" and "Tail" lines to each table page file
				end
			end
			table.insert(tblIndex,strLine)														-- Copy all required lines to index.html
		end
	end
	SaveStringToFile(table.concat(tblIndex,"\n"),strFolder.."\\index.html")			-- Update the index.html file
	for intTable, tblTable in ipairs(tblTables) do
		local strTableFile = strFolder.."\\"..tblTable.file
		if tblTable.links > 0 then
			SaveStringToFile(table.concat(tblTable.html,"\n"),strTableFile)				-- If any links, create table page file
			intTables = intTables + 1
		else
			DeleteFile(strTableFile)																-- Otherwise, delete old table page file
		end
	end

	-- Search each HTML file and convert its menu bar --

	local ProgressBar = MyProgressBar()															-- Create the ProgressBar functions
	local isBarStop
	local intHtml = 0
	for strFile in lfs.dir(strFolder) do
		if strFile:match("^.+%.html$") then intHtml = intHtml + 1 end					-- Count all HTML files
	end
	local intFile = 0
	for strFile in lfs.dir(strFolder) do
		if strFile:match("^.+%.html$") then														-- HTML file found
			ProgressBar.Message(strFile)
			local tblFile = {}																		-- Table of lines in file
			local strOldMenu = ""																	-- Old menu bar links
			local strNewMenu = ""																	-- New menu bar links for comparison
			strFile = strFolder.."\\"..strFile
			for strLine in io.lines(strFile) do													-- Read each HTML file line by line
				if strLine:match("^<li><span.*><a href=%p_%l*index%.html%p>%u%l+</a></span></li>$") then
					strOldMenu = strOldMenu..strLine											-- Accumulate all existing table page menu links
					if strLine:match("_nameindex%.html") then									-- Ignore all table page menu links except _nameindex.html
						if isMenu then
							for intTable, tblTable in ipairs(tblTables) do					-- Add any table page menu links
								if tblTable.links > 0 then
									local strMenu = "<li><span><a href='"..tblTable.file.."'>"..tblTable.name.."</a></span></li>"
									table.insert(tblFile,strMenu)
									strNewMenu = strNewMenu..strMenu							-- Accumulate all new table page menu links
								end
							end
						end
						strNewMenu = strNewMenu..strLine										-- Append the _nameindex.html page menu link
						table.insert(tblFile,strLine)
					end
				else
					table.insert(tblFile,strLine)												-- Copy all other lines
				end
			end
			intFile = intFile + 1
			if intFile == 1 then
				if strOldMenu == strNewMenu then break end									-- If menu bar unchanged in first file then skip all file updates
				if intHtml > 100 then
					ProgressBar.Start("Converting Menu Bars",intFile)						-- Otherwise, if more than 100 files, start progress bar
				end
			end
			SaveStringToFile(table.concat(tblFile,"\n"),strFile)							-- Save changed HTML files
			ProgressBar.Step(1)
		end
		isBarStop = ProgressBar.Stop()
		if isBarStop then break end
	end
	ProgressBar.Close()																				-- Close the Progress Bar and retrieve its window position
	IntDataX = tblGauge.ShowX
	IntDataY = tblGauge.ShowY

	return intTables

end -- function IntImproveTable

-- Add alternate & married names and idents to _nameindex.html Web/CD/DVD page --

function IntImproveIndex(strFilename,strNames,strStyle,strIdent)

	local tblNameList = {}																-- Name list of index page entries
	local tblShortcut = {}																-- Shortcut to Name list entries
	local strPagelink = ''																-- Pagelink to web page for current person
	local strRecordId = ''																-- Record Id of current person used to make Name list entry distinct
	local strLifedate = ''																-- Lifedates of current person in index page format or '( - )' if Living
	local strIdentity = ''																-- Identity text of current person associated with Indentity GUI option
	local strTitleTxt = ''																-- Tooltip title text for Name list entry

	-- Obtain Individual Lastname & Forenames --

	local function strGetNames(ptrIndiName)
		local strLastname = fhGetItemText(ptrIndiName,'~:SURNAME')			-- Get the Surname
		local strForename = fhGetItemText(ptrIndiName,'~:GIVEN_ALL')			-- Get the Forenames etc
		if strLastname == '' then
			strLastname = '?'
		end
		if strForename == '' then
			strForename = '?'
		end
		strLastname = StrCP1252_UTF8(strLastname)									-- Translate Code Page 1252 characters into UTF-8 bytes
		strForename = StrCP1252_UTF8(strForename)
		return StrHTML_Encode(strLastname), StrHTML_Encode(strForename)		-- Convert some symbols to HTML escape sequences
	end -- local function strGetNames

	-- Obtain Individual Identity Data Conditionally --

	local tblIdentity = {}
	tblIdentity[1] = { Ident='Record', Tag=' '     , Prefix=' RiD:' }		-- Record Identity
	tblIdentity[2] = { Ident='Perm'  , Tag='~.RFN' , Prefix=' PRN:' }		-- Permanent Record Number
	tblIdentity[3] = { Ident='Custom', Tag='~.REFN', Prefix=' CiD:' }		-- Custom Identity
	tblIdentity[4] = { Ident='Auto'  , Tag='~.RIN' , Prefix=' ARI:' }		-- Automatic Record Identity

	local function strGetIdentity(ptrIndi)
		local strIdentities = ''
		if strIdent:match('None') then return '' end
		for intIdentity, tblIdentity in ipairs(tblIdentity) do					-- Repeat for each GUI Identity option
			local strIdentity = strRecordId											-- Default to Record Id
			if not tblIdentity.Ident:match('Record') then						-- Get the Identity text
				strIdentity = fhGetValueAsText(fhGetItemPtr(ptrIndi,tblIdentity.Tag))
			end
			if strIdentity ~= '' and ( strIdent:match(tblIdentity.Ident) or strIdent:match('All') ) then
				strIdentity = tblIdentity.Prefix..strIdentity					-- Add prefix if required
			else
				strIdentity = ''
			end
			strIdentities = strIdentities..strIdentity							-- Accumulate each required Identity
		end
		if strIdentities ~= '' then strIdentities = '<p class="ident">'..StrHTML_Encode(StrCP1252_UTF8(strIdentities))..'</p>' end
		return strIdentities
	end -- local function strGetIdentity

	-- Find Existing Name list entry and update RecordId & Identity --

	local function isExisting(strEntry)
		local tblEntry = tblShortcut[strEntry] or {}								-- Lookup shortcut to Name list entries
		for i, intEntry in ipairs(tblEntry) do										-- Search any matching entries
			local strRecId = tblNameList[intEntry].RecordId
			if strRecId == strRecordId or strRecId == '' then					-- Record Id matches, or not yet assigned
				tblNameList[intEntry].RecordId = strRecordId
				tblNameList[intEntry].Identity = strIdentity
				return true																-- Found entry with matching Pagelink, FullName, Lifedate & RecordId
			end
		end
		return false																		-- No entry found
	end -- local function isExisting

	-- Obtain matching Pagelink for own web page or relative's web page --

	local function strGetPageLink(ptrIndi,intFamilyId)
		local strLastname, strForename = strGetNames(fhGetItemPtr(ptrIndi,'~.NAME'))
		local strSelfname = strLastname..strForename								-- Pagelink + Selfname + Lifedate is Shortcut index to Name list
		local strPagelink = ''															-- Pagelink for own or relative's featured web page
		local intRecordId = 0															-- RecordId for current Family or Individual record
		local flagLiving = fhGetItemText(ptrIndi,"~._FLGS.__LIVING")			-- 'Y' or ''
		local ptrLink = fhNewItemPtr()												-- Pointer to self and each relative
		local ptrFams = fhNewItemPtr()												-- Pointer to each Family of the above
		repeat
			for intTag, strTag in ipairs({ '~', '~.~FATH[1]>', '~.~MOTH[1]>', '~.~SPOU[1]>', '~.~CHIL[1]>' }) do
				local intNext = 1
				ptrLink:MoveTo(ptrIndi,strTag)										-- Search own and each relative's web page links
				while ptrLink:IsNotNull() do
					if intFamilyId ~= 0 then											-- Family web page search needed
						ptrFams:MoveTo(ptrLink,'~.FAMS')
						while ptrFams:IsNotNull() do									-- Check each Family Pagelink
							intRecordId = fhGetRecordId(fhGetValueAsLink(ptrFams))
							strPagelink = '"fam'..tostring(intRecordId)..'.html"'
							if intFamilyId < 0 then
								if isExisting(strPagelink..strSelfname..strLifedate) then return strPagelink end
							elseif intFamilyId == intRecordId then
								return strPagelink										-- Husband entry needs Family Pagelink (could check web page file exists)
							end
							ptrFams:MoveNext('SAME_TAG')
						end
					end
					intRecordId = fhGetRecordId(ptrLink)							-- Check the Individual Pagelink
					strPagelink = '"ind'..tostring(intRecordId)..'.html"'
					if isExisting(strPagelink..strSelfname..strLifedate) then return strPagelink end
					if strTag == '~' then
						ptrLink:SetNull()												-- Only one instance of self, so close while ptrLink:IsNotNull() loop
					else
						intNext = intNext + 1											-- Next instance of relative e.g. '~.~SPOU[2]>' or '~.~CHIL[9]>'
						ptrLink:MoveTo(ptrIndi,strTag:gsub('1',intNext))		-- ptrLink:MoveNext('SAME_TAG') does not work
					end
				end
			end
			if strLifedate == '( - )' then flagLiving = '' end					-- After trying blank Lifedate exit repeat loop
			if flagLiving == 'Y' then strLifedate = '( - )' end					-- If Living flag then try blank Lifedate
		until flagLiving == ''
		return nil																		-- No matching entry found
	end -- local function strGetPageLink

	-- Conditionally Update Name List and Shortcut --

	local function doUpdateNameList(strLastname,strForename,strFullname)
		local strEntry = strPagelink..strLastname..strForename..strLifedate
		if not tblShortcut[strEntry] then tblShortcut[strEntry] = {} end	-- New shortcut to Name entry needed
		if #tblShortcut[strEntry] == 0 or strRecordId == '' then				-- New shortcut to new Name, or replica Name in name index page
			table.insert(tblNameList,{ Pagelink=strPagelink, Lastname=strLastname, Forename=strForename, Fullname=strFullname, Lifedate=strLifedate, RecordId=strRecordId, Identity=strIdentity, TitleTxt=strTitleTxt })
			table.insert(tblShortcut[strEntry],#tblNameList)					-- Save shortcut to Name entry, which may have replicas
		end
	end -- local function doUpdateNameList

	-- Comparison for table sort that returns true when 1st is less than 2nd --

	local function isLessThan(tbl1st,tbl2nd)
		local str1stPref = ''						-- Adjust sort so non-alpabetic initial chars come first but ordered according to any subsequent letters
		local str2ndPref = ''
		if not tbl1st["Lastname"]:match('^%u') then str1stPref = '!'..(tbl1st["Lastname"]:match('(%u+)') or '!') end
		if not tbl2nd["Lastname"]:match('^%u') then str2ndPref = '!'..(tbl2nd["Lastname"]:match('(%u+)') or '!') end
		local str1stName = str1stPref..tbl1st["Lastname"]..tbl1st["Forename"]..tbl1st["Lifedate"]..tbl1st["Pagelink"]
		local str2ndName = str2ndPref..tbl2nd["Lastname"]..tbl2nd["Forename"]..tbl2nd["Lifedate"]..tbl2nd["Pagelink"]
		return str1stName < str2ndName
	end -- local function isLessThan

	--	Read _nameindex.html file of text into tblNameIndex, down to <div class="FhIndexList">

	fhOverridePreference("SURNAMES_UPPERCASE",true,true)
	local strStyleCSS = ' '
	if strStyle:match("Italics")   then strStyleCSS = strStyleCSS..'font-style:italic; ' end
	if strStyle:match("Underline") then strStyleCSS = strStyleCSS..'text-decoration:underline; ' end
	local intAlphabet = 0																-- Alphabet Anchor Hyperlinks line number
	local tblNameIndex = {}															-- Table of _nameindex.html leading text lines
	local strNameIndex = ''															-- Text of _nameindex.html trailing text lines
	local fileNameIndex = io.input(strFilename)
	for strLine in io.lines() do														-- Read _nameindex.html leading text line by line
		-- Exclude XHTML CSS married & alternate & ident style
		if not strLine:match('^<style type="text/css"> .*married .*alternate .*ident .* </style>') then
			if strLine == '</head>' then												-- Found end of Header so insert XHTML CSS married & alternate & ident styles
				table.insert(tblNameIndex,'<style type="text/css"> /*<![CDATA[*/ span.married {'..strStyleCSS..'} span.alternate {'..strStyleCSS..'} p.ident { margin-left:30em; margin-bottom:-1.25em; } /*]]>*/ </style>')
			end
			table.insert(tblNameIndex,strLine)										-- Save leading text lines
			if strLine:match('^<p><a href=.*</a></p>$') then
				intAlphabet = #tblNameIndex											-- Save index to Alphabet Anchor Hyperlinks line
			end
			if strLine == '<div class="FhIndexList">' then break end			-- Pause at <div class="FhIndexList"> line
		end
	end

	-- Read _nameindex.html web page link & full name & life dates into a tblNameList and tblShortcut dictionary

	local strLastname = ''
	local strForename = ''
	local strFullname = ''
	local intFamilyId = 0
	for strLine in io.lines() do														-- Read _nameindex.html Pagelink & Fullname & Lifedate lines 
		strPagelink, strFullname, strLifedate = strLine:match('^<li>.-<a href=(%p%w-%.html%p)>(.+ )(%(.-%)).-</a></li>$')
		if strPagelink and strFullname and strLifedate then						-- List the entry details
			if not ( strFullname:match(' title="%u%l+ Name">')					-- Exclude alternate/married names with tooltip title="Alternate/Married Name"
					or strFullname:match('</?i]>')									-- or with legacy <i> italics </i>
					or strFullname:match('</?span.->') ) then						-- or with <span class=...> name </span>
				strLastname = strFullname:match('([^%l]+), ') or '?'
				strForename = strFullname:match(strLastname:plain()..', (.+) ') or '?'
				doUpdateNameList(strLastname,strForename,strLastname..', '..strForename..' ')
				if strPagelink:match('fam') then intFamilyId = -1 end
			end
		end
		if strLine == '</div>' then
			strNameIndex = '</div>\n'													-- Save _nameindex.html trailing lines
			break
		end
	end
	for strLine in io.lines() do														-- Save _nameindex.html trailing lines
		strNameIndex = strNameIndex..strLine..'\n'
	end
	io.close(fileNameIndex)

	-- Search all GEDCOM Names to add Alternate Names &/or Married Womens Surnames to tables with correct web page link and Identity

	local ptrName = fhNewItemPtr()
	local ptrFams = fhNewItemPtr()
	local ptrFamr = fhNewItemPtr()
	local ptrSpou = fhNewItemPtr()
	local strStat = ''
	local ptrIndi = fhNewItemPtr()
	ptrIndi:MoveToFirstRecord('INDI')
	while ptrIndi:IsNotNull() do														-- Loop through every Individual to ensure RecordId & Identity added to Primary Names
		strRecordId = tostring(fhGetRecordId(ptrIndi))							-- Get current RecordId text
		strLifedate = '('..fhCallBuiltInFunction("LifeDates2",ptrIndi)..')'	-- Get current Lifedate text in name index format
		strIdentity = strGetIdentity(ptrIndi)										-- Get current Identity text required by GUI option
		strPagelink = strGetPageLink(ptrIndi,intFamilyId)						-- Get current Pagelink text from matching Name list entry
		if strPagelink then
			ptrName = fhGetItemPtr(ptrIndi,'~.NAME')

			if strNames:match(" Married ") then 									-- Add Married Womens Surnames
				strTitleTxt = ' title="Married Name"'
				if fhGetItemText(ptrIndi,'~.SEX') == "Female" then				-- For Females use her Forename with the Husband's Lastname
					strLastname, strForename = strGetNames(ptrName)				-- Get her Lastname & Forename
					ptrFams:MoveTo(ptrIndi,'~.FAMS')
					while ptrFams:IsNotNull() do
	                ptrFamr = fhGetValueAsLink(ptrFams)
						ptrSpou = fhGetItemPtr(ptrFamr,'~.HUSB>')					-- Check husband is Male
						if fhGetItemText(ptrSpou,'~.SEX') == "Male" then
		                strStat = fhGetItemText(ptrFamr,'~._STAT')
		                if strStat ~= "Never Married" and strStat ~= "Unmarried Couple" then
								if intFamilyId < 0 then								-- Use the Husband's family Pagelink
									strPagelink = strGetPageLink(ptrSpou,fhGetRecordId(ptrFamr))
								end
								if strPagelink then										-- Get the Husband's Surname
									strLastname = strGetNames(fhGetItemPtr(ptrSpou,'~.NAME'))
									if strLastname ~= '?' then						-- Add the Married Name in italics &/or underline with tooltip title
										doUpdateNameList(strLastname,strForename,'<span class="married">'..strLastname..'</span>, '..strForename..' ')
									end
								end
							end
						end
						ptrFams:MoveNext('SAME_TAG')
					end
				end
			end -- Add Married Womens Surnames

			if strNames:match(" Alternate ") then									-- Add Alternate Names
				strTitleTxt = ' title="Alternate Name"'
				ptrName:MoveNext('SAME_TAG')											-- Check each Alternate Name entry
				while ptrName:IsNotNull() do
					strLastname, strForename = strGetNames(ptrName)				-- Get Alternate Surname & Forename
					if strLastname..strForename ~= '??' then						-- Add the Alternate Name in italics &/or underline with tooltip title
						doUpdateNameList(strLastname,strForename,'<span class="alternate">'..strLastname..', '..strForename..'</span> ')
					end
					ptrName:MoveNext('SAME_TAG')
				end
			end -- Add Alternate Names

		end
		ptrIndi:MoveNext()
	end

	table.sort(tblNameList,isLessThan) 												-- Sort the NameList alphabetically by Name and Lifedates and Pagelink

	local strHeadName = nil
	local strAlphabet = '<p>A&nbsp;B&nbsp;C&nbsp;D&nbsp;E&nbsp;F&nbsp;G&nbsp;H&nbsp;I&nbsp;J&nbsp;K&nbsp;L&nbsp;M&nbsp;N&nbsp;O&nbsp;P&nbsp;Q&nbsp;R&nbsp;S&nbsp;T&nbsp;U&nbsp;V&nbsp;W&nbsp;X&nbsp;Y&nbsp;Z&nbsp;</p>'
	local strNextInit = ''
	local strPrevInit = ''
	for i, tblItem in ipairs(tblNameList) do										-- Add each NameList item to _nameindex.html text lines
		strPagelink = tblItem["Pagelink"]
		strLastname = tblItem["Lastname"]
		strForename = tblItem["Forename"]
		strFullname = tblItem["Fullname"]
		strLifedate = tblItem["Lifedate"]
		strIdentity = tblItem["Identity"]
		strTitleTxt = tblItem["TitleTxt"]
		if strHeadName ~= strLastname then
			if strHeadName then table.insert(tblNameIndex,'</ul>') end
			strHeadName = strLastname													-- Each new Lastname needs a Header and an unnumbered list <ul> structure
			strNextInit = strHeadName:sub(1,1)
			if strPrevInit ~= strNextInit											-- Each new Initial Letter needs an Alphabet Hyperlink <a href="#I">I</a> and Anchor <a name="I"></a>
			and strNextInit:match('%u') then
				strAlphabet = strAlphabet:gsub(strNextInit..'&nbsp;','<a href="#'..strNextInit..'">'..strNextInit..'</a>&nbsp;')
				strPrevInit = '<a id="'..strNextInit..'"></a>'
			else
				strPrevInit = ''
			end
			table.insert(tblNameIndex,'<p>'..strPrevInit..strHeadName:gsub('^?$','(no surname)'):sub(1,22)..'</p>')	-- Change ? to (no surname) and truncate to 22 chars to avoid overwriting Name list
			table.insert(tblNameIndex,'<ul>')
			strPrevInit = strNextInit
		end
		table.insert(tblNameIndex,'<li>'..strIdentity..'<a href='..strPagelink..strTitleTxt..'>'..strFullname..strLifedate..'</a></li>')	-- Insert Identity, Page link, full Name & Life dates
	end
	tblNameIndex[intAlphabet] = strAlphabet:gsub('&nbsp;</p>$','</p>')		-- Remove trailing &nbsp; from Alphabet Anchor Hyperlinks
	table.insert(tblNameIndex,'</ul>\n')
	strNameIndex = table.concat(tblNameIndex,'\n')..strNameIndex
	SaveStringToFile(strNameIndex,strFilename)									-- Save _nameindex.html file

	return #tblNameList																	-- Number of names in list

end -- function IntImproveIndex

-- Create a 'gendex.txt' file for the http://gendexnetwork.org/ GenDex web site --

function IntCreateGenDex(strFolder,strGenDex)

	-- Compose webpage Filename matching Individual Record --

	local function strFilename(ptrIndi)
			local strFile = "ind"..fhGetRecordId(ptrIndi)..".html"					-- Does "ind{RecId}.html" Individual Summary webpage file exist?
			if FlgFileExists(strFolder.."\\"..strFile) then return strFile end
			local ptrFams = fhNewItemPtr()
			ptrFams:MoveTo(ptrIndi,"~.FAMS>")
			strFile = "fam"..fhGetRecordId(ptrFams)..".html"						-- Does "fam{RecId}.html" Family Group Sheet webpage file exist?
			if FlgFileExists(strFolder.."\\"..strFile) then return strFile end
			return nil
	end -- local function strFilename

	local strGedcomDate = NewGedcomDate()												-- Define local function from prototype below

	fhOverridePreference("SURNAMES_UPPERCASE",true,true)
	local tblGenDex = {}
	local ptrIndi = fhNewItemPtr()
	ptrIndi:MoveToFirstRecord("INDI")
	while ptrIndi:IsNotNull() do
		local strFile = strFilename(ptrIndi)
		if strFile
		and not ( strGenDex:match("Living")  and fhGetItemText(ptrIndi,"~._FLGS.__LIVING")  == 'Y' )
		and not ( strGenDex:match("Private") and fhGetItemText(ptrIndi,"~._FLGS.__PRIVATE") == 'Y' ) then
			local tblData = {}
			table.insert(tblData,strFile)												-- Reference is featured webpage filename
			table.insert(tblData,fhGetItemText(ptrIndi,"~.NAME:SURNAME"))		-- Surname in uppercase
			table.insert(tblData,fhGetItemText(ptrIndi,"~.NAME:STORED"))			-- Stored full name
			for intList, tblList in ipairs ( { { "~.BIRT", "~.BAPM", "~.CHR" }, { "~.DEAT", "~.BURI", "~.CREM" } } ) do
				local strDate = ""
				local strPlac = ""
				for intFact, strFact in ipairs ( tblList ) do
					local ptrFact = fhGetItemPtr(ptrIndi,strFact)					-- Get Birth/Baptism/Christening or Death/Burial/Cremation Date & Place
					if ptrFact:IsNotNull() then
						if strDate == "" then strDate = fhGetItemText(ptrFact,"~.DATE") end
						if strPlac == "" then strPlac = fhGetItemText(ptrFact,"~.PLAC") end
					end
				end
				table.insert(tblData,strGedcomDate(strDate))							-- Convert date to GEDCOM format
				table.insert(tblData,strPlac)
			end													-- Should characters be converted from CP1252 to UTF-8 ???
			table.insert(tblData,"")
			table.insert(tblGenDex,table.concat(tblData,"|"))						-- Create "|" separated Individual data entry
		end
		ptrIndi:MoveNext()
	end

	SaveStringToFile(table.concat(tblGenDex,"\n"),strFolder.."\\gendex.txt")	-- Create the GenDex file in website folder
 
	return #tblGenDex

end -- function IntCreateGenDex

-- Convert any Date to Gedcom Format Function Prototype --

function NewGedcomDate()

	-- Convert 'approx.', 'calculated', 'estimated' dates --

	local tblQual = { app="ABT ", cal="CAL ", est="EST " }

	local function strQualifiedDate(strDate,strQual)
		if strQual then
			return tblQual[strQual:sub(1,3)]..strDate
		else
			return nil
		end
	end -- local function strQualifiedDate

	-- Convert a Quarter Date to Gedcom format --

	local tblBeg = { "JAN ", "APR ", "JUL ", "OCT " }
	local tblEnd = { "MAR ", "JUN ", "SEP ", "DEC " }

	local function strQuarterDate(strNum,strYear)
		if strNum then
			local intNum = tonumber(strNum)
			return "BET "..tblBeg[intNum]..strYear.." AND "..tblEnd[intNum]..strYear
		else
			return nil
		end
	end -- local function strQuarterDate

	-- Convert any Date to Gedcom format --

	local tblGedcomDate =
	{
		January="JAN", February="FEB", March="MAR", April="APR", May="MAY", June="JUN", July="JUL", August="AUG", September="SEP", October="OCT", November="NOV", December="DEC",
		from="FROM", ["to "]="TO ",
		before="BEF", after="AFT", between="BET", ["and"]="AND"
	}

	return function(strDate)
		local strText = ""
		if strDate:match("\".*\"") then													-- Convert 'Date Phrase' must be first to avoid converting months, etc in Phrase text
			local strGsub = "(.-)%(?\"(.*)\"%)?$"
			strText = strDate:gsub(strGsub,"(%2)")										-- Separate Phrase (Text) from interpreted Date
			strDate = strDate:gsub(strGsub,"%1")
			if strDate ~= "" then strDate = "INT "..strDate end						-- Convert '...interpreted as'
		end
		strDate = strDate:gsub("(.*) %((.*)%)$",strQualifiedDate)					-- Convert (qualified) date
		for strOld, strNew in pairs ( tblGedcomDate ) do
			strDate = strDate:gsub(strOld,strNew)										-- Convert months, and 'Period' and 'Range' dates
		end
		strDate = strDate:gsub("^Q([1-4]) (%d%d%d%d)",strQuarterDate)			-- Convert 'Quarter Date'
		return strDate..strText
	end -- anonymous function

end -- function NewGedcomDate

-- Graphical User Interface --

function GUI_MainDialogue()

	-- Create GUI controls
	local	btnFolder	= iup.button	{ tip=" Click here to choose HTML folder ", title="Browse to the Project '\\Public\\FH Website' or '\\Public\\FH CD-DVD\\data' or equivalent HTML folder" }
	local	txtFolder	= iup.text	{ tip=" Chosen HTML folder full path ", border="NO" }
	local	txtStatus	= iup.text	{ tip=" Advisory HTML folder message ", border="NO" }
	local	vbxFolder	= iup.vbox	{ btnFolder, txtFolder, txtStatus }

	local	lblPages	= iup.label	{ title=" Open URL target pages:" }
	local	lstPages	= iup.list	{ tip=" Choose URL target attribute ", value=IntPages, "   In same Page frame", "   In new Tab or Window" }
	local	lblChars	= iup.label	{ title=" Abbreviate long URL:" }
	local	lstChars	= iup.list	{ tip=" Choose URL text abbreviation length ", value=IntChars, "   Never", "   > 30 chars", "   > 50 chars", "   > 70 chars", "   > 90 chars" }
	local	hbxHyper	= iup.hbox	{ lblPages, lstPages, lblChars, lstChars }
	local	btnHyper	= iup.button	{ tip=" Click here to convert URL Hyperlinks and Hypertext ", title="Convert all URL (www. http: https: ftp: mailto:) to active Hyperlinks and alter special Hypertext" }
	local	txtHyper	= iup.text	{ tip=" Number of converted lines of Hyperlinks / Text in the HTML folder pages ", border="NO" }
	local	vbxHyper	= iup.vbox	{ hbxHyper, btnHyper, txtHyper }

	local	lblPopup	= iup.label	{ title=" Version of image window Popup:" }
	local	lstPopup	= iup.list	{ tip=" Choose image popup version ", value=IntPopup, "   Default Lytebox v4.0 supplied with FH", "   Updated Lytebox v5.5 from lytebox.com", "   Customised version with Zoom & Scroll", "   Customised version Large Screen popup" }
	local	hbxPopup	= iup.hbox	{ lblPopup, lstPopup }
	local	btnPopup	= iup.button	{ tip=" Click here to convert image Popups ", title="Convert all image window Popups to one of the alternative versions chosen above" }
	local	txtPopup	= iup.text	{ tip=" Number of converted image Popups in the HTML folder pages ", border="NO" }
	local	vbxPopup	= iup.vbox	{ hbxPopup, btnPopup, txtPopup }

	local	tglToPs	= iup.toggle	{ title=" Table of Pictures: " , value=StrToPs, rightbutton="YES", tip=" Create a Table of Picture Images ? " }
	local	tglToRs	= iup.toggle	{ title="  Table of Reports: " , value=StrToRs, rightbutton="YES", tip=" Create a Table of all Reports ? " }
	local	tglToDs	= iup.toggle	{ title="Table of Downloads: " , value=StrToDs, rightbutton="YES", tip=" Create a Table of File Downloads ? " }
	local	tglMenu	= iup.toggle	{ title="     Links in Menu: " , value=StrMenu, rightbutton="YES", tip=" Include links in the Menu Bar ? " }
	local	hbxTable	= iup.hbox	{ tglToPs, tglToRs, tglToDs, tglMenu, homogeneous="YES", }
	local	btnTable	= iup.button	{ tip=" Click here to create custom Tables of Contents ", title="Create a custom Table for each type of Contents item chosen above" }
	local	txtTable	= iup.text	{ tip=" Number of custom Tables of items created from Contents items ", border="NO" }
	local	vbxTable	= iup.vbox	{ hbxTable, btnTable, txtTable }

	local	lblNames	= iup.label	{ title=" Names:" }
	local	lstNames	= iup.list	{ tip=" Choose Names to include in Index ", value=IntNames, "   Default Primary Names only", "   Add Alternate Names only", "   Add Married Surnames only", "   Add Alternate & Married Names" }
	local	lblStyle	= iup.label	{ title=" Style:" }
	local	lstStyle	= iup.list	{ tip=" Choose font style of additional Names ", value=IntStyle, "   Italics only", "   Underline only", "   Italics & Underline" }
	local	lblIdent	= iup.label	{ title=" Identity:" }
	local	lstIdent	= iup.list	{ tip=" Choose identities to include ", value=IntIdent, "   None", "   Record Id", "   Perm Rec No", "   Custom Id", "   Auto Rec Id", "   All Idents"  }
	local	hbxIndex	= iup.hbox	{ lblNames, lstNames, lblStyle, lstStyle, lblIdent, lstIdent }
	local	btnIndex	= iup.button	{ tip=" Click here to convert Index of Names ", title="Adjust the Alternate Names / Married Women Surnames in 'Index of Names' using chosen font style" }
	local	txtIndex	= iup.text	{ tip=" Number of Names processed in the 'Index of Names' page ", border="NO" }
	local	vbxIndex	= iup.vbox	{ hbxIndex, btnIndex, txtIndex }

	local	lblGenDex	= iup.label	{ title=" Exclusion Flags:" }
	local	lstGenDex	= iup.list	{ tip=" Choose flags to exclude Individuals ", value=IntGenDex, "   None", "   Private only", "   Living only", "   Private & Living"  }
	local	hbxGenDex	= iup.hbox	{ lblGenDex, lstGenDex }
	local	btnGenDex	= iup.button	{ tip=" Click here to create 'gendex.txt' file ", title="Create a 'gendex.txt' file excluding Individuals with chosen flags" }
	local	txtGenDex	= iup.text	{ tip=" Number of Individuals included in the 'gendex.txt' file ", border="NO" }
	local	vbxGenDex	= iup.vbox	{ hbxGenDex, btnGenDex, txtGenDex }

	local	btnReset	= iup.button	{ title="Restore Defaults"	, tip=" Restore all tab option settings, and window positions and sizes " }
	local	btnFont	= iup.button	{ title="Set Interface Font"	, tip=" Alter the window interface font " }
			BtnHelp	= iup.button	{ title="  Help && Advice"	, tip=" Access the online Help and Advice pages " }
	local	btnClose	= iup.button	{ title="Close Plugin"			, tip=" Close this Plugin " }

	local strInitialText = " No improvement executed in this session "

	-- Set other GUI control attributes
	for iupName, tblAttr in pairs( {
		-- Control	=	1~fgcolor	, 2~alignment, 3~expand	, 4~padding, 5~gap	, 6~margin, 7~readonly	, 8~dropdown	, 9~font		Dialogue controls
		[btnFolder]	= { StrGreen	, false		, false		, "4x8"	,	false	,	false	,	false		,	false		,	false		},
		[txtFolder]	= { StrBlack	, "ACENTER"	, false		, "0x8"	,	false	,	false	,	"YES"		,	false		,	false		},
		[txtStatus]	= { StrBlack	, "ACENTER"	, false		, "4x8"	,	false	,	false	,	"YES"		,	false		,	false		},
		[vbxFolder]	= { StrBlack	, "ACENTER"	, false		, false	,	"10"	,	false	,	false		,	false		,	StrFontBody},

		[lblPages]	= { StrBlack	, "ARIGHT"	, "NO"			, "0x8"	,	false	,	false	,	false		,	false		,	false		},
		[lstPages]	= { StrGreen	, false		, "NO"			, "0x8"	,	false	,	false	,	false		,	"YES"		,	false		},
		[lblChars]	= { StrBlack	, "ARIGHT"	, "NO"			, "0x8"	,	false	,	false	,	false		,	false		,	false		},
		[lstChars]	= { StrGreen	, false		, "NO"			, "0x8"	,	false	,	false	,	false		,	"YES"		,	false		},
		[hbxHyper]	= { StrBlack	, "ACENTER"	, false		, false	,	"4"		,	"0x0"	,	false		,	false		,	false		},
		[btnHyper]	= { StrGreen	, false		, false		, "0x8"	,	false	,	false	,	false		,	false		,	false		},
		[txtHyper]	= { StrBlack	, "ACENTER"	, false		, "0x8"	,	false	,	false	,	"YES"		,	false		,	false		},
		[vbxHyper]	= { StrBlack	, "ACENTER"	, false		, false	,	"10"	,	false	,	false		,	false		,	StrFontBody},

		[lblPopup]	= { StrBlack	, "ARIGHT"	, "NO"			, "0x8"	,	false	,	false	,	false		,	false		,	false		},
		[lstPopup]	= { StrGreen	, false		, "NO"			, "0x8"	,	false	,	false	,	false		,	"YES"		,	false		},
		[hbxPopup]	= { StrBlack	, "ACENTER"	, false		, false	,	"4"		,	"0x0"	,	false		,	false		,	false		},
		[btnPopup]	= { StrGreen	, false		, false		, "0x8"	,	false	,	false	,	false		,	false		,	false		},
		[txtPopup]	= { StrBlack	, "ACENTER"	, false		, "0x8"	,	false	,	false	,	"YES"		,	false		,	false		},
		[vbxPopup]	= { StrBlack	, "ACENTER"	, false		, false	,	"10"	,	false	,	false		,	false		,	StrFontBody},

		[hbxTable]	= { StrBlack	, "ACENTER"	, false		, false	,	"4"		,	"0x8"	,	false		,	false		,	false		},
		[btnTable]	= { StrGreen	, false		, false		, "0x8"	,	false	,	false	,	false		,	false		,	false		},
		[txtTable]	= { StrBlack	, "ACENTER"	, false		, "0x8"	,	false	,	false	,	"YES"		,	false		,	false		},
		[vbxTable]	= { StrBlack	, "ACENTER"	, false		, false	,	"10"	,	false	,	false		,	false		,	StrFontBody},

		[lblNames]	= { StrBlack	, "ARIGHT"	, "NO"			, "0x8"	,	false	,	false	,	false		,	false		,	false		},
		[lstNames]	= { StrGreen	, false		, "NO"			, "0x8"	,	false	,	false	,	false		,	"YES"		,	false		},
		[lblStyle]	= { StrBlack	, "ARIGHT"	, "NO"			, "0x8"	,	false	,	false	,	false		,	false		,	false		},
		[lstStyle]	= { StrGreen	, false		, "NO"			, "0x8"	,	false	,	false	,	false		,	"YES"		,	false		},
		[lblIdent]	= { StrBlack	, "ARIGHT"	, "NO"			, "0x8"	,	false	,	false	,	false		,	false		,	false		},
		[lstIdent]	= { StrGreen	, false		, "NO"			, "0x8"	,	false	,	false	,	false		,	"YES"		,	false		},
		[hbxIndex]	= { StrBlack	, "ACENTER"	, false		, false	,	"4"		,	"0x0"	,	false		,	false		,	false		},
		[btnIndex]	= { StrGreen	, false		, false		, "0x8"	,	false	,	false	,	false		,	false		,	false		},
		[txtIndex]	= { StrBlack	, "ACENTER"	, false		, "0x8"	,	false	,	false	,	"YES"		,	false		,	false		},
		[vbxIndex]	= { StrBlack	, "ACENTER"	, false		, false	,	"10"	,	false	,	false		,	false		,	StrFontBody},

		[lblGenDex]	= { StrBlack	, "ARIGHT"	, "NO"			, "0x8"	,	false	,	false	,	false		,	false		,	false		},
		[lstGenDex]	= { StrGreen	, false		, "NO"			, "0x8"	,	false	,	false	,	false		,	"YES"		,	false		},
		[hbxGenDex]	= { StrBlack	, "ACENTER"	, false		, false	,	"4"		,	"0x0"	,	false		,	false		,	false		},
		[btnGenDex]	= { StrGreen	, false		, false		, "0x8"	,	false	,	false	,	false		,	false		,	false		},
		[txtGenDex]	= { StrBlack	, "ACENTER"	, false		, "0x8"	,	false	,	false	,	"YES"		,	false		,	false		},
		[vbxGenDex]	= { StrBlack	, "ACENTER"	, false		, false	,	"10"	,	false	,	false		,	false		,	StrFontBody},

		[btnReset]	= { StrGreen	, false		, false		, "4x6"	,	false	,	false	,	false		,	false		,	false		},
		[btnFont]		= { StrGreen	, false		, false		, "4x6"	,	false	,	false	,	false		,	false		,	false		},
		[BtnHelp]		= { StrGreen	, false		, false		, "4x6"	,	false	,	false	,	false		,	false		,	false		},
		[btnClose]	= { StrRed	, false		, false		, "4x6"	,	false	,	false	,	false		,	false		,	false		},
		} ) do
		iupName.fgcolor	= tblAttr[1]
		if tblAttr[2] then iupName.alignment	= tblAttr[2] end
		if tblAttr[3] then iupName.expand		= tblAttr[3] else iupName.expand = "YES" end
		if tblAttr[4] then iupName.padding		= tblAttr[4] end
		if tblAttr[5] then iupName.gap			= tblAttr[5] end
		if tblAttr[6] then iupName.margin		= tblAttr[6] end
		if tblAttr[7] then iupName.readonly		= tblAttr[7] iupName.value = strInitialText end
		if tblAttr[8] then iupName.dropdown		= tblAttr[8] iupName.visible_items	= "9" end
		if tblAttr[9] then iupName.font			= tblAttr[9] end
	end

	-- Create the URL Hyperlinks tab layout
	local	boxHyper 	= iup.hbox { font=StrFontBody, gap=StrGap, vbxHyper, }

	-- Create the Image Popups tab layout
	local	boxPopup 	= iup.hbox { font=StrFontBody, gap=StrGap, vbxPopup, }

	-- Create the Content Tables tab layout
	local	boxTable 	= iup.hbox { font=StrFontBody, gap=StrGap, vbxTable, }

	-- Create the Index of Names tab layout
	local	boxIndex 	= iup.hbox { font=StrFontBody, gap=StrGap, vbxIndex, }

	-- Create the Create GenDex tab layout
	local	boxGenDex	= iup.hbox { font=StrFontBody, gap=StrGap, vbxGenDex, }

	-- Create the Tab controls layout
	local	tabCont	= iup.tabs { font=StrFontHead, padding="7x8", tip=" Select required improvement option tab ", 
								boxHyper , tabtitle0="  Hyperlinks / Text  ",
								boxPopup , tabtitle1="   Image  Popups   ",
								boxTable , tabtitle2="  Content Tables   ",
								boxIndex , tabtitle3="  Index of Names   ",
								boxGenDex, tabtitle4="   Create GenDex   ",
							}

	-- Combine all the above controls
	local	allCont	= iup.vbox { font=StrFontBody, margin="3x8", gap="6",
								iup.hbox	{ vbxFolder,	},
								iup.hbox	{ tabCont,	},
								iup.hbox	{ btnReset, btnFont, BtnHelp, btnClose, homogeneous="YES", }
 							}

	-- Create dialogue and turn off resize, maximize, minimize, and menubox except Close button
	local	dialogMain =	iup.dialog { title=StrPlugin..StrVersion, dialogframe="YES", background=StrWhite, startfocus=btnClose, font=StrFontBody, allCont, -- rastersize="1020",
								move_cb	=function(self,x,y) if IsNormalWindow(self) then IntMainX=x IntMainY=y end end,
							}

	local function setStyleList(strMode)									-- Disable Style option when only Primary Names included
		if IntNames == IntIndexPrimary then
			lstStyle.active = "NO"
		else
			lstStyle.active = strMode
		end
	end -- local function setStyleList

	local function setActiveGUI(strMode)									-- Disable GUI options when invalid folder and during button operations
		dialogMain.active = strMode
		boxHyper.active = strMode
		boxPopup.active = strMode
		boxTable.active = strMode
		boxIndex.active = strMode
		boxGenDex.active = strMode
		setStyleList(strMode)
	end -- local function setActiveGUI

	local function setNumberOfText(itemName,intNumber)					-- Insert number into text status message for each tab
		local strText = itemName.tip:gsub("Number of",tostring(intNumber))
		if intNumber == 1 then
			strText = strText:gsub("s "," ",1)								-- Remove plural "s" if number is 1
		end
		itemName.value = strText
	end -- local function setNumberOfText

	local function isFolderOK()												-- Check if folder contains FH V5 Website or CD-DVD HTML files
		local isOK = FlgFileExists(StrFolder.."\\_nameindex.html") and FlgFileExists(StrFolder.."\\fhstyle.css")
		if isOK then
			for strLine in io.lines(StrFolder.."\\_nameindex.html") do
				if not strLine:match(" XHTML ") then isOK = false end	-- FH V5 first line contains XHTML, earlier versions do not
				break
			end
		end
		if isOK then
			setActiveGUI("YES")
			txtStatus.value = "The HTML folder is valid, so please use any of the improvement option tabs below"
			txtStatus.fgcolor = StrGreen
			txtFolder.fgcolor = StrBlack
		else
			setActiveGUI("NO")
			txtStatus.value = "Folder does NOT contain FH V5 Website or CD-DVD HTML files, so use Browse button"
			txtStatus.fgcolor = StrAmber
			txtFolder.fgcolor = StrAmber
		end
		txtFolder.value = StrFolder
		dialogMain.active = "YES"
		return isOK
	end -- local function isFolderOK

	function btnFolder:action()												-- Action for Folder button
		repeat
			local strDirectory = StrFolder
			if not FlgFolderExists(StrFolder) then strDirectory = StrPublicPath end
			local dialogFolder = iup.filedlg { dialogtype="DIR", title="Please select 'FH Website' or 'FH CD-DVD\\data' or equivalent HTML folder", directory=strDirectory }
			dialogFolder:popup(iup.CENTER, iup.CENTER)
			local strStatus = dialogFolder.status
			if strStatus == "0"
			and StrFolder ~= dialogFolder.value then
				StrFolder = dialogFolder.value
				SaveSettings(StrStickyFile)									-- Save sticky data settings
				txtHyper.value  = strInitialText
				txtPopup.value  = strInitialText
				txtIndex.value  = strInitialText
				txtGenDex.value = strInitialText
			end
		until isFolderOK() or strStatus == "-1"
	end -- function btnFolder:action

	function lstPages:action(strText,intItem,intState)					-- Action for Pages dropdown
		if intState == 1 then
			IntPages = intItem
			SaveSettings(StrStickyFile)										-- Save sticky data settings
		end
	end -- function lstPages:action

	function lstChars:action(strText,intItem,intState)					-- Action for Chars dropdown
		if intState == 1 then
			IntChars = intItem
			SaveSettings(StrStickyFile)										-- Save sticky data settings
		end
	end -- function lstChars:action

	function btnHyper:action()												-- Action for Hyper button
		if isFolderOK() then
			setActiveGUI("NO")
			local intLines = IntImproveHTML(StrFolder,tonumber(IntPages),tonumber(IntChars))
			setNumberOfText(txtHyper,intLines)
			setActiveGUI("YES")
			dialogMain.bringfront = "YES"
		end
	end -- function btnHyper:action

	function lstPopup:action(strText,intItem,intState)					-- Action for Popup dropdown
		if intState == 1 then
			IntPopup = intItem
			SaveSettings(StrStickyFile)										-- Save sticky data settings
		end
	end -- function lstPopup:action

	function btnPopup:action()												-- Action for Popup button
		if isFolderOK() then
			setActiveGUI("NO")
			local intLines = IntImprovePopup(StrFolder,lstPopup[IntPopup])
			if intLines < 0 then return iup.CLOSE end
			setNumberOfText(txtPopup,intLines)
			setActiveGUI("YES")
			dialogMain.bringfront = "YES"
		end
	end -- function btnPopup:action

	function tglToPs:action(iState)											-- Action for Table of Pictures
		if iState == 0 then
			StrToPs = "OFF"
		elseif iState == 1 then
			StrToPs = "ON"
		else
			iup.Message(StrPlugin, "tglToPs invalid iState")
			StrToPs = "ERROR"
		end
		SaveSettings(StrStickyFile)											-- Save sticky data settings
	end -- function tglToPs:action

	function tglToRs:action(iState)											-- Action for Table of Reports
		if iState == 0 then
			StrToRs = "OFF"
		elseif iState == 1 then
			StrToRs = "ON"
		else
			iup.Message(StrPlugin, "tglToRs invalid iState")
			StrToRs = "ERROR"
		end
		SaveSettings(StrStickyFile)											-- Save sticky data settings
	end -- function tglToRs:action

	function tglToDs:action(iState)											-- Action for Table of Downloads
		if iState == 0 then
			StrToDs = "OFF"
		elseif iState == 1 then
			StrToDs = "ON"
		else
			iup.Message(StrPlugin, "tglToDs invalid iState")
			StrToDs = "ERROR"
		end
		SaveSettings(StrStickyFile)											-- Save sticky data settings
	end -- function tglToDs:action

	function tglMenu:action(iState)											-- Action for Menu Bar setting
		if iState == 0 then
			StrMenu = "OFF"
		elseif iState == 1 then
			StrMenu = "ON"
		else
			iup.Message(StrPlugin, "tglMenu invalid iState")
			StrMenu = "ERROR"
		end
		SaveSettings(StrStickyFile)											-- Save sticky data settings
	end -- function tglMenu:action

	function btnTable:action()												-- Action for Table button
		if isFolderOK() then
			setActiveGUI("NO")
			local intTable = IntImproveTable(StrFolder,StrToPs=="ON",StrToRs=="ON",StrToDs=="ON",StrMenu=="ON")
			setNumberOfText(txtTable,intTable)
			setActiveGUI("YES")
			dialogMain.bringfront = "YES"
		end
	end -- function btnTable:action

	function lstNames:action(strText,intItem,intState)					-- Action for Names dropdown
		if intState == 1 then
			IntNames = intItem
			SaveSettings(StrStickyFile)										-- Save sticky data settings
			setStyleList("YES")
		end
	end -- function lstNames:action

	function lstStyle:action(strText,intItem,intState)					-- Action for Style dropdown
		if intState == 1 then
			IntStyle = intItem
			SaveSettings(StrStickyFile)										-- Save sticky data settings
		end
	end -- function lstStyle:action

	function lstIdent:action(strText,intItem,intState)					-- Action for Ident dropdown
		if intState == 1 then
			IntIdent = intItem
			SaveSettings(StrStickyFile)										-- Save sticky data settings
		end
	end -- function lstIdent:action

	function btnIndex:action()												-- Action for Index button
		if isFolderOK() then
			setActiveGUI("NO")
			local intNames = IntImproveIndex(StrFolder.."\\_nameindex.html",lstNames[IntNames],lstStyle[IntStyle],lstIdent[IntIdent])
			setNumberOfText(txtIndex,intNames)
			setActiveGUI("YES")
			dialogMain.bringfront = "YES"
		end
	end -- function btnIndex:action

	function lstGenDex:action(strText,intItem,intState)					-- Action for GenDex dropdown
		if intState == 1 then
			IntGenDex = intItem
			SaveSettings(StrStickyFile)										-- Save sticky data settings
		end
	end -- function lstGenDex:action

	function btnGenDex:action()												-- Action for GenDex button
		if isFolderOK() then
			setActiveGUI("NO")
			local intNames = IntCreateGenDex(StrFolder,lstGenDex[IntGenDex])
			setNumberOfText(txtGenDex,intNames)
			setActiveGUI("YES")
			dialogMain.bringfront = "YES"
		end
	end -- function btnGenDex:action

	function btnReset:action()												-- Action for Restore Defaults button
		ResetDefaultSettings()
		if	BtnHelp.active == "NO" then										-- If Help button inactive, then Help is active, so redisplay its dialogue
			DialogHelp.rastersize = StrHelpS
			DialogHelp:showxy(IntHelpX,IntHelpY)
		end
		lstPages.value	= IntPages											-- Reset controls & redisplay Main dialogue
		lstChars.value	= IntChars
		txtHyper.value	= strInitialText
		lstPopup.value	= IntPopup
		txtPopup.value	= strInitialText
		tglToPs.value	= StrToPs
		tglToRs.value	= StrToRs
		tglToDs.value	= StrToDs
		tglMenu.value	= StrMenu
		txtTable.value	= strInitialText
		lstNames.value	= IntNames
		lstStyle.value	= IntStyle
		lstIdent.value	= IntIdent
		txtIndex.value	= strInitialText
		lstGenDex.value	= IntGenDex
		txtGenDex.value	= strInitialText
		isFolderOK()																-- Adjust buttons according to current folder, etc
		dialogMain:showxy(IntMainX,IntMainY)
		tabCont.valuepos = IntTabPosn or 0									-- Adjust tab selection
		SaveSettings(StrStickyFile)											-- Save sticky data settings
	end -- function btnReset:action

	function btnFont:action()													-- Action for Set Interface Font button
		local strAnswer = GUI_FontDialogue()
		if strAnswer == "Change" then
			for i, control in ipairs({tabCont}) do
				control.font = StrFontHead									-- Controls head font
			end
			for i, control in ipairs({allCont,vbxFolder,vbxHyper,vbxPopup,vbxTable,vbxIndex,vbxGenDex}) do
				control.font = StrFontBody									-- Controls body font
			end
			if	BtnHelp.active == "NO" then									-- If Help button inactive, then Help is active, so update its font
				HboxHelp.font = StrFontBody
			end
			SaveSettings(StrStickyFile)										-- Save sticky data settings
		end
	end -- function btnFont:action

	function BtnHelp:action()													-- Action for Help & Advice button
		local tblHelp = {"improve","hyper","popup","table","index","gendex"}
		BtnHelp.active = "NO"
		GUI_HelpDialogue(tblHelp[(IntTabPosn or -1) + 2])
	end -- function BtnHelp:action

	function btnClose:action()												-- Action for Close Plugin button
		return iup.CLOSE
	end -- function btnClose:action

	function tabCont:tabchangepos_cb(intNew,intOld)						-- Call back when Main tab position is changed  
		IntTabPosn = intNew
		SaveSettings(StrStickyFile)											-- Save sticky data settings
	end -- function tabCont:tabchangepos_cb

	isFolderOK()																	-- Adjust buttons according to current folder, etc

	dialogMain:showxy(IntMainX,IntMainY)

	tabCont.valuepos = IntTabPosn or 0										-- Adjust tab selection

	if (iup.MainLoopLevel()==0) then iup.MainLoop() end

end -- function GUI_MainDialogue

-- Main code starts here --

--	RequireLibraryModule("tatewise-library-module","1.0")

	fhInitialise(5,0,9,"save_recommended")

	PresetGlobalConstants()													-- Preset global data constants

	CheckVersionInStore(StrVersion)											-- Notify if later Version

	ResetDefaultSettings()														-- Preset default sticky settings

	StrFolder  = StrPublicPath												-- Folder for Website/CD-DVD HTML pages

	IntFontSet = IntFontPlain													-- Font Face & Style default

	LoadSettings(StrStickyFile)												-- Load sticky data settings

	GUI_MainDialogue()

	SaveSettings(StrStickyFile)												-- Save sticky data settings
